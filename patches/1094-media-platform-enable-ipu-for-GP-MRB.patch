From 659b0e4000804b596d3d06e1a8e186e6dfe5cc75 Mon Sep 17 00:00:00 2001
From: "Bandi, Kushal" <kushal.bandi@intel.com>
Date: Mon, 18 Jun 2018 00:06:16 -0700
Subject: [PATCH 1094/1240] media: platform: enable ipu for GP MRB

Change-Id: Ic099e5b008ebada0c17c6858439962b6d99bdaaa
Signed-off-by: Bandi, Kushal <kushal.bandi@intel.com>
---
 drivers/media/platform/intel/Kconfig             |   6 ++
 drivers/media/platform/intel/Makefile            |   1 +
 drivers/media/platform/intel/ipu4-bxt-gp-pdata.c | 121 +++++++++++++++++++++++
 3 files changed, 128 insertions(+)
 create mode 100644 drivers/media/platform/intel/ipu4-bxt-gp-pdata.c

diff --git a/drivers/media/platform/intel/Kconfig b/drivers/media/platform/intel/Kconfig
index 6fa6652..d198d4e 100755
--- a/drivers/media/platform/intel/Kconfig
+++ b/drivers/media/platform/intel/Kconfig
@@ -4,6 +4,12 @@ config INTEL_IPU4_BXT_P_PDATA
 	---help---
 	Pre-ACPI system platform data is compiled inside kernel
 
+config INTEL_IPU4_BXT_GP_PDATA
+	depends on VIDEO_INTEL_IPU && VIDEO_INTEL_IPU4
+	bool "Enable built in platform data for Gordon Peak"
+	---help---
+	Pre-ACPI system platform data is compiled inside kernel
+
 config INTEL_IPU4_ICI_BXT_P_PDATA
 	depends on VIDEO_INTEL_IPU && VIDEO_INTEL_ICI
 	bool "Enable built in platform data for Broxton-P ICI driver"
diff --git a/drivers/media/platform/intel/Makefile b/drivers/media/platform/intel/Makefile
index 91e5798..7b2fc67 100644
--- a/drivers/media/platform/intel/Makefile
+++ b/drivers/media/platform/intel/Makefile
@@ -18,4 +18,5 @@ ccflags-y += -I$(srcpath)/$(src)/../../pci/intel/
 
 obj-$(CONFIG_INTEL_IPU4_ICI_BXT_P_PDATA)   += ipu4-ici-bxt-p-pdata.o
 obj-$(CONFIG_INTEL_IPU4_BXT_P_PDATA)   += ipu4-bxt-p-pdata.o
+obj-$(CONFIG_INTEL_IPU4_BXT_GP_PDATA)   += ipu4-bxt-gp-pdata.o
 obj-$(CONFIG_INTEL_IPU4P_CNL_RVP_PDATA)   += ipu4p-cnl-rvp-pdata.o
diff --git a/drivers/media/platform/intel/ipu4-bxt-gp-pdata.c b/drivers/media/platform/intel/ipu4-bxt-gp-pdata.c
new file mode 100644
index 0000000..c49ab8d
--- /dev/null
+++ b/drivers/media/platform/intel/ipu4-bxt-gp-pdata.c
@@ -0,0 +1,121 @@
+/*
+ * Copyright (c) 2016--2017 Intel Corporation.
+ *
+ * Author: Jouni Ukkonen <jouni.ukkonen@intel.com>
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License version
+ * 2 as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ */
+#include <linux/clk.h>
+#include <linux/clkdev.h>
+#include <linux/gpio.h>
+#include <linux/kernel.h>
+#include <linux/pci.h>
+
+#include <media/ipu-isys.h>
+#include <media/crlmodule.h>
+#include "ipu.h"
+
+#define ADV7481_HDMI_LANES      4
+#define ADV7481_HDMI_I2C_ADDRESS 0xe0
+
+#define ADV7481_LANES		1
+/*
+ * below i2c address is dummy one, to be able to register single
+ * ADV7481 chip as two sensors
+ */
+#define ADV7481_I2C_ADDRESS	0xe1
+
+
+#define GPIO_BASE		434
+
+
+static struct crlmodule_platform_data adv7481_cvbs_pdata = {
+	.ext_clk = 286363636,
+	.xshutdown = GPIO_BASE + 64, /*dummy for now*/
+	.lanes = ADV7481_LANES,
+	.module_name = "ADV7481 CVBS"
+};
+
+static struct ipu_isys_csi2_config adv7481_cvbs_csi2_cfg = {
+	.nlanes = ADV7481_LANES,
+	.port = 4,
+};
+
+static struct ipu_isys_subdev_info adv7481_cvbs_crl_sd = {
+	.csi2 = &adv7481_cvbs_csi2_cfg,
+	.i2c = {
+		.board_info = {
+			 .type = CRLMODULE_NAME,
+			 .flags = I2C_CLIENT_TEN,
+			 .addr = ADV7481_I2C_ADDRESS,
+			 .platform_data = &adv7481_cvbs_pdata,
+		},
+		.i2c_adapter_id = 0,
+	}
+};
+
+static struct crlmodule_platform_data adv7481_hdmi_pdata = {
+	/* FIXME: may need to revisit */
+	.ext_clk = 286363636,
+	.xshutdown = GPIO_BASE + 30,
+	.lanes = ADV7481_HDMI_LANES,
+	.module_name = "ADV7481 HDMI",
+	.crl_irq_pin = GPIO_BASE + 22,
+	.irq_pin_flags = (IRQF_TRIGGER_RISING | IRQF_ONESHOT),
+	.irq_pin_name = "ADV7481_HDMI_IRQ",
+};
+
+static struct ipu_isys_csi2_config adv7481_hdmi_csi2_cfg = {
+	.nlanes = ADV7481_HDMI_LANES,
+	.port = 0,
+};
+
+static struct ipu_isys_subdev_info adv7481_hdmi_crl_sd = {
+	.csi2 = &adv7481_hdmi_csi2_cfg,
+	.i2c = {
+		.board_info = {
+			 .type = CRLMODULE_NAME,
+			 .flags = I2C_CLIENT_TEN,
+			 .addr = ADV7481_HDMI_I2C_ADDRESS,
+			 .platform_data = &adv7481_hdmi_pdata,
+		},
+		.i2c_adapter_id = 0,
+	}
+};
+
+
+
+/*
+ * Map buttress output sensor clocks to sensors -
+ * this should be coming from ACPI, in Gordon Peak
+ * ADV7481 have its own oscillator, no buttres clock
+ * needed.
+ */
+struct ipu_isys_clk_mapping gp_mapping[] = {
+	{ CLKDEV_INIT(NULL, NULL, NULL), NULL }
+};
+
+static struct ipu_isys_subdev_pdata pdata = {
+	.subdevs = (struct ipu_isys_subdev_info *[]) {
+		&adv7481_hdmi_crl_sd,
+		&adv7481_cvbs_crl_sd,
+		NULL,
+	},
+	.clk_map = gp_mapping,
+};
+
+static void ipu4_quirk(struct pci_dev *pci_dev)
+{
+	pci_dev->dev.platform_data = &pdata;
+}
+
+DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, IPU_PCI_ID,
+			ipu4_quirk);
-- 
2.7.4

