From af39e10e8cc511059d3e1a098c5125f4693246d5 Mon Sep 17 00:00:00 2001
From: kbandi <kushal.bandi@intel.com>
Date: Fri, 4 May 2018 02:25:02 -0700
Subject: [PATCH 2363/2367] media: intel-ipu: Merge IPU kernel driver into 4.14
 kernel

IPU driver code from:
55971b4 platform: fix build warning

Change-Id: I92afa7abaa3c03b5ee2acb55cbf5cd407a776854
Signed-off-by: kbandi <kushal.bandi@intel.com>
---
 drivers/media/i2c/Kconfig                          |    6 +
 drivers/media/i2c/Makefile                         |    4 +
 drivers/media/i2c/ad5816g.c                        |    8 +
 drivers/media/i2c/ad5816g.h                        |    4 +
 drivers/media/i2c/ak7375.c                         |   15 +
 drivers/media/i2c/as3638.c                         |    4 +
 drivers/media/i2c/bu64295.c                        |   20 +
 drivers/media/i2c/bu64295.h                        |    4 +
 drivers/media/i2c/crlmodule/Makefile               |   15 +
 .../i2c/crlmodule/crl_adv7481_configuration.h      |    4 +
 .../i2c/crlmodule/crl_adv7481_cvbs_configuration.h |    4 +
 .../i2c/crlmodule/crl_adv7481_eval_configuration.h |    4 +
 .../i2c/crlmodule/crl_adv7481_hdmi_configuration.c |    4 +
 .../i2c/crlmodule/crl_adv7481_hdmi_configuration.h |  126 ++
 .../i2c/crlmodule/crl_ar0231at_configuration.h     |  102 ++
 .../media/i2c/crlmodule/crl_imx132_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_imx135_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_imx185_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_imx214_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_imx230_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_imx274_configuration.h |    8 +
 .../media/i2c/crlmodule/crl_imx290_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_imx318_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_imx477_common_regs.h   |   11 +
 .../crlmodule/crl_imx477_master_configuration.h    |   10 +
 .../i2c/crlmodule/crl_imx477_slave_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_magna_configuration.h  |    4 +
 .../i2c/crlmodule/crl_ov10635_configuration.h      |   34 +
 .../i2c/crlmodule/crl_ov10640_configuration.h      |    4 +
 .../i2c/crlmodule/crl_ov13858_configuration.h      |    7 +
 .../i2c/crlmodule/crl_ov13860_configuration.h      |    4 +
 .../media/i2c/crlmodule/crl_ov2740_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_ov5670_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_ov8858_configuration.h |    4 +
 .../media/i2c/crlmodule/crl_ov9281_configuration.h |    4 +
 .../i2c/crlmodule/crl_pixter_stub_configuration.h  |   94 +
 drivers/media/i2c/crlmodule/crlmodule-core.c       |   21 +
 drivers/media/i2c/crlmodule/crlmodule-data.c       |   19 +
 drivers/media/i2c/crlmodule/crlmodule-msrlist.c    |    4 +
 drivers/media/i2c/crlmodule/crlmodule-msrlist.h    |    4 +
 drivers/media/i2c/crlmodule/crlmodule-nvm.c        |    4 +
 drivers/media/i2c/crlmodule/crlmodule-nvm.h        |    4 +
 drivers/media/i2c/crlmodule/crlmodule-regs.c       |    4 +
 drivers/media/i2c/crlmodule/crlmodule-regs.h       |    4 +
 drivers/media/i2c/crlmodule/crlmodule-sensor-ds.h  |    4 +
 drivers/media/i2c/crlmodule/crlmodule.h            |    4 +
 drivers/media/i2c/dw9714.c                         |    9 +
 drivers/media/i2c/imx319.c                         | 1873 ++++++++++++++++++++
 drivers/media/i2c/imx355.c                         | 1124 ++++++++++++
 drivers/media/i2c/lc898122/Makefile                |   15 +
 drivers/media/i2c/lc898122/lc898122-oiscmd.c       |    4 +
 drivers/media/i2c/lc898122/lc898122-oisfil.h       |    4 +
 drivers/media/i2c/lc898122/lc898122-oisinit.c      |    4 +
 drivers/media/i2c/lc898122/lc898122-oisinit.h      |    4 +
 drivers/media/i2c/lc898122/lc898122-regs.h         |    4 +
 drivers/media/i2c/lc898122/lc898122.c              |   20 +
 drivers/media/i2c/lc898122/lc898122.h              |    4 +
 drivers/media/i2c/lm3643.c                         |    4 +
 drivers/media/i2c/max9286-reg-settings.h           |   40 +
 drivers/media/i2c/max9286.c                        |   99 ++
 drivers/media/i2c/ov8856.c                         |    4 +
 drivers/media/i2c/ti964-reg.h                      |    4 +
 drivers/media/i2c/ti964.c                          |   34 +
 drivers/media/i2c/vcm_stub.c                       |    4 +
 drivers/media/i2c/vcm_stub.h                       |    4 +
 drivers/media/pci/intel/Kconfig                    |    7 +
 drivers/media/pci/intel/Makefile                   |   17 +
 drivers/media/pci/intel/ipu-bus.c                  |   19 +
 drivers/media/pci/intel/ipu-bus.h                  |    4 +
 drivers/media/pci/intel/ipu-buttress.c             |   51 +
 drivers/media/pci/intel/ipu-buttress.h             |    8 +
 drivers/media/pci/intel/ipu-cpd.c                  |   33 +
 drivers/media/pci/intel/ipu-cpd.h                  |    9 +
 drivers/media/pci/intel/ipu-dma.c                  |   16 +
 drivers/media/pci/intel/ipu-dma.h                  |    4 +
 drivers/media/pci/intel/ipu-fw-com.c               |  110 ++
 drivers/media/pci/intel/ipu-fw-com.h               |   13 +
 drivers/media/pci/intel/ipu-fw-isys.c              |   17 +
 drivers/media/pci/intel/ipu-fw-isys.h              |   20 +
 drivers/media/pci/intel/ipu-fw-psys.c              |    7 +
 drivers/media/pci/intel/ipu-fw-psys.h              |   19 +
 drivers/media/pci/intel/ipu-fw-resources.h         |   25 +
 drivers/media/pci/intel/ipu-isys-csi2-be-soc.c     |   27 +
 drivers/media/pci/intel/ipu-isys-csi2-be.c         |    8 +
 drivers/media/pci/intel/ipu-isys-csi2-be.h         |    4 +
 drivers/media/pci/intel/ipu-isys-csi2.c            |  119 ++
 drivers/media/pci/intel/ipu-isys-csi2.h            |   29 +
 drivers/media/pci/intel/ipu-isys-media.c           |   26 +
 drivers/media/pci/intel/ipu-isys-media.h           |   21 +
 drivers/media/pci/intel/ipu-isys-queue.c           |   31 +
 drivers/media/pci/intel/ipu-isys-queue.h           |    9 +
 drivers/media/pci/intel/ipu-isys-subdev.c          |  137 ++
 drivers/media/pci/intel/ipu-isys-subdev.h          |   15 +
 drivers/media/pci/intel/ipu-isys-tpg.c             |   60 +
 drivers/media/pci/intel/ipu-isys-tpg.h             |   14 +
 drivers/media/pci/intel/ipu-isys-video.c           |  100 ++
 drivers/media/pci/intel/ipu-isys-video.h           |   12 +
 drivers/media/pci/intel/ipu-isys.c                 |   98 +
 drivers/media/pci/intel/ipu-isys.h                 |   10 +
 drivers/media/pci/intel/ipu-mmu.c                  |    8 +
 drivers/media/pci/intel/ipu-mmu.h                  |    9 +
 drivers/media/pci/intel/ipu-pdata.h                |    4 +
 drivers/media/pci/intel/ipu-psys-compat32.c        |   17 +
 drivers/media/pci/intel/ipu-psys.c                 | 1244 +++++++++++++
 drivers/media/pci/intel/ipu-psys.h                 |   73 +
 drivers/media/pci/intel/ipu-resources.c            |  455 +++++
 drivers/media/pci/intel/ipu-resources.h            |  154 ++
 drivers/media/pci/intel/ipu-trace-event.h          |    7 +
 drivers/media/pci/intel/ipu-trace.c                |   25 +
 drivers/media/pci/intel/ipu-trace.h                |    9 +
 drivers/media/pci/intel/ipu-wrapper.c              |  229 +++
 drivers/media/pci/intel/ipu-wrapper.h              |   11 +
 drivers/media/pci/intel/ipu.c                      |   28 +
 drivers/media/pci/intel/ipu.h                      |   15 +
 drivers/media/pci/intel/ipu4/Makefile              |  136 ++
 .../pci/intel/ipu4/ipu-platform-buttress-regs.h    |    4 +
 .../pci/intel/ipu4/ipu-platform-isys-csi2-reg.h    |    7 +
 drivers/media/pci/intel/ipu4/ipu-platform-isys.h   |    4 +
 drivers/media/pci/intel/ipu4/ipu-platform-regs.h   |   10 +
 .../media/pci/intel/ipu4/ipu-platform-resources.h  |   11 +
 drivers/media/pci/intel/ipu4/ipu-platform.h        |    7 +
 .../pci/intel/ipu4/ipu4-css/Makefile.ipu4isys_inc  |    3 +
 .../pci/intel/ipu4/ipu4-css/Makefile.ipu4psys_inc  |    3 +
 .../media/pci/intel/ipu4/ipu4-css/Makefile.isyslib |   37 +
 .../intel/ipu4/ipu4-css/ia_css_fw_pkg_release.h    |    4 +
 .../media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c    |  513 +++++-
 .../fw_abi_common_types/ia_css_terminal_defs.h     |    7 +
 .../interface/ia_css_isys_fw_bridged_types.h       |    6 +
 .../lib2600/isysapi/interface/ia_css_isysapi.h     |   11 +
 .../interface/ia_css_isysapi_proxy_region_defs.h   |   12 +
 .../isysapi/interface/ia_css_isysapi_types.h       |    9 +
 .../intel/ipu4/ipu4-css/lib2600/isysapi/isysapi.mk |    6 +
 .../lib2600/isysapi/src/ia_css_isys_private.c      |    3 +
 .../lib2600/isysapi/src/ia_css_isys_public.c       |    6 +
 .../lib2600/regmem/interface/regmem_access.h       |    7 +
 .../ipu4/ipu4-css/lib2600/support/assert_support.h |    6 +
 .../ipu4/ipu4-css/lib2600/support/math_support.h   |    3 +
 .../lib2600/syscom/interface/ia_css_syscom.h       |    3 +
 .../syscom/interface/ia_css_syscom_config.h        |    3 +
 .../ipu4-css/lib2600/syscom/src/ia_css_syscom.c    |   12 +
 .../lib2600/syscom/src/ia_css_syscom_config_fw.h   |    3 +
 .../intel/ipu4/ipu4-css/lib2600/syscom/syscom.mk   |    3 +
 .../pci/intel/ipu4/ipu4-css/lib2600psys/Makefile   |   15 +
 .../DSS_V2_program_group/ia_css_fw_pkg_release.h   |    4 +
 .../lib2600psys/lib/config/psys/subsystem_bxtB0.mk |   11 +
 .../lib/fw_abi_common_types/ia_css_terminal_defs.h |    7 +
 .../lib2600psys/lib/psys_server/psys_server.mk     |    3 +
 .../src/bxt_spctrl_process_group_cmd_impl.c        |   35 +
 .../data/src/ia_css_program_group_data_impl.h      |    4 +
 .../psysapi/device/interface/ia_css_psys_device.h  |    9 +
 .../lib/psysapi/device/src/ia_css_psys_device.c    |   19 +
 .../interface/ia_css_psys_process_group_cmd_impl.h |   11 +
 .../lib/psysapi/dynamic/src/ia_css_psys_process.c  |    4 +
 .../static/src/ia_css_psys_program_manifest.c      |    6 +
 .../lib/regmem/interface/regmem_access.h           |    7 +
 .../lib2600psys/lib/support/assert_support.h       |    6 +
 .../lib2600psys/lib/support/math_support.h         |    3 +
 .../lib/syscom/interface/ia_css_syscom.h           |    3 +
 .../lib/syscom/interface/ia_css_syscom_config.h    |    3 +
 .../lib2600psys/lib/syscom/src/ia_css_syscom.c     |   12 +
 .../lib/syscom/src/ia_css_syscom_config_fw.h       |    3 +
 .../ipu4/ipu4-css/lib2600psys/lib/syscom/syscom.mk |    3 +
 .../lib/vied_parameters/vied_parameters.mk         |    4 +
 .../ipu4/ipu4-css/lib2600psys/libcsspsys2600.c     |  274 +++
 .../media/pci/intel/ipu4/ipu4-css/libintel-ipu4.c  |   56 +
 drivers/media/pci/intel/ipu4/ipu4-fw-resources.c   |   50 +
 drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c      |   18 +
 drivers/media/pci/intel/ipu4/ipu4-isys-isa.c       |   26 +
 drivers/media/pci/intel/ipu4/ipu4-isys-isa.h       |   16 +
 drivers/media/pci/intel/ipu4/ipu4-isys.c           |   30 +
 drivers/media/pci/intel/ipu4/ipu4-psys.c           |   19 +
 .../media/pci/intel/ipu4/ipu4-resource-tables.c    |  173 ++
 drivers/media/pci/intel/ipu4/ipu4.c                |    7 +
 .../intel/ipu4/ipu4p-css/Makefile.ipu4pisys_inc    |    3 +
 .../intel/ipu4/ipu4p-css/Makefile.ipu4pisys_src    |    7 +
 .../intel/ipu4/ipu4p-css/Makefile.ipu4ppsys_inc    |    3 +
 .../pci/intel/ipu4/ipu4p-css/Makefile.isyslib      |   37 +
 .../intel/ipu4/ipu4p-css/ia_css_fw_pkg_release.h   |    4 +
 .../lib2600/cpd_binary/ia_css_fw_pkg_release.h     |    4 +
 .../fw_abi_common_types/ia_css_terminal_defs.h     |    7 +
 .../interface/ia_css_isys_fw_bridged_types.h       |    6 +
 .../lib2600/isysapi/interface/ia_css_isysapi.h     |   11 +
 .../interface/ia_css_isysapi_proxy_region_defs.h   |   12 +
 .../isysapi/interface/ia_css_isysapi_types.h       |    9 +
 .../ipu4/ipu4p-css/lib2600/isysapi/isysapi.mk      |    6 +
 .../lib2600/isysapi/src/ia_css_isys_private.c      |    3 +
 .../lib2600/isysapi/src/ia_css_isys_public.c       |    6 +
 .../lib2600/reg_dump/src/reg_dump_generic_bridge.c |   12 +
 .../lib2600/regmem/interface/regmem_access.h       |    7 +
 .../ipu4p-css/lib2600/support/assert_support.h     |    6 +
 .../ipu4/ipu4p-css/lib2600/support/math_support.h  |    3 +
 .../lib2600/syscom/interface/ia_css_syscom.h       |    3 +
 .../syscom/interface/ia_css_syscom_config.h        |    3 +
 .../ipu4p-css/lib2600/syscom/src/ia_css_syscom.c   |   12 +
 .../lib2600/syscom/src/ia_css_syscom_config_fw.h   |    3 +
 .../intel/ipu4/ipu4p-css/lib2600/syscom/syscom.mk  |    3 +
 .../pci/intel/ipu4/ipu4p-css/lib2600psys/Makefile  |    6 +
 .../lib/CNL_program_group/ia_css_fw_pkg_release.h  |    4 +
 .../lib/ICL_program_group/ia_css_fw_pkg_release.h  |    4 +
 .../lib2600psys/lib/config/psys/subsystem_cnlB0.mk |   33 +
 .../interface/ipu_device_gp_properties_types.h     |  109 ++
 .../lib/fw_abi_common_types/ia_css_terminal_defs.h |    7 +
 .../lib2600psys/lib/psys_server/psys_server.mk     |    3 +
 .../src/bxt_spctrl_process_group_cmd_impl.c        |   27 +
 .../data/src/ia_css_program_group_data_impl.h      |   12 +
 .../psysapi/device/interface/ia_css_psys_device.h  |    9 +
 .../lib/psysapi/device/src/ia_css_psys_device.c    |   19 +
 .../interface/ia_css_psys_process_group_cmd_impl.h |   16 +
 .../lib/psysapi/dynamic/src/ia_css_psys_process.c  |    6 +
 .../static/src/ia_css_psys_program_manifest.c      |    6 +
 .../static/src/ia_css_psys_terminal_manifest.c     |    3 +
 .../lib/reg_dump/src/reg_dump_generic_bridge.c     |   12 +
 .../lib/regmem/interface/regmem_access.h           |    7 +
 .../lib2600psys/lib/support/assert_support.h       |    6 +
 .../lib2600psys/lib/support/math_support.h         |    3 +
 .../lib/syscom/interface/ia_css_syscom.h           |    3 +
 .../lib/syscom/interface/ia_css_syscom_config.h    |    3 +
 .../lib2600psys/lib/syscom/src/ia_css_syscom.c     |   12 +
 .../lib/syscom/src/ia_css_syscom_config_fw.h       |    3 +
 .../ipu4p-css/lib2600psys/lib/syscom/syscom.mk     |    3 +
 .../lib/vied_parameters/vied_parameters.mk         |    4 +
 .../ipu4/ipu4p-css/lib2600psys/libcsspsys2600.c    |  290 +++
 .../pci/intel/ipu4/ipu4p-css/libintel-ipu4p.c      |   46 +
 drivers/media/pci/intel/ipu4/ipu4p-isys-csi2.c     |   15 +
 drivers/media/pci/intel/libintel-checker.c         |  127 ++
 drivers/media/pci/intel/libintel-checker.h         |    9 +
 drivers/media/platform/intel/Kconfig               |   14 +
 drivers/media/platform/intel/Makefile              |   22 +
 drivers/media/platform/intel/ipu4-bxt-p-pdata.c    |  197 ++
 drivers/media/platform/intel/ipu4p-cnl-rvp-pdata.c |   24 +
 drivers/media/platform/video-sensor-stub-pdata.c   |   18 +
 drivers/media/platform/video-sensor-stub.c         |    3 +
 include/media/as3638.h                             |    7 +
 include/media/crlmodule.h                          |   14 +
 include/media/dw9714.h                             |    4 +
 include/media/ipu-isys.h                           |    7 +
 include/media/lc898122.h                           |    4 +
 include/media/lm3643.h                             |    4 +
 include/media/max9286.h                            |    6 +
 include/media/ti964.h                              |   10 +
 include/uapi/linux/crlmodule.h                     |   11 +
 include/uapi/linux/ipu-isys-isa-fw.h               |    7 +
 include/uapi/linux/ipu-isys.h                      |    7 +
 include/uapi/linux/ipu-psys.h                      |    8 +
 244 files changed, 10288 insertions(+), 1 deletion(-)
 create mode 100644 drivers/media/pci/intel/ipu-fw-resources.h
 create mode 100644 drivers/media/pci/intel/ipu-isys-media.c
 create mode 100644 drivers/media/pci/intel/ipu-resources.c
 create mode 100644 drivers/media/pci/intel/ipu-resources.h
 mode change 120000 => 100644 drivers/media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c
 create mode 100644 drivers/media/pci/intel/ipu4/ipu4-resource-tables.c
 create mode 100644 drivers/media/pci/intel/libintel-checker.c
 create mode 100644 drivers/media/pci/intel/libintel-checker.h

diff --git a/drivers/media/i2c/Kconfig b/drivers/media/i2c/Kconfig
index c3b79304..2720a1e 100644
--- a/drivers/media/i2c/Kconfig
+++ b/drivers/media/i2c/Kconfig
@@ -785,7 +785,10 @@ config VIDEO_S5K5BAF
 source "drivers/media/i2c/smiapp/Kconfig"
 source "drivers/media/i2c/et8ek8/Kconfig"
 source "drivers/media/i2c/crlmodule/Kconfig"
+<<<<<<< HEAD
 source "drivers/media/i2c/crlmodule-lite/Kconfig"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 source "drivers/media/i2c/lc898122/Kconfig"
 
 config VIDEO_S5C73M3
@@ -939,12 +942,15 @@ config VIDEO_TI964
 	---help---
 	This is a driver for TI964 camera.
 
+<<<<<<< HEAD
 config VIDEO_TI960
 	tristate "TI960 driver support"
 	depends on I2C && VIDEO_V4L2
 	---help---
 	This is a driver for TI960 Deserializer.
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 config VIDEO_AS3638
 	tristate "AS3638 flash driver support"
 	depends on I2C && VIDEO_V4L2 && MEDIA_CONTROLLER
diff --git a/drivers/media/i2c/Makefile b/drivers/media/i2c/Makefile
index 1326bdf..9da973e 100644
--- a/drivers/media/i2c/Makefile
+++ b/drivers/media/i2c/Makefile
@@ -100,9 +100,13 @@ obj-$(CONFIG_VIDEO_BU64295) += bu64295.o
 obj-$(CONFIG_VIDEO_AD5816G) += ad5816g.o
 obj-$(CONFIG_VIDEO_VCM_STUB) += vcm_stub.o
 obj-$(CONFIG_VIDEO_CRLMODULE) += crlmodule/
+<<<<<<< HEAD
 obj-$(CONFIG_VIDEO_CRLMODULE_LITE) += crlmodule-lite/
 obj-$(CONFIG_VIDEO_TI964) += ti964.o
 ti960-objs	:=	ti953-ser.o ti960-des.o
 obj-$(CONFIG_VIDEO_TI960) += ti960.o
+=======
+obj-$(CONFIG_VIDEO_TI964) += ti964.o
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 obj-$(CONFIG_VIDEO_LC898122) += lc898122/
 obj-$(CONFIG_VIDEO_AS3638) += as3638.o
diff --git a/drivers/media/i2c/ad5816g.c b/drivers/media/i2c/ad5816g.c
index a1d23f2..154317f 100644
--- a/drivers/media/i2c/ad5816g.c
+++ b/drivers/media/i2c/ad5816g.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2016 - 2018 Intel Corporation
 
 #include <linux/delay.h>
@@ -167,6 +171,10 @@ static int ad5816g_vcm_init(struct v4l2_subdev *sd)
 static int ad5816g_t_focus_vcm(struct v4l2_subdev *sd, s32 val)
 {
 	struct i2c_client *client = v4l2_get_subdevdata(sd);
+<<<<<<< HEAD
+=======
+	struct ad5816g_device *ad5816g_dev = subdev_to_ad5816g_dev(sd);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	int ret;
 	u16 data;
 
diff --git a/drivers/media/i2c/ad5816g.h b/drivers/media/i2c/ad5816g.h
index 9c417a8..f05b5d0 100644
--- a/drivers/media/i2c/ad5816g.h
+++ b/drivers/media/i2c/ad5816g.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 #ifndef __AD5816G_H__
 #define __AD5816G_H__
diff --git a/drivers/media/i2c/ak7375.c b/drivers/media/i2c/ak7375.c
index 9150f77..d5cfffd 100644
--- a/drivers/media/i2c/ak7375.c
+++ b/drivers/media/i2c/ak7375.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2018 Intel Corporation
 
 #include <linux/acpi.h>
@@ -8,7 +12,10 @@
 #include <linux/pm_runtime.h>
 #include <media/v4l2-ctrls.h>
 #include <media/v4l2-device.h>
+<<<<<<< HEAD
 #include <media/v4l2-event.h>
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define AK7375_NAME		"ak7375"
 #define AK7375_MAX_FOCUS_POS	4095
@@ -109,6 +116,7 @@ static const struct v4l2_subdev_internal_ops ak7375_int_ops = {
 	.close = ak7375_close,
 };
 
+<<<<<<< HEAD
 static const struct v4l2_subdev_core_ops ak7375_subdev_core_ops = {
 	.subscribe_event = v4l2_ctrl_subdev_subscribe_event,
 	.unsubscribe_event = v4l2_event_subdev_unsubscribe,
@@ -117,6 +125,9 @@ static const struct v4l2_subdev_core_ops ak7375_subdev_core_ops = {
 static const struct v4l2_subdev_ops ak7375_ops = {
 	.core = &ak7375_subdev_core_ops,
 };
+=======
+static const struct v4l2_subdev_ops ak7375_ops = { };
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static void ak7375_subdev_cleanup(struct ak7375_device *ak7375_dev)
 {
@@ -154,8 +165,12 @@ static int ak7375_probe(struct i2c_client *client,
 		return -ENOMEM;
 
 	v4l2_i2c_subdev_init(&ak7375_dev->sd, client, &ak7375_ops);
+<<<<<<< HEAD
 	ak7375_dev->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE |
 				V4L2_SUBDEV_FL_HAS_EVENTS;
+=======
+	ak7375_dev->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	ak7375_dev->sd.internal_ops = &ak7375_int_ops;
 
 	rval = ak7375_init_controls(ak7375_dev);
diff --git a/drivers/media/i2c/as3638.c b/drivers/media/i2c/as3638.c
index 7ccdab91..0076eaa 100644
--- a/drivers/media/i2c/as3638.c
+++ b/drivers/media/i2c/as3638.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2016 - 2018 Intel Corporation
 
 #include <linux/module.h>
diff --git a/drivers/media/i2c/bu64295.c b/drivers/media/i2c/bu64295.c
index 586fbe5..da92b783 100644
--- a/drivers/media/i2c/bu64295.c
+++ b/drivers/media/i2c/bu64295.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2016 - 2018 Intel Corporation
 
 #include <linux/gpio.h>
@@ -166,10 +170,14 @@ static void bu64295_subdev_cleanup(struct bu64295_device *bu64295_dev)
 {
 	v4l2_ctrl_handler_free(&bu64295_dev->ctrls_vcm);
 	v4l2_device_unregister_subdev(&bu64295_dev->subdev_vcm);
+<<<<<<< HEAD
 
 #if defined(CONFIG_MEDIA_CONTROLLER)
 	media_entity_cleanup(&bu64295_dev->subdev_vcm.entity);
 #endif
+=======
+	media_entity_cleanup(&bu64295_dev->subdev_vcm.entity);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static const struct v4l2_subdev_ops bu64295_ops = { };
@@ -205,24 +213,36 @@ static int bu64295_probe(struct i2c_client *client,
 	rval = bu64295_init_controls(bu64295_dev);
 	if (rval)
 		goto err_cleanup;
+<<<<<<< HEAD
 #if defined(CONFIG_MEDIA_CONTROLLER)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 5, 0)
 	rval = media_entity_init(&bu64295_dev->subdev_vcm.entity, 0, NULL, 0);
 #else
 	rval = media_entity_pads_init(&bu64295_dev->subdev_vcm.entity, 0,
 				      NULL);
 #endif
+<<<<<<< HEAD
 #endif
 	if (rval)
 		goto err_cleanup;
 
 #if defined(CONFIG_MEDIA_CONTROLLER)
+=======
+	if (rval)
+		goto err_cleanup;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 5, 0)
 	bu64295_dev->subdev_vcm.entity.type = MEDIA_ENT_T_V4L2_SUBDEV_LENS;
 #else
 	bu64295_dev->subdev_vcm.entity.function = MEDIA_ENT_F_LENS;
 #endif
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	bu64295_dev->vcm_mode = BU64295_DIRECT;
 
 	return 0;
diff --git a/drivers/media/i2c/bu64295.h b/drivers/media/i2c/bu64295.h
index 36b873d..197f56c 100644
--- a/drivers/media/i2c/bu64295.h
+++ b/drivers/media/i2c/bu64295.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 #ifndef __BU64295_H__
 #define __BU64295_H__
diff --git a/drivers/media/i2c/crlmodule/Makefile b/drivers/media/i2c/crlmodule/Makefile
index c3a1fed..9c1937b 100644
--- a/drivers/media/i2c/crlmodule/Makefile
+++ b/drivers/media/i2c/crlmodule/Makefile
@@ -1,3 +1,4 @@
+<<<<<<< HEAD
 # SPDX-License-Identifier: GPL-2.0
 # Copyright (c) 2010 - 2018, Intel Corporation.
 
@@ -8,6 +9,20 @@ ccflags-y += $(call cc-disable-warning, unused-parameter)
 ccflags-y += $(call cc-disable-warning, implicit-fallthrough)
 ccflags-y += $(call cc-disable-warning, missing-field-initializers)
 ccflags-$(CONFIG_VIDEO_INTEL_IPU_WERROR) += -Werror
+=======
+#
+#  Copyright (c) 2010 - 2018 Intel Corporation.
+#
+#  This program is free software; you can redistribute it and/or modify it
+#  under the terms and conditions of the GNU General Public License,
+#  version 2, as published by the Free Software Foundation.
+#
+#  This program is distributed in the hope it will be useful, but WITHOUT
+#  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+#  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+#  more details.
+#
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 crlmodule-objs			+= crlmodule-core.o crlmodule-data.o \
 				   crlmodule-regs.o crlmodule-nvm.o \
diff --git a/drivers/media/i2c/crlmodule/crl_adv7481_configuration.h b/drivers/media/i2c/crlmodule/crl_adv7481_configuration.h
index 9cf6e37..7d85c68 100644
--- a/drivers/media/i2c/crlmodule/crl_adv7481_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_adv7481_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  *
  * Author: Jianxu Zheng <jian.xu.zheng@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_adv7481_cvbs_configuration.h b/drivers/media/i2c/crlmodule/crl_adv7481_cvbs_configuration.h
index 34f33ac..dec4abf 100644
--- a/drivers/media/i2c/crlmodule/crl_adv7481_cvbs_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_adv7481_cvbs_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  *
  * Author: Jianxu Zheng <jian.xu.zheng@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_adv7481_eval_configuration.h b/drivers/media/i2c/crlmodule/crl_adv7481_eval_configuration.h
index c778170..c92a996 100644
--- a/drivers/media/i2c/crlmodule/crl_adv7481_eval_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_adv7481_eval_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  *
  * Author: Jianxu Zheng <jian.xu.zheng@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.c b/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.c
index d8d9c7b..d02aa53 100644
--- a/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.c
+++ b/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2016 - 2018 Intel Corporation
 
 #include <linux/device.h>
diff --git a/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.h b/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.h
index 0a33945..c71d615 100644
--- a/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_adv7481_hdmi_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef __CRLMODULE_ADV7481_HDMI_CONFIGURATION_H_
@@ -168,12 +172,25 @@ static struct crl_register_write_rep adv7481_hdmi_onetime_init_regset[] = {
 
 static struct crl_register_write_rep adv7481_hdmi_mode_rgb565[] = {
 	{0x04, CRL_REG_LEN_08BIT, 0x02, 0xE0}, /* RGB Out of CP */
+<<<<<<< HEAD
 	{0x12, CRL_REG_LEN_08BIT, 0xF0, 0xE0}, /* CSC Depends on ip Packets - SDR 444 */
 	{0x17, CRL_REG_LEN_08BIT, 0xB8, 0xE0}, /* Luma & Chroma Values Can Reach 254d */
 	{0x7C, CRL_REG_LEN_08BIT, 0x00, 0x44}, /* ADI Required Write */
 	{0x0C, CRL_REG_LEN_08BIT, 0xE0, 0xE0}, /* Enable LLC_DLL & Double LLC Timing */
 	{0x0E, CRL_REG_LEN_08BIT, 0xDD, 0xE0},
 	/* LLC/PIX/SPI PINS TRISTATED AUD Outputs Enabled */
+=======
+	{0x12, CRL_REG_LEN_08BIT, 0xF0, 0xE0}, /* CSC Depends on ip Packets -
+					SDR 444 */
+	{0x17, CRL_REG_LEN_08BIT, 0xB8, 0xE0}, /* Configure for RGB565 & Luma &
+					Chroma Values Can Reach 254d */
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0}, /* CP-Insert_AV_Code */
+	{0x7C, CRL_REG_LEN_08BIT, 0x00, 0x44}, /* ADI Required Write */
+	{0x0C, CRL_REG_LEN_08BIT, 0xE0, 0xE0}, /* Enable LLC_DLL &
+					Double LLC Timing */
+	{0x0E, CRL_REG_LEN_08BIT, 0xDD, 0xE0}, /* LLC/PIX/SPI PINS TRISTATED
+					AUD Outputs Enabled */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{0xDB, CRL_REG_LEN_08BIT, 0x10, 0x94}, /* ADI Required Write */
 	 /* Enable 4-lane CSI TXB & Pixel Port */
 	{0x7E, CRL_REG_LEN_08BIT, 0x98, 0x94}, /* ADI Required Write */
@@ -181,17 +198,31 @@ static struct crl_register_write_rep adv7481_hdmi_mode_rgb565[] = {
 
 static struct crl_register_write_rep adv7481_hdmi_mode_rgb888[] = {
 	{0x04, CRL_REG_LEN_08BIT, 0x02, 0xE0}, /* RGB Out of CP */
+<<<<<<< HEAD
 	{0x12, CRL_REG_LEN_08BIT, 0xF0, 0xE0}, /* CSC Depends on ip Packets - SDR 444 */
 	{0x17, CRL_REG_LEN_08BIT, 0x80, 0xE0}, /* Luma & Chroma Values Can Reach 254d */
 	{0x7C, CRL_REG_LEN_08BIT, 0x00, 0x44}, /* ADI Required Write */
 	{0x0C, CRL_REG_LEN_08BIT, 0xE0, 0xE0}, /* Enable LLC_DLL & Double LLC Timing */
 	{0x0E, CRL_REG_LEN_08BIT, 0xDD, 0xE0},
 	/* LLC/PIX/SPI PINS TRISTATED AUD Outputs Enabled */
+=======
+	{0x12, CRL_REG_LEN_08BIT, 0xF0, 0xE0}, /* CSC Depends on ip Packets -
+					SDR 444 */
+	{0x17, CRL_REG_LEN_08BIT, 0x80, 0xE0}, /* Luma & Chroma Values Can
+					Reach 254d */
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0}, /* CP-Insert_AV_Code */
+	{0x7C, CRL_REG_LEN_08BIT, 0x00, 0x44}, /* ADI Required Write */
+	{0x0C, CRL_REG_LEN_08BIT, 0xE0, 0xE0}, /* Enable LLC_DLL &
+					Double LLC Timing */
+	{0x0E, CRL_REG_LEN_08BIT, 0xDD, 0xE0}, /* LLC/PIX/SPI PINS TRISTATED
+					AUD Outputs Enabled */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{0xDB, CRL_REG_LEN_08BIT, 0x10, 0x94}, /* ADI Required Write */
 	{0x7E, CRL_REG_LEN_08BIT, 0x1B, 0x94}, /* ADI Required Write */
 };
 
 
+<<<<<<< HEAD
 static struct crl_register_write_rep adv7481_hdmi_mode_uyvy[] = {
 	{0x1C, CRL_REG_LEN_08BIT, 0x00, 0xE0}, /* ADI Require Write*/
 	{0x04, CRL_REG_LEN_08BIT, 0x00, 0xE0}, /* YCrCb output */
@@ -217,6 +248,20 @@ static struct crl_register_write_rep adv7481_hdmi_mode_yuyv[] = {
 	{0x3E, CRL_REG_LEN_08BIT, 0x08, 0x44}, /* Invert order of Cb and Cr*/
 	{0x0C, CRL_REG_LEN_08BIT, 0xE0, 0xE0}, /* Enable LLC_DLL & Double LLC Timing */
 	{0x0E, CRL_REG_LEN_08BIT, 0xDD, 0xE0}, /* LLC/PIX/SPI PINS TRISTATED AUD Outputs Enabled */
+=======
+static struct crl_register_write_rep adv7481_hdmi_mode_yuv[] = {
+	{0x04, CRL_REG_LEN_08BIT, 0x00, 0xE0}, /* YCrCb output */
+	{0x12, CRL_REG_LEN_08BIT, 0xF2, 0xE0}, /* CSC Depends on ip Packets -
+					SDR422 set */
+	{0x17, CRL_REG_LEN_08BIT, 0x80, 0xE0}, /* Luma & Chroma Values Can
+					Reach 254d */
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0}, /* CP-Insert_AV_Code */
+	{0x7C, CRL_REG_LEN_08BIT, 0x00, 0x44}, /* ADI Required Write */
+	{0x0C, CRL_REG_LEN_08BIT, 0xE0, 0xE0}, /* Enable LLC_DLL &
+					Double LLC Timing */
+	{0x0E, CRL_REG_LEN_08BIT, 0xDD, 0xE0}, /* LLC/PIX/SPI PINS TRISTATED
+					AUD Outputs Enabled */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{0x10, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0xA0, 0xE0, 0xA0},
 	 /* Enable 4-lane CSI TXB & Pixel Port */
 	{0x00, CRL_REG_LEN_08BIT, 0x84, 0x94}, /* Enable 4-lane MIPI */
@@ -242,10 +287,17 @@ static struct crl_register_write_rep adv7481_hdmi_mode_1080p[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x5E, 0xE0},
+<<<<<<< HEAD
 	{0x8B, CRL_REG_LEN_08BIT, 0x43, 0x44}, /* shift 44 pixel to right */
 	{0x8C, CRL_REG_LEN_08BIT, 0xD4, 0x44},
 	{0x8B, CRL_REG_LEN_08BIT, 0x4F, 0x44},
 	{0x8D, CRL_REG_LEN_08BIT, 0xD4, 0x44},
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_mode_1080i[] = {
@@ -265,10 +317,17 @@ static struct crl_register_write_rep adv7481_hdmi_mode_1080i[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x54, 0xE0},
+<<<<<<< HEAD
 	{0x8B, CRL_REG_LEN_08BIT, 0x43, 0x44}, /* shift 44 pixel to right */
 	{0x8C, CRL_REG_LEN_08BIT, 0xD4, 0x44},
 	{0x8B, CRL_REG_LEN_08BIT, 0x4F, 0x44},
 	{0x8D, CRL_REG_LEN_08BIT, 0xD4, 0x44},
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_mode_480p[] = {
@@ -288,6 +347,13 @@ static struct crl_register_write_rep adv7481_hdmi_mode_480p[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x4A, 0xE0},
+<<<<<<< HEAD
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_mode_720p[] = {
@@ -307,10 +373,17 @@ static struct crl_register_write_rep adv7481_hdmi_mode_720p[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x53, 0xE0},
+<<<<<<< HEAD
 	{0x8B, CRL_REG_LEN_08BIT, 0x43, 0x44}, /* shift 40 pixel to right */
 	{0x8C, CRL_REG_LEN_08BIT, 0xD8, 0x44},
 	{0x8B, CRL_REG_LEN_08BIT, 0x4F, 0x44},
 	{0x8D, CRL_REG_LEN_08BIT, 0xD8, 0x44},
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_mode_576p[] = {
@@ -330,6 +403,13 @@ static struct crl_register_write_rep adv7481_hdmi_mode_576p[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x4B, 0xE0},
+<<<<<<< HEAD
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_mode_576i[] = {
@@ -349,6 +429,13 @@ static struct crl_register_write_rep adv7481_hdmi_mode_576i[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x41, 0xE0},
+<<<<<<< HEAD
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_mode_480i[] = {
@@ -368,6 +455,13 @@ static struct crl_register_write_rep adv7481_hdmi_mode_480i[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x40, 0xE0},
+<<<<<<< HEAD
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_mode_vga[] = {
@@ -387,6 +481,13 @@ static struct crl_register_write_rep adv7481_hdmi_mode_vga[] = {
 	{0x31, CRL_REG_LEN_08BIT, 0x80, 0x94},
 	{0xC9, CRL_REG_LEN_08BIT, 0x2D, 0x44},
 	{0x05, CRL_REG_LEN_08BIT, 0x88, 0xE0},
+<<<<<<< HEAD
+=======
+	{0x03, CRL_REG_LEN_08BIT, 0x86, 0xE0},
+	{0x00, CRL_REG_LEN_08BIT, 0x00, 0xE0},
+	{0x04, CRL_REG_LEN_08BIT | CRL_REG_READ_AND_UPDATE, 0x80, 0xE0, 0xFD},
+	{0x37, CRL_REG_LEN_08BIT, 0x81, 0x44},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep adv7481_hdmi_powerup_regset[] = {
@@ -728,6 +829,10 @@ static struct crl_mode_rep adv7481_hdmi_modes[] = {
 		.comp_items = 1,
 		.ctrl_data = &hdmi_ctrl_data_lanes[0],
 	},
+<<<<<<< HEAD
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{
 		.sd_rects_items = ARRAY_SIZE(adv7481_hdmi_480i_rects),
 		.sd_rects = adv7481_hdmi_480i_rects,
@@ -741,6 +846,10 @@ static struct crl_mode_rep adv7481_hdmi_modes[] = {
 		.comp_items = 1,
 		.ctrl_data = &hdmi_ctrl_data_lanes[2],
 	},
+<<<<<<< HEAD
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{
 		.sd_rects_items = ARRAY_SIZE(adv7481_hdmi_576p_rects),
 		.sd_rects = adv7481_hdmi_576p_rects,
@@ -809,10 +918,17 @@ static struct crl_csi_data_fmt adv7481_hdmi_crl_csi_data_fmt[] = {
 	},
 	{
 		.code = MEDIA_BUS_FMT_UYVY8_1X16,
+<<<<<<< HEAD
 		.pixel_order = CRL_PIXEL_ORDER_IGNORE,
 		.bits_per_pixel = 16,
 		.regs_items = ARRAY_SIZE(adv7481_hdmi_mode_uyvy),
 		.regs = adv7481_hdmi_mode_uyvy,
+=======
+		.pixel_order = CRL_PIXEL_ORDER_GRBG,
+		.bits_per_pixel = 16,
+		.regs_items = ARRAY_SIZE(adv7481_hdmi_mode_yuv),
+		.regs = adv7481_hdmi_mode_yuv,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.code = MEDIA_BUS_FMT_RGB888_1X24,
@@ -821,6 +937,7 @@ static struct crl_csi_data_fmt adv7481_hdmi_crl_csi_data_fmt[] = {
 		.regs_items = ARRAY_SIZE(adv7481_hdmi_mode_rgb888),
 		.regs = adv7481_hdmi_mode_rgb888,
 	},
+<<<<<<< HEAD
 	{
 		.code = MEDIA_BUS_FMT_YUYV8_1X16,
 		.pixel_order = CRL_PIXEL_ORDER_IGNORE,
@@ -893,6 +1010,8 @@ static struct crl_dep_reg_list adv7481_hdmi_test_pattern_fps_types_regs[] = {
 		{ CRL_DYNAMIC_VAL_OPERAND_TYPE_CONST, 4 },
 		ARRAY_SIZE(adv7481_hdmi_real_mode),
 		adv7481_hdmi_real_mode, 0, 0 },
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_v4l2_ctrl adv7481_hdmi_v4l2_ctrls[] = {
@@ -952,6 +1071,7 @@ static struct crl_v4l2_ctrl adv7481_hdmi_v4l2_ctrls[] = {
 		.flags = 0,
 		.impact = CRL_IMPACTS_NO_IMPACT,
 	},
+<<<<<<< HEAD
 	{
 		.sd_type = CRL_SUBDEV_TYPE_PIXEL_ARRAY,
 		.op_type = CRL_V4L2_CTRL_SET_OP,
@@ -971,6 +1091,8 @@ static struct crl_v4l2_ctrl adv7481_hdmi_v4l2_ctrls[] = {
 		.crl_ctrl_dep_reg_list = ARRAY_SIZE(adv7481_hdmi_test_pattern_fps_types_regs),
 		.dep_regs = adv7481_hdmi_test_pattern_fps_types_regs,
 	},
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 int adv7481_sensor_init(struct i2c_client *);
@@ -1014,7 +1136,11 @@ static struct crl_sensor_configuration adv7481_hdmi_crl_configuration = {
 	.csi_fmts_items = ARRAY_SIZE(adv7481_hdmi_crl_csi_data_fmt),
 	.csi_fmts = adv7481_hdmi_crl_csi_data_fmt,
 
+<<<<<<< HEAD
 	.irq_in_use = false,
+=======
+	.irq_in_use = true,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.crl_irq_fn = NULL,
 	.crl_threaded_irq_fn = crl_adv7481_threaded_irq_fn,
 
diff --git a/drivers/media/i2c/crlmodule/crl_ar0231at_configuration.h b/drivers/media/i2c/crlmodule/crl_ar0231at_configuration.h
index 1905a9e..6bc7f17 100644
--- a/drivers/media/i2c/crlmodule/crl_ar0231at_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ar0231at_configuration.h
@@ -19,8 +19,13 @@
 
 struct crl_pll_configuration ar0231at_pll_configurations[] = {
 	{
+<<<<<<< HEAD
 		.input_clk = 27000000,
 		.op_sys_clk = 87750000,
+=======
+		.input_clk = 24000000,
+		.op_sys_clk = 264000000,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.bitsperpixel = 12,
 		.pixel_rate_csi = 176000000,
 		.pixel_rate_pa = 176000000, /* pixel_rate = op_sys_clk*2 *csi_lanes/bitsperpixel */
@@ -30,6 +35,7 @@ struct crl_pll_configuration ar0231at_pll_configurations[] = {
 		.pll_regs_items = 0,
 		.pll_regs = 0,
 	},
+<<<<<<< HEAD
 	{
 		.input_clk = 27000000,
 		.op_sys_clk = 87750000,
@@ -42,6 +48,8 @@ struct crl_pll_configuration ar0231at_pll_configurations[] = {
 		.pll_regs_items = 0,
 		.pll_regs = 0,
 	},
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct crl_sensor_subdev_config ar0231at_sensor_subdevs[] = {
@@ -55,11 +63,16 @@ struct crl_sensor_subdev_config ar0231at_sensor_subdevs[] = {
 	},
 };
 
+<<<<<<< HEAD
 struct crl_subdev_rect_rep ar0231at_1920_1088_rects[] = {
+=======
+struct crl_subdev_rect_rep ar0231at_1920_1080_rects[] = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{
 		.subdev_type = CRL_SUBDEV_TYPE_PIXEL_ARRAY,
 		.in_rect.left = 0,
 		.in_rect.top = 0,
+<<<<<<< HEAD
 		.in_rect.width = 1920,
 		.in_rect.height = 1088,
 		.out_rect.left = 0,
@@ -1446,6 +1459,31 @@ static struct crl_register_write_rep ar0231at_1920_1088_3hdr_mode[] = {
 static struct crl_register_write_rep ar0231at_1920_1088_4hdr_mode[] = {
 	{ 0x301A, CRL_REG_LEN_16BIT, 0x10D8, 0x10 },
 	{ 0x0000, CRL_REG_LEN_DELAY, 100, 0x10 },
+=======
+		.in_rect.width = 1920,
+		.in_rect.height = 1080,
+		.out_rect.left = 0,
+		.out_rect.top = 0,
+		.out_rect.width = 1920,
+		.out_rect.height = 1080,
+	},
+	{
+		.subdev_type = CRL_SUBDEV_TYPE_BINNER,
+		.in_rect.left = 0,
+		.in_rect.top = 0,
+		.in_rect.width = 1920,
+		.in_rect.height = 1080,
+		.out_rect.left = 0,
+		.out_rect.top = 0,
+		.out_rect.width = 1920,
+		.out_rect.height = 1080,
+	}
+};
+
+static struct crl_register_write_rep ar0231at_1920_1080[] = {
+	{ 0x301A, CRL_REG_LEN_16BIT, 0x1058, 0x10 },
+	{ 0x0000, CRL_REG_LEN_DELAY, 200, 0x10 },
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{ 0x3092, CRL_REG_LEN_16BIT, 0x0C24, 0x10 },
 	{ 0x337A, CRL_REG_LEN_16BIT, 0x0C80, 0x10 },
 	{ 0x3520, CRL_REG_LEN_16BIT, 0x1288, 0x10 },
@@ -1717,6 +1755,7 @@ static struct crl_register_write_rep ar0231at_1920_1088_4hdr_mode[] = {
 	{ 0x30A2, CRL_REG_LEN_16BIT, 0x0001, 0x10 },
 	{ 0x30A6, CRL_REG_LEN_16BIT, 0x0001, 0x10 },
 	{ 0x3040, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
+<<<<<<< HEAD
 	{ 0x3040, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
 	{ 0x3082, CRL_REG_LEN_16BIT, 0x0008, 0x10 },
 	{ 0x3082, CRL_REG_LEN_16BIT, 0x0008, 0x10 },
@@ -1746,6 +1785,12 @@ static struct crl_register_write_rep ar0231at_1920_1088_4hdr_mode[] = {
 	{ 0x33D4, CRL_REG_LEN_16BIT, 0xEB40, 0x10 },
 	{ 0x33D6, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
 	{ 0x33DA, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
+=======
+	{ 0x3082, CRL_REG_LEN_16BIT, 0x0008, 0x10 },
+	{ 0x30BA, CRL_REG_LEN_16BIT, 0x11F2, 0x10 },
+	{ 0x3044, CRL_REG_LEN_16BIT, 0x0400, 0x10 },
+	{ 0x3064, CRL_REG_LEN_16BIT, 0x1802, 0x10 },
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{ 0x33E0, CRL_REG_LEN_16BIT, 0x0C80, 0x10 },
 	{ 0x33E0, CRL_REG_LEN_16BIT, 0x0C80, 0x10 },
 	{ 0x3180, CRL_REG_LEN_16BIT, 0x0080, 0x10 },
@@ -1754,6 +1799,7 @@ static struct crl_register_write_rep ar0231at_1920_1088_4hdr_mode[] = {
 	{ 0x33E0, CRL_REG_LEN_16BIT, 0x0C80, 0x10 },
 	{ 0x3004, CRL_REG_LEN_16BIT, 0x0004, 0x10 },
 	{ 0x3008, CRL_REG_LEN_16BIT, 0x0783, 0x10 },
+<<<<<<< HEAD
 	{ 0x3002, CRL_REG_LEN_16BIT, 0x003C, 0x10 },
 	{ 0x3006, CRL_REG_LEN_16BIT, 0x047B, 0x10 },
 	{ 0x3032, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
@@ -1790,15 +1836,44 @@ static struct crl_register_write_rep ar0231at_1920_1088_4hdr_mode[] = {
 	{ 0x31AE, CRL_REG_LEN_16BIT, 0x0201, 0x10 },
 	{ 0x31AE, CRL_REG_LEN_16BIT, 0x0001, 0x10 },
 	{ 0x31AC, CRL_REG_LEN_16BIT, 0x140C, 0x10 },
+=======
+	{ 0x3002, CRL_REG_LEN_16BIT, 0x0040, 0x10 },
+	{ 0x3006, CRL_REG_LEN_16BIT, 0x0477, 0x10 },
+	{ 0x3032, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
+	{ 0x3400, CRL_REG_LEN_16BIT, 0x0010, 0x10 },
+	{ 0x3402, CRL_REG_LEN_16BIT, 0x0F10, 0x10 },
+	{ 0x3404, CRL_REG_LEN_16BIT, 0x0970, 0x10 },
+	{ 0x3082, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
+	{ 0x30BA, CRL_REG_LEN_16BIT, 0x11F1, 0x10 },
+	{ 0x0000, CRL_REG_LEN_DELAY, 200, 0x10 },
+	{ 0x30BA, CRL_REG_LEN_16BIT, 0x11F0, 0x10 },
+	{ 0x300C, CRL_REG_LEN_16BIT, 0x0872, 0x10 },
+	{ 0x300A, CRL_REG_LEN_16BIT, 0x054A, 0x10 },
+	{ 0x3042, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
+	{ 0x3238, CRL_REG_LEN_16BIT, 0x0222, 0x10 },
+	{ 0x3012, CRL_REG_LEN_16BIT, 0x0163, 0x10 },
+	{ 0x3014, CRL_REG_LEN_16BIT, 0x014F, 0x10 },
+	{ 0x30B0, CRL_REG_LEN_16BIT, 0x0800, 0x10 },
+	{ 0x32EA, CRL_REG_LEN_16BIT, 0x3C08, 0x10 },
+	{ 0x32EC, CRL_REG_LEN_16BIT, 0x72A1, 0x10 },
+	{ 0x31D0, CRL_REG_LEN_16BIT, 0x0000, 0x10 },
+	{ 0x31AE, CRL_REG_LEN_16BIT, 0x0001, 0x10 },
+	{ 0x31AC, CRL_REG_LEN_16BIT, 0x0C0C, 0x10 },
+	/* try sync mode */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{ 0x340A, CRL_REG_LEN_16BIT, 0x0077, 0x10 },
 	{ 0x340C, CRL_REG_LEN_16BIT, 0x0080, 0x10 },
 	{ 0x30CE, CRL_REG_LEN_16BIT, 0x0120, 0x10 },
 	{ 0x301A, CRL_REG_LEN_16BIT, 0x19DC, 0x10 },
+<<<<<<< HEAD
 	{ 0x3370, CRL_REG_LEN_16BIT, 0x0231, 0x10 },
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct crl_mode_rep ar0231at_modes[] = {
 	{
+<<<<<<< HEAD
 		.sd_rects_items = ARRAY_SIZE(ar0231at_1920_1088_rects),
 		.sd_rects = ar0231at_1920_1088_rects,
 		.binn_hor = 1,
@@ -1861,10 +1936,15 @@ struct crl_mode_rep ar0231at_modes[] = {
 	{
 		.sd_rects_items = ARRAY_SIZE(ar0231at_1920_1088_rects),
 		.sd_rects = ar0231at_1920_1088_rects,
+=======
+		.sd_rects_items = ARRAY_SIZE(ar0231at_1920_1080_rects),
+		.sd_rects = ar0231at_1920_1080_rects,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.binn_hor = 1,
 		.binn_vert = 1,
 		.scale_m = 1,
 		.width = 1920,
+<<<<<<< HEAD
 		.height = 1088,
 		.min_llp = 2162,
 		.min_fll = 1354,
@@ -1872,6 +1952,15 @@ struct crl_mode_rep ar0231at_modes[] = {
 		.ctrl_data = &ar0231at_ctrl_data_modes[4],
 		.mode_regs_items = ARRAY_SIZE(ar0231at_1920_1088_10bit_linear_mode),
 		.mode_regs = ar0231at_1920_1088_10bit_linear_mode,
+=======
+		.height = 1080,
+		.min_llp = 2162,
+		.min_fll = 1354,
+		.comp_items = 0,
+		.ctrl_data = 0,
+		.mode_regs_items = ARRAY_SIZE(ar0231at_1920_1080),
+		.mode_regs = ar0231at_1920_1080,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 };
 
@@ -1903,6 +1992,7 @@ struct crl_csi_data_fmt ar0231at_crl_csi_data_fmt[] = {
 		.bits_per_pixel = 12,
 		.regs_items = 0,
 		.regs = 0,
+<<<<<<< HEAD
 	},
 	{
 		.code = MEDIA_BUS_FMT_SGRBG10_1X10,
@@ -2079,6 +2169,10 @@ static const char * const ar0231at_test_patterns[] = {
 	"Disabled",
 	"Solid Color",
 	"100% Vertical Color Bar",
+=======
+	}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct crl_v4l2_ctrl ar0231at_v4l2_ctrls[] = {
@@ -2135,6 +2229,7 @@ struct crl_v4l2_ctrl ar0231at_v4l2_ctrls[] = {
 		.dep_items = 0,
 		.dep_ctrls = 0,
 	},
+<<<<<<< HEAD
 	{
 		.sd_type = CRL_SUBDEV_TYPE_PIXEL_ARRAY,
 		.op_type = CRL_V4L2_CTRL_SET_OP,
@@ -2349,6 +2444,9 @@ struct crl_v4l2_ctrl ar0231at_v4l2_ctrls[] = {
 		.dep_items = 0,
 		.dep_ctrls = 0,
 	},
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct crl_sensor_detect_config ar0231at_sensor_detect_regset[] = {
@@ -2362,7 +2460,11 @@ static struct crl_sensor_limits ar0231at_maxim_sensor_limits = {
 	.x_addr_min = 0,
 	.y_addr_min = 0,
 	.x_addr_max = 1920,
+<<<<<<< HEAD
 	.y_addr_max = 1088,
+=======
+	.y_addr_max = 1080,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.min_frame_length_lines = 240,
 	.max_frame_length_lines = 65535,
 	.min_line_length_pixels = 320,
diff --git a/drivers/media/i2c/crlmodule/crl_imx132_configuration.h b/drivers/media/i2c/crlmodule/crl_imx132_configuration.h
index 128ccb5..149c84f 100644
--- a/drivers/media/i2c/crlmodule/crl_imx132_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx132_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation */
 
 #ifndef __CRLMODULE_IMX132_CONFIGURATION_H_
diff --git a/drivers/media/i2c/crlmodule/crl_imx135_configuration.h b/drivers/media/i2c/crlmodule/crl_imx135_configuration.h
index 82efac8..87ba06b 100644
--- a/drivers/media/i2c/crlmodule/crl_imx135_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx135_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation */
 
 #ifndef __CRLMODULE_IMX135_CONFIGURATION_H_
diff --git a/drivers/media/i2c/crlmodule/crl_imx185_configuration.h b/drivers/media/i2c/crlmodule/crl_imx185_configuration.h
index 168455b..935d85f 100644
--- a/drivers/media/i2c/crlmodule/crl_imx185_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx185_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Shuguang Gong <shuguang.gong@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_imx214_configuration.h b/drivers/media/i2c/crlmodule/crl_imx214_configuration.h
index 8dc536f..9fae952 100644
--- a/drivers/media/i2c/crlmodule/crl_imx214_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx214_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_imx230_configuration.h b/drivers/media/i2c/crlmodule/crl_imx230_configuration.h
index c19afad..d3fc6ea 100644
--- a/drivers/media/i2c/crlmodule/crl_imx230_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx230_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_imx274_configuration.h b/drivers/media/i2c/crlmodule/crl_imx274_configuration.h
index 6ec84fb..5d13ef2 100644
--- a/drivers/media/i2c/crlmodule/crl_imx274_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx274_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation
  *
  * Author: Yuning Pu <yuning.pu@intel.com>
@@ -1080,7 +1084,11 @@ static struct crl_v4l2_ctrl imx274_v4l2_ctrls[] = {
 		.ctrl_id = V4L2_CID_EXPOSURE,
 		.name = "V4L2_CID_EXPOSURE",
 		.type = CRL_V4L2_CTRL_TYPE_INTEGER,
+<<<<<<< HEAD
 		.data.std_data.min = 4,
+=======
+		.data.std_data.min = 8,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.data.std_data.max = IMX274_MAX_SHS2,
 		.data.std_data.step = 1,
 		.data.std_data.def = 0x400,
diff --git a/drivers/media/i2c/crlmodule/crl_imx290_configuration.h b/drivers/media/i2c/crlmodule/crl_imx290_configuration.h
index 6a3561b..652fcf3 100644
--- a/drivers/media/i2c/crlmodule/crl_imx290_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx290_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Yuning Pu <yuning.pu@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_imx318_configuration.h b/drivers/media/i2c/crlmodule/crl_imx318_configuration.h
index 631a6d1..a9958d4 100644
--- a/drivers/media/i2c/crlmodule/crl_imx318_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx318_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation
  *
  * Author: Jouni Ukkonen <jouni.ukkonen@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_imx477_common_regs.h b/drivers/media/i2c/crlmodule/crl_imx477_common_regs.h
index eebb884..b5809a5 100644
--- a/drivers/media/i2c/crlmodule/crl_imx477_common_regs.h
+++ b/drivers/media/i2c/crlmodule/crl_imx477_common_regs.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Alexei Zavjalov <alexei.zavjalov@intel.com>
@@ -10,7 +14,11 @@
 
 #include "crlmodule-sensor-ds.h"
 
+<<<<<<< HEAD
 #define IMX477_CAPTURE_MODE_MAX	10
+=======
+#define IMX477_CAPTURE_MODE_MAX	3
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static struct crl_dynamic_register_access imx477_fll_regs[] = {
 	{
@@ -759,6 +767,7 @@ static struct crl_subdev_rect_rep imx477_4056_3040_rects[] = {
 	}
 };
 
+<<<<<<< HEAD
 static struct crl_subdev_rect_rep imx477_4056_2288_rects[] = {
 	{
 		.subdev_type = CRL_SUBDEV_TYPE_PIXEL_ARRAY,
@@ -884,6 +893,8 @@ static struct crl_subdev_rect_rep imx477_656_512_rects[] = {
 	}
 };
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static struct crl_register_write_rep imx477_pll_1200mbps[] = {
 	/* MIPI Settings */
 	{0x0114, CRL_REG_LEN_08BIT, 0x01}, /* 2-lane Mode */
diff --git a/drivers/media/i2c/crlmodule/crl_imx477_master_configuration.h b/drivers/media/i2c/crlmodule/crl_imx477_master_configuration.h
index 10be93b..2f1f389a 100644
--- a/drivers/media/i2c/crlmodule/crl_imx477_master_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx477_master_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Alexei Zavjalov <alexei.zavjalov@intel.com>
@@ -573,6 +577,7 @@ static struct crl_register_write_rep imx477_4056_3040_19MHZ_DOL_3f_master[] = {
 	{0x034F, CRL_REG_LEN_08BIT, 0xE0}, /* Y output size [7:0]  */
 };
 
+<<<<<<< HEAD
 static struct crl_register_write_rep imx477_4056_2288_19MHZ_master[] = {
 	/* Frame Horizontal Clock Count */
 	{0x0342, CRL_REG_LEN_08BIT, 0x39}, /* Line length [15:8]  */
@@ -1152,6 +1157,8 @@ static struct crl_register_write_rep imx477_4056_2288_19MHZ_DOL_3f_master[] = {
 	{0x034F, CRL_REG_LEN_08BIT, 0xF0}, /* Y output size [7:0]  */
 };
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static struct crl_mode_rep imx477_modes_master[] = {
 	{
 		.sd_rects_items = ARRAY_SIZE(imx477_4056_3040_rects),
@@ -1198,6 +1205,7 @@ static struct crl_mode_rep imx477_modes_master[] = {
 		.mode_regs_items = ARRAY_SIZE(imx477_4056_3040_19MHZ_DOL_3f_master),
 		.mode_regs = imx477_4056_3040_19MHZ_DOL_3f_master,
 	},
+<<<<<<< HEAD
 	{
 		.sd_rects_items = ARRAY_SIZE(imx477_4056_2288_rects),
 		.sd_rects = imx477_4056_2288_rects,
@@ -1303,6 +1311,8 @@ static struct crl_mode_rep imx477_modes_master[] = {
 		.mode_regs_items = ARRAY_SIZE(imx477_4056_2288_19MHZ_DOL_3f_master),
 		.mode_regs = imx477_4056_2288_19MHZ_DOL_3f_master,
 	},
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_flip_data imx477_flip_configurations_master[] = {
diff --git a/drivers/media/i2c/crlmodule/crl_imx477_slave_configuration.h b/drivers/media/i2c/crlmodule/crl_imx477_slave_configuration.h
index b8dc15c..cc87a0f 100644
--- a/drivers/media/i2c/crlmodule/crl_imx477_slave_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_imx477_slave_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Alexei Zavjalov <alexei.zavjalov@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_magna_configuration.h b/drivers/media/i2c/crlmodule/crl_magna_configuration.h
index cd1e316..6a9b150 100644
--- a/drivers/media/i2c/crlmodule/crl_magna_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_magna_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Kishore Bodke <kishore.k.bodke@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_ov10635_configuration.h b/drivers/media/i2c/crlmodule/crl_ov10635_configuration.h
index 0f81f7d..ca3f24d 100644
--- a/drivers/media/i2c/crlmodule/crl_ov10635_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov10635_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation
  *
  * Author: Yunliang Ding <yunliang.ding@intel.com>
@@ -1906,6 +1910,7 @@ static struct crl_register_write_rep ov10635_1280_800_YUV_HDR[] = {
 	{0xceb3, CRL_REG_LEN_08BIT, 0x00},
 	{0xceb4, CRL_REG_LEN_08BIT, 0x00},
 	{0xceb5, CRL_REG_LEN_08BIT, 0x00},
+<<<<<<< HEAD
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
 	{0xceb6, CRL_REG_LEN_08BIT, 0x00},
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
@@ -1915,6 +1920,12 @@ static struct crl_register_write_rep ov10635_1280_800_YUV_HDR[] = {
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
 	{0xc4bd, CRL_REG_LEN_08BIT, 0x60},
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
+=======
+	{0xceb6, CRL_REG_LEN_08BIT, 0x00},
+	{0xceb7, CRL_REG_LEN_08BIT, 0x00},
+	{0xc4bc, CRL_REG_LEN_08BIT, 0x01},
+	{0xc4bd, CRL_REG_LEN_08BIT, 0x60},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep ov10635_1280_720_YUV_HDR_BT656[] = {
@@ -3952,6 +3963,7 @@ static struct crl_register_write_rep ov10635_1280_720_YUV_HDR_BT656[] = {
 	{0xceb3, CRL_REG_LEN_08BIT, 0x00},
 	{0xceb4, CRL_REG_LEN_08BIT, 0x00},
 	{0xceb5, CRL_REG_LEN_08BIT, 0x00},
+<<<<<<< HEAD
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
 	{0xceb6, CRL_REG_LEN_08BIT, 0x00},
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
@@ -3969,6 +3981,16 @@ static struct crl_register_write_rep ov10635_1280_720_YUV_HDR_BT656[] = {
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
 	{0x5608, CRL_REG_LEN_08BIT, 0x0d},
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
+=======
+	{0xceb6, CRL_REG_LEN_08BIT, 0x00},
+	{0xceb7, CRL_REG_LEN_08BIT, 0x00},
+	{0xc4bc, CRL_REG_LEN_08BIT, 0x01},
+	{0xc4bd, CRL_REG_LEN_08BIT, 0x60},
+	{0xc4a0, CRL_REG_LEN_08BIT, 0x03},
+	{0xc4a2, CRL_REG_LEN_08BIT, 0x04},
+	{0x3011, CRL_REG_LEN_08BIT, 0x42},
+	{0x5608, CRL_REG_LEN_08BIT, 0x0d},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_register_write_rep ov10635_640_480_YUV_HDR[] = {
@@ -5926,6 +5948,7 @@ static struct crl_register_write_rep ov10635_640_480_YUV_HDR[] = {
 	{0xceb3, CRL_REG_LEN_08BIT, 0x00},
 	{0xceb4, CRL_REG_LEN_08BIT, 0x00},
 	{0xceb5, CRL_REG_LEN_08BIT, 0x00},
+<<<<<<< HEAD
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
 	{0xceb6, CRL_REG_LEN_08BIT, 0x00},
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
@@ -5935,6 +5958,12 @@ static struct crl_register_write_rep ov10635_640_480_YUV_HDR[] = {
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
 	{0xc4bd, CRL_REG_LEN_08BIT, 0x60},
 	{0x0000, CRL_REG_LEN_DELAY, 0x0c},
+=======
+	{0xceb6, CRL_REG_LEN_08BIT, 0x00},
+	{0xceb7, CRL_REG_LEN_08BIT, 0x00},
+	{0xc4bc, CRL_REG_LEN_08BIT, 0x01},
+	{0xc4bd, CRL_REG_LEN_08BIT, 0x60},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_dynamic_register_access ov10635_h_flip_regs[] = {
@@ -6117,8 +6146,13 @@ static struct crl_register_write_rep ov10635_poweroff_regs[] = {
 static struct crl_power_seq_entity ov10635_power_items[] = {
 	{
 		.type = CRL_POWER_ETY_GPIO_FROM_PDATA,
+<<<<<<< HEAD
 		.val = 1,
 		.undo_val = 0,
+=======
+		.val = 0,
+		.undo_val = 1,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 };
 
diff --git a/drivers/media/i2c/crlmodule/crl_ov10640_configuration.h b/drivers/media/i2c/crlmodule/crl_ov10640_configuration.h
index ab8378b..4c69b9e 100644
--- a/drivers/media/i2c/crlmodule/crl_ov10640_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov10640_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Shuguang Gong <shuguang.gong@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_ov13858_configuration.h b/drivers/media/i2c/crlmodule/crl_ov13858_configuration.h
index 7a98ce7..d6d069ae 100755
--- a/drivers/media/i2c/crlmodule/crl_ov13858_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov13858_configuration.h
@@ -837,7 +837,11 @@ struct crl_register_read_rep ov13858_sensor_otp_read_regset[] = {
 };
 #endif
 
+<<<<<<< HEAD
 #if 0
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static struct crl_arithmetic_ops ov13858_frame_desc_width_ops[] = {
 	{
 	 .op = CRL_ASSIGNMENT,
@@ -875,7 +879,10 @@ static struct crl_frame_desc ov13858_frame_desc[] = {
 		.csi2_data_type.entity_val = 0x12,
 	},
 };
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* Power items, they are enabled in the order they are listed here */
 static struct crl_power_seq_entity ov13858_power_items[] = {
diff --git a/drivers/media/i2c/crlmodule/crl_ov13860_configuration.h b/drivers/media/i2c/crlmodule/crl_ov13860_configuration.h
index 4f8e7c6..a709f15 100644
--- a/drivers/media/i2c/crlmodule/crl_ov13860_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov13860_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  *
  * Author: Kamal Ramamoorthy <kamalanathan.ramamoorthy@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_ov2740_configuration.h b/drivers/media/i2c/crlmodule/crl_ov2740_configuration.h
index f6c56f3..7792de9 100755
--- a/drivers/media/i2c/crlmodule/crl_ov2740_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov2740_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Roy Yang <royx.yang@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_ov5670_configuration.h b/drivers/media/i2c/crlmodule/crl_ov5670_configuration.h
index 7badb60..dc9aeb4 100644
--- a/drivers/media/i2c/crlmodule/crl_ov5670_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov5670_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation
  *
  * Author: Tommi Franttila <tommi.franttila@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_ov8858_configuration.h b/drivers/media/i2c/crlmodule/crl_ov8858_configuration.h
index 63faedc..f5262ab 100644
--- a/drivers/media/i2c/crlmodule/crl_ov8858_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov8858_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_ov9281_configuration.h b/drivers/media/i2c/crlmodule/crl_ov9281_configuration.h
index b052d30..1ae9dc2 100644
--- a/drivers/media/i2c/crlmodule/crl_ov9281_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_ov9281_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2018 Intel Corporation
  *
  * Author: Wu Xia <xia.wu@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crl_pixter_stub_configuration.h b/drivers/media/i2c/crlmodule/crl_pixter_stub_configuration.h
index e6ffbb2..c666bfa 100644
--- a/drivers/media/i2c/crlmodule/crl_pixter_stub_configuration.h
+++ b/drivers/media/i2c/crlmodule/crl_pixter_stub_configuration.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation
  *
  * Author: Wang, Zaikuo <zaikuo.wang@intel.com>
@@ -33,6 +37,7 @@ static struct crl_pll_configuration pixter_stub_pll_configurations[] = {
 		.pll_regs_items = 0,
 		.pll_regs = NULL,
 	},
+<<<<<<< HEAD
 	{
 		.input_clk = 24000000,
 		.op_sys_clk = 400000000,
@@ -44,6 +49,8 @@ static struct crl_pll_configuration pixter_stub_pll_configurations[] = {
 		.pll_regs_items = 0,
 		.pll_regs = NULL,
 	},
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct crl_subdev_rect_rep pixter_stub_720p_rects[] = {
@@ -279,6 +286,7 @@ static struct crl_sensor_subdev_config pixter_stub_b_sensor_subdevs[] = {
 	},
 };
 
+<<<<<<< HEAD
 static struct crl_sensor_subdev_config pixter_stub_c_sensor_subdevs[] = {
 	{
 		.subdev_type = CRL_SUBDEV_TYPE_SCALER,
@@ -345,6 +353,8 @@ static struct crl_sensor_subdev_config pixter_stub_h_sensor_subdevs[] = {
 	},
 };
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static struct crl_sensor_limits pixter_stub_sensor_limits = {
 	.x_addr_min = 0,
 	.y_addr_min = 0,
@@ -493,7 +503,11 @@ static struct crl_v4l2_ctrl pixter_stub_v4l2_ctrls[] = {
 		.name = "V4L2_CID_PIXEL_RATE_PA",
 		.type = CRL_V4L2_CTRL_TYPE_INTEGER,
 		.data.std_data.min = 0,
+<<<<<<< HEAD
 		.data.std_data.max = 800000000,
+=======
+		.data.std_data.max = 0,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.data.std_data.step = 1,
 		.data.std_data.def = 0,
 		.flags = 0,
@@ -512,7 +526,11 @@ static struct crl_v4l2_ctrl pixter_stub_v4l2_ctrls[] = {
 		.name = "V4L2_CID_PIXEL_RATE_CSI",
 		.type = CRL_V4L2_CTRL_TYPE_INTEGER,
 		.data.std_data.min = 0,
+<<<<<<< HEAD
 		.data.std_data.max = 800000000,
+=======
+		.data.std_data.max = 0,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.data.std_data.step = 1,
 		.data.std_data.def = 0,
 		.flags = 0,
@@ -660,6 +678,7 @@ static struct crl_v4l2_ctrl pixter_stub_v4l2_ctrls[] = {
 	},
 };
 
+<<<<<<< HEAD
 #define DEFINE_PIXTER_CRL_CONFIGURATION(port) \
 static struct crl_sensor_configuration pixter_##port##_crl_configuration = { \
 	.powerup_regs_items = 0, \
@@ -706,5 +725,80 @@ DEFINE_PIXTER_CRL_CONFIGURATION(stub_f);
 DEFINE_PIXTER_CRL_CONFIGURATION(stub_g);
 DEFINE_PIXTER_CRL_CONFIGURATION(stub_h);
 
+=======
+static struct crl_sensor_configuration pixter_stub_crl_configuration = {
+	.powerup_regs_items = 0,
+	.powerup_regs = NULL,
+
+	.poweroff_regs_items = 0,
+	.poweroff_regs = NULL,
+
+	.id_reg_items = 0,
+	.id_regs = NULL,
+
+	.subdev_items = ARRAY_SIZE(pixter_stub_sensor_subdevs),
+	.subdevs = pixter_stub_sensor_subdevs,
+
+	.sensor_limits = &pixter_stub_sensor_limits,
+
+	.pll_config_items = ARRAY_SIZE(pixter_stub_pll_configurations),
+	.pll_configs = pixter_stub_pll_configurations,
+
+	.modes_items = ARRAY_SIZE(pixter_stub_modes),
+	.modes = pixter_stub_modes,
+
+	.streamon_regs_items = 0,
+	.streamon_regs = NULL,
+
+	.streamoff_regs_items = 0,
+	.streamoff_regs = NULL,
+
+	.v4l2_ctrls_items = ARRAY_SIZE(pixter_stub_v4l2_ctrls),
+	.v4l2_ctrl_bank = pixter_stub_v4l2_ctrls,
+
+	.flip_items = ARRAY_SIZE(pixter_stub_flip_configurations),
+	.flip_data = pixter_stub_flip_configurations,
+
+	.csi_fmts_items = ARRAY_SIZE(pixter_stub_crl_csi_data_fmt),
+	.csi_fmts = pixter_stub_crl_csi_data_fmt,
+};
+
+static struct crl_sensor_configuration pixter_stub_b_crl_configuration = {
+	.powerup_regs_items = 0,
+	.powerup_regs = NULL,
+
+	.poweroff_regs_items = 0,
+	.poweroff_regs = NULL,
+
+	.id_reg_items = 0,
+	.id_regs = NULL,
+
+	.subdev_items = ARRAY_SIZE(pixter_stub_b_sensor_subdevs),
+	.subdevs = pixter_stub_b_sensor_subdevs,
+
+	.sensor_limits = &pixter_stub_sensor_limits,
+
+	.pll_config_items = ARRAY_SIZE(pixter_stub_pll_configurations),
+	.pll_configs = pixter_stub_pll_configurations,
+
+	.modes_items = ARRAY_SIZE(pixter_stub_modes),
+	.modes = pixter_stub_modes,
+
+	.streamon_regs_items = 0,
+	.streamon_regs = NULL,
+
+	.streamoff_regs_items = 0,
+	.streamoff_regs = NULL,
+
+	.v4l2_ctrls_items = ARRAY_SIZE(pixter_stub_v4l2_ctrls),
+	.v4l2_ctrl_bank = pixter_stub_v4l2_ctrls,
+
+	.flip_items = ARRAY_SIZE(pixter_stub_flip_configurations),
+	.flip_data = pixter_stub_flip_configurations,
+
+	.csi_fmts_items = ARRAY_SIZE(pixter_stub_crl_csi_data_fmt),
+	.csi_fmts = pixter_stub_crl_csi_data_fmt,
+};
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #endif  /* __CRLMODULE_PIXTER_STUB_CONFIGURATION_H_ */
diff --git a/drivers/media/i2c/crlmodule/crlmodule-core.c b/drivers/media/i2c/crlmodule/crlmodule-core.c
index ac18120..e49e7c8 100755
--- a/drivers/media/i2c/crlmodule/crlmodule-core.c
+++ b/drivers/media/i2c/crlmodule/crlmodule-core.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
@@ -2443,10 +2447,13 @@ static int crlmodule_set_routing(struct v4l2_subdev *subdev,
 		    t->sink_pad != CRL_PAD_SINK)
 			continue;
 
+<<<<<<< HEAD
 		if (sensor->src->route_flags[t->source_stream] &
 			V4L2_SUBDEV_ROUTE_FL_IMMUTABLE)
 			continue;
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		if (t->flags & V4L2_SUBDEV_ROUTE_FL_ACTIVE)
 			sensor->src->route_flags[t->source_stream] |=
 				V4L2_SUBDEV_ROUTE_FL_ACTIVE;
@@ -2753,7 +2760,10 @@ static const struct media_entity_operations crlmodule_entity_ops;
 static int crlmodule_init_subdevs(struct v4l2_subdev *subdev)
 {
 	struct crl_sensor *sensor = to_crlmodule_sensor(subdev);
+<<<<<<< HEAD
 	struct crlmodule_platform_data *platform_data = sensor->platform_data;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct i2c_client *client = v4l2_get_subdevdata(&sensor->src->sd);
 	struct crl_subdev *prev_sd = NULL;
 	int i = 0, j;
@@ -2823,6 +2833,7 @@ static int crlmodule_init_subdevs(struct v4l2_subdev *subdev)
 			sd->source_pad = 1;
 		}
 
+<<<<<<< HEAD
 		if (platform_data->suffix)
 			snprintf(sd->sd.name,
 				 sizeof(sd->sd.name), "%s %c",
@@ -2835,6 +2846,12 @@ static int crlmodule_init_subdevs(struct v4l2_subdev *subdev)
 				 i2c_adapter_id(client->adapter),
 				 client->addr);
 
+=======
+		snprintf(sd->sd.name,
+			 sizeof(sd->sd.name), "%s %d-%4.4x",
+			 sensor->sensor_ds->subdevs[i].name,
+			 i2c_adapter_id(client->adapter), client->addr);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 		sd->sink_fmt.width =
 			sensor->sensor_ds->sensor_limits->x_addr_max;
@@ -2862,8 +2879,12 @@ static int crlmodule_init_subdevs(struct v4l2_subdev *subdev)
 				sd->route_flags[j] =
 					V4L2_SUBDEV_ROUTE_FL_SOURCE;
 			sd->route_flags[0] |=
+<<<<<<< HEAD
 					V4L2_SUBDEV_ROUTE_FL_ACTIVE |
 					V4L2_SUBDEV_ROUTE_FL_IMMUTABLE;
+=======
+					V4L2_SUBDEV_ROUTE_FL_ACTIVE;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		}
 
 		sd->sd.entity.ops = &crlmodule_entity_ops;
diff --git a/drivers/media/i2c/crlmodule/crlmodule-data.c b/drivers/media/i2c/crlmodule/crlmodule-data.c
index 8a526be..f227bad8 100755
--- a/drivers/media/i2c/crlmodule/crlmodule-data.c
+++ b/drivers/media/i2c/crlmodule/crlmodule-data.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
@@ -31,10 +35,13 @@
 #include "crl_ov9281_configuration.h"
 #include "crl_magna_configuration.h"
 #include "crl_ar023z_configuration.h"
+<<<<<<< HEAD
 #include "crl_ov2775_configuration.h"
 #include "crl_ox03a10_configuration.h"
 #include "crl_ox03a10_ficosa_configuration.h"
 #include "crl_ov495_configuration.h"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static const struct crlmodule_sensors supported_sensors[] = {
 	{ "i2c-OVTIF858:00", "ov13858", &ov13858_crl_configuration},
@@ -42,7 +49,10 @@ static const struct crlmodule_sensors supported_sensors[] = {
 	{ "OV13858-2", "ov13858", &ov13858_crl_configuration},
 	{ "i2c-INT3474:00", "ov2740", &ov2740_crl_configuration },
 	{ "OV2740", "ov2740", &ov2740_crl_configuration },
+<<<<<<< HEAD
 	{ "OV2740-2", "ov2740", &ov2740_crl_configuration },
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{ "i2c-SONY214A:00", "imx214", &imx214_crl_configuration },
 	{ "IMX214", "imx214", &imx214_crl_configuration },
 	{ "i2c-SONY132A:00", "imx132", &imx132_crl_configuration },
@@ -59,8 +69,11 @@ static const struct crlmodule_sensors supported_sensors[] = {
 	{ "ADV7481 HDMI", "adv7481_hdmi", &adv7481_hdmi_crl_configuration },
 	{ "ADV7481_EVAL", "adv7481_eval", &adv7481_eval_crl_configuration },
 	{ "ADV7481B_EVAL", "adv7481b_eval", &adv7481b_eval_crl_configuration },
+<<<<<<< HEAD
 	{ "i2c-ADV7481A:00", "adv7481_hdmi", &adv7481_hdmi_crl_configuration },
 	{ "i2c-ADV7481B:00", "adv7481_cvbs", &adv7481_cvbs_crl_configuration },
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{ "SONY318A", "imx318", &imx318_crl_configuration },
 	{ "OV10635", "ov10635", &ov10635_crl_configuration },
 	{ "AR0231AT", "ar0231at", &ar0231at_crl_configuration },
@@ -70,6 +83,7 @@ static const struct crlmodule_sensors supported_sensors[] = {
 	{ "IMX290", "imx290", &imx290_crl_configuration},
 	{ "PIXTER_STUB", "pixter_stub", &pixter_stub_crl_configuration},
 	{ "PIXTER_STUB_B", "pixter_stub_b", &pixter_stub_b_crl_configuration},
+<<<<<<< HEAD
 	{ "PIXTER_STUB_C", "pixter_stub_c", &pixter_stub_c_crl_configuration},
 	{ "PIXTER_STUB_D", "pixter_stub_d", &pixter_stub_d_crl_configuration},
 	{ "PIXTER_STUB_E", "pixter_stub_e", &pixter_stub_e_crl_configuration},
@@ -84,6 +98,11 @@ static const struct crlmodule_sensors supported_sensors[] = {
 	{ "OX03A10", "ox03a10", &ox03a10_crl_configuration },
 	{ "OX03A10_FICOSA", "ox03a10_ficosa", &ox03a10_ficosa_crl_configuration },
 	{ "OV495", "ov495", &ov495_crl_configuration},
+=======
+	{ "INT3474", "ov2740", &ov2740_crl_configuration },
+	{ "MAGNA", "magna", &magna_crl_configuration },
+	{ "AR023Z", "ar023z", &ar023z_crl_configuration },
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 /*
diff --git a/drivers/media/i2c/crlmodule/crlmodule-msrlist.c b/drivers/media/i2c/crlmodule/crlmodule-msrlist.c
index a15b76b..599e728 100644
--- a/drivers/media/i2c/crlmodule/crlmodule-msrlist.c
+++ b/drivers/media/i2c/crlmodule/crlmodule-msrlist.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2016 - 2018 Intel Corporation
 
 #include <linux/i2c.h>
diff --git a/drivers/media/i2c/crlmodule/crlmodule-msrlist.h b/drivers/media/i2c/crlmodule/crlmodule-msrlist.h
index 013469b..a82a2b4 100644
--- a/drivers/media/i2c/crlmodule/crlmodule-msrlist.h
+++ b/drivers/media/i2c/crlmodule/crlmodule-msrlist.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef __CRLMODULE_MSRLIST_H__
diff --git a/drivers/media/i2c/crlmodule/crlmodule-nvm.c b/drivers/media/i2c/crlmodule/crlmodule-nvm.c
index 691027b6..16898d6 100755
--- a/drivers/media/i2c/crlmodule/crlmodule-nvm.c
+++ b/drivers/media/i2c/crlmodule/crlmodule-nvm.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation
  *
  * Author: Tommi Franttila <tommi.franttila@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crlmodule-nvm.h b/drivers/media/i2c/crlmodule/crlmodule-nvm.h
index 42d462d..ee6884f 100644
--- a/drivers/media/i2c/crlmodule/crlmodule-nvm.h
+++ b/drivers/media/i2c/crlmodule/crlmodule-nvm.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  *
  * Author: Tommi Franttila <tommi.franttila@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crlmodule-regs.c b/drivers/media/i2c/crlmodule/crlmodule-regs.c
index e4b8c8a..ea84eff 100644
--- a/drivers/media/i2c/crlmodule/crlmodule-regs.c
+++ b/drivers/media/i2c/crlmodule/crlmodule-regs.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crlmodule-regs.h b/drivers/media/i2c/crlmodule/crlmodule-regs.h
index 6d84486..f04722f 100644
--- a/drivers/media/i2c/crlmodule/crlmodule-regs.h
+++ b/drivers/media/i2c/crlmodule/crlmodule-regs.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crlmodule-sensor-ds.h b/drivers/media/i2c/crlmodule/crlmodule-sensor-ds.h
index ff03185..ba15121 100644
--- a/drivers/media/i2c/crlmodule/crlmodule-sensor-ds.h
+++ b/drivers/media/i2c/crlmodule/crlmodule-sensor-ds.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
diff --git a/drivers/media/i2c/crlmodule/crlmodule.h b/drivers/media/i2c/crlmodule/crlmodule.h
index e68e82f..02d2a05 100644
--- a/drivers/media/i2c/crlmodule/crlmodule.h
+++ b/drivers/media/i2c/crlmodule/crlmodule.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Author: Vinod Govindapillai <vinod.govindapillai@intel.com>
diff --git a/drivers/media/i2c/dw9714.c b/drivers/media/i2c/dw9714.c
index 384b48d..ad0a30b 100644
--- a/drivers/media/i2c/dw9714.c
+++ b/drivers/media/i2c/dw9714.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  *
  * Based on ATOMISP dw9714 implementation by
@@ -323,8 +327,13 @@ static int dw9714_runtime_resume(struct device *dev)
 
 #else
 
+<<<<<<< HEAD
 #define dw9714_runtime_suspend	NULL
 #define dw9714_runtime_resume	NULL
+=======
+#define dw9714_suspend	NULL
+#define dw9714_resume	NULL
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #endif /* CONFIG_PM */
 
diff --git a/drivers/media/i2c/imx319.c b/drivers/media/i2c/imx319.c
index 9fee398..61095db 100644
--- a/drivers/media/i2c/imx319.c
+++ b/drivers/media/i2c/imx319.c
@@ -1,14 +1,30 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
 // Copyright (C) 2018 Intel Corporation
 
 #include <asm/unaligned.h>
+=======
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2018 Intel Corporation
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <linux/acpi.h>
 #include <linux/i2c.h>
 #include <linux/module.h>
 #include <linux/pm_runtime.h>
 #include <media/v4l2-ctrls.h>
 #include <media/v4l2-device.h>
+<<<<<<< HEAD
 #include <media/v4l2-event.h>
+=======
+
+#ifndef V4L2_CID_DIGITAL_GAIN
+#define V4L2_CID_DIGITAL_GAIN V4L2_CID_GAIN
+#endif
+
+#define IMX319_REG_VALUE_08BIT		1
+#define IMX319_REG_VALUE_16BIT		2
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define IMX319_REG_MODE_SELECT		0x0100
 #define IMX319_MODE_STANDBY		0x00
@@ -36,6 +52,7 @@
 #define IMX319_ANA_GAIN_DEFAULT		0
 
 /* Digital gain control */
+<<<<<<< HEAD
 #define IMX319_REG_DPGA_USE_GLOBAL_GAIN	0x3ff9
 #define IMX319_REG_DIG_GAIN_GLOBAL	0x020e
 #define IMX319_DGTL_GAIN_MIN		256
@@ -50,10 +67,26 @@
 #define IMX319_TEST_PATTERN_COLOR_BARS		2
 #define IMX319_TEST_PATTERN_GRAY_COLOR_BARS	3
 #define IMX319_TEST_PATTERN_PN9			4
+=======
+#define IMX319_REG_DIGITAL_GAIN		0x020e
+#define IMX319_DGTL_GAIN_MIN		0x100
+#define IMX319_DGTL_GAIN_MAX		0xfff
+#define IMX319_DGTL_GAIN_DEFAULT	0x100
+#define IMX319_DGTL_GAIN_STEP		1
+
+/* Test Pattern Control */
+#define IMX319_REG_TEST_PATTERN		0x0600
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* Flip Control */
 #define IMX319_REG_ORIENTATION		0x0101
 
+<<<<<<< HEAD
+=======
+/* Number of frames to skip */
+#define IMX319_NUM_OF_SKIP_FRAMES	0
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 struct imx319_reg {
 	u16 address;
 	u8 val;
@@ -82,6 +115,7 @@ struct imx319_mode {
 	struct imx319_reg_list reg_list;
 };
 
+<<<<<<< HEAD
 struct imx319 {
 	struct v4l2_subdev sd;
 	struct media_pad pad;
@@ -215,6 +249,113 @@ static const struct imx319_reg imx319_global_regs[] = {
 	{ 0xf2d5, 0x05 },
 	{ 0xf2d7, 0x03 },
 	{ 0xf2d9, 0x02 },
+=======
+static const struct imx319_reg imx319_global_regs[] = {
+	{0x0136, 0x13},
+	{0x0137, 0x33},
+	{0x3c7e, 0x03},
+	{0x3c7f, 0x07},
+	{0x4d39, 0x0b},
+	{0x4d41, 0x33},
+	{0x4d43, 0x0c},
+	{0x4d49, 0x89},
+	{0x4e05, 0x0b},
+	{0x4e0d, 0x33},
+	{0x4e0f, 0x0c},
+	{0x4e15, 0x89},
+	{0x4e49, 0x2a},
+	{0x4e51, 0x33},
+	{0x4e53, 0x0c},
+	{0x4e59, 0x89},
+	{0x5601, 0x4f},
+	{0x560b, 0x45},
+	{0x562f, 0x0a},
+	{0x5643, 0x0a},
+	{0x5645, 0x0c},
+	{0x56ef, 0x51},
+	{0x586f, 0x33},
+	{0x5873, 0x89},
+	{0x5905, 0x33},
+	{0x5907, 0x89},
+	{0x590d, 0x33},
+	{0x590f, 0x89},
+	{0x5915, 0x33},
+	{0x5917, 0x89},
+	{0x5969, 0x1c},
+	{0x596b, 0x72},
+	{0x5971, 0x33},
+	{0x5973, 0x89},
+	{0x5975, 0x33},
+	{0x5977, 0x89},
+	{0x5979, 0x1c},
+	{0x597b, 0x72},
+	{0x5985, 0x33},
+	{0x5987, 0x89},
+	{0x5999, 0x1c},
+	{0x599b, 0x72},
+	{0x59a5, 0x33},
+	{0x59a7, 0x89},
+	{0x7485, 0x08},
+	{0x7487, 0x0c},
+	{0x7489, 0xc7},
+	{0x748b, 0x8b},
+	{0x9004, 0x09},
+	{0x9200, 0x6a},
+	{0x9201, 0x22},
+	{0x9202, 0x6a},
+	{0x9203, 0x23},
+	{0x9204, 0x5f},
+	{0x9205, 0x23},
+	{0x9206, 0x5f},
+	{0x9207, 0x24},
+	{0x9208, 0x5f},
+	{0x9209, 0x26},
+	{0x920a, 0x5f},
+	{0x920b, 0x27},
+	{0x920c, 0x5f},
+	{0x920d, 0x29},
+	{0x920e, 0x5f},
+	{0x920f, 0x2a},
+	{0x9210, 0x5f},
+	{0x9211, 0x2c},
+	{0xbc22, 0x1a},
+	{0xf01f, 0x04},
+	{0xf021, 0x03},
+	{0xf023, 0x02},
+	{0xf03d, 0x05},
+	{0xf03f, 0x03},
+	{0xf041, 0x02},
+	{0xf0af, 0x04},
+	{0xf0b1, 0x03},
+	{0xf0b3, 0x02},
+	{0xf0cd, 0x05},
+	{0xf0cf, 0x03},
+	{0xf0d1, 0x02},
+	{0xf13f, 0x04},
+	{0xf141, 0x03},
+	{0xf143, 0x02},
+	{0xf15d, 0x05},
+	{0xf15f, 0x03},
+	{0xf161, 0x02},
+	{0xf1cf, 0x04},
+	{0xf1d1, 0x03},
+	{0xf1d3, 0x02},
+	{0xf1ed, 0x05},
+	{0xf1ef, 0x03},
+	{0xf1f1, 0x02},
+	{0xf287, 0x04},
+	{0xf289, 0x03},
+	{0xf28b, 0x02},
+	{0xf2a5, 0x05},
+	{0xf2a7, 0x03},
+	{0xf2a9, 0x02},
+	{0xf2b7, 0x04},
+	{0xf2b9, 0x03},
+	{0xf2bb, 0x02},
+	{0xf2d5, 0x05},
+	{0xf2d7, 0x03},
+	{0xf2d9, 0x02},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct imx319_reg_list imx319_global_setting = {
@@ -223,6 +364,7 @@ struct imx319_reg_list imx319_global_setting = {
 };
 
 static const struct imx319_reg mode_3264x2448_regs[] = {
+<<<<<<< HEAD
 	{ 0x0112, 0x0a },
 	{ 0x0113, 0x0a },
 	{ 0x0114, 0x03 },
@@ -1612,10 +1754,1402 @@ static const struct imx319_reg mode_1280x720_regs[] = {
 	{ 0x3936, 0x00 },
 	{ 0x3937, 0x00 },
 	{ 0x30ac, 0x00 },
+=======
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0f},
+	{0x0343, 0x80},
+	{0x0340, 0x0a},
+	{0x0341, 0x78},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x00},
+	{0x0347, 0x00},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x09},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x01},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x00},
+	{0x0409, 0x08},
+	{0x040a, 0x00},
+	{0x040b, 0x08},
+	{0x040c, 0x0c},
+	{0x040d, 0xc0},
+	{0x040e, 0x09},
+	{0x040f, 0x90},
+	{0x034c, 0x0c},
+	{0x034d, 0xc0},
+	{0x034e, 0x09},
+	{0x034f, 0x90},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x04},
+	{0x0305, 0x03},
+	{0x0306, 0x01},
+	{0x0307, 0x2c},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0x48},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x01},
+	{0x3f79, 0x18},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x00},
+	{0xe014, 0x00},
+	{0x0202, 0x0a},
+	{0x0203, 0x66},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+};
+
+static const struct imx319_reg mode_3280x2464_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0f},
+	{0x0343, 0x80},
+	{0x0340, 0x0a},
+	{0x0341, 0x78},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x00},
+	{0x0347, 0x00},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x09},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x01},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x00},
+	{0x0409, 0x00},
+	{0x040a, 0x00},
+	{0x040b, 0x00},
+	{0x040c, 0x0c},
+	{0x040d, 0xd0},
+	{0x040e, 0x09},
+	{0x040f, 0xa0},
+	{0x034c, 0x0c},
+	{0x034d, 0xd0},
+	{0x034e, 0x09},
+	{0x034f, 0xa0},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x04},
+	{0x0305, 0x03},
+	{0x0306, 0x01},
+	{0x0307, 0x2c},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0x48},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x01},
+	{0x3f79, 0x18},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x00},
+	{0xe014, 0x00},
+	{0x0202, 0x0a},
+	{0x0203, 0x66},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+};
+
+static const struct imx319_reg mode_1936x1096_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0f},
+	{0x0343, 0x80},
+	{0x0340, 0x07},
+	{0x0341, 0x72},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x01},
+	{0x0347, 0x30},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x08},
+	{0x034b, 0x6f},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x01},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x02},
+	{0x0409, 0xa0},
+	{0x040a, 0x01},
+	{0x040b, 0x7c},
+	{0x040c, 0x07},
+	{0x040d, 0x90},
+	{0x040e, 0x04},
+	{0x040f, 0x48},
+	{0x034c, 0x07},
+	{0x034d, 0x90},
+	{0x034e, 0x04},
+	{0x034f, 0x48},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x02},
+	{0x0305, 0x03},
+	{0x0306, 0x00},
+	{0x0307, 0xd6},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0x48},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x01},
+	{0x3f79, 0x18},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x00},
+	{0xe014, 0x00},
+	{0x0202, 0x07},
+	{0x0203, 0x60},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+};
+
+static const struct imx319_reg mode_1920x1080_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0f},
+	{0x0343, 0x80},
+	{0x0340, 0x07},
+	{0x0341, 0x72},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x01},
+	{0x0347, 0x30},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x08},
+	{0x034b, 0x6f},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x01},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x02},
+	{0x0409, 0xa8},
+	{0x040a, 0x01},
+	{0x040b, 0x84},
+	{0x040c, 0x07},
+	{0x040d, 0x80},
+	{0x040e, 0x04},
+	{0x040f, 0x38},
+	{0x034c, 0x07},
+	{0x034d, 0x80},
+	{0x034e, 0x04},
+	{0x034f, 0x38},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x02},
+	{0x0305, 0x03},
+	{0x0306, 0x00},
+	{0x0307, 0xd6},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0x48},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x01},
+	{0x3f79, 0x18},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x00},
+	{0xe014, 0x00},
+	{0x0202, 0x07},
+	{0x0203, 0x60},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+};
+
+static const struct imx319_reg mode_1640x1232_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x08},
+	{0x0343, 0x20},
+	{0x0340, 0x05},
+	{0x0341, 0x28},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x00},
+	{0x0347, 0x00},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x09},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x02},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x00},
+	{0x0409, 0x00},
+	{0x040a, 0x00},
+	{0x040b, 0x00},
+	{0x040c, 0x06},
+	{0x040d, 0x68},
+	{0x040e, 0x04},
+	{0x040f, 0xd0},
+	{0x034c, 0x06},
+	{0x034d, 0x68},
+	{0x034e, 0x04},
+	{0x034f, 0xd0},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x04},
+	{0x0305, 0x03},
+	{0x0306, 0x01},
+	{0x0307, 0x36},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0xba},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x00},
+	{0x3f79, 0x34},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x04},
+	{0xe014, 0x00},
+	{0x0202, 0x05},
+	{0x0203, 0x16},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+};
+
+static const struct imx319_reg mode_1640x922_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x08},
+	{0x0343, 0x20},
+	{0x0340, 0x05},
+	{0x0341, 0x00},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x01},
+	{0x0347, 0x30},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x08},
+	{0x034b, 0x6f},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x02},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x00},
+	{0x0409, 0x00},
+	{0x040a, 0x00},
+	{0x040b, 0x02},
+	{0x040c, 0x06},
+	{0x040d, 0x68},
+	{0x040e, 0x03},
+	{0x040f, 0x9a},
+	{0x034c, 0x06},
+	{0x034d, 0x68},
+	{0x034e, 0x03},
+	{0x034f, 0x9a},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x04},
+	{0x0305, 0x03},
+	{0x0306, 0x01},
+	{0x0307, 0x2c},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0xba},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x00},
+	{0x3f79, 0x34},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x04},
+	{0xe014, 0x00},
+	{0x0202, 0x04},
+	{0x0203, 0xee},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+};
+
+static const struct imx319_reg mode_1296x736_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x08},
+	{0x0343, 0x20},
+	{0x0340, 0x05},
+	{0x0341, 0x00},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x01},
+	{0x0347, 0xf0},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x07},
+	{0x034b, 0xaf},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x02},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x00},
+	{0x0409, 0xac},
+	{0x040a, 0x00},
+	{0x040b, 0x00},
+	{0x040c, 0x05},
+	{0x040d, 0x10},
+	{0x040e, 0x02},
+	{0x040f, 0xe0},
+	{0x034c, 0x05},
+	{0x034d, 0x10},
+	{0x034e, 0x02},
+	{0x034f, 0xe0},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x04},
+	{0x0305, 0x03},
+	{0x0306, 0x01},
+	{0x0307, 0x2c},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0xba},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x00},
+	{0x3f79, 0x34},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x04},
+	{0xe014, 0x00},
+	{0x0202, 0x04},
+	{0x0203, 0xee},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+};
+
+static const struct imx319_reg mode_1280x720_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x08},
+	{0x0343, 0x20},
+	{0x0340, 0x05},
+	{0x0341, 0x00},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x02},
+	{0x0347, 0x00},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x07},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0221, 0x11},
+	{0x0381, 0x01},
+	{0x0383, 0x01},
+	{0x0385, 0x01},
+	{0x0387, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x0a},
+	{0x3140, 0x02},
+	{0x3141, 0x00},
+	{0x3f0d, 0x0a},
+	{0x3f14, 0x01},
+	{0x3f3c, 0x02},
+	{0x3f4d, 0x01},
+	{0x3f4c, 0x01},
+	{0x4254, 0x7f},
+	{0x0401, 0x00},
+	{0x0404, 0x00},
+	{0x0405, 0x10},
+	{0x0408, 0x00},
+	{0x0409, 0xb4},
+	{0x040a, 0x00},
+	{0x040b, 0x00},
+	{0x040c, 0x05},
+	{0x040d, 0x00},
+	{0x040e, 0x02},
+	{0x040f, 0xd0},
+	{0x034c, 0x05},
+	{0x034d, 0x00},
+	{0x034e, 0x02},
+	{0x034f, 0xd0},
+	{0x3261, 0x00},
+	{0x3264, 0x00},
+	{0x3265, 0x10},
+	{0x0301, 0x06},
+	{0x0303, 0x04},
+	{0x0305, 0x03},
+	{0x0306, 0x01},
+	{0x0307, 0x2c},
+	{0x0309, 0x0a},
+	{0x030b, 0x02},
+	{0x030d, 0x04},
+	{0x030e, 0x01},
+	{0x030f, 0x2c},
+	{0x0310, 0x01},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x0822, 0x00},
+	{0x0823, 0x00},
+	{0x3e20, 0x01},
+	{0x3e37, 0x00},
+	{0x3e3b, 0x01},
+	{0x38a3, 0x01},
+	{0x38a8, 0x00},
+	{0x38a9, 0x00},
+	{0x38aa, 0x00},
+	{0x38ab, 0x00},
+	{0x3234, 0x00},
+	{0x3fc1, 0x00},
+	{0x3235, 0x00},
+	{0x3802, 0x00},
+	{0x3143, 0x04},
+	{0x360a, 0x00},
+	{0x0b00, 0x00},
+	{0x0106, 0x00},
+	{0x0b05, 0x01},
+	{0x0b06, 0x01},
+	{0x3230, 0x00},
+	{0x3602, 0x01},
+	{0x3607, 0x01},
+	{0x3c00, 0x00},
+	{0x3c01, 0xba},
+	{0x3c02, 0xc8},
+	{0x3c03, 0xaa},
+	{0x3c04, 0x91},
+	{0x3c05, 0x54},
+	{0x3c06, 0x26},
+	{0x3c07, 0x20},
+	{0x3c08, 0x51},
+	{0x3d80, 0x00},
+	{0x3f50, 0x00},
+	{0x3f56, 0x00},
+	{0x3f57, 0x30},
+	{0x3f78, 0x00},
+	{0x3f79, 0x34},
+	{0x3f7c, 0x00},
+	{0x3f7d, 0x00},
+	{0x3fba, 0x00},
+	{0x3fbb, 0x00},
+	{0xa081, 0x04},
+	{0xe014, 0x00},
+	{0x0202, 0x04},
+	{0x0203, 0xee},
+	{0x0224, 0x01},
+	{0x0225, 0xf4},
+	{0x0204, 0x00},
+	{0x0205, 0x00},
+	{0x0216, 0x00},
+	{0x0217, 0x00},
+	{0x020e, 0x01},
+	{0x020f, 0x00},
+	{0x0210, 0x01},
+	{0x0211, 0x00},
+	{0x0212, 0x01},
+	{0x0213, 0x00},
+	{0x0214, 0x01},
+	{0x0215, 0x00},
+	{0x0218, 0x01},
+	{0x0219, 0x00},
+	{0x3614, 0x00},
+	{0x3616, 0x0d},
+	{0x3617, 0x56},
+	{0xb612, 0x20},
+	{0xb613, 0x20},
+	{0xb614, 0x20},
+	{0xb615, 0x20},
+	{0xb616, 0x0a},
+	{0xb617, 0x0a},
+	{0xb618, 0x20},
+	{0xb619, 0x20},
+	{0xb61a, 0x20},
+	{0xb61b, 0x20},
+	{0xb61c, 0x0a},
+	{0xb61d, 0x0a},
+	{0xb666, 0x30},
+	{0xb667, 0x30},
+	{0xb668, 0x30},
+	{0xb669, 0x30},
+	{0xb66a, 0x14},
+	{0xb66b, 0x14},
+	{0xb66c, 0x20},
+	{0xb66d, 0x20},
+	{0xb66e, 0x20},
+	{0xb66f, 0x20},
+	{0xb670, 0x10},
+	{0xb671, 0x10},
+	{0x3237, 0x00},
+	{0x3900, 0x00},
+	{0x3901, 0x00},
+	{0x3902, 0x00},
+	{0x3904, 0x00},
+	{0x3905, 0x00},
+	{0x3906, 0x00},
+	{0x3907, 0x00},
+	{0x3908, 0x00},
+	{0x3909, 0x00},
+	{0x3912, 0x00},
+	{0x3930, 0x00},
+	{0x3931, 0x00},
+	{0x3933, 0x00},
+	{0x3934, 0x00},
+	{0x3935, 0x00},
+	{0x3936, 0x00},
+	{0x3937, 0x00},
+	{0x30ac, 0x00},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static const char * const imx319_test_pattern_menu[] = {
 	"Disabled",
+<<<<<<< HEAD
 	"100% color bars",
 	"Solid color",
 	"Fade to gray color bars",
@@ -1630,6 +3164,14 @@ static const int imx319_test_pattern_val[] = {
 	IMX319_TEST_PATTERN_PN9,
 };
 
+=======
+	"Solid Color",
+	"Color Bars",
+	"Grey Color Bars",
+	"PN9"
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Configurations for supported link frequencies */
 /* Menu items for LINK_FREQ V4L2 control */
 static const s64 link_freq_menu_items[] = {
@@ -1728,10 +3270,38 @@ static const struct imx319_mode supported_modes[] = {
 	},
 };
 
+<<<<<<< HEAD
 static inline struct imx319 *to_imx319(struct v4l2_subdev *_sd)
 {
 	return container_of(_sd, struct imx319, sd);
 }
+=======
+struct imx319 {
+	struct v4l2_subdev sd;
+	struct media_pad pad;
+
+	struct v4l2_ctrl_handler ctrl_handler;
+	/* V4L2 Controls */
+	struct v4l2_ctrl *link_freq;
+	struct v4l2_ctrl *pixel_rate;
+	struct v4l2_ctrl *vblank;
+	struct v4l2_ctrl *hblank;
+	struct v4l2_ctrl *exposure;
+	struct v4l2_ctrl *vflip;
+	struct v4l2_ctrl *hflip;
+
+	/* Current mode */
+	const struct imx319_mode *cur_mode;
+
+	/* Mutex for serialized access */
+	struct mutex mutex;
+
+	/* Streaming on/off */
+	bool streaming;
+};
+
+#define to_imx319(_sd)	container_of(_sd, struct imx319, sd)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* Get bayer order based on flip setting. */
 static __u32 imx319_get_format_code(struct imx319 *imx319)
@@ -1740,12 +3310,23 @@ static __u32 imx319_get_format_code(struct imx319 *imx319)
 	 * Only one bayer order is supported.
 	 * It depends on the flip settings.
 	 */
+<<<<<<< HEAD
 	static const __u32 codes[2][2] = {
 		{ MEDIA_BUS_FMT_SRGGB10_1X10, MEDIA_BUS_FMT_SGRBG10_1X10, },
 		{ MEDIA_BUS_FMT_SGBRG10_1X10, MEDIA_BUS_FMT_SBGGR10_1X10, },
 	};
 
 	return codes[imx319->vflip->val][imx319->hflip->val];
+=======
+	__u32 codes[] = {
+		MEDIA_BUS_FMT_SRGGB10_1X10,
+		MEDIA_BUS_FMT_SGRBG10_1X10,
+		MEDIA_BUS_FMT_SGBRG10_1X10,
+		MEDIA_BUS_FMT_SBGGR10_1X10
+	};
+
+	return codes[imx319->hflip->val | (imx319->vflip->val << 1)];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /* Read registers up to 4 at a time */
@@ -1753,31 +3334,55 @@ static int imx319_read_reg(struct imx319 *imx319, u16 reg, u32 len, u32 *val)
 {
 	struct i2c_client *client = v4l2_get_subdevdata(&imx319->sd);
 	struct i2c_msg msgs[2];
+<<<<<<< HEAD
 	u8 addr_buf[2];
 	u8 data_buf[4] = { 0 };
 	int ret;
+=======
+	u8 *data_be_p;
+	int ret;
+	u32 data_be = 0;
+	u16 reg_addr_be = cpu_to_be16(reg);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (len > 4)
 		return -EINVAL;
 
+<<<<<<< HEAD
 	put_unaligned_be16(reg, addr_buf);
 	/* Write register address */
 	msgs[0].addr = client->addr;
 	msgs[0].flags = 0;
 	msgs[0].len = ARRAY_SIZE(addr_buf);
 	msgs[0].buf = addr_buf;
+=======
+	data_be_p = (u8 *)&data_be;
+	/* Write register address */
+	msgs[0].addr = client->addr;
+	msgs[0].flags = 0;
+	msgs[0].len = 2;
+	msgs[0].buf = (u8 *)&reg_addr_be;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* Read data from register */
 	msgs[1].addr = client->addr;
 	msgs[1].flags = I2C_M_RD;
 	msgs[1].len = len;
+<<<<<<< HEAD
 	msgs[1].buf = &data_buf[4 - len];
+=======
+	msgs[1].buf = &data_be_p[4 - len];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	ret = i2c_transfer(client->adapter, msgs, ARRAY_SIZE(msgs));
 	if (ret != ARRAY_SIZE(msgs))
 		return -EIO;
 
+<<<<<<< HEAD
 	*val = get_unaligned_be32(data_buf);
+=======
+	*val = be32_to_cpu(data_be);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 }
@@ -1786,13 +3391,32 @@ static int imx319_read_reg(struct imx319 *imx319, u16 reg, u32 len, u32 *val)
 static int imx319_write_reg(struct imx319 *imx319, u16 reg, u32 len, u32 val)
 {
 	struct i2c_client *client = v4l2_get_subdevdata(&imx319->sd);
+<<<<<<< HEAD
 	u8 buf[6];
+=======
+	int buf_i, val_i;
+	u8 buf[6], *val_p;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (len > 4)
 		return -EINVAL;
 
+<<<<<<< HEAD
 	put_unaligned_be16(reg, buf);
 	put_unaligned_be32(val << (8 * (4 - len)), buf + 2);
+=======
+	buf[0] = reg >> 8;
+	buf[1] = reg & 0xff;
+
+	val = cpu_to_be32(val);
+	val_p = (u8 *)&val;
+	buf_i = 2;
+	val_i = 4 - len;
+
+	while (val_i < 4)
+		buf[buf_i++] = val_p[val_i++];
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (i2c_master_send(client, buf, len + 2) != len + 2)
 		return -EIO;
 
@@ -1823,12 +3447,27 @@ static int imx319_write_regs(struct imx319 *imx319,
 	return 0;
 }
 
+<<<<<<< HEAD
+=======
+static int imx319_write_reg_list(struct imx319 *imx319,
+				  const struct imx319_reg_list *r_list)
+{
+	return imx319_write_regs(imx319, r_list->regs, r_list->num_of_regs);
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Open sub-device */
 static int imx319_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)
 {
 	struct imx319 *imx319 = to_imx319(sd);
+<<<<<<< HEAD
 	struct v4l2_mbus_framefmt *try_fmt =
 		v4l2_subdev_get_try_format(sd, fh->pad, 0);
+=======
+	struct v4l2_mbus_framefmt *try_fmt = v4l2_subdev_get_try_format(sd,
+									fh->pad,
+									0);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	mutex_lock(&imx319->mutex);
 
@@ -1838,6 +3477,10 @@ static int imx319_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)
 	try_fmt->code = imx319_get_format_code(imx319);
 	try_fmt->field = V4L2_FIELD_NONE;
 
+<<<<<<< HEAD
+=======
+	/* No crop or compose */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	mutex_unlock(&imx319->mutex);
 
 	return 0;
@@ -1845,6 +3488,7 @@ static int imx319_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)
 
 static int imx319_update_digital_gain(struct imx319 *imx319, u32 d_gain)
 {
+<<<<<<< HEAD
 	int ret;
 
 	ret = imx319_write_reg(imx319, IMX319_REG_DPGA_USE_GLOBAL_GAIN, 1, 1);
@@ -1853,12 +3497,26 @@ static int imx319_update_digital_gain(struct imx319 *imx319, u32 d_gain)
 
 	/* Digital gain = (d_gain & 0xFF00) + (d_gain & 0xFF)/256 times */
 	return imx319_write_reg(imx319, IMX319_REG_DIG_GAIN_GLOBAL, 2, d_gain);
+=======
+	return imx319_write_reg(imx319, IMX319_REG_DIGITAL_GAIN,
+				IMX319_REG_VALUE_16BIT, d_gain);
+}
+
+static int imx319_enable_test_pattern(struct imx319 *imx319, u32 pattern)
+{
+	return imx319_write_reg(imx319, IMX319_REG_TEST_PATTERN,
+				 IMX319_REG_VALUE_08BIT, pattern);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx319_set_ctrl(struct v4l2_ctrl *ctrl)
 {
 	struct imx319 *imx319 = container_of(ctrl->handler,
+<<<<<<< HEAD
 					     struct imx319, ctrl_handler);
+=======
+					       struct imx319, ctrl_handler);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct i2c_client *client = v4l2_get_subdevdata(&imx319->sd);
 	s64 max;
 	int ret;
@@ -1878,6 +3536,7 @@ static int imx319_set_ctrl(struct v4l2_ctrl *ctrl)
 	 * Applying V4L2 control value only happens
 	 * when power is up for streaming
 	 */
+<<<<<<< HEAD
 	if (pm_runtime_get_if_in_use(&client->dev) == 0)
 		return 0;
 
@@ -1886,12 +3545,23 @@ static int imx319_set_ctrl(struct v4l2_ctrl *ctrl)
 		/* Analog gain = 1024/(1024 - ctrl->val) times */
 		ret = imx319_write_reg(imx319, IMX319_REG_ANALOG_GAIN,
 				       2, ctrl->val);
+=======
+	if (pm_runtime_get_if_in_use(&client->dev) <= 0)
+		return 0;
+
+	ret = 0;
+	switch (ctrl->id) {
+	case V4L2_CID_ANALOGUE_GAIN:
+		ret = imx319_write_reg(imx319, IMX319_REG_ANALOG_GAIN,
+					IMX319_REG_VALUE_16BIT, ctrl->val);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		break;
 	case V4L2_CID_DIGITAL_GAIN:
 		ret = imx319_update_digital_gain(imx319, ctrl->val);
 		break;
 	case V4L2_CID_EXPOSURE:
 		ret = imx319_write_reg(imx319, IMX319_REG_EXPOSURE,
+<<<<<<< HEAD
 				       2, ctrl->val);
 		break;
 	case V4L2_CID_VBLANK:
@@ -1911,6 +3581,29 @@ static int imx319_set_ctrl(struct v4l2_ctrl *ctrl)
 		break;
 	default:
 		ret = -EINVAL;
+=======
+					IMX319_REG_VALUE_16BIT,
+					ctrl->val);
+		break;
+	case V4L2_CID_VBLANK:
+		/* Update FLL that meets expected vertical blanking */
+		ret = imx319_write_reg(imx319, IMX319_REG_FLL,
+					IMX319_REG_VALUE_16BIT,
+					imx319->cur_mode->height
+					  + ctrl->val);
+		break;
+	case V4L2_CID_TEST_PATTERN:
+		ret = imx319_enable_test_pattern(imx319, ctrl->val);
+		break;
+	case V4L2_CID_HFLIP:
+	case V4L2_CID_VFLIP:
+		ret = imx319_write_reg(imx319, IMX319_REG_ORIENTATION,
+					IMX319_REG_VALUE_08BIT,
+					imx319->hflip->val |
+					imx319->vflip->val << 1);
+		break;
+	default:
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		dev_info(&client->dev,
 			 "ctrl(id:0x%x,val:0x%x) is not handled\n",
 			 ctrl->id, ctrl->val);
@@ -1968,10 +3661,13 @@ static void imx319_update_pad_format(struct imx319 *imx319,
 	fmt->format.height = mode->height;
 	fmt->format.code = imx319_get_format_code(imx319);
 	fmt->format.field = V4L2_FIELD_NONE;
+<<<<<<< HEAD
 	fmt->format.colorspace = V4L2_COLORSPACE_DEFAULT;
 	fmt->format.xfer_func = V4L2_XFER_FUNC_DEFAULT;
 	fmt->format.ycbcr_enc = V4L2_YCBCR_ENC_DEFAULT;
 	fmt->format.quantization = V4L2_QUANTIZATION_DEFAULT;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx319_do_get_pad_format(struct imx319 *imx319,
@@ -2005,6 +3701,42 @@ static int imx319_get_pad_format(struct v4l2_subdev *sd,
 	return ret;
 }
 
+<<<<<<< HEAD
+=======
+/*
+ * Calculate resolution distance
+ */
+static int
+imx319_get_resolution_dist(const struct imx319_mode *mode,
+			    struct v4l2_mbus_framefmt *framefmt)
+{
+	return abs(mode->width - framefmt->width) +
+	       abs(mode->height - framefmt->height);
+}
+
+/*
+ * Find the closest supported resolution to the requested resolution
+ */
+static const struct imx319_mode *
+imx319_find_best_fit(struct imx319 *imx319,
+		      struct v4l2_subdev_format *fmt)
+{
+	int i, dist, cur_best_fit = 0, cur_best_fit_dist = -1;
+	struct v4l2_mbus_framefmt *framefmt = &fmt->format;
+
+	for (i = 0; i < ARRAY_SIZE(supported_modes); i++) {
+		dist = imx319_get_resolution_dist(&supported_modes[i],
+						   framefmt);
+		if (cur_best_fit_dist == -1 || dist < cur_best_fit_dist) {
+			cur_best_fit_dist = dist;
+			cur_best_fit = i;
+		}
+	}
+
+	return &supported_modes[cur_best_fit];
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int
 imx319_set_pad_format(struct v4l2_subdev *sd,
 		       struct v4l2_subdev_pad_config *cfg,
@@ -2026,9 +3758,13 @@ imx319_set_pad_format(struct v4l2_subdev *sd,
 	 */
 	fmt->format.code = imx319_get_format_code(imx319);
 
+<<<<<<< HEAD
 	mode = v4l2_find_nearest_size(supported_modes,
 		ARRAY_SIZE(supported_modes), width, height,
 		fmt->format.width, fmt->format.height);
+=======
+	mode = imx319_find_best_fit(imx319, fmt);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	imx319_update_pad_format(imx319, mode, fmt);
 	if (fmt->which == V4L2_SUBDEV_FORMAT_TRY) {
 		framefmt = v4l2_subdev_get_try_format(sd, cfg, fmt->pad);
@@ -2062,6 +3798,16 @@ imx319_set_pad_format(struct v4l2_subdev *sd,
 	return 0;
 }
 
+<<<<<<< HEAD
+=======
+static int imx319_get_skip_frames(struct v4l2_subdev *sd, u32 *frames)
+{
+	*frames = IMX319_NUM_OF_SKIP_FRAMES;
+
+	return 0;
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Start streaming */
 static int imx319_start_streaming(struct imx319 *imx319)
 {
@@ -2071,16 +3817,27 @@ static int imx319_start_streaming(struct imx319 *imx319)
 
 	/* Global Setting */
 	reg_list = &imx319_global_setting;
+<<<<<<< HEAD
 	ret = imx319_write_regs(imx319, reg_list->regs, reg_list->num_of_regs);
 	if (ret) {
 		dev_err(&client->dev, "%s failed to set global settings\n",
 			__func__);
+=======
+	ret = imx319_write_reg_list(imx319, reg_list);
+	if (ret) {
+		dev_err(&client->dev,
+			"%s failed to set global settings\n", __func__);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		return ret;
 	}
 
 	/* Apply default values of current mode */
 	reg_list = &imx319->cur_mode->reg_list;
+<<<<<<< HEAD
 	ret = imx319_write_regs(imx319, reg_list->regs, reg_list->num_of_regs);
+=======
+	ret = imx319_write_reg_list(imx319, reg_list);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ret) {
 		dev_err(&client->dev, "%s failed to set mode\n", __func__);
 		return ret;
@@ -2092,14 +3849,23 @@ static int imx319_start_streaming(struct imx319 *imx319)
 		return ret;
 
 	return imx319_write_reg(imx319, IMX319_REG_MODE_SELECT,
+<<<<<<< HEAD
 				1, IMX319_MODE_STREAMING);
+=======
+				 IMX319_REG_VALUE_08BIT,
+				 IMX319_MODE_STREAMING);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /* Stop streaming */
 static int imx319_stop_streaming(struct imx319 *imx319)
 {
 	return imx319_write_reg(imx319, IMX319_REG_MODE_SELECT,
+<<<<<<< HEAD
 				1, IMX319_MODE_STANDBY);
+=======
+				 IMX319_REG_VALUE_08BIT, IMX319_MODE_STANDBY);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx319_set_stream(struct v4l2_subdev *sd, int enable)
@@ -2186,7 +3952,12 @@ static int imx319_identify_module(struct imx319 *imx319)
 	int ret;
 	u32 val;
 
+<<<<<<< HEAD
 	ret = imx319_read_reg(imx319, IMX319_REG_CHIP_ID, 2, &val);
+=======
+	ret = imx319_read_reg(imx319, IMX319_REG_CHIP_ID,
+			       IMX319_REG_VALUE_16BIT, &val);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ret)
 		return ret;
 
@@ -2198,11 +3969,14 @@ static int imx319_identify_module(struct imx319 *imx319)
 	return 0;
 }
 
+<<<<<<< HEAD
 static const struct v4l2_subdev_core_ops imx319_subdev_core_ops = {
 	.subscribe_event = v4l2_ctrl_subdev_subscribe_event,
 	.unsubscribe_event = v4l2_event_subdev_unsubscribe,
 };
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static const struct v4l2_subdev_video_ops imx319_video_ops = {
 	.s_stream = imx319_set_stream,
 };
@@ -2214,10 +3988,21 @@ static const struct v4l2_subdev_pad_ops imx319_pad_ops = {
 	.enum_frame_size = imx319_enum_frame_size,
 };
 
+<<<<<<< HEAD
 static const struct v4l2_subdev_ops imx319_subdev_ops = {
 	.core = &imx319_subdev_core_ops,
 	.video = &imx319_video_ops,
 	.pad = &imx319_pad_ops,
+=======
+static const struct v4l2_subdev_sensor_ops imx319_sensor_ops = {
+	.g_skip_frames = imx319_get_skip_frames,
+};
+
+static const struct v4l2_subdev_ops imx319_subdev_ops = {
+	.video = &imx319_video_ops,
+	.pad = &imx319_pad_ops,
+	.sensor = &imx319_sensor_ops,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static const struct media_entity_operations imx319_subdev_entity_ops = {
@@ -2246,6 +4031,10 @@ static int imx319_init_controls(struct imx319 *imx319)
 	if (ret)
 		return ret;
 
+<<<<<<< HEAD
+=======
+	mutex_init(&imx319->mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	ctrl_hdlr->lock = &imx319->mutex;
 	imx319->link_freq = v4l2_ctrl_new_int_menu(ctrl_hdlr,
 				&imx319_ctrl_ops,
@@ -2253,8 +4042,12 @@ static int imx319_init_controls(struct imx319 *imx319)
 				0,
 				0,
 				link_freq_menu_items);
+<<<<<<< HEAD
 	if (imx319->link_freq)
 		imx319->link_freq->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+=======
+	imx319->link_freq->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* pixel_rate = link_freq * 2 * nr_of_lanes / bits_per_sample */
 	pixel_rate = (link_freq_menu_items[0] * 2 * 4) / 10;
@@ -2277,8 +4070,12 @@ static int imx319_init_controls(struct imx319 *imx319)
 	imx319->hblank = v4l2_ctrl_new_std(
 				ctrl_hdlr, &imx319_ctrl_ops, V4L2_CID_HBLANK,
 				hblank, hblank, 1, hblank);
+<<<<<<< HEAD
 	if (imx319->hblank)
 		imx319->hblank->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+=======
+	imx319->hblank->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	exposure_max = mode->fll_def - 18;
 	imx319->exposure = v4l2_ctrl_new_std(
@@ -2320,6 +4117,10 @@ static int imx319_init_controls(struct imx319 *imx319)
 
 error:
 	v4l2_ctrl_handler_free(ctrl_hdlr);
+<<<<<<< HEAD
+=======
+	mutex_destroy(&imx319->mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return ret;
 }
@@ -2327,6 +4128,10 @@ static int imx319_init_controls(struct imx319 *imx319)
 static void imx319_free_controls(struct imx319 *imx319)
 {
 	v4l2_ctrl_handler_free(imx319->sd.ctrl_handler);
+<<<<<<< HEAD
+=======
+	mutex_destroy(&imx319->mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx319_probe(struct i2c_client *client,
@@ -2339,8 +4144,11 @@ static int imx319_probe(struct i2c_client *client,
 	if (!imx319)
 		return -ENOMEM;
 
+<<<<<<< HEAD
 	mutex_init(&imx319->mutex);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* Initialize subdev */
 	v4l2_i2c_subdev_init(&imx319->sd, client, &imx319_subdev_ops);
 
@@ -2348,13 +4156,18 @@ static int imx319_probe(struct i2c_client *client,
 	ret = imx319_identify_module(imx319);
 	if (ret) {
 		dev_err(&client->dev, "failed to find sensor: %d\n", ret);
+<<<<<<< HEAD
 		goto error_probe;
+=======
+		return ret;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 
 	/* Set default mode to max resolution */
 	imx319->cur_mode = &supported_modes[0];
 
 	ret = imx319_init_controls(imx319);
+<<<<<<< HEAD
 	if (ret) {
 		dev_err(&client->dev, "failed to init controls: %d\n", ret);
 		goto error_probe;
@@ -2364,6 +4177,14 @@ static int imx319_probe(struct i2c_client *client,
 	imx319->sd.internal_ops = &imx319_internal_ops;
 	imx319->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE |
 				V4L2_SUBDEV_FL_HAS_EVENTS;
+=======
+	if (ret)
+		return ret;
+
+	/* Initialize subdev */
+	imx319->sd.internal_ops = &imx319_internal_ops;
+	imx319->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	imx319->sd.entity.ops = &imx319_subdev_entity_ops;
 	imx319->sd.entity.function = MEDIA_ENT_F_CAM_SENSOR;
 
@@ -2375,7 +4196,11 @@ static int imx319_probe(struct i2c_client *client,
 		goto error_handler_free;
 	}
 
+<<<<<<< HEAD
 	ret = v4l2_async_register_subdev_sensor_common(&imx319->sd);
+=======
+	ret = v4l2_async_register_subdev(&imx319->sd);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ret < 0)
 		goto error_media_entity;
 
@@ -2383,9 +4208,16 @@ static int imx319_probe(struct i2c_client *client,
 	 * Device is already turned on by i2c-core with ACPI domain PM.
 	 * Enable runtime PM and turn off the device.
 	 */
+<<<<<<< HEAD
 	pm_runtime_set_active(&client->dev);
 	pm_runtime_enable(&client->dev);
 	pm_runtime_idle(&client->dev);
+=======
+	pm_runtime_get_noresume(&client->dev);
+	pm_runtime_set_active(&client->dev);
+	pm_runtime_enable(&client->dev);
+	pm_runtime_put(&client->dev);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 
@@ -2394,9 +4226,13 @@ static int imx319_probe(struct i2c_client *client,
 
 error_handler_free:
 	imx319_free_controls(imx319);
+<<<<<<< HEAD
 
 error_probe:
 	mutex_destroy(&imx319->mutex);
+=======
+	dev_err(&client->dev, "%s failed:%d\n", __func__, ret);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return ret;
 }
@@ -2410,41 +4246,78 @@ static int imx319_remove(struct i2c_client *client)
 	media_entity_cleanup(&sd->entity);
 	imx319_free_controls(imx319);
 
+<<<<<<< HEAD
 	pm_runtime_disable(&client->dev);
 	pm_runtime_set_suspended(&client->dev);
 
 	mutex_destroy(&imx319->mutex);
+=======
+	/*
+	 * Disable runtime PM but keep the device turned on.
+	 * i2c-core with ACPI domain PM will turn off the device.
+	 */
+	pm_runtime_get_sync(&client->dev);
+	pm_runtime_disable(&client->dev);
+	pm_runtime_set_suspended(&client->dev);
+	pm_runtime_put_noidle(&client->dev);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 }
 
 static const struct i2c_device_id imx319_id_table[] = {
+<<<<<<< HEAD
 	{ "imx319", 0 },
 	{ /* sentinel */ },
 };
+=======
+	{"imx319", 0},
+	{},
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 MODULE_DEVICE_TABLE(i2c, imx319_id_table);
 
 static const struct dev_pm_ops imx319_pm_ops = {
 	SET_SYSTEM_SLEEP_PM_OPS(imx319_suspend, imx319_resume)
 };
 
+<<<<<<< HEAD
 static const struct acpi_device_id imx319_acpi_ids[] = {
 	{ "SONY319A" },
 	{ /* sentinel */ }
 };
 MODULE_DEVICE_TABLE(acpi, imx319_acpi_ids);
+=======
+#ifdef CONFIG_ACPI
+static const struct acpi_device_id imx319_acpi_ids[] = {
+	{"IMX319"},
+	{ /* sentinel */ }
+};
+
+MODULE_DEVICE_TABLE(acpi, imx319_acpi_ids);
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static struct i2c_driver imx319_i2c_driver = {
 	.driver = {
 		.name = "imx319",
 		.owner = THIS_MODULE,
 		.pm = &imx319_pm_ops,
+<<<<<<< HEAD
 		.acpi_match_table = ACPI_PTR(imx319_acpi_ids),
+=======
+		/*.acpi_match_table = ACPI_PTR(imx319_acpi_ids),*/
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	.probe = imx319_probe,
 	.remove = imx319_remove,
 	.id_table = imx319_id_table,
 };
+<<<<<<< HEAD
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 module_i2c_driver(imx319_i2c_driver);
 
 MODULE_AUTHOR("Qiu, Tianshu <tian.shu.qiu@intel.com>");
diff --git a/drivers/media/i2c/imx355.c b/drivers/media/i2c/imx355.c
index 3c092d0..d15abdf 100644
--- a/drivers/media/i2c/imx355.c
+++ b/drivers/media/i2c/imx355.c
@@ -1,14 +1,30 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
 // Copyright (C) 2017 - 2018 Intel Corporation
 
 #include <asm/unaligned.h>
+=======
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2017 - 2018 Intel Corporation
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <linux/acpi.h>
 #include <linux/i2c.h>
 #include <linux/module.h>
 #include <linux/pm_runtime.h>
 #include <media/v4l2-ctrls.h>
 #include <media/v4l2-device.h>
+<<<<<<< HEAD
 #include <media/v4l2-event.h>
+=======
+
+#ifndef V4L2_CID_DIGITAL_GAIN
+#define V4L2_CID_DIGITAL_GAIN V4L2_CID_GAIN
+#endif
+
+#define IMX355_REG_VALUE_08BIT		1
+#define IMX355_REG_VALUE_16BIT		2
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define IMX355_REG_MODE_SELECT		0x0100
 #define IMX355_MODE_STANDBY		0x00
@@ -36,6 +52,7 @@
 #define IMX355_ANA_GAIN_DEFAULT		0
 
 /* Digital gain control */
+<<<<<<< HEAD
 #define IMX355_REG_DPGA_USE_GLOBAL_GAIN	0x3070
 #define IMX355_REG_DIG_GAIN_GLOBAL	0x020e
 #define IMX355_DGTL_GAIN_MIN		256
@@ -50,10 +67,26 @@
 #define IMX355_TEST_PATTERN_COLOR_BARS		2
 #define IMX355_TEST_PATTERN_GRAY_COLOR_BARS	3
 #define IMX355_TEST_PATTERN_PN9			4
+=======
+#define IMX355_REG_DIGITAL_GAIN		0x020e
+#define IMX355_DGTL_GAIN_MIN		0
+#define IMX355_DGTL_GAIN_MAX		3840
+#define IMX355_DGTL_GAIN_DEFAULT	256
+#define IMX355_DGTL_GAIN_STEP		1
+
+/* Test Pattern Control */
+#define IMX355_REG_TEST_PATTERN		0x0600
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* Flip Control */
 #define IMX355_REG_ORIENTATION		0x0101
 
+<<<<<<< HEAD
+=======
+/* Number of frames to skip */
+#define IMX355_NUM_OF_SKIP_FRAMES	2
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 struct imx355_reg {
 	u16 address;
 	u8 val;
@@ -82,6 +115,7 @@ struct imx355_mode {
 	struct imx355_reg_list reg_list;
 };
 
+<<<<<<< HEAD
 struct imx355 {
 	struct v4l2_subdev sd;
 	struct media_pad pad;
@@ -166,11 +200,56 @@ static const struct imx355_reg imx355_global_regs[] = {
 };
 
 static const struct imx355_reg_list imx355_global_setting = {
+=======
+static const struct imx355_reg imx355_global_regs[] = {
+	{0x0136, 0x13},
+	{0x0137, 0x33},
+	{0x304e, 0x03},
+	{0x4348, 0x16},
+	{0x4350, 0x19},
+	{0x4408, 0x0a},
+	{0x440c, 0x0b},
+	{0x4411, 0x5f},
+	{0x4412, 0x2c},
+	{0x4623, 0x00},
+	{0x462c, 0x0f},
+	{0x462d, 0x00},
+	{0x462e, 0x00},
+	{0x4684, 0x54},
+	{0x480a, 0x07},
+	{0x4908, 0x07},
+	{0x4909, 0x07},
+	{0x490d, 0x0a},
+	{0x491e, 0x0f},
+	{0x4921, 0x06},
+	{0x4923, 0x28},
+	{0x4924, 0x28},
+	{0x4925, 0x29},
+	{0x4926, 0x29},
+	{0x4927, 0x1f},
+	{0x4928, 0x20},
+	{0x4929, 0x20},
+	{0x492a, 0x20},
+	{0x492c, 0x05},
+	{0x492d, 0x06},
+	{0x492e, 0x06},
+	{0x492f, 0x06},
+	{0x4930, 0x03},
+	{0x4931, 0x04},
+	{0x4932, 0x04},
+	{0x4933, 0x05},
+	{0x595e, 0x01},
+	{0x5963, 0x01},
+};
+
+struct imx355_reg_list imx355_global_setting = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.num_of_regs = ARRAY_SIZE(imx355_global_regs),
 	.regs = imx355_global_regs,
 };
 
 static const struct imx355_reg mode_3268x2448_regs[] = {
+<<<<<<< HEAD
 	{ 0x0112, 0x0a },
 	{ 0x0113, 0x0a },
 	{ 0x0114, 0x03 },
@@ -854,10 +933,696 @@ static const struct imx355_reg mode_820x616_regs[] = {
 	{ 0x684d, 0x07 },
 	{ 0x684e, 0x01 },
 	{ 0x684f, 0x04 },
+=======
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x0a},
+	{0x0341, 0x36},
+	{0x0344, 0x00},
+	{0x0345, 0x08},
+	{0x0346, 0x00},
+	{0x0347, 0x08},
+	{0x0348, 0x0c},
+	{0x0349, 0xcb},
+	{0x034a, 0x09},
+	{0x034b, 0x97},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x00},
+	{0x034c, 0x0c},
+	{0x034d, 0xc4},
+	{0x034e, 0x09},
+	{0x034f, 0x90},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_3264x2448_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x0a},
+	{0x0341, 0x36},
+	{0x0344, 0x00},
+	{0x0345, 0x08},
+	{0x0346, 0x00},
+	{0x0347, 0x08},
+	{0x0348, 0x0c},
+	{0x0349, 0xc7},
+	{0x034a, 0x09},
+	{0x034b, 0x97},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x00},
+	{0x034c, 0x0c},
+	{0x034d, 0xc0},
+	{0x034e, 0x09},
+	{0x034f, 0x90},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_3280x2464_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x0a},
+	{0x0341, 0x36},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x00},
+	{0x0347, 0x00},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x09},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x00},
+	{0x034c, 0x0c},
+	{0x034d, 0xd0},
+	{0x034e, 0x09},
+	{0x034f, 0xa0},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1940x1096_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x02},
+	{0x0345, 0xa0},
+	{0x0346, 0x02},
+	{0x0347, 0xac},
+	{0x0348, 0x0a},
+	{0x0349, 0x33},
+	{0x034a, 0x06},
+	{0x034b, 0xf3},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x00},
+	{0x034c, 0x07},
+	{0x034d, 0x94},
+	{0x034e, 0x04},
+	{0x034f, 0x48},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1936x1096_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x02},
+	{0x0345, 0xa0},
+	{0x0346, 0x02},
+	{0x0347, 0xac},
+	{0x0348, 0x0a},
+	{0x0349, 0x2f},
+	{0x034a, 0x06},
+	{0x034b, 0xf3},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x00},
+	{0x034c, 0x07},
+	{0x034d, 0x90},
+	{0x034e, 0x04},
+	{0x034f, 0x48},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1924x1080_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x02},
+	{0x0345, 0xa8},
+	{0x0346, 0x02},
+	{0x0347, 0xb4},
+	{0x0348, 0x0a},
+	{0x0349, 0x2b},
+	{0x034a, 0x06},
+	{0x034b, 0xeb},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x00},
+	{0x034c, 0x07},
+	{0x034d, 0x84},
+	{0x034e, 0x04},
+	{0x034f, 0x38},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1920x1080_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x02},
+	{0x0345, 0xa8},
+	{0x0346, 0x02},
+	{0x0347, 0xb4},
+	{0x0348, 0x0a},
+	{0x0349, 0x27},
+	{0x034a, 0x06},
+	{0x034b, 0xeb},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x00},
+	{0x0901, 0x11},
+	{0x0902, 0x00},
+	{0x034c, 0x07},
+	{0x034d, 0x80},
+	{0x034e, 0x04},
+	{0x034f, 0x38},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1640x1232_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x07},
+	{0x0343, 0x2c},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x00},
+	{0x0347, 0x00},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x09},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x00},
+	{0x034c, 0x06},
+	{0x034d, 0x68},
+	{0x034e, 0x04},
+	{0x034f, 0xd0},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1640x922_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x07},
+	{0x0343, 0x2c},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x01},
+	{0x0347, 0x30},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x08},
+	{0x034b, 0x63},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x00},
+	{0x034c, 0x06},
+	{0x034d, 0x68},
+	{0x034e, 0x03},
+	{0x034f, 0x9a},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1300x736_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x07},
+	{0x0343, 0x2c},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x01},
+	{0x0345, 0x58},
+	{0x0346, 0x01},
+	{0x0347, 0xf0},
+	{0x0348, 0x0b},
+	{0x0349, 0x7f},
+	{0x034a, 0x07},
+	{0x034b, 0xaf},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x00},
+	{0x034c, 0x05},
+	{0x034d, 0x14},
+	{0x034e, 0x02},
+	{0x034f, 0xe0},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1296x736_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x07},
+	{0x0343, 0x2c},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x01},
+	{0x0345, 0x58},
+	{0x0346, 0x01},
+	{0x0347, 0xf0},
+	{0x0348, 0x0b},
+	{0x0349, 0x77},
+	{0x034a, 0x07},
+	{0x034b, 0xaf},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x00},
+	{0x034c, 0x05},
+	{0x034d, 0x10},
+	{0x034e, 0x02},
+	{0x034f, 0xe0},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1284x720_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x07},
+	{0x0343, 0x2c},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x01},
+	{0x0345, 0x68},
+	{0x0346, 0x02},
+	{0x0347, 0x00},
+	{0x0348, 0x0b},
+	{0x0349, 0x6f},
+	{0x034a, 0x07},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x00},
+	{0x034c, 0x05},
+	{0x034d, 0x04},
+	{0x034e, 0x02},
+	{0x034f, 0xd0},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_1280x720_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x07},
+	{0x0343, 0x2c},
+	{0x0340, 0x05},
+	{0x0341, 0x1a},
+	{0x0344, 0x01},
+	{0x0345, 0x68},
+	{0x0346, 0x02},
+	{0x0347, 0x00},
+	{0x0348, 0x0b},
+	{0x0349, 0x67},
+	{0x034a, 0x07},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x22},
+	{0x0902, 0x00},
+	{0x034c, 0x05},
+	{0x034d, 0x00},
+	{0x034e, 0x02},
+	{0x034f, 0xd0},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x00},
+	{0x0701, 0x10},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+};
+
+static const struct imx355_reg mode_820x616_regs[] = {
+	{0x0112, 0x0a},
+	{0x0113, 0x0a},
+	{0x0114, 0x03},
+	{0x0342, 0x0e},
+	{0x0343, 0x58},
+	{0x0340, 0x02},
+	{0x0341, 0x8c},
+	{0x0344, 0x00},
+	{0x0345, 0x00},
+	{0x0346, 0x00},
+	{0x0347, 0x00},
+	{0x0348, 0x0c},
+	{0x0349, 0xcf},
+	{0x034a, 0x09},
+	{0x034b, 0x9f},
+	{0x0220, 0x00},
+	{0x0222, 0x01},
+	{0x0900, 0x01},
+	{0x0901, 0x44},
+	{0x0902, 0x00},
+	{0x034c, 0x03},
+	{0x034d, 0x34},
+	{0x034e, 0x02},
+	{0x034f, 0x68},
+	{0x0301, 0x05},
+	{0x0303, 0x01},
+	{0x0305, 0x02},
+	{0x0306, 0x00},
+	{0x0307, 0x78},
+	{0x030b, 0x01},
+	{0x030d, 0x02},
+	{0x030e, 0x00},
+	{0x030f, 0x4b},
+	{0x0310, 0x00},
+	{0x0700, 0x02},
+	{0x0701, 0x78},
+	{0x0820, 0x0b},
+	{0x0821, 0x40},
+	{0x3088, 0x04},
+	{0x6813, 0x02},
+	{0x6835, 0x07},
+	{0x6836, 0x01},
+	{0x6837, 0x04},
+	{0x684d, 0x07},
+	{0x684e, 0x01},
+	{0x684f, 0x04},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static const char * const imx355_test_pattern_menu[] = {
 	"Disabled",
+<<<<<<< HEAD
 	"100% color bars",
 	"Solid color",
 	"Fade to gray color bars",
@@ -876,6 +1641,18 @@ static const int imx355_test_pattern_val[] = {
 /* Menu items for LINK_FREQ V4L2 control */
 static const s64 link_freq_menu_items[] = {
 	360000000,
+=======
+	"Solid Color",
+	"Color Bars",
+	"Grey Color Bars",
+	"PN9"
+};
+
+/* Configurations for supported link frequencies */
+/* Menu items for LINK_FREQ V4L2 control */
+static const s64 link_freq_menu_items[] = {
+	300800000,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 /* Mode configs */
@@ -883,8 +1660,13 @@ static const struct imx355_mode supported_modes[] = {
 	{
 		.width = 3280,
 		.height = 2464,
+<<<<<<< HEAD
 		.fll_def = 0xa37,
 		.fll_min = 0xa37,
+=======
+		.fll_def = 0xa36,
+		.fll_min = 0xa36,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.llp = 0xe58,
 		.reg_list = {
 			.num_of_regs = ARRAY_SIZE(mode_3280x2464_regs),
@@ -894,8 +1676,13 @@ static const struct imx355_mode supported_modes[] = {
 	{
 		.width = 3268,
 		.height = 2448,
+<<<<<<< HEAD
 		.fll_def = 0xa37,
 		.fll_min = 0xa37,
+=======
+		.fll_def = 0xa36,
+		.fll_min = 0xa36,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.llp = 0xe58,
 		.reg_list = {
 			.num_of_regs = ARRAY_SIZE(mode_3268x2448_regs),
@@ -905,8 +1692,13 @@ static const struct imx355_mode supported_modes[] = {
 	{
 		.width = 3264,
 		.height = 2448,
+<<<<<<< HEAD
 		.fll_def = 0xa37,
 		.fll_min = 0xa37,
+=======
+		.fll_def = 0xa36,
+		.fll_min = 0xa36,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.llp = 0xe58,
 		.reg_list = {
 			.num_of_regs = ARRAY_SIZE(mode_3264x2448_regs),
@@ -1036,10 +1828,38 @@ static const struct imx355_mode supported_modes[] = {
 	},
 };
 
+<<<<<<< HEAD
 static inline struct imx355 *to_imx355(struct v4l2_subdev *_sd)
 {
 	return container_of(_sd, struct imx355, sd);
 }
+=======
+struct imx355 {
+	struct v4l2_subdev sd;
+	struct media_pad pad;
+
+	struct v4l2_ctrl_handler ctrl_handler;
+	/* V4L2 Controls */
+	struct v4l2_ctrl *link_freq;
+	struct v4l2_ctrl *pixel_rate;
+	struct v4l2_ctrl *vblank;
+	struct v4l2_ctrl *hblank;
+	struct v4l2_ctrl *exposure;
+	struct v4l2_ctrl *vflip;
+	struct v4l2_ctrl *hflip;
+
+	/* Current mode */
+	const struct imx355_mode *cur_mode;
+
+	/* Mutex for serialized access */
+	struct mutex mutex;
+
+	/* Streaming on/off */
+	bool streaming;
+};
+
+#define to_imx355(_sd)	container_of(_sd, struct imx355, sd)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* Get bayer order based on flip setting. */
 static __u32 imx355_get_format_code(struct imx355 *imx355)
@@ -1048,12 +1868,23 @@ static __u32 imx355_get_format_code(struct imx355 *imx355)
 	 * Only one bayer order is supported.
 	 * It depends on the flip settings.
 	 */
+<<<<<<< HEAD
 	static const __u32 codes[2][2] = {
 		{ MEDIA_BUS_FMT_SRGGB10_1X10, MEDIA_BUS_FMT_SGRBG10_1X10, },
 		{ MEDIA_BUS_FMT_SGBRG10_1X10, MEDIA_BUS_FMT_SBGGR10_1X10, },
 	};
 
 	return codes[imx355->vflip->val][imx355->hflip->val];
+=======
+	__u32 codes[] = {
+		MEDIA_BUS_FMT_SRGGB10_1X10,
+		MEDIA_BUS_FMT_SGRBG10_1X10,
+		MEDIA_BUS_FMT_SGBRG10_1X10,
+		MEDIA_BUS_FMT_SBGGR10_1X10
+	};
+
+	return codes[imx355->hflip->val | (imx355->vflip->val << 1)];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /* Read registers up to 4 at a time */
@@ -1061,31 +1892,55 @@ static int imx355_read_reg(struct imx355 *imx355, u16 reg, u32 len, u32 *val)
 {
 	struct i2c_client *client = v4l2_get_subdevdata(&imx355->sd);
 	struct i2c_msg msgs[2];
+<<<<<<< HEAD
 	u8 addr_buf[2];
 	u8 data_buf[4] = { 0 };
 	int ret;
+=======
+	u8 *data_be_p;
+	int ret;
+	u32 data_be = 0;
+	u16 reg_addr_be = cpu_to_be16(reg);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (len > 4)
 		return -EINVAL;
 
+<<<<<<< HEAD
 	put_unaligned_be16(reg, addr_buf);
 	/* Write register address */
 	msgs[0].addr = client->addr;
 	msgs[0].flags = 0;
 	msgs[0].len = ARRAY_SIZE(addr_buf);
 	msgs[0].buf = addr_buf;
+=======
+	data_be_p = (u8 *)&data_be;
+	/* Write register address */
+	msgs[0].addr = client->addr;
+	msgs[0].flags = 0;
+	msgs[0].len = 2;
+	msgs[0].buf = (u8 *)&reg_addr_be;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* Read data from register */
 	msgs[1].addr = client->addr;
 	msgs[1].flags = I2C_M_RD;
 	msgs[1].len = len;
+<<<<<<< HEAD
 	msgs[1].buf = &data_buf[4 - len];
+=======
+	msgs[1].buf = &data_be_p[4 - len];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	ret = i2c_transfer(client->adapter, msgs, ARRAY_SIZE(msgs));
 	if (ret != ARRAY_SIZE(msgs))
 		return -EIO;
 
+<<<<<<< HEAD
 	*val = get_unaligned_be32(data_buf);
+=======
+	*val = be32_to_cpu(data_be);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 }
@@ -1094,13 +1949,32 @@ static int imx355_read_reg(struct imx355 *imx355, u16 reg, u32 len, u32 *val)
 static int imx355_write_reg(struct imx355 *imx355, u16 reg, u32 len, u32 val)
 {
 	struct i2c_client *client = v4l2_get_subdevdata(&imx355->sd);
+<<<<<<< HEAD
 	u8 buf[6];
+=======
+	int buf_i, val_i;
+	u8 buf[6], *val_p;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (len > 4)
 		return -EINVAL;
 
+<<<<<<< HEAD
 	put_unaligned_be16(reg, buf);
 	put_unaligned_be32(val << (8 * (4 - len)), buf + 2);
+=======
+	buf[0] = reg >> 8;
+	buf[1] = reg & 0xff;
+
+	val = cpu_to_be32(val);
+	val_p = (u8 *)&val;
+	buf_i = 2;
+	val_i = 4 - len;
+
+	while (val_i < 4)
+		buf[buf_i++] = val_p[val_i++];
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (i2c_master_send(client, buf, len + 2) != len + 2)
 		return -EIO;
 
@@ -1117,7 +1991,11 @@ static int imx355_write_regs(struct imx355 *imx355,
 
 	for (i = 0; i < len; i++) {
 		ret = imx355_write_reg(imx355, regs[i].address, 1,
+<<<<<<< HEAD
 				       regs[i].val);
+=======
+					regs[i].val);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		if (ret) {
 			dev_err_ratelimited(
 				&client->dev,
@@ -1131,12 +2009,27 @@ static int imx355_write_regs(struct imx355 *imx355,
 	return 0;
 }
 
+<<<<<<< HEAD
+=======
+static int imx355_write_reg_list(struct imx355 *imx355,
+				  const struct imx355_reg_list *r_list)
+{
+	return imx355_write_regs(imx355, r_list->regs, r_list->num_of_regs);
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Open sub-device */
 static int imx355_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)
 {
 	struct imx355 *imx355 = to_imx355(sd);
+<<<<<<< HEAD
 	struct v4l2_mbus_framefmt *try_fmt =
 		v4l2_subdev_get_try_format(sd, fh->pad, 0);
+=======
+	struct v4l2_mbus_framefmt *try_fmt = v4l2_subdev_get_try_format(sd,
+									fh->pad,
+									0);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	mutex_lock(&imx355->mutex);
 
@@ -1146,6 +2039,10 @@ static int imx355_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)
 	try_fmt->code = imx355_get_format_code(imx355);
 	try_fmt->field = V4L2_FIELD_NONE;
 
+<<<<<<< HEAD
+=======
+	/* No crop or compose */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	mutex_unlock(&imx355->mutex);
 
 	return 0;
@@ -1153,6 +2050,7 @@ static int imx355_open(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh)
 
 static int imx355_update_digital_gain(struct imx355 *imx355, u32 d_gain)
 {
+<<<<<<< HEAD
 	int ret;
 
 	ret = imx355_write_reg(imx355, IMX355_REG_DPGA_USE_GLOBAL_GAIN, 1, 1);
@@ -1161,12 +2059,26 @@ static int imx355_update_digital_gain(struct imx355 *imx355, u32 d_gain)
 
 	/* Digital gain = (d_gain & 0xFF00) + (d_gain & 0xFF)/256 times */
 	return imx355_write_reg(imx355, IMX355_REG_DIG_GAIN_GLOBAL, 2, d_gain);
+=======
+	return imx355_write_reg(imx355, IMX355_REG_DIGITAL_GAIN,
+				IMX355_REG_VALUE_16BIT, d_gain);
+}
+
+static int imx355_enable_test_pattern(struct imx355 *imx355, u32 pattern)
+{
+	return imx355_write_reg(imx355, IMX355_REG_TEST_PATTERN,
+				 IMX355_REG_VALUE_08BIT, pattern);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx355_set_ctrl(struct v4l2_ctrl *ctrl)
 {
 	struct imx355 *imx355 = container_of(ctrl->handler,
+<<<<<<< HEAD
 					     struct imx355, ctrl_handler);
+=======
+					       struct imx355, ctrl_handler);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct i2c_client *client = v4l2_get_subdevdata(&imx355->sd);
 	s64 max;
 	int ret;
@@ -1186,6 +2098,7 @@ static int imx355_set_ctrl(struct v4l2_ctrl *ctrl)
 	 * Applying V4L2 control value only happens
 	 * when power is up for streaming
 	 */
+<<<<<<< HEAD
 	if (pm_runtime_get_if_in_use(&client->dev) == 0)
 		return 0;
 
@@ -1194,12 +2107,23 @@ static int imx355_set_ctrl(struct v4l2_ctrl *ctrl)
 		/* Analog gain = 1024/(1024 - ctrl->val) times */
 		ret = imx355_write_reg(imx355, IMX355_REG_ANALOG_GAIN,
 				       2, ctrl->val);
+=======
+	if (pm_runtime_get_if_in_use(&client->dev) <= 0)
+		return 0;
+
+	ret = 0;
+	switch (ctrl->id) {
+	case V4L2_CID_ANALOGUE_GAIN:
+		ret = imx355_write_reg(imx355, IMX355_REG_ANALOG_GAIN,
+					IMX355_REG_VALUE_16BIT, ctrl->val);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		break;
 	case V4L2_CID_DIGITAL_GAIN:
 		ret = imx355_update_digital_gain(imx355, ctrl->val);
 		break;
 	case V4L2_CID_EXPOSURE:
 		ret = imx355_write_reg(imx355, IMX355_REG_EXPOSURE,
+<<<<<<< HEAD
 				       2, ctrl->val);
 		break;
 	case V4L2_CID_VBLANK:
@@ -1219,6 +2143,29 @@ static int imx355_set_ctrl(struct v4l2_ctrl *ctrl)
 		break;
 	default:
 		ret = -EINVAL;
+=======
+					IMX355_REG_VALUE_16BIT,
+					ctrl->val);
+		break;
+	case V4L2_CID_VBLANK:
+		/* Update FLL that meets expected vertical blanking */
+		ret = imx355_write_reg(imx355, IMX355_REG_FLL,
+					IMX355_REG_VALUE_16BIT,
+					imx355->cur_mode->height
+					  + ctrl->val);
+		break;
+	case V4L2_CID_TEST_PATTERN:
+		ret = imx355_enable_test_pattern(imx355, ctrl->val);
+		break;
+	case V4L2_CID_HFLIP:
+	case V4L2_CID_VFLIP:
+		ret = imx355_write_reg(imx355, IMX355_REG_ORIENTATION,
+					IMX355_REG_VALUE_08BIT,
+					imx355->hflip->val |
+					imx355->vflip->val << 1);
+		break;
+	default:
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		dev_info(&client->dev,
 			 "ctrl(id:0x%x,val:0x%x) is not handled\n",
 			 ctrl->id, ctrl->val);
@@ -1276,10 +2223,13 @@ static void imx355_update_pad_format(struct imx355 *imx355,
 	fmt->format.height = mode->height;
 	fmt->format.code = imx355_get_format_code(imx355);
 	fmt->format.field = V4L2_FIELD_NONE;
+<<<<<<< HEAD
 	fmt->format.colorspace = V4L2_COLORSPACE_DEFAULT;
 	fmt->format.xfer_func = V4L2_XFER_FUNC_DEFAULT;
 	fmt->format.ycbcr_enc = V4L2_YCBCR_ENC_DEFAULT;
 	fmt->format.quantization = V4L2_QUANTIZATION_DEFAULT;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx355_do_get_pad_format(struct imx355 *imx355,
@@ -1313,6 +2263,42 @@ static int imx355_get_pad_format(struct v4l2_subdev *sd,
 	return ret;
 }
 
+<<<<<<< HEAD
+=======
+/*
+ * Calculate resolution distance
+ */
+static int
+imx355_get_resolution_dist(const struct imx355_mode *mode,
+			    struct v4l2_mbus_framefmt *framefmt)
+{
+	return abs(mode->width - framefmt->width) +
+	       abs(mode->height - framefmt->height);
+}
+
+/*
+ * Find the closest supported resolution to the requested resolution
+ */
+static const struct imx355_mode *
+imx355_find_best_fit(struct imx355 *imx355,
+		      struct v4l2_subdev_format *fmt)
+{
+	int i, dist, cur_best_fit = 0, cur_best_fit_dist = -1;
+	struct v4l2_mbus_framefmt *framefmt = &fmt->format;
+
+	for (i = 0; i < ARRAY_SIZE(supported_modes); i++) {
+		dist = imx355_get_resolution_dist(&supported_modes[i],
+						   framefmt);
+		if (cur_best_fit_dist == -1 || dist < cur_best_fit_dist) {
+			cur_best_fit_dist = dist;
+			cur_best_fit = i;
+		}
+	}
+
+	return &supported_modes[cur_best_fit];
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int
 imx355_set_pad_format(struct v4l2_subdev *sd,
 		       struct v4l2_subdev_pad_config *cfg,
@@ -1334,9 +2320,13 @@ imx355_set_pad_format(struct v4l2_subdev *sd,
 	 */
 	fmt->format.code = imx355_get_format_code(imx355);
 
+<<<<<<< HEAD
 	mode = v4l2_find_nearest_size(supported_modes,
 		ARRAY_SIZE(supported_modes), width, height,
 		fmt->format.width, fmt->format.height);
+=======
+	mode = imx355_find_best_fit(imx355, fmt);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	imx355_update_pad_format(imx355, mode, fmt);
 	if (fmt->which == V4L2_SUBDEV_FORMAT_TRY) {
 		framefmt = v4l2_subdev_get_try_format(sd, cfg, fmt->pad);
@@ -1370,6 +2360,16 @@ imx355_set_pad_format(struct v4l2_subdev *sd,
 	return 0;
 }
 
+<<<<<<< HEAD
+=======
+static int imx355_get_skip_frames(struct v4l2_subdev *sd, u32 *frames)
+{
+	*frames = IMX355_NUM_OF_SKIP_FRAMES;
+
+	return 0;
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Start streaming */
 static int imx355_start_streaming(struct imx355 *imx355)
 {
@@ -1379,7 +2379,11 @@ static int imx355_start_streaming(struct imx355 *imx355)
 
 	/* Global Setting */
 	reg_list = &imx355_global_setting;
+<<<<<<< HEAD
 	ret = imx355_write_regs(imx355, reg_list->regs, reg_list->num_of_regs);
+=======
+	ret = imx355_write_reg_list(imx355, reg_list);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ret) {
 		dev_err(&client->dev, "%s failed to set global settings\n",
 			__func__);
@@ -1388,7 +2392,11 @@ static int imx355_start_streaming(struct imx355 *imx355)
 
 	/* Apply default values of current mode */
 	reg_list = &imx355->cur_mode->reg_list;
+<<<<<<< HEAD
 	ret = imx355_write_regs(imx355, reg_list->regs, reg_list->num_of_regs);
+=======
+	ret = imx355_write_reg_list(imx355, reg_list);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ret) {
 		dev_err(&client->dev, "%s failed to set mode\n", __func__);
 		return ret;
@@ -1400,14 +2408,23 @@ static int imx355_start_streaming(struct imx355 *imx355)
 		return ret;
 
 	return imx355_write_reg(imx355, IMX355_REG_MODE_SELECT,
+<<<<<<< HEAD
 				1, IMX355_MODE_STREAMING);
+=======
+				 IMX355_REG_VALUE_08BIT,
+				 IMX355_MODE_STREAMING);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /* Stop streaming */
 static int imx355_stop_streaming(struct imx355 *imx355)
 {
 	return imx355_write_reg(imx355, IMX355_REG_MODE_SELECT,
+<<<<<<< HEAD
 				1, IMX355_MODE_STANDBY);
+=======
+				 IMX355_REG_VALUE_08BIT, IMX355_MODE_STANDBY);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx355_set_stream(struct v4l2_subdev *sd, int enable)
@@ -1494,7 +2511,12 @@ static int imx355_identify_module(struct imx355 *imx355)
 	int ret;
 	u32 val;
 
+<<<<<<< HEAD
 	ret = imx355_read_reg(imx355, IMX355_REG_CHIP_ID, 2, &val);
+=======
+	ret = imx355_read_reg(imx355, IMX355_REG_CHIP_ID,
+			       IMX355_REG_VALUE_16BIT, &val);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ret)
 		return ret;
 
@@ -1506,11 +2528,14 @@ static int imx355_identify_module(struct imx355 *imx355)
 	return 0;
 }
 
+<<<<<<< HEAD
 static const struct v4l2_subdev_core_ops imx355_subdev_core_ops = {
 	.subscribe_event = v4l2_ctrl_subdev_subscribe_event,
 	.unsubscribe_event = v4l2_event_subdev_unsubscribe,
 };
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static const struct v4l2_subdev_video_ops imx355_video_ops = {
 	.s_stream = imx355_set_stream,
 };
@@ -1522,10 +2547,21 @@ static const struct v4l2_subdev_pad_ops imx355_pad_ops = {
 	.enum_frame_size = imx355_enum_frame_size,
 };
 
+<<<<<<< HEAD
 static const struct v4l2_subdev_ops imx355_subdev_ops = {
 	.core = &imx355_subdev_core_ops,
 	.video = &imx355_video_ops,
 	.pad = &imx355_pad_ops,
+=======
+static const struct v4l2_subdev_sensor_ops imx355_sensor_ops = {
+	.g_skip_frames = imx355_get_skip_frames,
+};
+
+static const struct v4l2_subdev_ops imx355_subdev_ops = {
+	.video = &imx355_video_ops,
+	.pad = &imx355_pad_ops,
+	.sensor = &imx355_sensor_ops,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static const struct media_entity_operations imx355_subdev_entity_ops = {
@@ -1554,6 +2590,10 @@ static int imx355_init_controls(struct imx355 *imx355)
 	if (ret)
 		return ret;
 
+<<<<<<< HEAD
+=======
+	mutex_init(&imx355->mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	ctrl_hdlr->lock = &imx355->mutex;
 	imx355->link_freq = v4l2_ctrl_new_int_menu(ctrl_hdlr,
 				&imx355_ctrl_ops,
@@ -1561,8 +2601,12 @@ static int imx355_init_controls(struct imx355 *imx355)
 				0,
 				0,
 				link_freq_menu_items);
+<<<<<<< HEAD
 	if (imx355->link_freq)
 		imx355->link_freq->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+=======
+	imx355->link_freq->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* pixel_rate = link_freq * 2 * nr_of_lanes / bits_per_sample */
 	pixel_rate = (link_freq_menu_items[0] * 2 * 4) / 10;
@@ -1585,8 +2629,12 @@ static int imx355_init_controls(struct imx355 *imx355)
 	imx355->hblank = v4l2_ctrl_new_std(
 				ctrl_hdlr, &imx355_ctrl_ops, V4L2_CID_HBLANK,
 				hblank, hblank, 1, hblank);
+<<<<<<< HEAD
 	if (imx355->hblank)
 		imx355->hblank->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+=======
+	imx355->hblank->flags |= V4L2_CTRL_FLAG_READ_ONLY;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	exposure_max = mode->fll_def - 10;
 	imx355->exposure = v4l2_ctrl_new_std(
@@ -1628,6 +2676,10 @@ static int imx355_init_controls(struct imx355 *imx355)
 
 error:
 	v4l2_ctrl_handler_free(ctrl_hdlr);
+<<<<<<< HEAD
+=======
+	mutex_destroy(&imx355->mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return ret;
 }
@@ -1635,6 +2687,10 @@ static int imx355_init_controls(struct imx355 *imx355)
 static void imx355_free_controls(struct imx355 *imx355)
 {
 	v4l2_ctrl_handler_free(imx355->sd.ctrl_handler);
+<<<<<<< HEAD
+=======
+	mutex_destroy(&imx355->mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int imx355_probe(struct i2c_client *client,
@@ -1647,8 +2703,11 @@ static int imx355_probe(struct i2c_client *client,
 	if (!imx355)
 		return -ENOMEM;
 
+<<<<<<< HEAD
 	mutex_init(&imx355->mutex);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* Initialize subdev */
 	v4l2_i2c_subdev_init(&imx355->sd, client, &imx355_subdev_ops);
 
@@ -1656,13 +2715,18 @@ static int imx355_probe(struct i2c_client *client,
 	ret = imx355_identify_module(imx355);
 	if (ret) {
 		dev_err(&client->dev, "failed to find sensor: %d\n", ret);
+<<<<<<< HEAD
 		goto error_probe;
+=======
+		return ret;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 
 	/* Set default mode to max resolution */
 	imx355->cur_mode = &supported_modes[0];
 
 	ret = imx355_init_controls(imx355);
+<<<<<<< HEAD
 	if (ret) {
 		dev_err(&client->dev, "failed to init controls: %d\n", ret);
 		goto error_probe;
@@ -1672,6 +2736,14 @@ static int imx355_probe(struct i2c_client *client,
 	imx355->sd.internal_ops = &imx355_internal_ops;
 	imx355->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE |
 				V4L2_SUBDEV_FL_HAS_EVENTS;
+=======
+	if (ret)
+		return ret;
+
+	/* Initialize subdev */
+	imx355->sd.internal_ops = &imx355_internal_ops;
+	imx355->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	imx355->sd.entity.ops = &imx355_subdev_entity_ops;
 	imx355->sd.entity.function = MEDIA_ENT_F_CAM_SENSOR;
 
@@ -1683,7 +2755,11 @@ static int imx355_probe(struct i2c_client *client,
 		goto error_handler_free;
 	}
 
+<<<<<<< HEAD
 	ret = v4l2_async_register_subdev_sensor_common(&imx355->sd);
+=======
+	ret = v4l2_async_register_subdev(&imx355->sd);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ret < 0)
 		goto error_media_entity;
 
@@ -1691,9 +2767,16 @@ static int imx355_probe(struct i2c_client *client,
 	 * Device is already turned on by i2c-core with ACPI domain PM.
 	 * Enable runtime PM and turn off the device.
 	 */
+<<<<<<< HEAD
 	pm_runtime_set_active(&client->dev);
 	pm_runtime_enable(&client->dev);
 	pm_runtime_idle(&client->dev);
+=======
+	pm_runtime_get_noresume(&client->dev);
+	pm_runtime_set_active(&client->dev);
+	pm_runtime_enable(&client->dev);
+	pm_runtime_put(&client->dev);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 
@@ -1702,9 +2785,13 @@ static int imx355_probe(struct i2c_client *client,
 
 error_handler_free:
 	imx355_free_controls(imx355);
+<<<<<<< HEAD
 
 error_probe:
 	mutex_destroy(&imx355->mutex);
+=======
+	dev_err(&client->dev, "%s failed:%d\n", __func__, ret);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return ret;
 }
@@ -1718,41 +2805,78 @@ static int imx355_remove(struct i2c_client *client)
 	media_entity_cleanup(&sd->entity);
 	imx355_free_controls(imx355);
 
+<<<<<<< HEAD
 	pm_runtime_disable(&client->dev);
 	pm_runtime_set_suspended(&client->dev);
 
 	mutex_destroy(&imx355->mutex);
+=======
+	/*
+	 * Disable runtime PM but keep the device turned on.
+	 * i2c-core with ACPI domain PM will turn off the device.
+	 */
+	pm_runtime_get_sync(&client->dev);
+	pm_runtime_disable(&client->dev);
+	pm_runtime_set_suspended(&client->dev);
+	pm_runtime_put_noidle(&client->dev);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 }
 
 static const struct i2c_device_id imx355_id_table[] = {
+<<<<<<< HEAD
 	{ "imx355", 0 },
 	{ /* sentinel */ },
 };
+=======
+	{"imx355", 0},
+	{},
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 MODULE_DEVICE_TABLE(i2c, imx355_id_table);
 
 static const struct dev_pm_ops imx355_pm_ops = {
 	SET_SYSTEM_SLEEP_PM_OPS(imx355_suspend, imx355_resume)
 };
 
+<<<<<<< HEAD
 static const struct acpi_device_id imx355_acpi_ids[] = {
 	{"SONY355A"},
 	{ /* sentinel */ }
 };
 MODULE_DEVICE_TABLE(acpi, imx355_acpi_ids);
+=======
+#ifdef CONFIG_ACPI
+static const struct acpi_device_id imx355_acpi_ids[] = {
+	{"IMX355"},
+	{ /* sentinel */ }
+};
+
+MODULE_DEVICE_TABLE(acpi, imx355_acpi_ids);
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static struct i2c_driver imx355_i2c_driver = {
 	.driver = {
 		.name = "imx355",
 		.owner = THIS_MODULE,
 		.pm = &imx355_pm_ops,
+<<<<<<< HEAD
 		.acpi_match_table = ACPI_PTR(imx355_acpi_ids),
+=======
+		/*.acpi_match_table = ACPI_PTR(imx355_acpi_ids),*/
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	.probe = imx355_probe,
 	.remove = imx355_remove,
 	.id_table = imx355_id_table,
 };
+<<<<<<< HEAD
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 module_i2c_driver(imx355_i2c_driver);
 
 MODULE_AUTHOR("Qiu, Tianshu <tian.shu.qiu@intel.com>");
diff --git a/drivers/media/i2c/lc898122/Makefile b/drivers/media/i2c/lc898122/Makefile
index 4ad76ba..0074ac2 100644
--- a/drivers/media/i2c/lc898122/Makefile
+++ b/drivers/media/i2c/lc898122/Makefile
@@ -1,5 +1,20 @@
+<<<<<<< HEAD
 # SPDX-License-Identifier: GPL-2.0
 # Copyright (c) 2010 - 2018, Intel Corporation.
+=======
+#
+#  Copyright (c) 2010 - 2018 Intel Corporation.
+#
+#  This program is free software; you can redistribute it and/or modify it
+#  under the terms and conditions of the GNU General Public License,
+#  version 2, as published by the Free Software Foundation.
+#
+#  This program is distributed in the hope it will be useful, but WITHOUT
+#  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+#  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+#  more details.
+#
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ifneq ($(EXTERNAL_BUILD), 1)
 srcpath := $(srctree)
diff --git a/drivers/media/i2c/lc898122/lc898122-oiscmd.c b/drivers/media/i2c/lc898122/lc898122-oiscmd.c
index 4bb4b26..aa295ea 100644
--- a/drivers/media/i2c/lc898122/lc898122-oiscmd.c
+++ b/drivers/media/i2c/lc898122/lc898122-oiscmd.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  * Copyright (C) ON Semiconductor
  *
diff --git a/drivers/media/i2c/lc898122/lc898122-oisfil.h b/drivers/media/i2c/lc898122/lc898122-oisfil.h
index 5e73e507..53af15e 100644
--- a/drivers/media/i2c/lc898122/lc898122-oisfil.h
+++ b/drivers/media/i2c/lc898122/lc898122-oisfil.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  * Copyright (C) ON Semiconductor
  *
diff --git a/drivers/media/i2c/lc898122/lc898122-oisinit.c b/drivers/media/i2c/lc898122/lc898122-oisinit.c
index 429eb70..2f9b894 100644
--- a/drivers/media/i2c/lc898122/lc898122-oisinit.c
+++ b/drivers/media/i2c/lc898122/lc898122-oisinit.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  * Copyright (C) ON Semiconductor
  *
diff --git a/drivers/media/i2c/lc898122/lc898122-oisinit.h b/drivers/media/i2c/lc898122/lc898122-oisinit.h
index d619fe0..eb3bc85 100644
--- a/drivers/media/i2c/lc898122/lc898122-oisinit.h
+++ b/drivers/media/i2c/lc898122/lc898122-oisinit.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  * Copyright (C) ON Semiconductor
  *
diff --git a/drivers/media/i2c/lc898122/lc898122-regs.h b/drivers/media/i2c/lc898122/lc898122-regs.h
index 74caa384..ac3fc41 100644
--- a/drivers/media/i2c/lc898122/lc898122-regs.h
+++ b/drivers/media/i2c/lc898122/lc898122-regs.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  * Copyright (C) ON Semiconductor
  *
diff --git a/drivers/media/i2c/lc898122/lc898122.c b/drivers/media/i2c/lc898122/lc898122.c
index 1abf559..f55fc6d 100644
--- a/drivers/media/i2c/lc898122/lc898122.c
+++ b/drivers/media/i2c/lc898122/lc898122.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2015 - 2018 Intel Corporation
 
 #include <linux/gpio.h>
@@ -172,7 +176,10 @@ int lc898122_read_long(struct i2c_client *client, u16 reg, u32 *val)
 	return 0;
 }
 
+<<<<<<< HEAD
 #ifdef CONFIG_PM
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int lc898122_adjust_af_parameters(struct lc898122_device *lc898122_dev)
 {
 	struct i2c_client *client = lc898122_dev->client;
@@ -248,9 +255,12 @@ static int lc898122_adjust_af_parameters(struct lc898122_device *lc898122_dev)
 
 	return 0;
 }
+<<<<<<< HEAD
 #else
 #define lc898122_adjust_af_parameters NULL
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 
 /*
@@ -516,7 +526,10 @@ static int lc898122_remove(struct i2c_client *client)
 	return 0;
 }
 
+<<<<<<< HEAD
 #ifdef CONFIG_PM
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int lc898122_poweron_init(struct lc898122_device *lc898122_dev)
 {
 	int rval = 0;
@@ -541,6 +554,10 @@ static int lc898122_poweron_init(struct lc898122_device *lc898122_dev)
 	return rval;
 }
 
+<<<<<<< HEAD
+=======
+#ifdef CONFIG_PM
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static void lc898122_complete(struct device *dev)
 {
 	struct i2c_client *client = to_i2c_client(dev);
@@ -602,7 +619,10 @@ static int lc898122_runtime_resume(struct device *dev)
 }
 
 #else
+<<<<<<< HEAD
 #define lc898122_poweron_init		NULL
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define lc898122_complete		NULL
 #define lc898122_runtime_suspend	NULL
 #define lc898122_runtime_resume		NULL
diff --git a/drivers/media/i2c/lc898122/lc898122.h b/drivers/media/i2c/lc898122/lc898122.h
index 5edf017..aa16c6f 100644
--- a/drivers/media/i2c/lc898122/lc898122.h
+++ b/drivers/media/i2c/lc898122/lc898122.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation */
 
 #ifndef __LC898122_H__
diff --git a/drivers/media/i2c/lm3643.c b/drivers/media/i2c/lm3643.c
index 695a238..2cadb0a 100644
--- a/drivers/media/i2c/lm3643.c
+++ b/drivers/media/i2c/lm3643.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  *
  * Lm3560 and other TI drivers used for this, written by
diff --git a/drivers/media/i2c/max9286-reg-settings.h b/drivers/media/i2c/max9286-reg-settings.h
index f03e6fc..b577785 100644
--- a/drivers/media/i2c/max9286-reg-settings.h
+++ b/drivers/media/i2c/max9286-reg-settings.h
@@ -20,11 +20,17 @@
 #define DS_FSYNC_PERIOD_HIGH      0x08
 #define DS_FWDCCEN_REVCCEN        0x0A
 #define DS_LINK_OUTORD            0x0B
+<<<<<<< HEAD
 #define DS_HS_VS                  0x0C
 #define DS_CSI_DBL_DT             0x12
 #define DS_CSI_VC_CTL             0x15
 #define DS_ENEQ                   0x1B
 #define DS_HIGHIMM                0x1C
+=======
+#define DS_CSI_DBL_DT             0x12
+#define DS_CSI_VC_CTL             0x15
+#define DS_ENEQ                   0x1B
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define DS_MAX9286_DEVID          0x1E
 #define DS_FSYNC_LOCKED           0x31
 #define DS_I2CLOCACK              0x34
@@ -46,6 +52,7 @@
 #define S_I2C_SOURCE_SER          0x0B
 #define S_I2C_DST_SER             0x0C
 #define S_INPUT_STATUS            0x15
+<<<<<<< HEAD
 #define S_SYNC_GEN_CONFIG         0x43
 #define S_VS_DLY_2                0x44
 #define S_VS_DLY_1                0x45
@@ -53,6 +60,8 @@
 #define S_VS_H_1                  0x48
 #define S_VS_H_0                  0x49
 #define S_DBL_ALIGN_TO            0x67
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define S_RSVD_97                 0x97
 
 struct max9286_register_write {
@@ -60,6 +69,7 @@ struct max9286_register_write {
 	u8 val;
 };
 
+<<<<<<< HEAD
 static const struct max9286_register_write max9286_byte_order_settings_12bit[] = {
 	{0x20, 0x0B},
 	{0x21, 0x0A},
@@ -110,4 +120,34 @@ static const struct max9286_register_write max9286_byte_order_settings_10bit[] =
 	{0x39, 0x10},
 };
 
+=======
+static const struct max9286_register_write max9286_byte_order_settings[] = {
+	{0x20, 0x0C},
+	{0x21, 0x0B},
+	{0x22, 0x0A},
+	{0x23, 0x09},
+	{0x24, 0x08},
+	{0x25, 0x07},
+	{0x26, 0x06},
+	{0x27, 0x05},
+	{0x28, 0x04},
+	{0x29, 0x03},
+	{0x2A, 0x02},
+	{0x2B, 0x01},
+	{0x2C, 0x00},
+	{0x30, 0x1C},
+	{0x31, 0x1B},
+	{0x32, 0x1A},
+	{0x33, 0x19},
+	{0x34, 0x18},
+	{0x35, 0x17},
+	{0x36, 0x16},
+	{0x37, 0x15},
+	{0x38, 0x14},
+	{0x39, 0x13},
+	{0x3A, 0x12},
+	{0x3B, 0x11},
+	{0x3C, 0x10},
+};
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
diff --git a/drivers/media/i2c/max9286.c b/drivers/media/i2c/max9286.c
index b54bcf4..eb973a1 100644
--- a/drivers/media/i2c/max9286.c
+++ b/drivers/media/i2c/max9286.c
@@ -11,7 +11,10 @@
 #include <media/media-device.h>
 #include <media/media-entity.h>
 #include <media/max9286.h>
+<<<<<<< HEAD
 #include <media/crlmodule.h>
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <media/v4l2-device.h>
 #include <media/videobuf2-core.h>
 
@@ -155,6 +158,7 @@ max96705_read_register(struct max9286 *max, unsigned int i, u8 reg)
 	return val;
 }
 
+<<<<<<< HEAD
 /* Validate csi_data_format */
 static const struct max9286_csi_data_format *
 max9286_validate_csi_data_format(u32 code)
@@ -169,17 +173,25 @@ max9286_validate_csi_data_format(u32 code)
 	return &max_csi_data_formats[0];
 }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Initialize image sensors and set stream on registers */
 static int max9286_set_stream(struct v4l2_subdev *subdev, int enable)
 {
 	struct max9286 *max = to_max_9286(subdev);
 	struct media_pad *remote_pad;
 	struct v4l2_subdev *sd;
+<<<<<<< HEAD
 	int i, rval, j;
 	unsigned int val;
 	u8 slval = 0xE0;
 	u8 dtval = 0xF7;
 	const struct max9286_register_write *max9286_byte_order_settings;
+=======
+	int i, rval;
+	unsigned int val;
+	u8 slval = 0;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	dev_dbg(max->v4l2_sd.dev, "MAX9286 set stream. enable = %d\n", enable);
 
@@ -200,6 +212,7 @@ static int max9286_set_stream(struct v4l2_subdev *subdev, int enable)
 		if (!remote_pad)
 			continue;
 
+<<<<<<< HEAD
 		if (enable) {
 			/*
 			 * Enable CSI-2 lanes D0, D1, D2, D3
@@ -246,6 +259,9 @@ static int max9286_set_stream(struct v4l2_subdev *subdev, int enable)
 
 		/* Enable link */
 		slval |= (0x0F & (1 << i));
+=======
+		slval = 0xEF;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		rval = regmap_write(max->regmap8, DS_LINK_ENABLE, slval);
 		if (rval) {
 			dev_err(max->v4l2_sd.dev,
@@ -267,6 +283,10 @@ static int max9286_set_stream(struct v4l2_subdev *subdev, int enable)
 				sd->name, enable);
 			return rval;
 		}
+<<<<<<< HEAD
+=======
+		break;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 
 	/* Enable I2C ACK */
@@ -295,6 +315,7 @@ static int max9286_set_stream(struct v4l2_subdev *subdev, int enable)
 		S_ADDR_MAX96705, S_CMLLVL_PREEMP, 0xAA);
 	usleep_range(5000, 6000);
 
+<<<<<<< HEAD
 	/* Set VSYNC Delay */
 	max96705_write_register(max, S_ADDR_MAX96705_BROADCAST -
 		S_ADDR_MAX96705, S_SYNC_GEN_CONFIG, 0x21);
@@ -324,6 +345,8 @@ static int max9286_set_stream(struct v4l2_subdev *subdev, int enable)
 		S_ADDR_MAX96705, S_DBL_ALIGN_TO, 0xC4);
 	usleep_range(5000, 6000);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* Enable link equalizers */
 	rval = regmap_write(max->regmap8, DS_ENEQ, 0x0F);
 	if (rval) {
@@ -332,7 +355,11 @@ static int max9286_set_stream(struct v4l2_subdev *subdev, int enable)
 		return rval;
 	}
 	usleep_range(5000, 6000);
+<<<<<<< HEAD
 	rval = regmap_write(max->regmap8, DS_HS_VS, 0x91);
+=======
+	rval = regmap_write(max->regmap8, 0x0C, 0x91);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* Enable serial links and desable configuration */
 	max96705_write_register(max, S_ADDR_MAX96705_BROADCAST -
@@ -419,6 +446,23 @@ static int max9286_get_format(struct v4l2_subdev *subdev,
 	return 0;
 }
 
+<<<<<<< HEAD
+=======
+/* Validate csi_data_format */
+static const struct max9286_csi_data_format *
+max9286_validate_csi_data_format(u32 code)
+{
+	unsigned int i;
+
+	for (i = 0; i < ARRAY_SIZE(max_csi_data_formats); i++) {
+		if (max_csi_data_formats[i].code == code)
+			return &max_csi_data_formats[i];
+	}
+
+	return &max_csi_data_formats[0];
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* callback for VIDIOC_SUBDEV_S_FMT ioctl handler code */
 static int max9286_set_format(struct v4l2_subdev *subdev,
 	struct v4l2_subdev_pad_config *cfg,
@@ -614,7 +658,10 @@ static int max9286_open(struct v4l2_subdev *subdev,
 static int max9286_registered(struct v4l2_subdev *subdev)
 {
 	struct max9286 *max = to_max_9286(subdev);
+<<<<<<< HEAD
 	struct i2c_client *client = v4l2_get_subdevdata(subdev);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	int i, j, k, l, rval, num, nsinks;
 
 	num = max->pdata->subdev_num;
@@ -622,6 +669,7 @@ static int max9286_registered(struct v4l2_subdev *subdev)
 	for (i = 0, k = 0; (i < num) && (k < nsinks); i++, k++) {
 		struct max9286_subdev_i2c_info *info =
 			&max->pdata->subdev_info[i];
+<<<<<<< HEAD
 		struct crlmodule_platform_data *pdata =
 		    (struct crlmodule_platform_data *)
 		    info->board_info.platform_data;
@@ -633,6 +681,15 @@ static int max9286_registered(struct v4l2_subdev *subdev)
 		max->sub_devs[k] = v4l2_i2c_new_subdev_board(
 			max->v4l2_sd.v4l2_dev, client->adapter,
 			&info->board_info, 0);
+=======
+		struct i2c_adapter *adapter;
+
+		adapter = i2c_get_adapter(info->i2c_adapter_id);
+		max->sub_devs[k] = v4l2_i2c_new_subdev_board(
+			max->v4l2_sd.v4l2_dev, adapter,
+			&info->board_info, 0);
+		i2c_put_adapter(adapter);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		if (!max->sub_devs[k]) {
 			dev_err(max->v4l2_sd.dev,
 				"can't create new i2c subdev %d-%04x\n",
@@ -736,7 +793,11 @@ static const struct v4l2_ctrl_ops max9286_ctrl_ops = {
 	.s_ctrl = max9286_s_ctrl,
 };
 
+<<<<<<< HEAD
 static const s64 max9286_op_sys_clock[] = { 87750000, };
+=======
+static const s64 max9286_op_sys_clock[] = { 264000000, };
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static const struct v4l2_ctrl_config max9286_controls[] = {
 	{
 		.ops = &max9286_ctrl_ops,
@@ -770,8 +831,13 @@ static int max9286_register_subdev(struct max9286 *max)
 	/* subdevice driver initializes v4l2 subdev */
 	v4l2_subdev_init(&max->v4l2_sd, &max9286_sd_ops);
 	snprintf(max->v4l2_sd.name, sizeof(max->v4l2_sd.name),
+<<<<<<< HEAD
 		"MAX9286 %c", max->pdata->suffix);
 
+=======
+		"MAX9286 %d-%4.4x", i2c_adapter_id(client->adapter),
+		client->addr);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	max->v4l2_sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE |
 		V4L2_SUBDEV_FL_HAS_SUBSTREAMS;
 
@@ -942,6 +1008,7 @@ static int max9286_init(struct max9286 *max, struct i2c_client *client)
 	 * Enable CSI-2 lanes D0, D1, D2, D3
 	 * Enable CSI-2 DBL (Double Input Mode)
 	 * Enable GMSL DBL for RAWx2
+<<<<<<< HEAD
 	 * Enable RAW12 data type by default
 	 */
 	rval = regmap_write(max->regmap8, DS_CSI_DBL_DT, 0xF7); //RAW12
@@ -951,12 +1018,26 @@ static int max9286_init(struct max9286 *max, struct i2c_client *client)
 	}
 	usleep_range(2000, 3000);
 
+=======
+	 * Enable YUV422 8-bit data type
+	 */
+	rval = regmap_write(max->regmap8, DS_CSI_DBL_DT, 0xF7);
+	if (rval) {
+		dev_err(max->v4l2_sd.dev, "Failed to disable PRBS test!\n");
+		return rval;
+	}
+	usleep_range(2000, 3000);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* Enable Frame sync Auto-mode for row/column reset on frame sync
 	 * sensors
 	 */
 	rval = regmap_write(max->regmap8, DS_FSYNCMODE, 0x00);
 	if (rval) {
+<<<<<<< HEAD
 		dev_err(max->v4l2_sd.dev, "Failed to set frame sync mode!\n");
+=======
+		dev_err(max->v4l2_sd.dev, "Failed to disable PRBS test!\n");
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		return rval;
 	}
 	usleep_range(2000, 3000);
@@ -967,6 +1048,7 @@ static int max9286_init(struct max9286 *max, struct i2c_client *client)
 	rval = regmap_write(max->regmap8, DS_FSYNC_PERIOD_MIDDLE, 0xc2);
 	rval = regmap_write(max->regmap8, DS_FSYNC_PERIOD_HIGH, 0x2C);
 
+<<<<<<< HEAD
 	rval = regmap_write(max->regmap8, DS_HIGHIMM, 0x06);
 
 	/*
@@ -981,6 +1063,12 @@ static int max9286_init(struct max9286 *max, struct i2c_client *client)
 		rval = max96705_write_register(max, 0,
 				max9286_byte_order_settings_12bit[i].reg,
 				max9286_byte_order_settings_12bit[i].val);
+=======
+	for (i = 0; i < ARRAY_SIZE(max9286_byte_order_settings); i++) {
+		rval = max96705_write_register(max, 0,
+				max9286_byte_order_settings[i].reg,
+				max9286_byte_order_settings[i].val);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		if (rval) {
 			dev_err(max->v4l2_sd.dev,
 				"Failed to set max9286 byte order\n");
@@ -1034,6 +1122,17 @@ static int max9286_init(struct max9286 *max, struct i2c_client *client)
 
 	slval = 0xE0 | max->sensor_present;
 
+<<<<<<< HEAD
+=======
+	/*
+	 * Enable DBL
+	 * Edge select: Rising Edge
+	 * Enable HS/VS encoding
+	 */
+	max96705_write_register(max, 0, S_CONFIG, 0x94);
+	usleep_range(2000, 3000);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	mval = 0;
 	tmval = 0;
 	/*
diff --git a/drivers/media/i2c/ov8856.c b/drivers/media/i2c/ov8856.c
index 9c8fabd0..98e10d0 100644
--- a/drivers/media/i2c/ov8856.c
+++ b/drivers/media/i2c/ov8856.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2017 - 2018 Intel Corporation
 
 #include <linux/acpi.h>
diff --git a/drivers/media/i2c/ti964-reg.h b/drivers/media/i2c/ti964-reg.h
index e916c41..a0c0a94 100644
--- a/drivers/media/i2c/ti964-reg.h
+++ b/drivers/media/i2c/ti964-reg.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef TI964_REG_H
diff --git a/drivers/media/i2c/ti964.c b/drivers/media/i2c/ti964.c
index 3af5c68..d13d63f 100644
--- a/drivers/media/i2c/ti964.c
+++ b/drivers/media/i2c/ti964.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2016 - 2018 Intel Corporation
 
 #include <linux/device.h>
@@ -343,11 +347,18 @@ static int ti964_get_frame_desc(struct v4l2_subdev *sd,
 	int i;
 
 	desc->type = V4L2_MBUS_FRAME_DESC_TYPE_CSI2;
+<<<<<<< HEAD
 	desc->num_entries = min_t(int, va->nstreams, V4L2_FRAME_DESC_ENTRY_MAX);
 
 	for (i = 0; i < desc->num_entries; i++) {
 		struct v4l2_mbus_framefmt *ffmt =
 			&va->ffmts[TI964_PAD_SOURCE][i];
+=======
+
+	for (i = 0; i < min_t(int, va->nstreams, desc->num_entries); i++) {
+		struct v4l2_mbus_framefmt *ffmt =
+			&va->ffmts[i][TI964_PAD_SOURCE];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		const struct ti964_csi_data_format *csi_format =
 			ti964_validate_csi_data_format(ffmt->code);
 
@@ -458,7 +469,10 @@ static int ti964_open(struct v4l2_subdev *subdev,
 static int ti964_registered(struct v4l2_subdev *subdev)
 {
 	struct ti964 *va = to_ti964(subdev);
+<<<<<<< HEAD
 	struct i2c_client *client = v4l2_get_subdevdata(subdev);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	int i, j, k, l, rval;
 
 	for (i = 0, k = 0; i < va->pdata->subdev_num; i++) {
@@ -467,6 +481,10 @@ static int ti964_registered(struct v4l2_subdev *subdev)
 		struct crlmodule_platform_data *pdata =
 			(struct crlmodule_platform_data *)
 			info->board_info.platform_data;
+<<<<<<< HEAD
+=======
+		struct i2c_adapter *adapter;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 		if (k >= va->nsinks)
 			break;
@@ -486,9 +504,12 @@ static int ti964_registered(struct v4l2_subdev *subdev)
 		/* If 0 is xshutdown, then 1 would be FSIN, vice versa. */
 		va->sub_devs[k].fsin_gpio = 1 - va->subdev_pdata[k].xshutdown;
 
+<<<<<<< HEAD
 		/* Spin sensor subdev suffix name */
 		va->subdev_pdata[k].suffix = info->suffix;
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		/*
 		 * Change the gpio value to have xshutdown
 		 * and rx port included, so in gpio_set those
@@ -515,10 +536,18 @@ static int ti964_registered(struct v4l2_subdev *subdev)
 		if (rval)
 			return rval;
 
+<<<<<<< HEAD
 		/* aggre and subdves share the same i2c bus */
 		va->sub_devs[k].sd = v4l2_i2c_new_subdev_board(
 			va->sd.v4l2_dev, client->adapter,
 			&info->board_info, 0);
+=======
+		adapter = i2c_get_adapter(info->i2c_adapter_id);
+		va->sub_devs[k].sd = v4l2_i2c_new_subdev_board(
+			va->sd.v4l2_dev, adapter,
+			&info->board_info, 0);
+		i2c_put_adapter(adapter);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		if (!va->sub_devs[k].sd) {
 			dev_err(va->sd.dev,
 				"can't create new i2c subdev %d-%04x\n",
@@ -1027,8 +1056,13 @@ static int ti964_register_subdev(struct ti964 *va)
 	struct i2c_client *client = v4l2_get_subdevdata(&va->sd);
 
 	v4l2_subdev_init(&va->sd, &ti964_sd_ops);
+<<<<<<< HEAD
 	snprintf(va->sd.name, sizeof(va->sd.name), "TI964 %c",
 		 va->pdata->suffix);
+=======
+	snprintf(va->sd.name, sizeof(va->sd.name), "TI964 %d-%4.4x",
+		i2c_adapter_id(client->adapter), client->addr);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	va->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE |
 			V4L2_SUBDEV_FL_HAS_SUBSTREAMS;
diff --git a/drivers/media/i2c/vcm_stub.c b/drivers/media/i2c/vcm_stub.c
index 773c2a3..ba8cf4e 100644
--- a/drivers/media/i2c/vcm_stub.c
+++ b/drivers/media/i2c/vcm_stub.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2017 - 2018 Intel Corporation
 
 #include <linux/i2c.h>
diff --git a/drivers/media/i2c/vcm_stub.h b/drivers/media/i2c/vcm_stub.h
index f609ed2..2ec5dd4 100644
--- a/drivers/media/i2c/vcm_stub.h
+++ b/drivers/media/i2c/vcm_stub.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2017 - 2018 Intel Corporation */
 
 #ifndef _VCM_STUB_H_
diff --git a/drivers/media/pci/intel/Kconfig b/drivers/media/pci/intel/Kconfig
index fca22a7..a3ea4ac 100644
--- a/drivers/media/pci/intel/Kconfig
+++ b/drivers/media/pci/intel/Kconfig
@@ -1,6 +1,10 @@
 config VIDEO_INTEL_IPU
 	tristate "Intel IPU driver"
+<<<<<<< HEAD
 	depends on ACPI && X86_64
+=======
+	depends on ACPI
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	select IOMMU_API
 	select IOMMU_IOVA
 	select X86_DEV_DMA_OPS if X86
@@ -44,6 +48,7 @@ config VIDEO_INTEL_IPU_FW_LIB
 	---help---
 	If selected, the firmware hostlib css would be compiled
 
+<<<<<<< HEAD
 config VIDEO_INTEL_IPU_WERROR
 	bool "Force GCC to throw an error instead of a warning when compiling"
 	depends on VIDEO_INTEL_IPU
@@ -89,3 +94,5 @@ config VIDEO_INTEL_IPU_VIRTIO_FE
     Configuring IPU4 driver as virtio frontend
 
 endchoice
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/Makefile b/drivers/media/pci/intel/Makefile
index 0aeba66..e9dae01 100644
--- a/drivers/media/pci/intel/Makefile
+++ b/drivers/media/pci/intel/Makefile
@@ -1,3 +1,4 @@
+<<<<<<< HEAD
 # SPDX-License-Identifier: GPL-2.0
 # Copyright (c) 2010 - 2018, Intel Corporation.
 
@@ -14,4 +15,20 @@ obj-$(CONFIG_VIDEO_INTEL_IPU_ACRN)	+= virtio/
 ifndef CONFIG_VIDEO_INTEL_ICI
 obj-$(CONFIG_VIDEO_INTEL_IPU4)	+= ipu4/
 endif
+=======
+#
+#  Copyright (c) 2010 - 2018 Intel Corporation.
+#
+#  This program is free software; you can redistribute it and/or modify it
+#  under the terms and conditions of the GNU General Public License,
+#  version 2, as published by the Free Software Foundation.
+#
+#  This program is distributed in the hope it will be useful, but WITHOUT
+#  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+#  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+#  more details.
+#
+
+obj-$(CONFIG_VIDEO_INTEL_IPU4)	+= ipu4/
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 obj-$(CONFIG_VIDEO_INTEL_IPU4P)	+= ipu4/
diff --git a/drivers/media/pci/intel/ipu-bus.c b/drivers/media/pci/intel/ipu-bus.c
index 30e5033..b978b53 100644
--- a/drivers/media/pci/intel/ipu-bus.c
+++ b/drivers/media/pci/intel/ipu-bus.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/delay.h>
@@ -155,7 +159,11 @@ static int bus_pm_runtime_resume(struct device *dev)
 	return -EBUSY;
 }
 
+<<<<<<< HEAD
 static const struct dev_pm_ops ipu_bus_pm_ops = {
+=======
+const struct dev_pm_ops ipu_bus_pm_ops = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.runtime_suspend = bus_pm_runtime_suspend,
 	.runtime_resume = bus_pm_runtime_resume,
 };
@@ -189,6 +197,7 @@ static struct ipu_dma_mapping *alloc_dma_mapping(struct device *dev)
 		return NULL;
 	}
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 0, 0)
+<<<<<<< HEAD
 	init_iova_domain(&dmap->iovad, dma_get_mask(dev) >> PAGE_SHIFT);
 #elif LINUX_VERSION_CODE < KERNEL_VERSION(4, 15, 0)
 	init_iova_domain(&dmap->iovad, SZ_4K, 1,
@@ -196,6 +205,13 @@ static struct ipu_dma_mapping *alloc_dma_mapping(struct device *dev)
 #else
 	init_iova_domain(&dmap->iovad, SZ_4K, 1);
 #endif
+=======
+	init_iova_domain(&dmap->iovad,
+#else
+	init_iova_domain(&dmap->iovad, SZ_4K, 1,
+#endif
+			 dma_get_mask(dev) >> PAGE_SHIFT);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	kref_init(&dmap->ref);
 
@@ -372,7 +388,10 @@ struct ipu_bus_device *ipu_bus_add_device(struct pci_dev *pdev,
 				      IPU_MMU_ADDRESS_BITS :
 				      IPU_MMU_ADDRESS_BITS_NON_SECURE);
 	adev->dev.dma_mask = &adev->dma_mask;
+<<<<<<< HEAD
 	adev->dev.coherent_dma_mask = adev->dma_mask;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	adev->iommu = iommu;
 	adev->ctrl = ctrl;
 	adev->pdata = pdata;
diff --git a/drivers/media/pci/intel/ipu-bus.h b/drivers/media/pci/intel/ipu-bus.h
index 4226b86..16673208 100644
--- a/drivers/media/pci/intel/ipu-bus.h
+++ b/drivers/media/pci/intel/ipu-bus.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_BUS_H
diff --git a/drivers/media/pci/intel/ipu-buttress.c b/drivers/media/pci/intel/ipu-buttress.c
index 5dd6507..469632f 100644
--- a/drivers/media/pci/intel/ipu-buttress.c
+++ b/drivers/media/pci/intel/ipu-buttress.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/clk.h>
@@ -50,7 +54,11 @@
 
 #define BUTTRESS_IPC_CMD_SEND_RETRY	1
 
+<<<<<<< HEAD
 static const struct ipu_buttress_sensor_clk_freq sensor_clk_freqs[] = {
+=======
+const struct ipu_buttress_sensor_clk_freq sensor_clk_freqs[] = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{6750000, BUTTRESS_SENSOR_CLK_FREQ_6P75MHZ},
 	{8000000, BUTTRESS_SENSOR_CLK_FREQ_8MHZ},
 	{9600000, BUTTRESS_SENSOR_CLK_FREQ_9P6MHZ},
@@ -404,10 +412,17 @@ irqreturn_t ipu_buttress_isr(int irq, void *isp_ptr)
 	irqreturn_t ret = IRQ_NONE;
 	u32 disable_irqs = 0;
 	u32 irq_status;
+<<<<<<< HEAD
 #ifdef CONFIG_VIDEO_INTEL_IPU4
 	u32 reg_irq_sts = BUTTRESS_REG_ISR_ENABLED_STATUS;
 #else
 	u32 reg_irq_sts = BUTTRESS_REG_ISR_STATUS;
+=======
+#ifdef CONFIG_VIDEO_INTEL_IPU4P
+	u32 reg_irq_sts = BUTTRESS_REG_ISR_STATUS;
+#else
+	u32 reg_irq_sts = BUTTRESS_REG_ISR_ENABLED_STATUS;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 	unsigned int i;
 
@@ -705,7 +720,11 @@ ipu_buttress_add_psys_constraint(struct ipu_device *isp,
 						  b->psys_fused_freqs.max_freq);
 		ipu_buttress_set_psys_freq(isp, b->psys_min_freq);
 	}
+<<<<<<< HEAD
 	mutex_unlock(&b->cons_mutex);
+=======
+	mutex_unlock(&isp->buttress.cons_mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 EXPORT_SYMBOL_GPL(ipu_buttress_add_psys_constraint);
 
@@ -862,10 +881,17 @@ int ipu_buttress_authenticate(struct ipu_device *isp)
 	 * Write address of FIT table to FW_SOURCE register
 	 * Let's use fw address. I.e. not using FIT table yet
 	 */
+<<<<<<< HEAD
 	data = lower_32_bits(isp->pkg_dir_dma_addr);
 	writel(data, isp->base + BUTTRESS_REG_FW_SOURCE_BASE_LO);
 
 	data = upper_32_bits(isp->pkg_dir_dma_addr);
+=======
+	data = (u32)isp->pkg_dir_dma_addr;
+	writel(data, isp->base + BUTTRESS_REG_FW_SOURCE_BASE_LO);
+
+	data = (u32)(isp->pkg_dir_dma_addr >> 32);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	writel(data, isp->base + BUTTRESS_REG_FW_SOURCE_BASE_HI);
 
 	/*
@@ -1260,6 +1286,7 @@ static void ipu_buttress_read_psys_fused_freqs(struct ipu_device *isp)
 	fused_freq->efficient_freq = efficient_ratio * BUTTRESS_PS_FREQ_STEP;
 }
 
+<<<<<<< HEAD
 #ifdef I2C_DYNAMIC
 static LIST_HEAD(clkmap_dynamic);
 
@@ -1298,6 +1325,8 @@ int ipu_get_i2c_bus_id(int adapter_id)
 EXPORT_SYMBOL_GPL(ipu_get_i2c_bus_id);
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int ipu_buttress_clk_init(struct ipu_device *isp)
 {
 	struct ipu_buttress *b = &isp->buttress;
@@ -1380,6 +1409,7 @@ static int ipu_buttress_clk_init(struct ipu_device *isp)
 		return 0;
 
 	while (clkmap->clkdev_data.dev_id) {
+<<<<<<< HEAD
 #ifdef I2C_DYNAMIC
 		char *dev_id = kstrdup(clkmap->clkdev_data.dev_id, GFP_KERNEL);
 		int adapter_id = clkmap->clkdev_data.dev_id[0] - '0';
@@ -1389,6 +1419,8 @@ static int ipu_buttress_clk_init(struct ipu_device *isp)
 		snprintf(dev_id, PAGE_SIZE, "%d-%s", bus_id, addr + 1);
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		/*
 		 * Lookup table must be NULL terminated
 		 * CLKDEV_INIT(NULL, NULL, NULL)
@@ -1396,6 +1428,7 @@ static int ipu_buttress_clk_init(struct ipu_device *isp)
 		for (i = 0; i < IPU_BUTTRESS_NUM_OF_SENS_CKS; i++) {
 			if (!strcmp(clkmap->platform_clock_name,
 				    clk_data[i].name)) {
+<<<<<<< HEAD
 #ifdef I2C_DYNAMIC
 				struct clk_dynamic *clk = NULL;
 				struct clk_lookup *clk_data = NULL;
@@ -1422,6 +1455,10 @@ static int ipu_buttress_clk_init(struct ipu_device *isp)
 				clkmap->clkdev_data.clk = b->clk_sensor[i];
 				clkdev_add(&clkmap->clkdev_data);
 #endif
+=======
+				clkmap->clkdev_data.clk = b->clk_sensor[i];
+				clkdev_add(&clkmap->clkdev_data);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 				break;
 			}
 		}
@@ -1445,6 +1482,7 @@ static void ipu_buttress_clk_exit(struct ipu_device *isp)
 {
 	struct ipu_buttress *b = &isp->buttress;
 	int i;
+<<<<<<< HEAD
 #ifdef I2C_DYNAMIC
 	struct clk_dynamic *clk = NULL;
 	const char *dev_id = NULL;
@@ -1460,6 +1498,8 @@ static void ipu_buttress_clk_exit(struct ipu_device *isp)
 		kfree(clk);
 	}
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* It is safe to call clk_unregister with null pointer */
 	for (i = 0; i < IPU_BUTTRESS_NUM_OF_SENS_CKS; i++)
@@ -1585,7 +1625,10 @@ DEFINE_SIMPLE_ATTRIBUTE(ipu_buttress_start_tsc_sync_fops, NULL,
 
 u64 ipu_buttress_tsc_ticks_to_ns(u64 ticks)
 {
+<<<<<<< HEAD
 	u64 ns = ticks * 10000;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/*
 	 * TSC clock frequency is 19.2MHz,
 	 * converting TSC tick count to ns is calculated by:
@@ -1593,9 +1636,13 @@ u64 ipu_buttress_tsc_ticks_to_ns(u64 ticks)
 	 *    = ticks * 1000 000 000 / 19200000Hz
 	 *    = ticks * 10000 / 192 ns
 	 */
+<<<<<<< HEAD
 	do_div(ns, 192);
 
 	return ns;
+=======
+	return ticks * 10000 / 192;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 EXPORT_SYMBOL_GPL(ipu_buttress_tsc_ticks_to_ns);
 
@@ -1623,8 +1670,12 @@ static int ipu_buttress_psys_force_freq_set(void *data, u64 val)
 		    val > BUTTRESS_MAX_FORCE_PS_FREQ))
 		return -EINVAL;
 
+<<<<<<< HEAD
 	do_div(val, BUTTRESS_PS_FREQ_STEP);
 	isp->buttress.psys_force_ratio = val;
+=======
+	isp->buttress.psys_force_ratio = val / BUTTRESS_PS_FREQ_STEP;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (isp->buttress.psys_force_ratio)
 		ipu_buttress_set_psys_ratio(isp,
diff --git a/drivers/media/pci/intel/ipu-buttress.h b/drivers/media/pci/intel/ipu-buttress.h
index f798881..a16b6e5 100644
--- a/drivers/media/pci/intel/ipu-buttress.h
+++ b/drivers/media/pci/intel/ipu-buttress.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_BUTTRESS_H
@@ -132,7 +136,11 @@ ipu_buttress_ipc_send_bulk(struct ipu_device *isp,
 			   struct ipu_ipc_buttress_bulk_msg *msgs, u32 size);
 int ipu_buttress_psys_freq_get(void *data, u64 *val);
 int ipu_buttress_isys_freq_get(void *data, u64 *val);
+<<<<<<< HEAD
 #ifdef I2C_DYNAMIC
 int ipu_get_i2c_bus_id(int adapter_id);
 #endif /* I2C_DYNAMIC */
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* IPU_BUTTRESS_H */
diff --git a/drivers/media/pci/intel/ipu-cpd.c b/drivers/media/pci/intel/ipu-cpd.c
index 87028a6..1237b9b 100644
--- a/drivers/media/pci/intel/ipu-cpd.c
+++ b/drivers/media/pci/intel/ipu-cpd.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2015 - 2018 Intel Corporation
 
 #include <linux/dma-mapping.h>
@@ -7,10 +11,15 @@
 #include "ipu.h"
 #include "ipu-cpd.h"
 
+<<<<<<< HEAD
 #ifdef CONFIG_VIDEO_INTEL_IPU_FW_LIB
 #include <ia_css_fw_pkg_release.h>
 
 #endif
+=======
+#include <ia_css_fw_pkg_release.h>
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* 15 entries + header*/
 #define MAX_PKG_DIR_ENT_CNT		16
 /* 2 qword per entry/header */
@@ -48,12 +57,18 @@
 #define ipu_cpd_get_metadata(cpd) ipu_cpd_get_entry(cpd, CPD_METADATA_IDX)
 #define ipu_cpd_get_moduledata(cpd) ipu_cpd_get_entry(cpd, CPD_MODULEDATA_IDX)
 
+<<<<<<< HEAD
 #ifdef CONFIG_VIDEO_INTEL_IPU_FW_LIB
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static bool fw_version_check = true;
 module_param(fw_version_check, bool, 0444);
 MODULE_PARM_DESC(fw_version_check, "enable/disable checking firmware version");
 
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static const struct ipu_cpd_metadata_cmpnt *
 ipu_cpd_metadata_get_cmpnt(struct ipu_device *isp,
 			   const void *metadata,
@@ -198,12 +213,24 @@ void *ipu_cpd_create_pkg_dir(struct ipu_bus_device *adev,
 			     dma_addr_t *dma_addr, unsigned int *pkg_dir_size)
 {
 	struct ipu_device *isp = adev->isp;
+<<<<<<< HEAD
 	const struct ipu_cpd_ent *ent, *man_ent, *met_ent;
 	u64 *pkg_dir;
 	unsigned int man_sz, met_sz;
 	void *pkg_dir_pos;
 	int ret;
 
+=======
+	const struct ipu_cpd_hdr *hdr = src;
+	const struct ipu_cpd_ent *ent, *man_ent, *met_ent;
+	u64 *pkg_dir;
+	unsigned int man_sz, met_sz, hdr_sz;
+	void *pkg_dir_pos;
+	int ret;
+
+	hdr_sz = hdr->hdr_len;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	man_ent = ipu_cpd_get_manifest(src);
 	man_sz = man_ent->len;
 
@@ -353,7 +380,10 @@ static int ipu_cpd_validate_moduledata(struct ipu_device *isp,
 		return -EINVAL;
 	}
 
+<<<<<<< HEAD
 #ifdef CONFIG_VIDEO_INTEL_IPU_FW_LIB
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (fw_version_check && mod_hdr->fw_pkg_date != IA_CSS_FW_PKG_RELEASE) {
 		dev_err(&isp->pdev->dev,
 			"Moduledata and library version mismatch (%x != %x)\n",
@@ -366,9 +396,12 @@ static int ipu_cpd_validate_moduledata(struct ipu_device *isp,
 		 mod_hdr->fw_pkg_date, IA_CSS_FW_PKG_RELEASE);
 
 	dev_info(&isp->pdev->dev, "CSS release: %x\n", IA_CSS_FW_PKG_RELEASE);
+<<<<<<< HEAD
 #else
 	dev_info(&isp->pdev->dev, "FW version: %x\n", mod_hdr->fw_pkg_date);
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	rval = ipu_cpd_validate_cpd(isp, moduledata +
 				    mod_hdr->hdr_len,
 				    moduledata_size -
diff --git a/drivers/media/pci/intel/ipu-cpd.h b/drivers/media/pci/intel/ipu-cpd.h
index 7033e90..c49b451 100644
--- a/drivers/media/pci/intel/ipu-cpd.h
+++ b/drivers/media/pci/intel/ipu-cpd.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation */
 
 #ifndef IPU_CPD_H
@@ -37,6 +41,7 @@ struct __packed ipu_cpd_hdr {
 	u8 hdr_ver;
 	u8 ent_ver;
 	u8 hdr_len;
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 	u8 chksm;
 	u32 name;
@@ -45,6 +50,10 @@ struct __packed ipu_cpd_hdr {
 	u32 sub_partition_name;
 	u32 chksm;
 #endif
+=======
+	u8 chksm;
+	u32 name;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct __packed ipu_cpd_ent {
diff --git a/drivers/media/pci/intel/ipu-dma.c b/drivers/media/pci/intel/ipu-dma.c
index 8a12c03..c7e3311 100644
--- a/drivers/media/pci/intel/ipu-dma.c
+++ b/drivers/media/pci/intel/ipu-dma.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <asm/cacheflush.h>
@@ -258,8 +262,12 @@ static void ipu_dma_free(struct device *dev, size_t size, void *vaddr,
 	if (WARN_ON(!area->pages))
 		return;
 
+<<<<<<< HEAD
 	if (WARN_ON(!iova))
 		return;
+=======
+	WARN_ON(!iova);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	size = PAGE_ALIGN(size);
 
@@ -324,8 +332,12 @@ static void ipu_dma_unmap_sg(struct device *dev,
 	if (!nents)
 		return;
 
+<<<<<<< HEAD
 	if (WARN_ON(!iova))
 		return;
+=======
+	WARN_ON(!iova);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 8, 0)
 	if (!dma_get_attr(DMA_ATTR_SKIP_CPU_SYNC, attrs))
@@ -378,8 +390,12 @@ static int ipu_dma_map_sg(struct device *dev, struct scatterlist *sglist,
 		int rval;
 
 		dev_dbg(dev, "mapping entry %d: iova 0x%8.8x,phy 0x%16.16llx\n",
+<<<<<<< HEAD
 			i, iova_addr << PAGE_SHIFT,
 			(unsigned long long)page_to_phys(sg_page(sg)));
+=======
+			i, iova_addr << PAGE_SHIFT, page_to_phys(sg_page(sg)));
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		rval = iommu_map(mmu->dmap->domain, iova_addr << PAGE_SHIFT,
 				 page_to_phys(sg_page(sg)),
 				 PAGE_ALIGN(sg->length), 0);
diff --git a/drivers/media/pci/intel/ipu-dma.h b/drivers/media/pci/intel/ipu-dma.h
index 9974b69..3b56166 100644
--- a/drivers/media/pci/intel/ipu-dma.h
+++ b/drivers/media/pci/intel/ipu-dma.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_DMA_H
diff --git a/drivers/media/pci/intel/ipu-fw-com.c b/drivers/media/pci/intel/ipu-fw-com.c
index 4ddf111..6c59be2 100644
--- a/drivers/media/pci/intel/ipu-fw-com.c
+++ b/drivers/media/pci/intel/ipu-fw-com.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <asm/cacheflush.h>
@@ -28,7 +32,11 @@
  */
 
 /* Shared structure between driver and FW - do not modify */
+<<<<<<< HEAD
 struct ipu_fw_sys_queue {
+=======
+struct sys_queue {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	u64 host_address;
 	u32 vied_address;
 	u32 size;
@@ -38,7 +46,11 @@ struct ipu_fw_sys_queue {
 	u32 _align;
 };
 
+<<<<<<< HEAD
 struct ipu_fw_sys_queue_res {
+=======
+struct sys_queue_res {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	u64 host_address;
 	u32 vied_address;
 	u32 reg;
@@ -63,13 +75,21 @@ enum syscom_cmd {
 /* firmware config: data that sent from the host to SP via DDR */
 /* Cell copies data into a context */
 
+<<<<<<< HEAD
 struct ipu_fw_syscom_config {
+=======
+struct ia_css_syscom_config_fw {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	u32 firmware_address;
 
 	u32 num_input_queues;
 	u32 num_output_queues;
 
+<<<<<<< HEAD
 	/* ISP pointers to an array of ipu_fw_sys_queue structures */
+=======
+	/* ISP pointers to an array of sys_queue structures */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	u32 input_queue;
 	u32 output_queue;
 
@@ -94,8 +114,13 @@ struct ipu_fw_com_context {
 	unsigned int num_input_queues;
 	unsigned int num_output_queues;
 
+<<<<<<< HEAD
 	struct ipu_fw_sys_queue *input_queue;	/* array of host to SP queues */
 	struct ipu_fw_sys_queue *output_queue;	/* array of SP to host */
+=======
+	struct sys_queue *input_queue;	/* array of host to SP queues */
+	struct sys_queue *output_queue;	/* array of SP to host */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	void *config_host_addr;
 	void *specific_host_addr;
@@ -126,10 +151,15 @@ enum regmem_id {
 	SYSCOM_COMMAND_REG = 3,
 	/* Store interrupt status - updated by SP */
 	SYSCOM_IRQ_REG = 4,
+<<<<<<< HEAD
 	/* Store VTL0_ADDR_MASK in trusted secure regision - provided by host.*/
 	SYSCOM_VTL0_ADDR_MASK = 5,
 	/* first syscom queue pointer register */
 	SYSCOM_QPR_BASE_REG = 6
+=======
+	/* first syscom queue pointer register */
+	SYSCOM_QPR_BASE_REG = 5
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 enum message_direction {
@@ -158,7 +188,11 @@ static unsigned int curr_index(void __iomem *q_dmem,
 			 (dir == DIR_RECV ? FW_COM_RD_REG : FW_COM_WR_REG));
 }
 
+<<<<<<< HEAD
 static unsigned int inc_index(void __iomem *q_dmem, struct ipu_fw_sys_queue *q,
+=======
+static unsigned int inc_index(void __iomem *q_dmem, struct sys_queue *q,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			      enum message_direction dir)
 {
 	unsigned int index;
@@ -167,14 +201,23 @@ static unsigned int inc_index(void __iomem *q_dmem, struct ipu_fw_sys_queue *q,
 	return index >= q->size ? 0 : index;
 }
 
+<<<<<<< HEAD
 static unsigned int ipu_sys_queue_buf_size(unsigned int size,
 					   unsigned int token_size)
+=======
+unsigned int ipu_sys_queue_buf_size(unsigned int size, unsigned int token_size)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	return (size + 1) * token_size;
 }
 
+<<<<<<< HEAD
 static void ipu_sys_queue_init(struct ipu_fw_sys_queue *q, unsigned int size,
 		    unsigned int token_size, struct ipu_fw_sys_queue_res *res)
+=======
+void ipu_sys_queue_init(struct sys_queue *q, unsigned int size,
+		    unsigned int token_size, struct sys_queue_res *res)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	unsigned int buf_size;
 
@@ -199,12 +242,20 @@ void *ipu_fw_com_prepare(struct ipu_fw_com_cfg *cfg,
 			 struct ipu_bus_device *adev, void __iomem *base)
 {
 	struct ipu_fw_com_context *ctx;
+<<<<<<< HEAD
 	struct ipu_fw_syscom_config *fw_cfg;
+=======
+	struct ia_css_syscom_config_fw *fw_cfg;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	unsigned int i;
 	unsigned int sizeall, offset;
 	unsigned int sizeinput = 0, sizeoutput = 0;
 	unsigned long attrs = 0;
+<<<<<<< HEAD
 	struct ipu_fw_sys_queue_res res;
+=======
+	struct sys_queue_res res;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* error handling */
 	if (!cfg || !cfg->cell_start || !cfg->cell_ready)
@@ -226,10 +277,17 @@ void *ipu_fw_com_prepare(struct ipu_fw_com_cfg *cfg,
 	 */
 	sizeall =
 	    /* Base cfg for FW */
+<<<<<<< HEAD
 	    roundup(sizeof(struct ipu_fw_syscom_config), 8) +
 	    /* Descriptions of the queues */
 	    cfg->num_input_queues * sizeof(struct ipu_fw_sys_queue) +
 	    cfg->num_output_queues * sizeof(struct ipu_fw_sys_queue) +
+=======
+	    roundup(sizeof(struct ia_css_syscom_config_fw), 8) +
+	    /* Descriptions of the queues */
+	    cfg->num_input_queues * sizeof(struct sys_queue) +
+	    cfg->num_output_queues * sizeof(struct sys_queue) +
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	    /* FW specific information structure */
 	    roundup(cfg->specific_size, 8);
 
@@ -261,6 +319,7 @@ void *ipu_fw_com_prepare(struct ipu_fw_com_cfg *cfg,
 	/* This is the address where FW starts to parse allocations */
 	ctx->config_host_addr = ctx->dma_buffer;
 	ctx->config_vied_addr = ctx->dma_addr;
+<<<<<<< HEAD
 	fw_cfg = (struct ipu_fw_syscom_config *)ctx->config_host_addr;
 	offset = roundup(sizeof(struct ipu_fw_syscom_config), 8);
 
@@ -271,16 +330,36 @@ void *ipu_fw_com_prepare(struct ipu_fw_com_cfg *cfg,
 	ctx->output_queue = ctx->dma_buffer + offset;
 	ctx->output_queue_vied_addr = ctx->dma_addr + offset;
 	offset += cfg->num_output_queues * sizeof(struct ipu_fw_sys_queue);
+=======
+	fw_cfg = (struct ia_css_syscom_config_fw *)ctx->config_host_addr;
+	offset = roundup(sizeof(struct ia_css_syscom_config_fw), 8);
+
+	ctx->input_queue = ctx->dma_buffer + offset;
+	ctx->input_queue_vied_addr = ctx->dma_addr + offset;
+	offset += cfg->num_input_queues * sizeof(struct sys_queue);
+
+	ctx->output_queue = ctx->dma_buffer + offset;
+	ctx->output_queue_vied_addr = ctx->dma_addr + offset;
+	offset += cfg->num_output_queues * sizeof(struct sys_queue);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	ctx->specific_host_addr = ctx->dma_buffer + offset;
 	ctx->specific_vied_addr = ctx->dma_addr + offset;
 	offset += roundup(cfg->specific_size, 8);
 
+<<<<<<< HEAD
 	ctx->ibuf_host_addr = (uintptr_t)(ctx->dma_buffer + offset);
 	ctx->ibuf_vied_addr = ctx->dma_addr + offset;
 	offset += sizeinput;
 
 	ctx->obuf_host_addr = (uintptr_t)(ctx->dma_buffer + offset);
+=======
+	ctx->ibuf_host_addr = (u64)(ctx->dma_buffer + offset);
+	ctx->ibuf_vied_addr = ctx->dma_addr + offset;
+	offset += sizeinput;
+
+	ctx->obuf_host_addr = (u64)(ctx->dma_buffer + offset);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	ctx->obuf_vied_addr = ctx->dma_addr + offset;
 	offset += sizeoutput;
 
@@ -390,7 +469,11 @@ int ipu_fw_com_ready(struct ipu_fw_com_context *ctx)
 }
 EXPORT_SYMBOL_GPL(ipu_fw_com_ready);
 
+<<<<<<< HEAD
 static bool is_index_valid(struct ipu_fw_sys_queue *q, unsigned int index)
+=======
+static bool is_index_valid(struct sys_queue *q, unsigned int index)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	if (index >= q->size)
 		return false;
@@ -399,7 +482,11 @@ static bool is_index_valid(struct ipu_fw_sys_queue *q, unsigned int index)
 
 void *ipu_send_get_token(struct ipu_fw_com_context *ctx, int q_nbr)
 {
+<<<<<<< HEAD
 	struct ipu_fw_sys_queue *q = &ctx->input_queue[q_nbr];
+=======
+	struct sys_queue *q = &ctx->input_queue[q_nbr];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	void __iomem *q_dmem = ctx->dmem_addr + q->wr_reg * 4;
 	unsigned int wr, rd;
 	unsigned int packets;
@@ -418,17 +505,28 @@ void *ipu_send_get_token(struct ipu_fw_com_context *ctx, int q_nbr)
 
 	index = curr_index(q_dmem, DIR_SEND);
 
+<<<<<<< HEAD
 	return (void *)(unsigned long)q->host_address + (index * q->token_size);
+=======
+	return (void *)q->host_address + (index * q->token_size);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 EXPORT_SYMBOL_GPL(ipu_send_get_token);
 
 void ipu_send_put_token(struct ipu_fw_com_context *ctx, int q_nbr)
 {
+<<<<<<< HEAD
 	struct ipu_fw_sys_queue *q = &ctx->input_queue[q_nbr];
 	void __iomem *q_dmem = ctx->dmem_addr + q->wr_reg * 4;
 	int index = curr_index(q_dmem, DIR_SEND);
 	void *addr = (void *)(unsigned long)q->host_address +
 				(index * q->token_size);
+=======
+	struct sys_queue *q = &ctx->input_queue[q_nbr];
+	void __iomem *q_dmem = ctx->dmem_addr + q->wr_reg * 4;
+	int index = curr_index(q_dmem, DIR_SEND);
+	void *addr = (void *)q->host_address + (index * q->token_size);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	clflush_cache_range(addr, q->token_size);
 
@@ -441,7 +539,11 @@ EXPORT_SYMBOL_GPL(ipu_send_put_token);
 
 void *ipu_recv_get_token(struct ipu_fw_com_context *ctx, int q_nbr)
 {
+<<<<<<< HEAD
 	struct ipu_fw_sys_queue *q = &ctx->output_queue[q_nbr];
+=======
+	struct sys_queue *q = &ctx->output_queue[q_nbr];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	void __iomem *q_dmem = ctx->dmem_addr + q->wr_reg * 4;
 	unsigned int wr, rd;
 	unsigned int packets;
@@ -458,7 +560,11 @@ void *ipu_recv_get_token(struct ipu_fw_com_context *ctx, int q_nbr)
 	if (packets <= 0)
 		return NULL;
 
+<<<<<<< HEAD
 	addr = (void *)(unsigned long)q->host_address + (rd * q->token_size);
+=======
+	addr = (void *)q->host_address + (rd * q->token_size);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	clflush_cache_range(addr, q->token_size);
 
 	return addr;
@@ -467,7 +573,11 @@ EXPORT_SYMBOL_GPL(ipu_recv_get_token);
 
 void ipu_recv_put_token(struct ipu_fw_com_context *ctx, int q_nbr)
 {
+<<<<<<< HEAD
 	struct ipu_fw_sys_queue *q = &ctx->output_queue[q_nbr];
+=======
+	struct sys_queue *q = &ctx->output_queue[q_nbr];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	void __iomem *q_dmem = ctx->dmem_addr + q->wr_reg * 4;
 	unsigned int rd = inc_index(q_dmem, q, DIR_RECV);
 
diff --git a/drivers/media/pci/intel/ipu-fw-com.h b/drivers/media/pci/intel/ipu-fw-com.h
index de47455..312e6bd 100644
--- a/drivers/media/pci/intel/ipu-fw-com.h
+++ b/drivers/media/pci/intel/ipu-fw-com.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_FW_COM_H
@@ -7,7 +11,11 @@
 struct ipu_fw_com_context;
 struct ipu_bus_device;
 
+<<<<<<< HEAD
 struct ipu_fw_syscom_queue_config {
+=======
+struct ia_css_syscom_queue_config {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	unsigned int queue_size;	/* tokens per queue */
 	unsigned int token_size;	/* bytes per token */
 };
@@ -15,8 +23,13 @@ struct ipu_fw_syscom_queue_config {
 struct ipu_fw_com_cfg {
 	unsigned int num_input_queues;
 	unsigned int num_output_queues;
+<<<<<<< HEAD
 	struct ipu_fw_syscom_queue_config *input;
 	struct ipu_fw_syscom_queue_config *output;
+=======
+	struct ia_css_syscom_queue_config *input;
+	struct ia_css_syscom_queue_config *output;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	unsigned int dmem_addr;
 
diff --git a/drivers/media/pci/intel/ipu-fw-isys.c b/drivers/media/pci/intel/ipu-fw-isys.c
index 304bcae..0b4b24b 100644
--- a/drivers/media/pci/intel/ipu-fw-isys.c
+++ b/drivers/media/pci/intel/ipu-fw-isys.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <asm/cacheflush.h>
@@ -80,8 +84,12 @@ extracted_bits_per_pixel_per_mipi_data_type[N_IPU_FW_ISYS_MIPI_DATA_TYPE] = {
 	IPU_FW_UNSUPPORTED_DATA_TYPE	/* [0x3F] */
 };
 
+<<<<<<< HEAD
 #ifndef CONFIG_VIDEO_INTEL_IPU_FW_LIB
 static const char send_msg_types[N_IPU_FW_ISYS_SEND_TYPE][32] = {
+=======
+const char send_msg_types[N_IPU_FW_ISYS_SEND_TYPE][32] = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	"STREAM_OPEN",
 	"STREAM_START",
 	"STREAM_START_AND_CAPTURE",
@@ -91,6 +99,7 @@ static const char send_msg_types[N_IPU_FW_ISYS_SEND_TYPE][32] = {
 	"STREAM_CLOSE"
 };
 
+<<<<<<< HEAD
 static int handle_proxy_response(struct ipu_isys *isys, unsigned int req_id)
 {
 	struct ipu_fw_isys_proxy_resp_info_abi *resp;
@@ -423,6 +432,8 @@ void ipu_fw_isys_put_resp(void *context, unsigned int queue)
 	ipu_recv_put_token(context, queue);
 }
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 void ipu_fw_isys_set_params(struct ipu_fw_isys_stream_cfg_data_abi *stream_cfg)
 {
@@ -499,10 +510,13 @@ ipu_fw_isys_dump_stream_cfg(struct device *dev,
 			stream_cfg->output_pins[i].send_irq);
 		dev_dbg(dev, "Reserve compression %d\n",
 			stream_cfg->output_pins[i].reserve_compression);
+<<<<<<< HEAD
 		dev_dbg(dev, "snoopable %d\n",
 			stream_cfg->output_pins[i].snoopable);
 		dev_dbg(dev, "sensor type %d\n",
 			stream_cfg->output_pins[i].sensor_type);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		dev_dbg(dev, "----------------\n");
 	}
 
@@ -554,8 +568,11 @@ void ipu_fw_isys_dump_frame_buff_set(struct device *dev,
 	dev_dbg(dev, "send_irq_eof 0x%x\n", buf->send_irq_eof);
 	dev_dbg(dev, "send_resp_sof 0x%x\n", buf->send_resp_sof);
 	dev_dbg(dev, "send_resp_eof 0x%x\n", buf->send_resp_eof);
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 	dev_dbg(dev, "send_irq_capture_ack 0x%x\n", buf->send_irq_capture_ack);
 	dev_dbg(dev, "send_irq_capture_done 0x%x\n", buf->send_irq_capture_done);
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
diff --git a/drivers/media/pci/intel/ipu-fw-isys.h b/drivers/media/pci/intel/ipu-fw-isys.h
index 4056736..971f2f7 100644
--- a/drivers/media/pci/intel/ipu-fw-isys.h
+++ b/drivers/media/pci/intel/ipu-fw-isys.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_FW_ISYS_H
@@ -16,11 +20,15 @@
 #define IPU_MAX_OPINS ((IPU_MAX_IPINS) + 2)
 
 /* Max number of supported virtual streams */
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 #define IPU_STREAM_ID_MAX 8
 #else
 #define IPU_STREAM_ID_MAX 16
 #endif
+=======
+#define IPU_STREAM_ID_MAX 8
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* Aligned with the approach of having one dedicated per stream */
 #define IPU_N_MAX_MSG_SEND_QUEUES (IPU_STREAM_ID_MAX)
@@ -545,8 +553,11 @@ struct ipu_fw_isys_output_pin_info_abi {
 	u8 ft;
 	u8 reserved;
 	u8 reserve_compression;
+<<<<<<< HEAD
 	u8 snoopable;
 	u32 sensor_type;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 /**
@@ -679,10 +690,13 @@ struct ipu_fw_isys_frame_buff_set_abi {
 	struct ipu_fw_isys_param_pin_abi process_group_light;
 	u8 send_irq_sof;
 	u8 send_irq_eof;
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 	u8 send_irq_capture_ack;
 	u8 send_irq_capture_done;
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	u8 send_resp_sof;
 	u8 send_resp_eof;
 	u8 reserved;
@@ -801,7 +815,10 @@ void ipu_fw_isys_dump_stream_cfg(struct device *dev,
 void ipu_fw_isys_dump_frame_buff_set(struct device *dev,
 				     struct ipu_fw_isys_frame_buff_set_abi *buf,
 				     unsigned int outputs);
+<<<<<<< HEAD
 #ifndef CONFIG_VIDEO_INTEL_ICI
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ipu_fw_isys_init(struct ipu_isys *isys, unsigned int num_streams);
 int ipu_fw_isys_close(struct ipu_isys *isys);
 int ipu_fw_isys_simple_cmd(struct ipu_isys *isys,
@@ -817,6 +834,7 @@ int ipu_fw_isys_send_proxy_token(struct ipu_isys *isys,
 				 unsigned int index,
 				 unsigned int offset, u32 value);
 void ipu_fw_isys_cleanup(struct ipu_isys *isys);
+<<<<<<< HEAD
 #else
 struct ici_isys;
 int ipu_fw_isys_init(struct ici_isys *isys, unsigned int num_streams);
@@ -835,6 +853,8 @@ int ipu_fw_isys_send_proxy_token(struct ici_isys *isys,
                                  unsigned int offset, u32 value);
 void ipu_fw_isys_cleanup(struct ici_isys *isys);
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 struct ipu_fw_isys_resp_info_abi *ipu_fw_isys_get_resp(void *context,
 						       unsigned int queue,
 						       struct
diff --git a/drivers/media/pci/intel/ipu-fw-psys.c b/drivers/media/pci/intel/ipu-fw-psys.c
index 5f0f601..beedce1c 100644
--- a/drivers/media/pci/intel/ipu-fw-psys.c
+++ b/drivers/media/pci/intel/ipu-fw-psys.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2016 - 2018 Intel Corporation
 
 #include <linux/delay.h>
@@ -51,7 +55,10 @@ int ipu_fw_psys_pg_disown(struct ipu_psys_kcmd *kcmd)
 	return ret;
 }
 
+<<<<<<< HEAD
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ipu_fw_psys_pg_abort(struct ipu_psys_kcmd *kcmd)
 {
 	struct ipu_fw_psys_cmd *psys_cmd;
diff --git a/drivers/media/pci/intel/ipu-fw-psys.h b/drivers/media/pci/intel/ipu-fw-psys.h
index 1738f6c..d45e3dc 100644
--- a/drivers/media/pci/intel/ipu-fw-psys.h
+++ b/drivers/media/pci/intel/ipu-fw-psys.h
@@ -1,9 +1,19 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef IPU_FW_PSYS_H
 #define IPU_FW_PSYS_H
 
+<<<<<<< HEAD
+=======
+#include <linux/errno.h>
+#include <linux/device.h>
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include "ipu-platform-resources.h"
 
 /* ia_css_psys_device.c */
@@ -239,6 +249,7 @@ struct ipu_fw_psys_buffer_set {
 	u8 padding[IPU_FW_PSYS_N_PADDING_UINT8_IN_BUFFER_SET_STRUCT];
 };
 
+<<<<<<< HEAD
 struct ipu_fw_psys_program_group_manifest {
 	u32 kernel_bitmap[IPU_FW_PSYS_KERNEL_BITMAP_NOF_ELEMS];
 	u32 ID;
@@ -306,6 +317,11 @@ struct ipu_fw_resource_definitions {
 
 struct ipu_psys_kcmd;
 struct ipu_psys;
+=======
+struct ipu_psys_kcmd;
+struct ipu_psys;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ipu_fw_psys_pg_start(struct ipu_psys_kcmd *kcmd);
 int ipu_fw_psys_pg_disown(struct ipu_psys_kcmd *kcmd);
 int ipu_fw_psys_pg_abort(struct ipu_psys_kcmd *kcmd);
@@ -333,6 +349,7 @@ u64 ipu_fw_psys_pg_get_token(struct ipu_psys_kcmd *kcmd);
 int ipu_fw_psys_pg_get_protocol(struct ipu_psys_kcmd *kcmd);
 int ipu_fw_psys_open(struct ipu_psys *psys);
 int ipu_fw_psys_close(struct ipu_psys *psys);
+<<<<<<< HEAD
 
 /* common resource interface for both abi and api mode */
 int ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
@@ -347,4 +364,6 @@ int ipu_fw_psys_get_program_manifest_by_process(
 	struct ipu_fw_generic_program_manifest *gen_pm,
 	const struct ipu_fw_psys_program_group_manifest *pg_manifest,
 	struct ipu_fw_psys_process *process);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* IPU_FW_PSYS_H */
diff --git a/drivers/media/pci/intel/ipu-fw-resources.h b/drivers/media/pci/intel/ipu-fw-resources.h
new file mode 100644
index 00000000..8a76597
--- /dev/null
+++ b/drivers/media/pci/intel/ipu-fw-resources.h
@@ -0,0 +1,25 @@
+
+/* SPDX-License_Identifier: GPL-2.0 */
+/* Copyright (C) 2018 Intel Corporation */
+
+#ifndef IPU_FW_RESOURCES_H
+#define IPU_FW_RESOURCES_H
+
+#include "ipu-resources.h"
+
+/* common resource interface for both abi and api mode */
+void ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
+				     u8 value);
+u8 ipu_fw_psys_get_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index);
+void ipu_fw_psys_set_process_dev_chn_offset(struct ipu_fw_psys_process *ptr,
+					    u16 offset, u16 value);
+void ipu_fw_psys_set_process_ext_mem_offset(struct ipu_fw_psys_process *ptr,
+					    u16 offset, u16 value);
+void ipu_fw_psys_set_process_ext_mem_id(struct ipu_fw_psys_process *ptr,
+					u16 offset, u8 value);
+int ipu_fw_psys_get_program_manifest_by_process(
+	struct ipu_fw_generic_program_manifest *gen_pm,
+	const struct ipu_fw_psys_program_group_manifest *pg_manifest,
+	struct ipu_fw_psys_process *process);
+
+#endif
diff --git a/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c b/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c
index c031626..14c2cc1 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c
+++ b/drivers/media/pci/intel/ipu-isys-csi2-be-soc.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2014 - 2018 Intel Corporation
 
 #include <linux/device.h>
@@ -23,8 +27,11 @@ static const u32 csi2_be_soc_supported_codes_pad[] = {
 	MEDIA_BUS_FMT_Y10_1X10,
 	MEDIA_BUS_FMT_RGB565_1X16,
 	MEDIA_BUS_FMT_RGB888_1X24,
+<<<<<<< HEAD
 	/* YUV420 plannar */
 	MEDIA_BUS_FMT_UYVY8_2X8,
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	MEDIA_BUS_FMT_UYVY8_1X16,
 	MEDIA_BUS_FMT_YUYV8_1X16,
 	MEDIA_BUS_FMT_SBGGR14_1X14,
@@ -94,8 +101,12 @@ ipu_isys_csi2_be_soc_set_sel(struct v4l2_subdev *sd,
 		int i;
 
 		for (i = 0; i < asd->nstreams; i++) {
+<<<<<<< HEAD
 			if (!(asd->route[i].flags &
 			      V4L2_SUBDEV_ROUTE_FL_ACTIVE))
+=======
+			if (!asd->route[i].flags & V4L2_SUBDEV_ROUTE_FL_ACTIVE)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 				continue;
 			if (asd->route[i].source == sel->pad) {
 				sink_pad = asd->route[i].sink;
@@ -194,7 +205,10 @@ static void csi2_be_soc_set_ffmt(struct v4l2_subdev *sd,
 		ffmt->height = r->height;
 		ffmt->code = sink_ffmt->code;
 		ffmt->field = sink_ffmt->field;
+<<<<<<< HEAD
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 }
 
@@ -287,24 +301,37 @@ int ipu_isys_csi2_be_soc_init(struct ipu_isys_csi2_be_soc *csi2_be_soc,
 		    = 0;
 	}
 	for (i = 0; i < NR_OF_CSI2_BE_SOC_STREAMS; i++) {
+<<<<<<< HEAD
 		csi2_be_soc->asd.route[i].flags = V4L2_SUBDEV_ROUTE_FL_ACTIVE;
+=======
+		csi2_be_soc->asd.route[i].flags = V4L2_SUBDEV_ROUTE_FL_ACTIVE |
+		    V4L2_SUBDEV_ROUTE_FL_IMMUTABLE;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		bitmap_set(csi2_be_soc->asd.stream[CSI2_BE_SOC_PAD_SINK(i)].
 			   streams_stat, 0, 1);
 		bitmap_set(csi2_be_soc->asd.stream[CSI2_BE_SOC_PAD_SOURCE(i)].
 			   streams_stat, 0, 1);
 	}
+<<<<<<< HEAD
 	csi2_be_soc->asd.route[0].flags |= V4L2_SUBDEV_ROUTE_FL_IMMUTABLE;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	mutex_unlock(&csi2_be_soc->asd.mutex);
 	for (i = 0; i < NR_OF_CSI2_BE_SOC_SOURCE_PADS; i++) {
 		snprintf(csi2_be_soc->av[i].vdev.name,
 			 sizeof(csi2_be_soc->av[i].vdev.name),
 			 IPU_ISYS_ENTITY_PREFIX " BE SOC capture %d", i);
+<<<<<<< HEAD
 		/*
 		 * Pin type could be overwritten for YUV422 to I420 case, at
 		 * set_format phase
 		 */
 		csi2_be_soc->av[i].aq.css_pin_type =
 			IPU_FW_ISYS_PIN_TYPE_RAW_SOC;
+=======
+		csi2_be_soc->av[i].aq.css_pin_type =
+		    IPU_FW_ISYS_PIN_TYPE_RAW_SOC;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		csi2_be_soc->av[i].isys = isys;
 		csi2_be_soc->av[i].pfmts = ipu_isys_pfmts_be_soc;
 
diff --git a/drivers/media/pci/intel/ipu-isys-csi2-be.c b/drivers/media/pci/intel/ipu-isys-csi2-be.c
index 028c2de..34ae6f5 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2-be.c
+++ b/drivers/media/pci/intel/ipu-isys-csi2-be.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2014 - 2018 Intel Corporation
 
 #include <linux/device.h>
@@ -255,6 +259,10 @@ int ipu_isys_csi2_be_init(struct ipu_isys_csi2_be *csi2_be,
 	csi2_be->asd.pad[CSI2_BE_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 	csi2_be->asd.valid_tgts[CSI2_BE_PAD_SOURCE].crop = true;
 	csi2_be->asd.set_ffmt = csi2_be_set_ffmt;
+<<<<<<< HEAD
+=======
+	csi2_be->asd.isys = isys;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	BUILD_BUG_ON(ARRAY_SIZE(csi2_be_supported_codes) != NR_OF_CSI2_BE_PADS);
 	csi2_be->asd.supported_codes = csi2_be_supported_codes;
diff --git a/drivers/media/pci/intel/ipu-isys-csi2-be.h b/drivers/media/pci/intel/ipu-isys-csi2-be.h
index 70a1783..4d32b49 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2-be.h
+++ b/drivers/media/pci/intel/ipu-isys-csi2-be.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_CSI2_BE_H
diff --git a/drivers/media/pci/intel/ipu-isys-csi2.c b/drivers/media/pci/intel/ipu-isys-csi2.c
index 9a71ce5..54ba0c7 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2.c
+++ b/drivers/media/pci/intel/ipu-isys-csi2.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/device.h>
@@ -19,7 +23,10 @@
 
 #define CREATE_TRACE_POINTS
 #define IPU_SOF_SEQID_TRACE
+<<<<<<< HEAD
 #define IPU_EOF_SEQID_TRACE
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include "ipu-trace-event.h"
 
 static const u32 csi2_supported_codes_pad_sink[] = {
@@ -28,7 +35,10 @@ static const u32 csi2_supported_codes_pad_sink[] = {
 	MEDIA_BUS_FMT_RGB888_1X24,
 	MEDIA_BUS_FMT_UYVY8_1X16,
 	MEDIA_BUS_FMT_YUYV8_1X16,
+<<<<<<< HEAD
 	MEDIA_BUS_FMT_YUYV10_1X20,
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	MEDIA_BUS_FMT_SBGGR10_1X10,
 	MEDIA_BUS_FMT_SGBRG10_1X10,
 	MEDIA_BUS_FMT_SGRBG10_1X10,
@@ -58,7 +68,10 @@ static const u32 csi2_supported_codes_pad_source[] = {
 	MEDIA_BUS_FMT_RGB888_1X24,
 	MEDIA_BUS_FMT_UYVY8_1X16,
 	MEDIA_BUS_FMT_YUYV8_1X16,
+<<<<<<< HEAD
 	MEDIA_BUS_FMT_YUYV10_1X20,
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	MEDIA_BUS_FMT_SBGGR10_1X10,
 	MEDIA_BUS_FMT_SGBRG10_1X10,
 	MEDIA_BUS_FMT_SGRBG10_1X10,
@@ -78,12 +91,18 @@ static const u32 csi2_supported_codes_pad_source[] = {
 	0,
 };
 
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static const u32 csi2_supported_codes_pad_meta[] = {
 	MEDIA_BUS_FMT_FIXED,
 	0,
 };
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static const u32 *csi2_supported_codes[NR_OF_CSI2_PADS];
 
@@ -133,14 +152,21 @@ int ipu_isys_csi2_get_link_freq(struct ipu_isys_csi2 *csi2, __s64 *link_freq)
 	return 0;
 }
 
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int ipu_get_frame_desc_entry_by_dt(struct v4l2_subdev *sd,
 					  struct v4l2_mbus_frame_desc_entry
 					  *entry, u8 data_type)
 {
+<<<<<<< HEAD
 	struct v4l2_mbus_frame_desc desc = {
 		.num_entries = V4L2_FRAME_DESC_ENTRY_MAX,
 	};
+=======
+	struct v4l2_mbus_frame_desc desc;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	int rval, i;
 
 	rval = v4l2_subdev_call(sd, pad, get_frame_desc, 0, &desc);
@@ -195,13 +221,17 @@ static void csi2_meta_prepare_firmware_stream_cfg_default(
 		    entry.size.two_dim.height;
 	}
 }
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static int subscribe_event(struct v4l2_subdev *sd, struct v4l2_fh *fh,
 			   struct v4l2_event_subscription *sub)
 {
 	struct ipu_isys_csi2 *csi2 = to_ipu_isys_csi2(sd);
 
+<<<<<<< HEAD
 	dev_dbg(&csi2->isys->adev->dev, "subscribe event(type %u id %u)\n",
 		sub->type, sub->id);
 
@@ -213,6 +243,14 @@ static int subscribe_event(struct v4l2_subdev *sd, struct v4l2_fh *fh,
 	default:
 		return -EINVAL;
 	}
+=======
+	if (sub->type != V4L2_EVENT_FRAME_SYNC)
+		return -EINVAL;
+
+	dev_dbg(&csi2->isys->adev->dev, "sub->id %u\n", sub->id);
+
+	return v4l2_event_subscribe(fh, sub, 10, NULL);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static const struct v4l2_subdev_core_ops csi2_sd_core_ops = {
@@ -220,12 +258,20 @@ static const struct v4l2_subdev_core_ops csi2_sd_core_ops = {
 	.unsubscribe_event = v4l2_event_subdev_unsubscribe,
 };
 
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 static struct ipu_isys_pixelformat csi2_meta_pfmts[] = {
 	{V4L2_FMT_IPU_ISYS_META, 8, 8, 0, MEDIA_BUS_FMT_FIXED, 0},
 	{},
 };
 #endif
+=======
+struct ipu_isys_pixelformat csi2_meta_pfmts[] = {
+	{V4L2_FMT_IPU_ISYS_META, 8, 8, 0, MEDIA_BUS_FMT_FIXED, 0},
+	{},
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /*
  * The input system CSI2+ receiver has several
  * parameters affecting the receiver timings. These depend
@@ -443,6 +489,7 @@ static int csi2_link_validate(struct media_link *link)
 	return 0;
 }
 
+<<<<<<< HEAD
 static bool csi2_has_route(struct media_entity *entity, unsigned int pad0,
 			   unsigned int pad1, int *stream)
 {
@@ -450,6 +497,15 @@ static bool csi2_has_route(struct media_entity *entity, unsigned int pad0,
 	if (pad0 == CSI2_PAD_META || pad1 == CSI2_PAD_META)
 		return true;
 #endif
+=======
+bool csi2_has_route(struct media_entity *entity, unsigned int pad0,
+		    unsigned int pad1, int *stream)
+{
+	/* TODO: need to remove this when meta data node is removed */
+	if (pad0 == CSI2_PAD_META || pad1 == CSI2_PAD_META)
+		return true;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return ipu_isys_subdev_has_route(entity, pad0, pad1, stream);
 }
 
@@ -457,7 +513,10 @@ static const struct v4l2_subdev_video_ops csi2_sd_video_ops = {
 	.s_stream = set_stream,
 };
 
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int get_metadata_fmt(struct v4l2_subdev *sd,
 			    struct v4l2_subdev_pad_config *cfg,
 			    struct v4l2_subdev_format *fmt)
@@ -484,16 +543,25 @@ static int get_metadata_fmt(struct v4l2_subdev *sd,
 	}
 	return rval;
 }
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static int ipu_isys_csi2_get_fmt(struct v4l2_subdev *sd,
 				 struct v4l2_subdev_pad_config *cfg,
 				 struct v4l2_subdev_format *fmt)
 {
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 	if (fmt->pad == CSI2_PAD_META)
 		return get_metadata_fmt(sd, cfg, fmt);
 #endif
+=======
+	if (fmt->pad == CSI2_PAD_META)
+		return get_metadata_fmt(sd, cfg, fmt);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return ipu_isys_subdev_get_ffmt(sd, cfg, fmt);
 }
 
@@ -501,10 +569,16 @@ static int ipu_isys_csi2_set_fmt(struct v4l2_subdev *sd,
 				 struct v4l2_subdev_pad_config *cfg,
 				 struct v4l2_subdev_format *fmt)
 {
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 	if (fmt->pad == CSI2_PAD_META)
 		return get_metadata_fmt(sd, cfg, fmt);
 #endif
+=======
+	if (fmt->pad == CSI2_PAD_META)
+		return get_metadata_fmt(sd, cfg, fmt);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return ipu_isys_subdev_set_ffmt(sd, cfg, fmt);
 }
 
@@ -566,7 +640,10 @@ static void csi2_set_ffmt(struct v4l2_subdev *sd,
 		return;
 	}
 
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (fmt->pad == CSI2_PAD_META) {
 		struct v4l2_mbus_framefmt *ffmt =
 			__ipu_isys_get_ffmt(sd, cfg, fmt->pad,
@@ -599,7 +676,11 @@ static void csi2_set_ffmt(struct v4l2_subdev *sd,
 
 		return;
 	}
+<<<<<<< HEAD
 #endif
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (sd->entity.pads[fmt->pad].flags & MEDIA_PAD_FL_SOURCE) {
 		ffmt->width = fmt->format.width;
 		ffmt->height = fmt->format.height;
@@ -648,9 +729,13 @@ void ipu_isys_csi2_cleanup(struct ipu_isys_csi2 *csi2)
 	ipu_isys_subdev_cleanup(&csi2->asd);
 	for (i = 0; i < NR_OF_CSI2_SOURCE_PADS; i++)
 		ipu_isys_video_cleanup(&csi2->av[i]);
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 	ipu_isys_video_cleanup(&csi2->av_meta);
 #endif
+=======
+	ipu_isys_video_cleanup(&csi2->av_meta);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	csi2->isys = NULL;
 }
 
@@ -684,12 +769,18 @@ int ipu_isys_csi2_init(struct ipu_isys_csi2 *csi2,
 			   .height = 3072,
 			  },
 	};
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct v4l2_subdev_format fmt_meta = {
 		.which = V4L2_SUBDEV_FORMAT_ACTIVE,
 		.pad = CSI2_PAD_META,
 	};
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	int i, rval, src;
 
 	csi2->isys = isys;
@@ -718,9 +809,13 @@ int ipu_isys_csi2_init(struct ipu_isys_csi2 *csi2,
 	     i < (NR_OF_CSI2_SOURCE_PADS + CSI2_PAD_SOURCE(0)); i++)
 		csi2->asd.pad[i].flags = MEDIA_PAD_FL_SOURCE;
 
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 	csi2->asd.pad[CSI2_PAD_META].flags = MEDIA_PAD_FL_SOURCE;
 #endif
+=======
+	csi2->asd.pad[CSI2_PAD_META].flags = MEDIA_PAD_FL_SOURCE;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	src = index;
 #ifdef CONFIG_VIDEO_INTEL_IPU4P
 	src = index ? (index + 5) : (index + 3);
@@ -730,9 +825,13 @@ int ipu_isys_csi2_init(struct ipu_isys_csi2 *csi2,
 
 	for (i = 0; i < NR_OF_CSI2_SOURCE_PADS; i++)
 		csi2_supported_codes[i + 1] = csi2_supported_codes_pad_source;
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 	csi2_supported_codes[CSI2_PAD_META] = csi2_supported_codes_pad_meta;
 #endif
+=======
+	csi2_supported_codes[CSI2_PAD_META] = csi2_supported_codes_pad_meta;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	csi2->asd.supported_codes = csi2_supported_codes;
 	csi2->asd.set_ffmt = csi2_set_ffmt;
 
@@ -751,9 +850,13 @@ int ipu_isys_csi2_init(struct ipu_isys_csi2 *csi2,
 	}
 
 	__ipu_isys_subdev_set_ffmt(&csi2->asd.sd, NULL, &fmt);
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 	__ipu_isys_subdev_set_ffmt(&csi2->asd.sd, NULL, &fmt_meta);
 #endif
+=======
+	__ipu_isys_subdev_set_ffmt(&csi2->asd.sd, NULL, &fmt_meta);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	/* create default route information */
 	for (i = 0; i < NR_OF_CSI2_STREAMS; i++) {
@@ -806,7 +909,11 @@ int ipu_isys_csi2_init(struct ipu_isys_csi2 *csi2,
 		}
 	}
 
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
+=======
+	/* TODO: remove meta data pad */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	snprintf(csi2->av_meta.vdev.name, sizeof(csi2->av_meta.vdev.name),
 		 IPU_ISYS_ENTITY_PREFIX " CSI-2 %u meta", index);
 	csi2->av_meta.isys = isys;
@@ -833,7 +940,11 @@ int ipu_isys_csi2_init(struct ipu_isys_csi2 *csi2,
 		dev_info(&isys->adev->dev, "can't init metadata node\n");
 		goto fail;
 	}
+<<<<<<< HEAD
 #endif
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return 0;
 
 fail:
@@ -877,8 +988,13 @@ void ipu_isys_csi2_sof_event(struct ipu_isys_csi2 *csi2, unsigned int vc)
 	trace_ipu_sof_seqid(ev.u.frame_sync.frame_sequence, csi2->index, vc);
 	v4l2_event_queue(vdev, &ev);
 	dev_dbg(&csi2->isys->adev->dev,
+<<<<<<< HEAD
 		"sof_event::csi2-%i CPU-timestamp:%lld, sequence:%i, vc:%d, stream_id:%d\n",
 		csi2->index, ktime_get_ns(), ev.u.frame_sync.frame_sequence, vc, ip->stream_id);
+=======
+		"sof_event::csi2-%i sequence: %i, vc: %d, stream_id: %d\n",
+		csi2->index, ev.u.frame_sync.frame_sequence, vc, ip->stream_id);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 void ipu_isys_csi2_eof_event(struct ipu_isys_csi2 *csi2, unsigned int vc)
@@ -906,8 +1022,11 @@ void ipu_isys_csi2_eof_event(struct ipu_isys_csi2 *csi2, unsigned int vc)
 	if (ip) {
 		frame_sequence = atomic_read(&ip->sequence);
 
+<<<<<<< HEAD
 	trace_ipu_eof_seqid(frame_sequence, csi2->index, vc);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		dev_dbg(&csi2->isys->adev->dev,
 			"eof_event::csi2-%i sequence: %i, vc: %d, stream_id: %d\n",
 			csi2->index, frame_sequence, vc, ip->stream_id);
diff --git a/drivers/media/pci/intel/ipu-isys-csi2.h b/drivers/media/pci/intel/ipu-isys-csi2.h
index a464df9..7a21a0f 100644
--- a/drivers/media/pci/intel/ipu-isys-csi2.h
+++ b/drivers/media/pci/intel/ipu-isys-csi2.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_CSI2_H
@@ -25,14 +29,20 @@ struct ipu_isys;
 	(__n >= NR_OF_CSI2_SOURCE_PADS ? \
 		(NR_OF_CSI2_PADS - 2) : \
 		(__n + NR_OF_CSI2_SINK_PADS)); })
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define NR_OF_CSI2_META_PADS		1
 #define NR_OF_CSI2_PADS			\
 	(NR_OF_CSI2_SINK_PADS + NR_OF_CSI2_SOURCE_PADS + NR_OF_CSI2_META_PADS)
 #define CSI2_PAD_META			(NR_OF_CSI2_PADS - 1)
+<<<<<<< HEAD
 #else
 #define NR_OF_CSI2_PADS	(NR_OF_CSI2_SINK_PADS + NR_OF_CSI2_SOURCE_PADS)
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define IPU_ISYS_SHORT_PACKET_BUFFER_NUM	VIDEO_MAX_FRAME
 #define IPU_ISYS_SHORT_PACKET_WIDTH	32
@@ -94,9 +104,13 @@ struct ipu_isys_csi2 {
 	struct ipu_isys *isys;
 	struct ipu_isys_subdev asd;
 	struct ipu_isys_video av[NR_OF_CSI2_SOURCE_PADS];
+<<<<<<< HEAD
 #ifdef IPU_META_DATA_SUPPORT
 	struct ipu_isys_video av_meta;
 #endif
+=======
+	struct ipu_isys_video av_meta;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct completion eof_completion;
 
 	void __iomem *base;
@@ -125,16 +139,27 @@ struct ipu_isys_csi2_timing {
  * from IPU MIPI receiver. Due to hardware conversion,
  * this structure is not the same as defined in CSI-2 spec.
  */
+<<<<<<< HEAD
 struct ipu_isys_mipi_packet_header {
 	u32 word_count:16, dtype:13, sync:2, stype:1;
 	u32 sid:4, port_id:4, reserved:23, odd_even:1;
 } __packed;
+=======
+__packed struct ipu_isys_mipi_packet_header {
+	u32 word_count:16, dtype:13, sync:2, stype:1;
+	u32 sid:4, port_id:4, reserved:23, odd_even:1;
+};
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*
  * This structure defines the trace message content
  * for CSI2 receiver monitor messages.
  */
+<<<<<<< HEAD
 struct ipu_isys_csi2_monitor_message {
+=======
+__packed struct ipu_isys_csi2_monitor_message {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	u64 fe:1,
 	    fs:1,
 	    pe:1,
@@ -153,7 +178,11 @@ struct ipu_isys_csi2_monitor_message {
 	    port:4, vc:2, reserved4:2, frame_sync:4, reserved5:4;
 	u64 reserved6:3,
 	    cmd:2, reserved7:1, monitor_id:7, reserved8:1, timestamp_h:50;
+<<<<<<< HEAD
 } __packed;
+=======
+};
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define to_ipu_isys_csi2(sd) container_of(to_ipu_isys_subdev(sd), \
 					struct ipu_isys_csi2, asd)
diff --git a/drivers/media/pci/intel/ipu-isys-media.c b/drivers/media/pci/intel/ipu-isys-media.c
new file mode 100644
index 00000000..199131f
--- /dev/null
+++ b/drivers/media/pci/intel/ipu-isys-media.c
@@ -0,0 +1,26 @@
+/* SPDX-License_Identifier: GPL-2.0
+ * Copyright (C) 2016 - 2018 Intel Corporation
+ * FIXME: update checkpatch script
+ */
+
+#include <linux/slab.h>
+#include <media/media-entity.h>
+
+
+#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 5, 0)
+int media_entity_enum_init(struct media_entity_enum *ent_enum,
+			   struct media_device *mdev)
+{
+	int idx_max = IPU_COMPAT_MAX_ENTITIES;
+
+	ent_enum->bmap = kcalloc(DIV_ROUND_UP(idx_max, BITS_PER_LONG),
+				 sizeof(long), GFP_KERNEL);
+	if (!ent_enum->bmap)
+		return -ENOMEM;
+
+	bitmap_zero(ent_enum->bmap, idx_max);
+
+	ent_enum->idx_max = idx_max;
+	return 0;
+}
+#endif
diff --git a/drivers/media/pci/intel/ipu-isys-media.h b/drivers/media/pci/intel/ipu-isys-media.h
index b09d240..fe431e7 100644
--- a/drivers/media/pci/intel/ipu-isys-media.h
+++ b/drivers/media/pci/intel/ipu-isys-media.h
@@ -1,3 +1,4 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
@@ -7,6 +8,16 @@
 #include <linux/slab.h>
 #include <media/media-entity.h>
 
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+/* Copyright (C) 2016 - 2018 Intel Corporation */
+
+#include <media/media-entity.h>
+
+#ifndef IPU_ISYS_COMPAT_DEFS_H
+#define IPU_ISYS_COMPAT_DEFS_H
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 5, 0)
 #define is_media_entity_v4l2_subdev(e) \
 	(media_entity_type(e) == MEDIA_ENT_T_V4L2_SUBDEV)
@@ -27,6 +38,7 @@ struct media_entity_enum {
 	int idx_max;
 };
 
+<<<<<<< HEAD
 static inline int media_entity_enum_init(struct media_entity_enum *ent_enum,
 			   struct media_device *mdev)
 {
@@ -42,6 +54,10 @@ static inline int media_entity_enum_init(struct media_entity_enum *ent_enum,
 	ent_enum->idx_max = idx_max;
 	return 0;
 }
+=======
+int media_entity_enum_init(struct media_entity_enum *ent_enum,
+			   struct media_device *mdev);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static inline void media_entity_enum_cleanup(struct media_entity_enum *ent_enum)
 {
@@ -87,6 +103,7 @@ static inline bool media_entity_enum_test(struct media_entity_enum *ent_enum,
 #define media_graph_walk_cleanup(g) media_entity_graph_walk_cleanup(g)
 #endif
 
+<<<<<<< HEAD
 #ifndef MEDIA_IOC_REQUEST_CMD
 
 struct __packed media_request_cmd {
@@ -159,3 +176,7 @@ media_device_request_complete(struct media_device *mdev,
 #endif
 
 #endif /* IPU_ISYS_MEDIA_H */
+=======
+
+#endif /* IPU_ISYS_COMPAT_DEFS_H */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu-isys-queue.c b/drivers/media/pci/intel/ipu-isys-queue.c
index 9653c97..8dc3c80 100644
--- a/drivers/media/pci/intel/ipu-isys-queue.c
+++ b/drivers/media/pci/intel/ipu-isys-queue.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/completion.h>
@@ -493,6 +497,7 @@ void ipu_isys_buffer_list_to_ipu_fw_isys_frame_buff_set(
 
 	set->send_irq_sof = 1;
 	set->send_resp_sof = 1;
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 	set->send_irq_capture_ack = 1;
 	set->send_irq_capture_done = 1;
@@ -502,6 +507,10 @@ void ipu_isys_buffer_list_to_ipu_fw_isys_frame_buff_set(
 	set->send_irq_eof = 0;
 	set->send_resp_eof = 0;
 #endif
+=======
+	set->send_irq_eof = 1;
+	set->send_resp_eof = 1;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	list_for_each_entry(ib, &bl->head, head) {
 		if (ib->type == IPU_ISYS_VIDEO_BUFFER) {
@@ -674,7 +683,11 @@ static int ipu_isys_stream_start(struct ipu_isys_pipeline *ip,
 					buf, to_dma_addr(msg),
 					sizeof(*buf),
 					IPU_FW_ISYS_SEND_TYPE_STREAM_CAPTURE);
+<<<<<<< HEAD
 		ipu_put_fw_mgs_buffer(pipe_av->isys, (uintptr_t) buf);
+=======
+		ipu_put_fw_mgs_buffer(pipe_av->isys, (u64) buf);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	} while (!WARN_ON(rval));
 
 	return 0;
@@ -799,7 +812,11 @@ static void __buf_queue(struct vb2_buffer *vb, bool force)
 				       buf, to_dma_addr(msg),
 				       sizeof(*buf),
 				       IPU_FW_ISYS_SEND_TYPE_STREAM_CAPTURE);
+<<<<<<< HEAD
 	ipu_put_fw_mgs_buffer(pipe_av->isys, (uintptr_t) buf);
+=======
+	ipu_put_fw_mgs_buffer(pipe_av->isys, (u64) buf);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/*
 	 * FIXME: mark the buffers in the buffer list if the queue
 	 * operation fails.
@@ -1162,8 +1179,13 @@ ipu_isys_buf_calc_sequence_time(struct ipu_isys_buffer *ib,
 	vbuf->vb2_buf.timestamp = ns;
 	vbuf->sequence = sequence;
 
+<<<<<<< HEAD
 	dev_dbg(&av->isys->adev->dev, "buffer: %s: buffer done, CPU-timestamp:%lld, sequence:%d, vc:%d, index:%d, vbuf timestamp:%lld, endl\n",
 		av->vdev.name, ktime_get_ns(), sequence, ip->vc, vb->index, vbuf->vb2_buf.timestamp);
+=======
+	dev_dbg(&av->isys->adev->dev, "buffer: %s: buffer done %u\n",
+		av->vdev.name, vb->index);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 }
 
@@ -1332,6 +1354,7 @@ int ipu_isys_req_prepare(struct media_device *mdev,
 
 	set->send_irq_sof = 1;
 	set->send_resp_sof = 1;
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 	set->send_irq_capture_ack = 1;
 	set->send_irq_capture_done = 1;
@@ -1341,6 +1364,10 @@ int ipu_isys_req_prepare(struct media_device *mdev,
 	set->send_irq_eof = 0;
 	set->send_resp_eof = 0;
 #endif
+=======
+	set->send_irq_eof = 1;
+	set->send_resp_eof = 1;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	spin_lock_irqsave(&ireq->lock, flags);
 
@@ -1380,7 +1407,11 @@ ipu_isys_req_dispatch(struct media_device *mdev,
 				       ip->stream_handle,
 				       set, dma_addr, sizeof(*set),
 				       IPU_FW_ISYS_SEND_TYPE_STREAM_CAPTURE);
+<<<<<<< HEAD
 	ipu_put_fw_mgs_buffer(pipe_av->isys, (uintptr_t) set);
+=======
+	ipu_put_fw_mgs_buffer(pipe_av->isys, (u64) set);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	WARN_ON(rval);
 }
diff --git a/drivers/media/pci/intel/ipu-isys-queue.h b/drivers/media/pci/intel/ipu-isys-queue.h
index 5138077..32748a3 100644
--- a/drivers/media/pci/intel/ipu-isys-queue.h
+++ b/drivers/media/pci/intel/ipu-isys-queue.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_QUEUE_H
@@ -13,8 +17,13 @@
 #include <media/videobuf2-v4l2.h>
 #endif
 
+<<<<<<< HEAD
 #include "ipu-isys-media.h"
 
+=======
+
+struct ipu_isys;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 struct ipu_isys_video;
 struct ipu_isys_pipeline;
 struct ipu_fw_isys_resp_info_abi;
diff --git a/drivers/media/pci/intel/ipu-isys-subdev.c b/drivers/media/pci/intel/ipu-isys-subdev.c
index 4b4b055..9859ec1 100644
--- a/drivers/media/pci/intel/ipu-isys-subdev.c
+++ b/drivers/media/pci/intel/ipu-isys-subdev.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/types.h>
@@ -17,8 +21,11 @@ unsigned int ipu_isys_mbus_code_to_bpp(u32 code)
 	switch (code) {
 	case MEDIA_BUS_FMT_RGB888_1X24:
 		return 24;
+<<<<<<< HEAD
 	case MEDIA_BUS_FMT_YUYV10_1X20:
 		return 20;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	case MEDIA_BUS_FMT_Y10_1X10:
 	case MEDIA_BUS_FMT_RGB565_1X16:
 	case MEDIA_BUS_FMT_UYVY8_1X16:
@@ -61,8 +68,11 @@ unsigned int ipu_isys_mbus_code_to_mipi(u32 code)
 		return IPU_ISYS_MIPI_CSI2_TYPE_RGB565;
 	case MEDIA_BUS_FMT_RGB888_1X24:
 		return IPU_ISYS_MIPI_CSI2_TYPE_RGB888;
+<<<<<<< HEAD
 	case MEDIA_BUS_FMT_YUYV10_1X20:
 		return IPU_ISYS_MIPI_CSI2_TYPE_YUV422_10;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	case MEDIA_BUS_FMT_UYVY8_1X16:
 	case MEDIA_BUS_FMT_YUYV8_1X16:
 		return IPU_ISYS_MIPI_CSI2_TYPE_YUV422_8;
@@ -131,6 +141,22 @@ enum ipu_isys_subdev_pixelorder ipu_isys_subdev_get_pixelorder(u32 code)
 	}
 }
 
+<<<<<<< HEAD
+=======
+unsigned int ipu_isys_get_compression_scheme(u32 code)
+{
+	switch (code) {
+	case MEDIA_BUS_FMT_SBGGR10_DPCM8_1X8:
+	case MEDIA_BUS_FMT_SGBRG10_DPCM8_1X8:
+	case MEDIA_BUS_FMT_SGRBG10_DPCM8_1X8:
+	case MEDIA_BUS_FMT_SRGGB10_DPCM8_1X8:
+		return 3;
+	default:
+		return 0;
+	}
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 u32 ipu_isys_subdev_code_to_uncompressed(u32 sink_code)
 {
 	switch (sink_code) {
@@ -223,7 +249,11 @@ static int target_valid(struct v4l2_subdev *sd, unsigned int target,
 	}
 }
 
+<<<<<<< HEAD
 int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
+=======
+void ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 1, 0)
 				   struct v4l2_subdev_fh *cfg,
 #else
@@ -235,6 +265,7 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 				   unsigned int pad, unsigned int which)
 {
 	struct ipu_isys_subdev *asd = to_ipu_isys_subdev(sd);
+<<<<<<< HEAD
 	struct v4l2_mbus_framefmt **ffmts = NULL;
 	struct v4l2_rect **crops = NULL;
 	struct v4l2_rect **compose = NULL;
@@ -265,6 +296,18 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 		rval = -ENOMEM;
 		goto out_subdev_fmt_propagate;
 	}
+=======
+	struct v4l2_mbus_framefmt *ffmts[sd->entity.num_pads];
+	struct v4l2_rect *crops[sd->entity.num_pads];
+	struct v4l2_rect *compose[sd->entity.num_pads];
+	unsigned int i;
+
+	if (tgt == IPU_ISYS_SUBDEV_PROP_TGT_NR_OF)
+		return;
+
+	if (WARN_ON(pad >= sd->entity.num_pads))
+		return;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	for (i = 0; i < sd->entity.num_pads; i++) {
 		ffmts[i] = __ipu_isys_get_ffmt(sd, cfg, i, 0, which);
@@ -280,17 +323,27 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 		crops[pad]->top = 0;
 		crops[pad]->width = ffmt->width;
 		crops[pad]->height = ffmt->height;
+<<<<<<< HEAD
 		rval = ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt, crops[pad],
 					      tgt + 1, pad, which);
 		goto out_subdev_fmt_propagate;
 	case IPU_ISYS_SUBDEV_PROP_TGT_SINK_CROP:
 		if (WARN_ON(sd->entity.pads[pad].flags & MEDIA_PAD_FL_SOURCE))
 			goto out_subdev_fmt_propagate;
+=======
+		ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt, crops[pad],
+					      tgt + 1, pad, which);
+		return;
+	case IPU_ISYS_SUBDEV_PROP_TGT_SINK_CROP:
+		if (WARN_ON(sd->entity.pads[pad].flags & MEDIA_PAD_FL_SOURCE))
+			return;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 		compose[pad]->left = 0;
 		compose[pad]->top = 0;
 		compose[pad]->width = r->width;
 		compose[pad]->height = r->height;
+<<<<<<< HEAD
 		rval = ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
 					      compose[pad], tgt + 1,
 					      pad, which);
@@ -300,6 +353,15 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 			rval = -EINVAL;
 			goto out_subdev_fmt_propagate;
 		}
+=======
+		ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
+					      compose[pad], tgt + 1,
+					      pad, which);
+		return;
+	case IPU_ISYS_SUBDEV_PROP_TGT_SINK_COMPOSE:
+		if (WARN_ON(sd->entity.pads[pad].flags & MEDIA_PAD_FL_SOURCE))
+			return;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 		/* 1:n and 1:1 case: only propagate to the first source pad */
 		if (asd->nsinks == 1 && asd->nsources >= 1) {
@@ -307,12 +369,19 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 			    compose[asd->nsinks]->top = 0;
 			compose[asd->nsinks]->width = r->width;
 			compose[asd->nsinks]->height = r->height;
+<<<<<<< HEAD
 			rval = ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
 						      compose[asd->nsinks],
 						      tgt + 1, asd->nsinks,
 						      which);
 			if (rval)
 				goto out_subdev_fmt_propagate;
+=======
+			ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
+						      compose[asd->nsinks],
+						      tgt + 1, asd->nsinks,
+						      which);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			/* n:n case: propagate according to route info */
 		} else if (asd->nsinks == asd->nsources && asd->nsources > 1) {
 			for (i = asd->nsinks; i < sd->entity.num_pads; i++)
@@ -324,12 +393,19 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 				compose[i]->top = 0;
 				compose[i]->width = r->width;
 				compose[i]->height = r->height;
+<<<<<<< HEAD
 				rval = ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
 							      compose[i],
 							      tgt + 1, i,
 							      which);
 				if (rval)
 					goto out_subdev_fmt_propagate;
+=======
+				ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
+							      compose[i],
+							      tgt + 1, i,
+							      which);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			}
 			/* n:m case: propagate to all source pad */
 		} else if (asd->nsinks != asd->nsources && asd->nsources > 1 &&
@@ -343,11 +419,16 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 				compose[i]->top = 0;
 				compose[i]->width = r->width;
 				compose[i]->height = r->height;
+<<<<<<< HEAD
 				rval = ipu_isys_subdev_fmt_propagate(sd, cfg,
+=======
+				ipu_isys_subdev_fmt_propagate(sd, cfg,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 							      ffmt,
 							      compose[i],
 							      tgt + 1, i,
 							      which);
+<<<<<<< HEAD
 				if (rval)
 					goto out_subdev_fmt_propagate;
 			}
@@ -358,14 +439,28 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 			rval = -EINVAL;
 			goto out_subdev_fmt_propagate;
 		}
+=======
+			}
+		}
+		return;
+	case IPU_ISYS_SUBDEV_PROP_TGT_SOURCE_COMPOSE:
+		if (WARN_ON(sd->entity.pads[pad].flags & MEDIA_PAD_FL_SINK))
+			return;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 		crops[pad]->left = 0;
 		crops[pad]->top = 0;
 		crops[pad]->width = r->width;
 		crops[pad]->height = r->height;
+<<<<<<< HEAD
 		rval = ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
 					      crops[pad], tgt + 1, pad, which);
 		goto out_subdev_fmt_propagate;
+=======
+		ipu_isys_subdev_fmt_propagate(sd, cfg, ffmt,
+					      crops[pad], tgt + 1, pad, which);
+		return;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	case IPU_ISYS_SUBDEV_PROP_TGT_SOURCE_CROP:{
 			struct v4l2_subdev_format fmt = {
 				.which = which,
@@ -386,6 +481,7 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 			};
 
 			asd->set_ffmt(sd, cfg, &fmt);
+<<<<<<< HEAD
 			goto out_subdev_fmt_propagate;
 		}
 	}
@@ -398,6 +494,14 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 }
 
 int ipu_isys_subdev_set_ffmt_default(struct v4l2_subdev *sd,
+=======
+			return;
+		}
+	}
+}
+
+void ipu_isys_subdev_set_ffmt_default(struct v4l2_subdev *sd,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 1, 0)
 				      struct v4l2_subdev_fh *cfg,
 #else
@@ -419,6 +523,10 @@ int ipu_isys_subdev_set_ffmt_default(struct v4l2_subdev *sd,
 		ffmt->height = sink_ffmt->height;
 		ffmt->code = sink_ffmt->code;
 		ffmt->field = sink_ffmt->field;
+<<<<<<< HEAD
+=======
+		return;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 
 	ffmt->width = fmt->format.width;
@@ -426,7 +534,11 @@ int ipu_isys_subdev_set_ffmt_default(struct v4l2_subdev *sd,
 	ffmt->code = fmt->format.code;
 	ffmt->field = fmt->format.field;
 
+<<<<<<< HEAD
 	return ipu_isys_subdev_fmt_propagate(sd, cfg, &fmt->format, NULL,
+=======
+	ipu_isys_subdev_fmt_propagate(sd, cfg, &fmt->format, NULL,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 				      IPU_ISYS_SUBDEV_PROP_TGT_SINK_FMT,
 				      fmt->pad, fmt->which);
 }
@@ -553,9 +665,16 @@ bool ipu_isys_subdev_has_route(struct media_entity *entity,
 		    ((asd->route[i].sink == pad0 &&
 		      asd->route[i].source == pad1) ||
 		     (asd->route[i].sink == pad1 &&
+<<<<<<< HEAD
 			  asd->route[i].source == pad0))) {
 			if (stream)
 				*stream = i;
+=======
+		      asd->route[i].source == pad0))) {
+			if (stream)
+				*stream = i;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			return true;
 		}
 	}
@@ -593,7 +712,12 @@ int ipu_isys_subdev_set_routing(struct v4l2_subdev *sd,
 		if (j == asd->nstreams)
 			continue;
 
+<<<<<<< HEAD
 		if (asd->route[j].flags & V4L2_SUBDEV_ROUTE_FL_IMMUTABLE)
+=======
+		if (t->flags & V4L2_SUBDEV_ROUTE_FL_IMMUTABLE &&
+		    t->flags != asd->route[j].flags)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			continue;
 
 		if ((t->flags & V4L2_SUBDEV_ROUTE_FL_SOURCE) && asd->nsinks)
@@ -733,8 +857,15 @@ int ipu_isys_subdev_set_sel(struct v4l2_subdev *sd,
 	sel->r.height = clamp(sel->r.height, IPU_ISYS_MIN_HEIGHT, r->height);
 	*__ipu_isys_get_selection(sd, cfg, sel->target, sel->pad,
 				  sel->which) = sel->r;
+<<<<<<< HEAD
 	return ipu_isys_subdev_fmt_propagate(sd, cfg, NULL, &sel->r, tgt,
 				      sel->pad, sel->which);
+=======
+	ipu_isys_subdev_fmt_propagate(sd, cfg, NULL, &sel->r, tgt,
+				      sel->pad, sel->which);
+
+	return 0;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 int ipu_isys_subdev_get_sel(struct v4l2_subdev *sd,
@@ -904,6 +1035,12 @@ int ipu_isys_subdev_init(struct ipu_isys_subdev *asd,
 
 	v4l2_subdev_init(&asd->sd, ops);
 
+<<<<<<< HEAD
+=======
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 0)
+	asd->sd.entity.function = MEDIA_ENT_F_IO_V4L;
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	asd->sd.flags |= V4L2_SUBDEV_FL_HAS_DEVNODE | sd_flags;
 	asd->sd.owner = THIS_MODULE;
 
diff --git a/drivers/media/pci/intel/ipu-isys-subdev.h b/drivers/media/pci/intel/ipu-isys-subdev.h
index 034b356..039cde0 100644
--- a/drivers/media/pci/intel/ipu-isys-subdev.h
+++ b/drivers/media/pci/intel/ipu-isys-subdev.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_SUBDEV_H
@@ -16,7 +20,10 @@
 #define IPU_ISYS_MIPI_CSI2_TYPE_BLANKING	0x11
 #define IPU_ISYS_MIPI_CSI2_TYPE_EMBEDDED8	0x12
 #define IPU_ISYS_MIPI_CSI2_TYPE_YUV422_8	0x1e
+<<<<<<< HEAD
 #define IPU_ISYS_MIPI_CSI2_TYPE_YUV422_10	0x1f
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define IPU_ISYS_MIPI_CSI2_TYPE_RGB565	0x22
 #define IPU_ISYS_MIPI_CSI2_TYPE_RGB888	0x24
 #define IPU_ISYS_MIPI_CSI2_TYPE_RAW6	0x28
@@ -121,7 +128,11 @@ u32 ipu_isys_subdev_code_to_uncompressed(u32 sink_code);
 
 enum ipu_isys_subdev_pixelorder ipu_isys_subdev_get_pixelorder(u32 code);
 
+<<<<<<< HEAD
 int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
+=======
+void ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 1, 0)
 				   struct v4l2_subdev_fh *cfg,
 #else
@@ -132,7 +143,11 @@ int ipu_isys_subdev_fmt_propagate(struct v4l2_subdev *sd,
 				   enum isys_subdev_prop_tgt tgt,
 				   unsigned int pad, unsigned int which);
 
+<<<<<<< HEAD
 int ipu_isys_subdev_set_ffmt_default(struct v4l2_subdev *sd,
+=======
+void ipu_isys_subdev_set_ffmt_default(struct v4l2_subdev *sd,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 1, 0)
 				      struct v4l2_subdev_fh *cfg,
 #else
diff --git a/drivers/media/pci/intel/ipu-isys-tpg.c b/drivers/media/pci/intel/ipu-isys-tpg.c
index e7400e0..7f4e290 100644
--- a/drivers/media/pci/intel/ipu-isys-tpg.c
+++ b/drivers/media/pci/intel/ipu-isys-tpg.c
@@ -1,11 +1,19 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/device.h>
 #include <linux/module.h>
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_CRLMODULE)
 #include <linux/crlmodule.h>
 #endif
+=======
+#include <linux/crlmodule.h>
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #include <media/media-entity.h>
 #include <media/v4l2-device.h>
@@ -59,7 +67,10 @@ static int ipu_isys_tpg_s_ctrl(struct v4l2_ctrl *ctrl)
 	case V4L2_CID_VBLANK:
 		writel(ctrl->val, tpg->base + MIPI_GEN_REG_SYNG_VBLANK_CYC);
 		break;
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_CRLMODULE)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	case V4L2_CID_LINE_LENGTH_PIXELS:
 		if (ctrl->val > tpg->asd.ffmt[TPG_PAD_SOURCE][0].width)
 			writel(ctrl->val -
@@ -72,7 +83,10 @@ static int ipu_isys_tpg_s_ctrl(struct v4l2_ctrl *ctrl)
 				   tpg->asd.ffmt[TPG_PAD_SOURCE][0].height,
 				   tpg->base + MIPI_GEN_REG_SYNG_VBLANK_CYC);
 		break;
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	case V4L2_CID_TEST_PATTERN:
 		writel(ctrl->val, tpg->base + MIPI_GEN_REG_TPG_MODE);
 		break;
@@ -94,6 +108,10 @@ static const char *const tpg_mode_items[] = {
 	"Ramp",
 	"Checkerboard",	/* Does not work, disabled. */
 	"Frame Based Colour",
+<<<<<<< HEAD
+=======
+	NULL,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct v4l2_ctrl_config tpg_mode = {
@@ -108,6 +126,7 @@ static struct v4l2_ctrl_config tpg_mode = {
 	.qmenu = tpg_mode_items,
 };
 
+<<<<<<< HEAD
 static const struct v4l2_ctrl_config csi2_header_cfg = {
 	.id = V4L2_CID_IPU_STORE_CSI2_HEADER,
 	.name = "Store CSI-2 Headers",
@@ -118,21 +137,32 @@ static const struct v4l2_ctrl_config csi2_header_cfg = {
 	.def = 1,
 };
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static void ipu_isys_tpg_init_controls(struct v4l2_subdev *sd)
 {
 	struct ipu_isys_tpg *tpg = to_ipu_isys_tpg(sd);
 	int hblank;
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_CRLMODULE)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct v4l2_ctrl_config cfg = {
 		.ops = &ipu_isys_tpg_ctrl_ops,
 		.type = V4L2_CTRL_TYPE_INTEGER,
 		.max = 65535,
 		.min = 8,
 		.step = 1,
+<<<<<<< HEAD
 		.qmenu = NULL,
 		.elem_size = 0,
 	};
 #endif
+=======
+		.qmenu = 0,
+		.elem_size = 0,
+	};
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	hblank = 1024;
 
@@ -144,7 +174,10 @@ static void ipu_isys_tpg_init_controls(struct v4l2_subdev *sd)
 					&ipu_isys_tpg_ctrl_ops,
 					V4L2_CID_VBLANK, 8, 65535, 1, 1024);
 
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_CRLMODULE)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	cfg.id = V4L2_CID_LINE_LENGTH_PIXELS;
 	cfg.name = "Line Length Pixels";
 	cfg.def = 1024 + 4096;
@@ -156,7 +189,10 @@ static void ipu_isys_tpg_init_controls(struct v4l2_subdev *sd)
 	cfg.def = 1024 + 3072;
 	tpg->fll = v4l2_ctrl_new_custom(&tpg->asd.ctrl_handler, &cfg, NULL);
 
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	tpg->pixel_rate = v4l2_ctrl_new_std(&tpg->asd.ctrl_handler,
 					    &ipu_isys_tpg_ctrl_ops,
 					    V4L2_CID_PIXEL_RATE, 0, 0, 1, 0);
@@ -167,8 +203,11 @@ static void ipu_isys_tpg_init_controls(struct v4l2_subdev *sd)
 	}
 
 	v4l2_ctrl_new_custom(&tpg->asd.ctrl_handler, &tpg_mode, NULL);
+<<<<<<< HEAD
 	tpg->store_csi2_header =
 		v4l2_ctrl_new_custom(&tpg->asd.ctrl_handler, &csi2_header_cfg, NULL);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static void tpg_set_ffmt(struct v4l2_subdev *sd,
@@ -210,6 +249,7 @@ static int ipu_isys_tpg_set_ffmt(struct v4l2_subdev *sd,
 	return 0;
 }
 
+<<<<<<< HEAD
 static const struct ipu_isys_pixelformat *ipu_isys_tpg_try_fmt(
 					struct ipu_isys_video *av,
 					struct v4l2_pix_format_mplane *mpix)
@@ -233,6 +273,15 @@ static const struct ipu_isys_pixelformat *ipu_isys_tpg_try_fmt(
 
 	return ipu_isys_video_try_fmt_vid_mplane(av, mpix,
 		v4l2_ctrl_g_ctrl(tpg->store_csi2_header));
+=======
+const struct ipu_isys_pixelformat *ipu_isys_tpg_try_fmt(struct ipu_isys_video
+							*av,
+							struct
+							v4l2_pix_format_mplane
+							*mpix)
+{
+	return ipu_isys_video_try_fmt_vid_mplane(av, mpix, 1);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static const struct v4l2_subdev_pad_ops tpg_sd_pad_ops = {
@@ -241,6 +290,7 @@ static const struct v4l2_subdev_pad_ops tpg_sd_pad_ops = {
 	.enum_mbus_code = ipu_isys_subdev_enum_mbus_code,
 };
 
+<<<<<<< HEAD
 static int subscribe_event(struct v4l2_subdev *sd, struct v4l2_fh *fh,
 			   struct v4l2_event_subscription *sub)
 {
@@ -260,6 +310,9 @@ static const struct v4l2_subdev_core_ops tpg_sd_core_ops = {
 
 static struct v4l2_subdev_ops tpg_sd_ops = {
 	.core = &tpg_sd_core_ops,
+=======
+static struct v4l2_subdev_ops tpg_sd_ops = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.video = &tpg_sd_video_ops,
 	.pad = &tpg_sd_pad_ops,
 };
@@ -303,6 +356,7 @@ int ipu_isys_tpg_init(struct ipu_isys_tpg *tpg,
 				    NR_OF_TPG_PADS,
 				    NR_OF_TPG_STREAMS,
 				    NR_OF_TPG_SOURCE_PADS,
+<<<<<<< HEAD
 				    NR_OF_TPG_SINK_PADS,
 				    V4L2_SUBDEV_FL_HAS_EVENTS);
 	if (rval)
@@ -313,6 +367,12 @@ int ipu_isys_tpg_init(struct ipu_isys_tpg *tpg,
 #else
 	tpg->asd.sd.entity.function = MEDIA_ENT_F_CAM_SENSOR;
 #endif
+=======
+				    NR_OF_TPG_SINK_PADS, 0);
+	if (rval)
+		return rval;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	tpg->asd.pad[TPG_PAD_SOURCE].flags = MEDIA_PAD_FL_SOURCE;
 
 	tpg->asd.source = IPU_FW_ISYS_STREAM_SRC_MIPIGEN_PORT0 + index;
diff --git a/drivers/media/pci/intel/ipu-isys-tpg.h b/drivers/media/pci/intel/ipu-isys-tpg.h
index 65b8e21..2254efd 100644
--- a/drivers/media/pci/intel/ipu-isys-tpg.h
+++ b/drivers/media/pci/intel/ipu-isys-tpg.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_TPG_H
@@ -78,17 +82,27 @@ struct ipu_isys_tpg {
 
 	struct v4l2_ctrl *hblank;
 	struct v4l2_ctrl *vblank;
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_CRLMODULE)
 	struct v4l2_ctrl *llp;
 	struct v4l2_ctrl *fll;
 #endif
 	struct v4l2_ctrl *pixel_rate;
 	struct v4l2_ctrl *store_csi2_header;
+=======
+	struct v4l2_ctrl *llp;
+	struct v4l2_ctrl *fll;
+	struct v4l2_ctrl *pixel_rate;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 #define to_ipu_isys_tpg(sd)		\
 	container_of(to_ipu_isys_subdev(sd), \
 	struct ipu_isys_tpg, asd)
+<<<<<<< HEAD
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ipu_isys_tpg_init(struct ipu_isys_tpg *tpg,
 		      struct ipu_isys *isys,
 		      void __iomem *base, void __iomem *sel,
diff --git a/drivers/media/pci/intel/ipu-isys-video.c b/drivers/media/pci/intel/ipu-isys-video.c
index a1ffa29..f6364c5 100644
--- a/drivers/media/pci/intel/ipu-isys-video.c
+++ b/drivers/media/pci/intel/ipu-isys-video.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/delay.h>
@@ -40,7 +44,11 @@ module_param(num_stream_support, uint, 0660);
 MODULE_PARM_DESC(num_stream_support, "IPU project support number of stream");
 
 static bool use_stream_stop;
+<<<<<<< HEAD
 module_param(use_stream_stop, bool, 0660);
+=======
+module_param(use_stream_stop, bool, S_IRUSR | S_IWUSR | S_IRGRP | S_IWGRP);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 MODULE_PARM_DESC(use_stream_stop, "Use STOP command if running in CSI capture mode");
 
 const struct ipu_isys_pixelformat ipu_isys_pfmts_be_soc[] = {
@@ -50,10 +58,15 @@ const struct ipu_isys_pixelformat ipu_isys_pfmts_be_soc[] = {
 	 IPU_FW_ISYS_FRAME_FORMAT_UYVY},
 	{V4L2_PIX_FMT_YUYV, 16, 16, 0, MEDIA_BUS_FMT_YUYV8_1X16,
 	 IPU_FW_ISYS_FRAME_FORMAT_YUYV},
+<<<<<<< HEAD
 	{V4L2_PIX_FMT_NV16, 16, 16, 8, MEDIA_BUS_FMT_UYVY8_1X16,
 	 IPU_FW_ISYS_FRAME_FORMAT_NV16},
 	{V4L2_PIX_FMT_YUV420, 12, 0, 8, MEDIA_BUS_FMT_UYVY8_2X8,
 	 IPU_FW_ISYS_FRAME_FORMAT_YUV420},
+=======
+	{V4L2_PIX_FMT_NV16, 16, 16, 8, MEDIA_BUS_FMT_YUYV8_1X16,
+	 IPU_FW_ISYS_FRAME_FORMAT_NV16},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{V4L2_PIX_FMT_XRGB32, 32, 32, 0, MEDIA_BUS_FMT_RGB565_1X16,
 	 IPU_FW_ISYS_FRAME_FORMAT_RGBA888},
 	{V4L2_PIX_FMT_XBGR32, 32, 32, 0, MEDIA_BUS_FMT_RGB888_1X24,
@@ -165,11 +178,14 @@ static int video_open(struct file *file)
 	struct ipu_isys *isys = av->isys;
 	struct ipu_bus_device *adev = to_ipu_bus_device(&isys->adev->dev);
 	struct ipu_device *isp = adev->isp;
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 	const struct sched_param param = {
 			.sched_priority = MAX_USER_RT_PRIO / 2,
 	};
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	int rval;
 
 	mutex_lock(&isys->mutex);
@@ -234,6 +250,7 @@ static int video_open(struct file *file)
 		ipu_fw_isys_cleanup(isys);
 	}
 
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 	isys->isr_thread = kthread_run(ipu_isys_isr_run,
 				       av->isys,
@@ -246,6 +263,8 @@ static int video_open(struct file *file)
 
 	sched_setscheduler(isys->isr_thread, SCHED_FIFO, &param);
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	rval = ipu_fw_isys_init(av->isys, num_stream_support);
 	if (rval < 0)
@@ -256,11 +275,14 @@ static int video_open(struct file *file)
 	return 0;
 
 out_lib_init:
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 	kthread_stop(isys->isr_thread);
 
 out_ipu_pipeline_pm_use:
 #endif /* IPU_IRQ_POLL */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	isys->video_opened--;
 	mutex_unlock(&isys->mutex);
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 6, 0)
@@ -287,9 +309,12 @@ static int video_release(struct file *file)
 	mutex_lock(&av->isys->mutex);
 
 	if (!--av->isys->video_opened) {
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 		kthread_stop(av->isys->isr_thread);
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		ipu_fw_isys_close(av->isys);
 		if (av->isys->fwcom) {
 			av->isys->reset_needed = true;
@@ -441,6 +466,15 @@ int ipu_isys_vidioc_enum_fmt(struct file *file, void *fh,
 
 	f->flags = 0;
 
+<<<<<<< HEAD
+=======
+	if (*supported_codes == MEDIA_BUS_FMT_FIXED) {
+		/* FIXME: No proper pixel format. Use 0. */
+		f->pixelformat = 0;
+		return 0;
+	}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* Code found */
 	for (pfmt = av->pfmts; pfmt->bpp; pfmt++)
 		if (pfmt->code == *supported_codes)
@@ -487,11 +521,14 @@ const struct ipu_isys_pixelformat *ipu_isys_video_try_fmt_vid_mplane(
 	mpix->pixelformat = pfmt->pixelformat;
 	mpix->num_planes = 1;
 
+<<<<<<< HEAD
 	mpix->width = clamp(mpix->width, IPU_ISYS_MIN_WIDTH,
 			    IPU_ISYS_MAX_WIDTH);
 	mpix->height = clamp(mpix->height, IPU_ISYS_MIN_HEIGHT,
 			     IPU_ISYS_MAX_HEIGHT);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (!av->packed)
 		mpix->plane_fmt[0].bytesperline =
 		    mpix->width * DIV_ROUND_UP(pfmt->bpp_planar ?
@@ -529,6 +566,7 @@ const struct ipu_isys_pixelformat *ipu_isys_video_try_fmt_vid_mplane(
 		    max(mpix->plane_fmt[0].bytesperline,
 			av->isys->pdata->ipdata->isys_dma_overshoot)), 1U);
 
+<<<<<<< HEAD
 	memset(mpix->plane_fmt[0].reserved, 0,
 	       sizeof(mpix->plane_fmt[0].reserved));
 
@@ -539,6 +577,10 @@ const struct ipu_isys_pixelformat *ipu_isys_video_try_fmt_vid_mplane(
 	mpix->ycbcr_enc = V4L2_YCBCR_ENC_DEFAULT;
 	mpix->quantization = V4L2_QUANTIZATION_DEFAULT;
 	mpix->xfer_func = V4L2_XFER_FUNC_DEFAULT;
+=======
+	if (mpix->field == V4L2_FIELD_ANY)
+		mpix->field = V4L2_FIELD_NONE;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return pfmt;
 }
@@ -591,10 +633,13 @@ static void fmt_mp_to_sp(struct v4l2_pix_format *pix,
 	pix->bytesperline = mpix->plane_fmt[0].bytesperline;
 	pix->sizeimage = mpix->plane_fmt[0].sizeimage;
 	pix->flags = mpix->flags;
+<<<<<<< HEAD
 	pix->colorspace = mpix->colorspace;
 	pix->ycbcr_enc = mpix->ycbcr_enc;
 	pix->quantization = mpix->quantization;
 	pix->xfer_func = mpix->xfer_func;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int vidioc_g_fmt_vid_cap(struct file *file, void *fh,
@@ -641,6 +686,7 @@ static int vidioc_try_fmt_vid_cap(struct file *file, void *fh,
 	return 0;
 }
 
+<<<<<<< HEAD
 static long ipu_isys_vidioc_private(struct file *file, void *fh,
 				    bool valid_prio, unsigned int cmd,
 				    void *arg)
@@ -661,6 +707,8 @@ static long ipu_isys_vidioc_private(struct file *file, void *fh,
 	return ret;
 }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int vidioc_enum_input(struct file *file, void *fh,
 			     struct v4l2_input *input)
 {
@@ -751,7 +799,11 @@ static int link_validate(struct media_link *link)
 
 	if (ip->external) {
 		struct v4l2_mbus_frame_desc desc = {
+<<<<<<< HEAD
 			.num_entries = V4L2_FRAME_DESC_ENTRY_MAX,
+=======
+			.num_entries = IPU_ISYS_MAX_STREAMS,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		};
 
 		sd = media_entity_to_v4l2_subdev(ip->external->entity);
@@ -952,7 +1004,11 @@ static int short_packet_queue_setup(struct ipu_isys_pipeline *ip)
 	return 0;
 }
 
+<<<<<<< HEAD
 static void csi_short_packet_prepare_firmware_stream_cfg(
+=======
+void csi_short_packet_prepare_firmware_stream_cfg(
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 				struct ipu_isys_pipeline *ip,
 				struct ipu_fw_isys_stream_cfg_data_abi *cfg)
 {
@@ -992,6 +1048,10 @@ void ipu_isys_prepare_firmware_stream_cfg_default(
 {
 	struct ipu_isys_pipeline *ip =
 	    to_ipu_isys_pipeline(av->vdev.entity.pipe);
+<<<<<<< HEAD
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct ipu_isys_queue *aq = &av->aq;
 	struct ipu_fw_isys_output_pin_info_abi *pin_info;
 	int pin = cfg->nof_output_pins++;
@@ -1105,9 +1165,12 @@ static int start_stream_firmware(struct ipu_isys_video *av,
 	if (ip->csi2 && !v4l2_ctrl_g_ctrl(ip->csi2->store_csi2_header))
 		stream_cfg->input_pins[0].mipi_store_mode =
 		    IPU_FW_ISYS_MIPI_STORE_MODE_DISCARD_LONG_HEADER;
+<<<<<<< HEAD
 	else if (ip->tpg && !v4l2_ctrl_g_ctrl(ip->tpg->store_csi2_header))
 		stream_cfg->input_pins[0].mipi_store_mode =
 		    IPU_FW_ISYS_MIPI_STORE_MODE_DISCARD_LONG_HEADER;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	stream_cfg->src = ip->source;
 	stream_cfg->vc = 0;
@@ -1194,7 +1257,11 @@ static int start_stream_firmware(struct ipu_isys_video *av,
 				       to_dma_addr(msg),
 				       sizeof(*stream_cfg),
 				       IPU_FW_ISYS_SEND_TYPE_STREAM_OPEN);
+<<<<<<< HEAD
 	ipu_put_fw_mgs_buffer(av->isys, (uintptr_t) stream_cfg);
+=======
+	ipu_put_fw_mgs_buffer(av->isys, (u64) stream_cfg);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (rval < 0) {
 		dev_err(dev, "can't open stream (%d)\n", rval);
@@ -1249,7 +1316,11 @@ static int start_stream_firmware(struct ipu_isys_video *av,
 				buf, to_dma_addr(msg),
 				sizeof(*buf),
 				IPU_FW_ISYS_SEND_TYPE_STREAM_START_AND_CAPTURE);
+<<<<<<< HEAD
 		ipu_put_fw_mgs_buffer(av->isys, (uintptr_t) buf);
+=======
+		ipu_put_fw_mgs_buffer(av->isys, (u64) buf);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	} else {
 		rval = ipu_fw_isys_simple_cmd(av->isys,
 					ip->stream_handle,
@@ -1436,7 +1507,10 @@ int ipu_isys_video_prepare_streaming(struct ipu_isys_video *av,
 	ip->csi2_be = NULL;
 	ip->csi2_be_soc = NULL;
 	ip->csi2 = NULL;
+<<<<<<< HEAD
 	ip->tpg = NULL;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	ip->seq_index = 0;
 	memset(ip->seq, 0, sizeof(ip->seq));
 
@@ -1465,11 +1539,15 @@ int ipu_isys_video_prepare_streaming(struct ipu_isys_video *av,
 
 	/* Gather all entities in the graph. */
 	mutex_lock(&mdev->graph_mutex);
+<<<<<<< HEAD
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 19, 0)
 	media_graph_walk_start(&graph, &av->vdev.entity);
 #else
 	media_graph_walk_start(&graph, &av->vdev.entity.pads[0]);
 #endif
+=======
+	media_graph_walk_start(&graph, &av->vdev.entity.pads[0]);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	while ((entity = media_graph_walk_next(&graph)))
 		media_entity_enum_set(&ip->entity_enum, entity);
 
@@ -1575,9 +1653,13 @@ int ipu_isys_video_set_streaming(struct ipu_isys_video *av,
 		if (ip->csi2) {
 			if (ip->csi2->stream_count == 1) {
 				v4l2_subdev_call(esd, video, s_stream, state);
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 				ipu_isys_csi2_wait_last_eof(ip->csi2);
 #endif
+=======
+				ipu_isys_csi2_wait_last_eof(ip->csi2);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			}
 		} else {
 			v4l2_subdev_call(esd, video, s_stream, state);
@@ -1591,11 +1673,15 @@ int ipu_isys_video_set_streaming(struct ipu_isys_video *av,
 				      ip->
 #endif
 				      graph,
+<<<<<<< HEAD
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 19, 0)
 				      &av->vdev.entity);
 #else
 				      &av->vdev.entity.pads[0]);
 #endif
+=======
+				      &av->vdev.entity.pads[0]);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	while ((entity = media_graph_walk_next(&
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 0)
@@ -1679,11 +1765,15 @@ int ipu_isys_video_set_streaming(struct ipu_isys_video *av,
 				      ip->
 #endif
 				      graph,
+<<<<<<< HEAD
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 19, 0)
 				      &av->vdev.entity);
 #else
 				      &av->vdev.entity.pads[0]);
 #endif
+=======
+				      &av->vdev.entity.pads[0]);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	while (state && (entity2 = media_graph_walk_next(&
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 5, 0)
@@ -1741,7 +1831,10 @@ static const struct v4l2_ioctl_ops ioctl_ops_splane = {
 	.vidioc_streamon = vb2_ioctl_streamon,
 	.vidioc_streamoff = vb2_ioctl_streamoff,
 	.vidioc_expbuf = vb2_ioctl_expbuf,
+<<<<<<< HEAD
 	.vidioc_default = ipu_isys_vidioc_private,
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.vidioc_enum_input = vidioc_enum_input,
 	.vidioc_g_input = vidioc_g_input,
 	.vidioc_s_input = vidioc_s_input,
@@ -1749,11 +1842,15 @@ static const struct v4l2_ioctl_ops ioctl_ops_splane = {
 
 static const struct v4l2_ioctl_ops ioctl_ops_mplane = {
 	.vidioc_querycap = ipu_isys_vidioc_querycap,
+<<<<<<< HEAD
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(5, 3, 0)
 	.vidioc_enum_fmt_vid_cap = ipu_isys_vidioc_enum_fmt,
 #else
 	.vidioc_enum_fmt_vid_cap_mplane = ipu_isys_vidioc_enum_fmt,
 #endif
+=======
+	.vidioc_enum_fmt_vid_cap_mplane = ipu_isys_vidioc_enum_fmt,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.vidioc_g_fmt_vid_cap_mplane = vidioc_g_fmt_vid_cap_mplane,
 	.vidioc_s_fmt_vid_cap_mplane = vidioc_s_fmt_vid_cap_mplane,
 	.vidioc_try_fmt_vid_cap_mplane = vidioc_try_fmt_vid_cap_mplane,
@@ -1766,7 +1863,10 @@ static const struct v4l2_ioctl_ops ioctl_ops_mplane = {
 	.vidioc_streamon = vb2_ioctl_streamon,
 	.vidioc_streamoff = vb2_ioctl_streamoff,
 	.vidioc_expbuf = vb2_ioctl_expbuf,
+<<<<<<< HEAD
 	.vidioc_default = ipu_isys_vidioc_private,
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.vidioc_enum_input = vidioc_enum_input,
 	.vidioc_g_input = vidioc_g_input,
 	.vidioc_s_input = vidioc_s_input,
diff --git a/drivers/media/pci/intel/ipu-isys-video.h b/drivers/media/pci/intel/ipu-isys-video.h
index c1375f7..1a387d5 100644
--- a/drivers/media/pci/intel/ipu-isys-video.h
+++ b/drivers/media/pci/intel/ipu-isys-video.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_VIDEO_H
@@ -18,6 +22,11 @@
 #define IPU_ISYS_MAX_PARALLEL_SOF 2
 
 struct ipu_isys;
+<<<<<<< HEAD
+=======
+struct ipu_fw_isys_stream_cfg_data;
+struct ipu_isys_csi2_be_raw;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 struct ipu_isys_csi2_be_soc;
 struct ipu_fw_isys_stream_cfg_data_abi;
 
@@ -54,7 +63,10 @@ struct ipu_isys_pipeline {
 	struct ipu_isys_csi2_be *csi2_be;
 	struct ipu_isys_csi2_be_soc *csi2_be_soc;
 	struct ipu_isys_csi2 *csi2;
+<<<<<<< HEAD
 	struct ipu_isys_tpg *tpg;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/*
 	 * Number of capture queues, write access serialised using struct
 	 * ipu_isys.stream_mutex
diff --git a/drivers/media/pci/intel/ipu-isys.c b/drivers/media/pci/intel/ipu-isys.c
index 51a5fc5..7db8138 100644
--- a/drivers/media/pci/intel/ipu-isys.c
+++ b/drivers/media/pci/intel/ipu-isys.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/debugfs.h>
@@ -14,7 +18,10 @@
 #include <linux/version.h>
 
 #include <media/ipu-isys.h>
+<<<<<<< HEAD
 #include <media/ipu4-acpi.h>
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE >= KERNEL_VERSION(4, 6, 0)
 #include <media/v4l2-mc.h>
 #endif
@@ -40,7 +47,11 @@
  * The param was passed from module to indicate if port
  * could be optimized.
  */
+<<<<<<< HEAD
 static bool csi2_port_optimized = true;
+=======
+static bool csi2_port_optimized;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 module_param(csi2_port_optimized, bool, 0660);
 MODULE_PARM_DESC(csi2_port_optimized, "IPU CSI2 port optimization");
 
@@ -331,6 +342,7 @@ i2c_client *isys_find_i2c_subdev(struct i2c_adapter *adapter,
 	return test.client;
 }
 
+<<<<<<< HEAD
 static struct v4l2_subdev *
 register_acpi_i2c_subdev(struct v4l2_device *v4l2_dev,
                         struct ipu_isys_subdev_info *sd_info,
@@ -365,6 +377,8 @@ register_acpi_i2c_subdev(struct v4l2_device *v4l2_dev,
        return sd;
 }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int
 isys_complete_ext_device_registration(struct ipu_isys *isys,
 				      struct v4l2_subdev *sd,
@@ -404,6 +418,7 @@ isys_complete_ext_device_registration(struct ipu_isys *isys,
 }
 
 static int isys_register_ext_subdev(struct ipu_isys *isys,
+<<<<<<< HEAD
 				    struct ipu_isys_subdev_info *sd_info,
 				    bool acpi_only)
 {
@@ -427,12 +442,30 @@ static int isys_register_ext_subdev(struct ipu_isys *isys,
 		dev_warn(&isys->adev->dev, "can't find adapter\n");
 		return -ENOENT;
 	}
+=======
+				    struct ipu_isys_subdev_info *sd_info)
+{
+	struct i2c_adapter *adapter =
+	    i2c_get_adapter(sd_info->i2c.i2c_adapter_id);
+	struct v4l2_subdev *sd;
+	struct i2c_client *client;
+	int rval;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	dev_info(&isys->adev->dev,
 		 "creating new i2c subdev for %s (address %2.2x, bus %d)",
 		 sd_info->i2c.board_info.type, sd_info->i2c.board_info.addr,
+<<<<<<< HEAD
 		 bus);
 
+=======
+		 sd_info->i2c.i2c_adapter_id);
+
+	if (!adapter) {
+		dev_warn(&isys->adev->dev, "can't find adapter\n");
+		return -ENOENT;
+	}
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (sd_info->csi2) {
 		dev_info(&isys->adev->dev, "sensor device on CSI port: %d\n",
 			 sd_info->csi2->port);
@@ -449,6 +482,7 @@ static int isys_register_ext_subdev(struct ipu_isys *isys,
 
 	client = isys_find_i2c_subdev(adapter, sd_info);
 
+<<<<<<< HEAD
 	if (acpi_only) {
 		if (!client) {
 			dev_dbg(&isys->adev->dev, "Matching ACPI device not found - postpone\n");
@@ -488,13 +522,26 @@ static int isys_register_ext_subdev(struct ipu_isys *isys,
                 sd = register_acpi_i2c_subdev(&isys->v4l2_dev,
                                               sd_info, client);
         }
+=======
+	if (client) {
+		dev_dbg(&isys->adev->dev, "Device exists\n");
+		rval = 0;
+		goto skip_put_adapter;
+	}
+
+	sd = v4l2_i2c_new_subdev_board(&isys->v4l2_dev, adapter,
+				       &sd_info->i2c.board_info, 0);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (!sd) {
 		dev_warn(&isys->adev->dev, "can't create new i2c subdev\n");
 		rval = -EINVAL;
 		goto skip_put_adapter;
 	}
+<<<<<<< HEAD
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (!sd_info->csi2)
 		return 0;
 
@@ -506,6 +553,7 @@ static int isys_register_ext_subdev(struct ipu_isys *isys,
 	return rval;
 }
 
+<<<<<<< HEAD
 static int isys_acpi_add_device(struct device *dev, void *priv,
                                struct ipu_isys_csi2_config *csi2,
                                bool reprobe)
@@ -546,11 +594,14 @@ static int isys_acpi_add_device(struct device *dev, void *priv,
        return -ENODEV;
 }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static void isys_register_ext_subdevs(struct ipu_isys *isys)
 {
 	struct ipu_isys_subdev_pdata *spdata = isys->pdata->spdata;
 	struct ipu_isys_subdev_info **sd_info;
 
+<<<<<<< HEAD
         if (spdata) {
                 /* Scan spdata first to possibly override ACPI data */
                 /* ACPI created devices */
@@ -570,6 +621,14 @@ static void isys_register_ext_subdevs(struct ipu_isys *isys)
         ipu_get_acpi_devices(isys, &isys->adev->dev,
                                     isys_acpi_add_device);
 
+=======
+	if (!spdata) {
+		dev_info(&isys->adev->dev, "no subdevice info provided\n");
+		return;
+	}
+	for (sd_info = spdata->subdevs; *sd_info; sd_info++)
+		isys_register_ext_subdev(isys, *sd_info);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static void isys_unregister_subdevices(struct ipu_isys *isys)
@@ -733,8 +792,12 @@ static int isys_register_subdevices(struct ipu_isys *isys)
 			    media_create_pad_link(&isys->tpg[i].asd.sd.entity,
 						  TPG_PAD_SOURCE,
 						  &isys->csi2_be_soc.asd.sd.
+<<<<<<< HEAD
 						  entity, k,
 						  MEDIA_LNK_FL_DYNAMIC);
+=======
+						  entity, k, 0);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			if (rval) {
 				dev_info(&isys->adev->dev,
 					 "can't create link tpg->be_soc\n");
@@ -758,17 +821,27 @@ static int isys_register_subdevices(struct ipu_isys *isys)
 	return rval;
 }
 
+<<<<<<< HEAD
 static struct media_device_ops isys_mdev_ops = {
+=======
+struct media_device_ops isys_mdev_ops = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 6, 0)
 	.link_notify = ipu_pipeline_link_notify,
 #else
 	.link_notify = v4l2_pipeline_link_notify,
 #endif
+<<<<<<< HEAD
 #ifdef MEDIA_IOC_REQUEST_CMD
 	.req_alloc = ipu_isys_req_alloc,
 	.req_free = ipu_isys_req_free,
 	.req_queue = ipu_isys_req_queue,
 #endif /* MEDIA_IOC_REQUEST_CMD */
+=======
+	.req_alloc = ipu_isys_req_alloc,
+	.req_free = ipu_isys_req_free,
+	.req_queue = ipu_isys_req_queue,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static int isys_register_devices(struct ipu_isys *isys)
@@ -939,8 +1012,12 @@ static void isys_remove(struct ipu_bus_device *adev)
 	struct isys_fw_msgs *fwmsg, *safe;
 
 	dev_info(&adev->dev, "removed\n");
+<<<<<<< HEAD
 	if (isp->ipu_dir)
 		debugfs_remove_recursive(isys->debugfsdir);
+=======
+	debugfs_remove_recursive(isys->debugfsdir);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	list_for_each_entry_safe(fwmsg, safe, &isys->framebuflist, head) {
 		dma_free_attrs(&adev->dev, sizeof(struct isys_fw_msgs),
@@ -1141,7 +1218,11 @@ void ipu_cleanup_fw_msg_bufs(struct ipu_isys *isys)
 void ipu_put_fw_mgs_buffer(struct ipu_isys *isys, u64 data)
 {
 	struct isys_fw_msgs *msg;
+<<<<<<< HEAD
 	u64 *ptr = (u64 *)(unsigned long)data;
+=======
+	u64 *ptr = (u64 *) data;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (!ptr)
 		return;
@@ -1158,17 +1239,28 @@ static int isys_probe(struct ipu_bus_device *adev)
 	struct ipu_mmu *mmu = dev_get_drvdata(adev->iommu);
 	struct ipu_isys *isys;
 	struct ipu_device *isp = adev->isp;
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
 	const u32 trace_size = IPU_ISYS_SHORT_PACKET_TRACE_BUFFER_SIZE;
 	dma_addr_t *trace_dma_addr;
+=======
+	const u32 trace_size = IPU_ISYS_SHORT_PACKET_TRACE_BUFFER_SIZE;
+	dma_addr_t *trace_dma_addr;
+
+	const struct firmware *uninitialized_var(fw);
+	int rval = 0;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 8, 0)
 	struct dma_attrs attrs;
 #else
 	unsigned long attrs;
 #endif
+<<<<<<< HEAD
 #endif
 	const struct firmware *uninitialized_var(fw);
 	int rval = 0;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	trace_printk("B|%d|TMWK\n", current->pid);
 
@@ -1293,7 +1385,10 @@ static int isys_probe(struct ipu_bus_device *adev)
 
 	if (isys->short_packet_source == IPU_ISYS_SHORT_PACKET_FROM_TUNIT) {
 		mutex_destroy(&isys->short_packet_tracing_mutex);
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU4) || defined(CONFIG_VIDEO_INTEL_IPU4P)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		dma_free_attrs(&adev->dev, trace_size,
 			       isys->short_packet_trace_buffer,
 			       isys->short_packet_trace_buffer_dma_addr,
@@ -1302,7 +1397,10 @@ static int isys_probe(struct ipu_bus_device *adev)
 #else
 			       attrs);
 #endif
+<<<<<<< HEAD
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 
 	return rval;
diff --git a/drivers/media/pci/intel/ipu-isys.h b/drivers/media/pci/intel/ipu-isys.h
index cd18a226..3deaa07 100644
--- a/drivers/media/pci/intel/ipu-isys.h
+++ b/drivers/media/pci/intel/ipu-isys.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_H
@@ -13,7 +17,10 @@
 #include <uapi/linux/ipu-isys.h>
 
 #include "ipu.h"
+<<<<<<< HEAD
 #include "ipu-isys-media.h"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include "ipu-isys-csi2.h"
 #include "ipu-isys-csi2-be.h"
 #include "ipu-isys-tpg.h"
@@ -104,10 +111,13 @@ struct ipu_isys {
 	struct ipu_isys_pipeline *pipes[IPU_ISYS_MAX_STREAMS];
 	void *fwcom;
 	unsigned int line_align;
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 	/* for polling for events if interrupt delivery isn't available */
 	struct task_struct *isr_thread;
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	bool reset_needed;
 	bool icache_prefetch;
 	bool csi2_cse_ipc_not_supported;
diff --git a/drivers/media/pci/intel/ipu-mmu.c b/drivers/media/pci/intel/ipu-mmu.c
index f46f479..8ade49f 100644
--- a/drivers/media/pci/intel/ipu-mmu.c
+++ b/drivers/media/pci/intel/ipu-mmu.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <asm/cacheflush.h>
@@ -834,7 +838,11 @@ static int ipu_mmu_suspend(struct device *dev)
 	return 0;
 }
 
+<<<<<<< HEAD
 static const struct dev_pm_ops ipu_mmu_pm_ops = {
+=======
+const struct dev_pm_ops ipu_mmu_pm_ops = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.resume = ipu_mmu_hw_init,
 	.suspend = ipu_mmu_suspend,
 	.runtime_resume = ipu_mmu_hw_init,
diff --git a/drivers/media/pci/intel/ipu-mmu.h b/drivers/media/pci/intel/ipu-mmu.h
index 0e8863a..b6a0ca5 100644
--- a/drivers/media/pci/intel/ipu-mmu.h
+++ b/drivers/media/pci/intel/ipu-mmu.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_MMU_H
@@ -12,6 +16,11 @@
 #define ISYS_MMID 1
 #define PSYS_MMID 0
 
+<<<<<<< HEAD
+=======
+struct pci_dev;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /*
  * @pgtbl: virtual address of the l1 page table (one page)
  */
diff --git a/drivers/media/pci/intel/ipu-pdata.h b/drivers/media/pci/intel/ipu-pdata.h
index 66f1112..346a7be 100644
--- a/drivers/media/pci/intel/ipu-pdata.h
+++ b/drivers/media/pci/intel/ipu-pdata.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_PDATA_H
diff --git a/drivers/media/pci/intel/ipu-psys-compat32.c b/drivers/media/pci/intel/ipu-psys-compat32.c
index df1bd4f..747d18c 100644
--- a/drivers/media/pci/intel/ipu-psys-compat32.c
+++ b/drivers/media/pci/intel/ipu-psys-compat32.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/compat.h>
@@ -7,8 +11,11 @@
 
 #include <uapi/linux/ipu-psys.h>
 
+<<<<<<< HEAD
 #include "ipu-psys.h"
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static long native_ioctl(struct file *file, unsigned int cmd, unsigned long arg)
 {
 	long ret = -ENOTTY;
@@ -42,7 +49,10 @@ struct ipu_psys_command32 {
 	u32 pg_manifest_size;
 	u32 bufcount;
 	u32 min_psys_freq;
+<<<<<<< HEAD
 	u32 frame_counter;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	u32 reserved[2];
 } __packed;
 
@@ -60,7 +70,11 @@ get_ipu_psys_command32(struct ipu_psys_command *kp,
 	compat_uptr_t pgm, bufs;
 
 	if (!access_ok(VERIFY_READ, up,
+<<<<<<< HEAD
 		       sizeof(struct ipu_psys_command32)) ||
+=======
+		       sizeof(struct ipu_psys_buffer32)) ||
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	    get_user(kp->issue_id, &up->issue_id) ||
 	    get_user(kp->user_token, &up->user_token) ||
 	    get_user(kp->priority, &up->priority) ||
@@ -70,7 +84,10 @@ get_ipu_psys_command32(struct ipu_psys_command *kp,
 	    get_user(kp->pg_manifest_size, &up->pg_manifest_size) ||
 	    get_user(kp->bufcount, &up->bufcount) ||
 	    get_user(kp->min_psys_freq, &up->min_psys_freq)
+<<<<<<< HEAD
 		|| get_user(kp->frame_counter, &up->frame_counter)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	    )
 		return -EFAULT;
 
diff --git a/drivers/media/pci/intel/ipu-psys.c b/drivers/media/pci/intel/ipu-psys.c
index 9f22f9c..9d349a0 100644
--- a/drivers/media/pci/intel/ipu-psys.c
+++ b/drivers/media/pci/intel/ipu-psys.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/debugfs.h>
@@ -13,9 +17,12 @@
 #include <linux/mm.h>
 #include <linux/module.h>
 #include <linux/pm_runtime.h>
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU_ACRN) && defined(CONFIG_VIDEO_INTEL_IPU_VIRTIO_BE)
 #include <linux/syscalls.h>
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <linux/version.h>
 #include <linux/poll.h>
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 14, 0)
@@ -40,6 +47,7 @@
 #include "ipu-cpd.h"
 #include "ipu-fw-psys.h"
 #include "ipu-psys.h"
+<<<<<<< HEAD
 #include "ipu-platform-psys.h"
 #include "ipu-platform-regs.h"
 #include "ipu-fw-isys.h"
@@ -50,6 +58,30 @@ module_param(async_fw_init, bool, 0664);
 MODULE_PARM_DESC(async_fw_init, "Enable asynchronous firmware initialization");
 
 #define IPU_PSYS_NUM_DEVICES		4
+=======
+#include "ipu-platform-regs.h"
+#define CREATE_TRACE_POINTS
+#define IPU_PG_KCMD_TRACE
+#include "ipu-trace-event.h"
+#include "ipu-fw-isys.h"
+#include "ipu-fw-com.h"
+
+static bool early_pg_transfer;
+static bool enable_concurrency = true;
+static bool async_fw_init;
+module_param(early_pg_transfer, bool, 0664);
+module_param(enable_concurrency, bool, 0664);
+module_param(async_fw_init, bool, 0664);
+
+MODULE_PARM_DESC(early_pg_transfer,
+		 "Copy PGs back to user after resource allocation");
+MODULE_PARM_DESC(enable_concurrency,
+		 "Enable concurrent execution of program groups");
+MODULE_PARM_DESC(async_fw_init, "Enable asynchronous firmware initialization");
+
+#define IPU_PSYS_NUM_DEVICES		4
+#define IPU_PSYS_WORK_QUEUE		system_power_efficient_wq
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define IPU_PSYS_AUTOSUSPEND_DELAY	2000
 
 #ifdef CONFIG_PM
@@ -75,15 +107,19 @@ static struct fw_init_task {
 	struct ipu_psys *psys;
 } fw_init_task;
 
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 static int ipu_psys_isr_run(void *data);
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static void ipu_psys_remove(struct ipu_bus_device *adev);
 
 static struct bus_type ipu_psys_bus = {
 	.name = IPU_PSYS_NAME,
 };
 
+<<<<<<< HEAD
 struct ipu_psys_pg *__get_pg_buf(struct ipu_psys *psys, size_t pg_size)
 {
 	struct ipu_psys_pg *kpg;
@@ -121,6 +157,15 @@ struct ipu_psys_pg *__get_pg_buf(struct ipu_psys *psys, size_t pg_size)
 }
 
 struct ipu_psys_kbuffer *ipu_psys_lookup_kbuffer(struct ipu_psys_fh *fh, int fd)
+=======
+static struct ipu_psys_capability caps = {
+	.version = 1,
+	.driver = "ipu-psys",
+};
+
+static struct ipu_psys_kbuffer *
+ipu_psys_lookup_kbuffer(struct ipu_psys_fh *fh, int fd)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	struct ipu_psys_kbuffer *kbuffer;
 
@@ -132,7 +177,11 @@ struct ipu_psys_kbuffer *ipu_psys_lookup_kbuffer(struct ipu_psys_fh *fh, int fd)
 	return NULL;
 }
 
+<<<<<<< HEAD
 struct ipu_psys_kbuffer *
+=======
+static struct ipu_psys_kbuffer *
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 ipu_psys_lookup_kbuffer_by_kaddr(struct ipu_psys_fh *fh, void *kaddr)
 {
 	struct ipu_psys_kbuffer *kbuffer;
@@ -145,6 +194,10 @@ ipu_psys_lookup_kbuffer_by_kaddr(struct ipu_psys_fh *fh, void *kaddr)
 	return NULL;
 }
 
+<<<<<<< HEAD
+=======
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int ipu_psys_get_userpages(struct ipu_dma_buf_attach *attach)
 {
 	struct vm_area_struct *vma;
@@ -164,6 +217,7 @@ static int ipu_psys_get_userpages(struct ipu_dma_buf_attach *attach)
 	if (!sgt)
 		return -ENOMEM;
 
+<<<<<<< HEAD
 	if (attach->npages != 0) {
 		pages = attach->pages;
 		npages = attach->npages;
@@ -171,6 +225,8 @@ static int ipu_psys_get_userpages(struct ipu_dma_buf_attach *attach)
 		goto skip_pages;
 	}
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (array_size <= PAGE_SIZE)
 		pages = kzalloc(array_size, GFP_KERNEL);
 	else
@@ -227,10 +283,13 @@ static int ipu_psys_get_userpages(struct ipu_dma_buf_attach *attach)
 	}
 	up_read(&current->mm->mmap_sem);
 
+<<<<<<< HEAD
 	attach->pages = pages;
 	attach->npages = npages;
 
 skip_pages:
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	ret = sg_alloc_table_from_pages(sgt, pages, npages,
 					start & ~PAGE_MASK, attach->len,
 					GFP_KERNEL);
@@ -238,6 +297,11 @@ static int ipu_psys_get_userpages(struct ipu_dma_buf_attach *attach)
 		goto error;
 
 	attach->sgt = sgt;
+<<<<<<< HEAD
+=======
+	attach->pages = pages;
+	attach->npages = npages;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 
@@ -383,6 +447,7 @@ static void ipu_dma_buf_release(struct dma_buf *buf)
 	if (!kbuf)
 		return;
 
+<<<<<<< HEAD
 	if (kbuf->db_attach) {
 		dev_dbg(kbuf->db_attach->dev,
 			"releasing buffer %d\n", kbuf->fd);
@@ -392,6 +457,16 @@ static void ipu_dma_buf_release(struct dma_buf *buf)
 }
 
 static int ipu_dma_buf_begin_cpu_access(struct dma_buf *dma_buf,
+=======
+	dev_dbg(&kbuf->psys->adev->dev, "releasing buffer %d\n", kbuf->fd);
+
+	if (kbuf->db_attach)
+		ipu_psys_put_userpages(kbuf->db_attach->priv);
+	kfree(kbuf);
+}
+
+int ipu_dma_buf_begin_cpu_access(struct dma_buf *dma_buf,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 6, 0)
 				 size_t start, size_t len,
 #endif
@@ -437,7 +512,11 @@ static void ipu_dma_buf_vunmap(struct dma_buf *dmabuf, void *vaddr)
 	vm_unmap_ram(vaddr, ipu_attach->npages);
 }
 
+<<<<<<< HEAD
 struct dma_buf_ops ipu_dma_buf_ops = {
+=======
+static struct dma_buf_ops ipu_dma_buf_ops = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.attach = ipu_dma_buf_attach,
 	.detach = ipu_dma_buf_detach,
 	.map_dma_buf = ipu_dma_buf_map,
@@ -461,7 +540,12 @@ static int ipu_psys_open(struct inode *inode, struct file *file)
 	struct ipu_psys *psys = inode_to_ipu_psys(inode);
 	struct ipu_device *isp = psys->adev->isp;
 	struct ipu_psys_fh *fh;
+<<<<<<< HEAD
 	int rval;
+=======
+	struct ipu_psys_buffer_set *kbuf_set, *kbuf_set_tmp;
+	int i, rval;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	if (isp->flr_done)
 		return -EIO;
@@ -472,10 +556,16 @@ static int ipu_psys_open(struct inode *inode, struct file *file)
 		return rval;
 	}
 
+<<<<<<< HEAD
+=======
+	pm_runtime_use_autosuspend(&psys->adev->dev);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	fh = kzalloc(sizeof(*fh), GFP_KERNEL);
 	if (!fh)
 		return -ENOMEM;
 
+<<<<<<< HEAD
 	fh->psys = psys;
 
 #if defined(CONFIG_VIDEO_INTEL_IPU_ACRN) && defined(CONFIG_VIDEO_INTEL_IPU_VIRTIO_BE)
@@ -509,11 +599,46 @@ static int ipu_psys_open(struct inode *inode, struct file *file)
 		sched_setscheduler(psys->isr_thread, SCHED_FIFO, &param);
 	}
 #endif
+=======
+	mutex_init(&fh->mutex);
+	INIT_LIST_HEAD(&fh->bufmap);
+	for (i = 0; i < IPU_PSYS_CMD_PRIORITY_NUM; i++)
+		INIT_LIST_HEAD(&fh->kcmds[i]);
+
+	init_waitqueue_head(&fh->wait);
+
+	mutex_init(&fh->bs_mutex);
+	INIT_LIST_HEAD(&fh->buf_sets);
+
+	/* allocate and map memory for buf_sets */
+	for (i = 0; i < IPU_PSYS_BUF_SET_POOL_SIZE; i++) {
+		kbuf_set = kzalloc(sizeof(*kbuf_set), GFP_KERNEL);
+		if (!kbuf_set)
+			goto out_free_buf_sets;
+		kbuf_set->kaddr = dma_alloc_attrs(&psys->adev->dev,
+						  IPU_PSYS_BUF_SET_MAX_SIZE,
+						  &kbuf_set->dma_addr,
+						  GFP_KERNEL,
+						  DMA_ATTR_NON_CONSISTENT);
+		if (!kbuf_set->kaddr) {
+			kfree(kbuf_set);
+			goto out_free_buf_sets;
+		}
+		kbuf_set->size = IPU_PSYS_BUF_SET_MAX_SIZE;
+		list_add(&kbuf_set->list, &fh->buf_sets);
+	}
+
+	fh->psys = psys;
+	file->private_data = fh;
+
+	mutex_lock(&psys->mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	list_add_tail(&fh->list, &psys->fhs);
 	mutex_unlock(&psys->mutex);
 
 	return 0;
 
+<<<<<<< HEAD
 open_failed:
 #ifdef IPU_IRQ_POLL
 	if (list_empty(&psys->fhs) && psys->isr_thread) {
@@ -526,11 +651,66 @@ static int ipu_psys_open(struct inode *inode, struct file *file)
 	return rval;
 }
 
+=======
+out_free_buf_sets:
+	list_for_each_entry_safe(kbuf_set, kbuf_set_tmp, &fh->buf_sets, list) {
+		dma_free_attrs(&psys->adev->dev,
+			       kbuf_set->size, kbuf_set->kaddr,
+			       kbuf_set->dma_addr, DMA_ATTR_NON_CONSISTENT);
+		list_del(&kbuf_set->list);
+		kfree(kbuf_set);
+	}
+	mutex_destroy(&fh->bs_mutex);
+	mutex_destroy(&fh->mutex);
+	kfree(fh);
+	return -ENOMEM;
+}
+
+/*
+ * Called to free up all resources associated with a kcmd.
+ * After this the kcmd doesn't anymore exist in the driver.
+ */
+static void ipu_psys_kcmd_free(struct ipu_psys_kcmd *kcmd)
+{
+	struct ipu_psys *psys;
+	unsigned long flags;
+
+	if (!kcmd)
+		return;
+
+	psys = kcmd->fh->psys;
+
+	if (!list_empty(&kcmd->list))
+		list_del(&kcmd->list);
+
+	spin_lock_irqsave(&psys->pgs_lock, flags);
+	if (kcmd->kpg) {
+		kcmd->kpg->pg_size = 0;
+	}
+	spin_unlock_irqrestore(&psys->pgs_lock, flags);
+
+	mutex_lock(&kcmd->fh->bs_mutex);
+	if (kcmd->kbuf_set) {
+		kcmd->kbuf_set->buf_set_size = 0;
+	}
+	mutex_unlock(&kcmd->fh->bs_mutex);
+
+	kfree(kcmd->pg_manifest);
+	kfree(kcmd->kbufs);
+	kfree(kcmd->buffers);
+	kfree(kcmd);
+}
+
+static int ipu_psys_kcmd_abort(struct ipu_psys *psys,
+			       struct ipu_psys_kcmd *kcmd, int error);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int ipu_psys_release(struct inode *inode, struct file *file)
 {
 	struct ipu_psys *psys = inode_to_ipu_psys(inode);
 	struct ipu_psys_fh *fh = file->private_data;
 	struct ipu_psys_kbuffer *kbuf, *kbuf0;
+<<<<<<< HEAD
 #if LINUX_VERSION_CODE > KERNEL_VERSION(4, 17, 0) && defined(CONFIG_VIDEO_INTEL_IPU_ACRN) && defined(CONFIG_VIDEO_INTEL_IPU_VIRTIO_BE)
 	struct ipu_dma_buf_attach *ipu_attach;
 #endif
@@ -583,6 +763,77 @@ static int ipu_psys_release(struct inode *inode, struct file *file)
 	mutex_unlock(&psys->mutex);
 
 	ipu_psys_fh_deinit(fh);
+=======
+	struct ipu_psys_kcmd *kcmd, *kcmd0;
+	struct ipu_psys_buffer_set *kbuf_set, *kbuf_set0;
+	int p;
+
+	mutex_lock(&psys->mutex);
+	mutex_lock(&fh->mutex);
+
+	/*
+	 * Set pg_user to NULL so that completed kcmds don't write
+	 * their result to user space anymore.
+	 */
+	for (p = 0; p < IPU_PSYS_CMD_PRIORITY_NUM; p++)
+		list_for_each_entry(kcmd, &fh->kcmds[p], list)
+			kcmd->pg_user = NULL;
+
+	/* Prevent scheduler from running more kcmds */
+	memset(fh->new_kcmd_tail, 0, sizeof(fh->new_kcmd_tail));
+
+	/* Wait until kcmds are completed in this queue and free them */
+	for (p = 0; p < IPU_PSYS_CMD_PRIORITY_NUM; p++) {
+		fh->new_kcmd_tail[p] = NULL;
+		list_for_each_entry_safe(kcmd, kcmd0, &fh->kcmds[p], list) {
+			ipu_psys_kcmd_abort(psys, kcmd, -EIO);
+			ipu_psys_kcmd_free(kcmd);
+		}
+	}
+
+	mutex_lock(&fh->bs_mutex);
+	list_for_each_entry_safe(kbuf_set, kbuf_set0, &fh->buf_sets, list) {
+		dma_free_attrs(&psys->adev->dev,
+			       kbuf_set->size, kbuf_set->kaddr,
+			       kbuf_set->dma_addr, DMA_ATTR_NON_CONSISTENT);
+		list_del(&kbuf_set->list);
+		kfree(kbuf_set);
+	}
+	mutex_unlock(&fh->bs_mutex);
+
+	/* clean up buffers */
+	list_for_each_entry_safe(kbuf, kbuf0, &fh->bufmap, list) {
+		list_del(&kbuf->list);
+		/* Unmap and release buffers */
+		if (kbuf->dbuf && kbuf->db_attach) {
+			struct dma_buf *dbuf;
+
+			dma_buf_vunmap(kbuf->dbuf, kbuf->kaddr);
+			dma_buf_unmap_attachment(kbuf->db_attach, kbuf->sgt,
+						 DMA_BIDIRECTIONAL);
+			dma_buf_detach(kbuf->dbuf, kbuf->db_attach);
+			dbuf = kbuf->dbuf;
+			kbuf->dbuf = NULL;
+			kbuf->db_attach = NULL;
+			dma_buf_put(dbuf);
+		} else {
+			if (kbuf->db_attach)
+				ipu_psys_put_userpages(kbuf->db_attach->priv);
+			kfree(kbuf);
+		}
+	}
+
+	list_del(&fh->list);
+
+	/* disable runtime autosuspend for the last fh */
+	if (list_empty(&psys->fhs))
+		pm_runtime_dont_use_autosuspend(&psys->adev->dev);
+
+	mutex_unlock(&fh->mutex);
+	mutex_unlock(&psys->mutex);
+
+	mutex_destroy(&fh->bs_mutex);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	mutex_destroy(&fh->mutex);
 	kfree(fh);
 
@@ -638,6 +889,11 @@ static int ipu_psys_getbuf(struct ipu_psys_buffer *buf, struct ipu_psys_fh *fh)
 
 	kbuf->fd = ret;
 	buf->base.fd = ret;
+<<<<<<< HEAD
+=======
+	kbuf->psys = psys;
+	kbuf->fh = fh;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	kbuf->flags = buf->flags &= ~IPU_BUFFER_FLAG_USERPTR;
 	kbuf->flags = buf->flags |= IPU_BUFFER_FLAG_DMA_HANDLE;
 
@@ -655,6 +911,853 @@ static int ipu_psys_putbuf(struct ipu_psys_buffer *buf, struct ipu_psys_fh *fh)
 	return 0;
 }
 
+<<<<<<< HEAD
+=======
+struct ipu_psys_pg *__get_pg_buf(struct ipu_psys *psys, size_t pg_size)
+{
+	struct ipu_psys_pg *kpg;
+	unsigned long flags;
+
+	spin_lock_irqsave(&psys->pgs_lock, flags);
+	list_for_each_entry(kpg, &psys->pgs, list) {
+		if (!kpg->pg_size && kpg->size >= pg_size) {
+			kpg->pg_size = pg_size;
+			spin_unlock_irqrestore(&psys->pgs_lock, flags);
+			return kpg;
+		}
+	}
+	spin_unlock_irqrestore(&psys->pgs_lock, flags);
+	/* no big enough buffer available, allocate new one */
+	kpg = kzalloc(sizeof(*kpg), GFP_KERNEL);
+	if (!kpg)
+		return NULL;
+
+	kpg->pg = dma_alloc_attrs(&psys->adev->dev, pg_size,
+				  &kpg->pg_dma_addr, GFP_KERNEL,
+				  DMA_ATTR_NON_CONSISTENT);
+	if (!kpg->pg) {
+		kfree(kpg);
+		return NULL;
+	}
+
+	kpg->pg_size = pg_size;
+	kpg->size = pg_size;
+	spin_lock_irqsave(&psys->pgs_lock, flags);
+	list_add(&kpg->list, &psys->pgs);
+	spin_unlock_irqrestore(&psys->pgs_lock, flags);
+
+	return kpg;
+}
+
+struct ipu_psys_buffer_set *__get_buf_set(struct ipu_psys_fh *fh,
+					  size_t buf_set_size)
+{
+	struct ipu_psys_buffer_set *kbuf_set;
+
+	mutex_lock(&fh->bs_mutex);
+	list_for_each_entry(kbuf_set, &fh->buf_sets, list) {
+		if (!kbuf_set->buf_set_size && kbuf_set->size >= buf_set_size) {
+			kbuf_set->buf_set_size = buf_set_size;
+			mutex_unlock(&fh->bs_mutex);
+			return kbuf_set;
+		}
+	}
+
+	mutex_unlock(&fh->bs_mutex);
+	/* no big enough buffer available, allocate new one */
+	kbuf_set = kzalloc(sizeof(*kbuf_set), GFP_KERNEL);
+	if (!kbuf_set)
+		return NULL;
+
+	kbuf_set->kaddr = dma_alloc_attrs(&fh->psys->adev->dev,
+					  buf_set_size, &kbuf_set->dma_addr,
+					  GFP_KERNEL, DMA_ATTR_NON_CONSISTENT);
+	if (!kbuf_set->kaddr) {
+		kfree(kbuf_set);
+		return NULL;
+	}
+
+	kbuf_set->buf_set_size = buf_set_size;
+	kbuf_set->size = buf_set_size;
+	mutex_lock(&fh->bs_mutex);
+	list_add(&kbuf_set->list, &fh->buf_sets);
+	mutex_unlock(&fh->bs_mutex);
+
+	return kbuf_set;
+}
+
+struct ipu_psys_kcmd *ipu_psys_copy_cmd(struct ipu_psys_command *cmd,
+					struct ipu_psys_fh *fh)
+{
+	struct ipu_psys *psys = fh->psys;
+	struct ipu_psys_kcmd *kcmd;
+	struct ipu_psys_kbuffer *kpgbuf;
+	unsigned int i;
+	int ret, prevfd = 0;
+
+	if (cmd->bufcount > IPU_MAX_PSYS_CMD_BUFFERS)
+		return NULL;
+
+	if (!cmd->pg_manifest_size ||
+	    cmd->pg_manifest_size > KMALLOC_MAX_CACHE_SIZE)
+		return NULL;
+
+	kcmd = kzalloc(sizeof(*kcmd), GFP_KERNEL);
+	if (!kcmd)
+		return NULL;
+
+	kcmd->state = KCMD_STATE_NEW;
+	kcmd->fh = fh;
+	INIT_LIST_HEAD(&kcmd->list);
+	INIT_LIST_HEAD(&kcmd->started_list);
+
+	mutex_lock(&fh->mutex);
+	kpgbuf = ipu_psys_lookup_kbuffer(fh, cmd->pg);
+	mutex_unlock(&fh->mutex);
+	if (!kpgbuf || !kpgbuf->sgt)
+		goto error;
+
+	kcmd->pg_user = kpgbuf->kaddr;
+	kcmd->kpg = __get_pg_buf(psys, kpgbuf->len);
+	if (!kcmd->kpg)
+		goto error;
+
+	memcpy(kcmd->kpg->pg, kcmd->pg_user, kcmd->kpg->pg_size);
+
+	kcmd->pg_manifest = kzalloc(cmd->pg_manifest_size, GFP_KERNEL);
+	if (!kcmd->pg_manifest)
+		goto error;
+
+	ret = copy_from_user(kcmd->pg_manifest, cmd->pg_manifest,
+			     cmd->pg_manifest_size);
+	if (ret)
+		goto error;
+
+	kcmd->pg_manifest_size = cmd->pg_manifest_size;
+
+	kcmd->user_token = cmd->user_token;
+	kcmd->issue_id = cmd->issue_id;
+	kcmd->priority = cmd->priority;
+	if (kcmd->priority >= IPU_PSYS_CMD_PRIORITY_NUM)
+		goto error;
+
+	kcmd->nbuffers = ipu_fw_psys_pg_get_terminal_count(kcmd);
+	kcmd->buffers = kcalloc(kcmd->nbuffers, sizeof(*kcmd->buffers),
+				GFP_KERNEL);
+	if (!kcmd->buffers)
+		goto error;
+
+	kcmd->kbufs = kcalloc(kcmd->nbuffers, sizeof(kcmd->kbufs[0]),
+			      GFP_KERNEL);
+	if (!kcmd->kbufs)
+		goto error;
+
+
+	if (!cmd->bufcount || kcmd->nbuffers > cmd->bufcount)
+		goto error;
+
+	ret = copy_from_user(kcmd->buffers, cmd->buffers,
+			     kcmd->nbuffers * sizeof(*kcmd->buffers));
+	if (ret)
+		goto error;
+
+	for (i = 0; i < kcmd->nbuffers; i++) {
+		struct ipu_fw_psys_terminal *terminal;
+
+		terminal = ipu_fw_psys_pg_get_terminal(kcmd, i);
+		if (!terminal)
+			continue;
+
+
+		mutex_lock(&fh->mutex);
+		kcmd->kbufs[i] = ipu_psys_lookup_kbuffer(fh,
+							 kcmd->buffers[i].base.
+							 fd);
+		mutex_unlock(&fh->mutex);
+		if (!kcmd->kbufs[i] || !kcmd->kbufs[i]->sgt ||
+		    kcmd->kbufs[i]->len < kcmd->buffers[i].bytes_used)
+			goto error;
+		if ((kcmd->kbufs[i]->flags &
+		     IPU_BUFFER_FLAG_NO_FLUSH) ||
+		    (kcmd->buffers[i].flags &
+		     IPU_BUFFER_FLAG_NO_FLUSH) ||
+		    prevfd == kcmd->buffers[i].base.fd)
+			continue;
+
+		prevfd = kcmd->buffers[i].base.fd;
+		dma_sync_sg_for_device(&psys->adev->dev,
+				       kcmd->kbufs[i]->sgt->sgl,
+				       kcmd->kbufs[i]->sgt->orig_nents,
+				       DMA_BIDIRECTIONAL);
+	}
+
+
+	return kcmd;
+error:
+	ipu_psys_kcmd_free(kcmd);
+
+	dev_dbg(&psys->adev->dev, "failed to copy cmd\n");
+
+	return NULL;
+}
+
+static void ipu_psys_kcmd_run(struct ipu_psys *psys)
+{
+	struct ipu_psys_kcmd *kcmd = list_first_entry(&psys->started_kcmds_list,
+						      struct ipu_psys_kcmd,
+						      started_list);
+	int ret;
+
+	ret = ipu_psys_move_resources(&psys->adev->dev,
+				      &kcmd->resource_alloc,
+				      &psys->resource_pool_started,
+				      &psys->resource_pool_running);
+	if (!ret) {
+		psys->started_kcmds--;
+		psys->active_kcmds++;
+		kcmd->state = KCMD_STATE_RUNNING;
+		list_del(&kcmd->started_list);
+		kcmd->watchdog.expires = jiffies +
+		    msecs_to_jiffies(psys->timeout);
+		add_timer(&kcmd->watchdog);
+		return;
+	}
+
+	if (ret != -ENOSPC || !psys->active_kcmds) {
+		dev_err(&psys->adev->dev,
+			"kcmd %p failed to alloc resources (running (%d, psys->active_kcmds = %d))\n",
+			kcmd, ret, psys->active_kcmds);
+		ipu_psys_kcmd_abort(psys, kcmd, ret);
+		return;
+	}
+}
+
+/*
+ * Move kcmd into completed state (due to running finished or failure).
+ * Fill up the event struct and notify waiters.
+ */
+static void ipu_psys_kcmd_complete(struct ipu_psys *psys,
+				   struct ipu_psys_kcmd *kcmd, int error)
+{
+	struct ipu_psys_fh *fh = kcmd->fh;
+
+	trace_ipu_pg_kcmd(__func__, kcmd->user_token, kcmd->issue_id,
+			  kcmd->priority,
+			  ipu_fw_psys_pg_get_id(kcmd),
+			  ipu_fw_psys_pg_load_cycles(kcmd),
+			  ipu_fw_psys_pg_init_cycles(kcmd),
+			  ipu_fw_psys_pg_processing_cycles(kcmd));
+
+	switch (kcmd->state) {
+	case KCMD_STATE_RUNNING:
+		if (try_to_del_timer_sync(&kcmd->watchdog) < 0) {
+			dev_err(&psys->adev->dev,
+				"could not cancel kcmd timer\n");
+			return;
+		}
+		/* Fall through on purpose */
+	case KCMD_STATE_RUN_PREPARED:
+		ipu_psys_free_resources(&kcmd->resource_alloc,
+					&psys->resource_pool_running);
+		if (psys->started_kcmds)
+			ipu_psys_kcmd_run(psys);
+		if (kcmd->state == KCMD_STATE_RUNNING)
+			psys->active_kcmds--;
+		break;
+	case KCMD_STATE_STARTED:
+		psys->started_kcmds--;
+		list_del(&kcmd->started_list);
+		/* Fall through on purpose */
+	case KCMD_STATE_START_PREPARED:
+		ipu_psys_free_resources(&kcmd->resource_alloc,
+					&psys->resource_pool_started);
+		break;
+	default:
+		break;
+	}
+
+	kcmd->ev.type = IPU_PSYS_EVENT_TYPE_CMD_COMPLETE;
+	kcmd->ev.user_token = kcmd->user_token;
+	kcmd->ev.issue_id = kcmd->issue_id;
+	kcmd->ev.error = error;
+
+	if (kcmd->constraint.min_freq)
+		ipu_buttress_remove_psys_constraint(psys->adev->isp,
+						    &kcmd->constraint);
+
+	if (!early_pg_transfer && kcmd->pg_user && kcmd->kpg->pg) {
+		struct ipu_psys_kbuffer *kbuf;
+
+		kbuf = ipu_psys_lookup_kbuffer_by_kaddr(kcmd->fh,
+							kcmd->pg_user);
+
+		if (kbuf && kbuf->valid)
+			memcpy(kcmd->pg_user,
+			       kcmd->kpg->pg, kcmd->kpg->pg_size);
+		else
+			dev_dbg(&psys->adev->dev,
+				"Skipping already unmapped buffer\n");
+	}
+
+	if (kcmd->state == KCMD_STATE_RUNNING ||
+	    kcmd->state == KCMD_STATE_STARTED) {
+		pm_runtime_mark_last_busy(&psys->adev->dev);
+		pm_runtime_put_autosuspend(&psys->adev->dev);
+	}
+
+	kcmd->state = KCMD_STATE_COMPLETE;
+
+	wake_up_interruptible(&fh->wait);
+}
+
+/*
+ * Move kcmd into completed state. If kcmd is currently running,
+ * abort it.
+ */
+static int ipu_psys_kcmd_abort(struct ipu_psys *psys,
+			       struct ipu_psys_kcmd *kcmd, int error)
+{
+	int ret = 0;
+
+	if (kcmd->state == KCMD_STATE_COMPLETE)
+		return 0;
+
+	if ((kcmd->state == KCMD_STATE_RUNNING ||
+	     kcmd->state == KCMD_STATE_STARTED)) {
+		ret = ipu_fw_psys_pg_abort(kcmd);
+		if (ret) {
+			dev_err(&psys->adev->dev, "failed to abort kcmd!\n");
+			goto out;
+		}
+	}
+
+out:
+	ipu_psys_kcmd_complete(psys, kcmd, ret);
+
+	return ret;
+}
+
+/*
+ * Submit kcmd into psys queue. If running fails, complete the kcmd
+ * with an error.
+ */
+static int ipu_psys_kcmd_start(struct ipu_psys *psys,
+			       struct ipu_psys_kcmd *kcmd)
+{
+	/*
+	 * Found a runnable PG. Move queue to the list tail for round-robin
+	 * scheduling and run the PG. Start the watchdog timer if the PG was
+	 * started successfully. Enable PSYS power if requested.
+	 */
+	int ret;
+
+	if (psys->adev->isp->flr_done) {
+		ipu_psys_kcmd_complete(psys, kcmd, -EIO);
+		return -EIO;
+	}
+
+	ret = pm_runtime_get_sync(&psys->adev->dev);
+	if (ret < 0) {
+		dev_err(&psys->adev->dev, "failed to power on PSYS\n");
+		ipu_psys_kcmd_complete(psys, kcmd, -EIO);
+		pm_runtime_put_noidle(&psys->adev->dev);
+		return ret;
+	}
+
+	if (early_pg_transfer && kcmd->pg_user && kcmd->kpg->pg)
+		memcpy(kcmd->pg_user, kcmd->kpg->pg, kcmd->kpg->pg_size);
+
+	ret = ipu_fw_psys_pg_start(kcmd);
+	if (ret) {
+		dev_err(&psys->adev->dev, "failed to start kcmd!\n");
+		goto error;
+	}
+
+	ipu_fw_psys_pg_dump(psys, kcmd, "run");
+
+	/*
+	 * Starting from scci_master_20151228_1800, pg start api is split into
+	 * two different calls, making driver responsible to flush pg between
+	 * start and disown library calls.
+	 */
+	clflush_cache_range(kcmd->kpg->pg, kcmd->kpg->pg_size);
+	ret = ipu_fw_psys_pg_disown(kcmd);
+	if (ret) {
+		dev_err(&psys->adev->dev, "failed to start kcmd!\n");
+		goto error;
+	}
+
+	trace_ipu_pg_kcmd(__func__, kcmd->user_token, kcmd->issue_id,
+			  kcmd->priority,
+			  ipu_fw_psys_pg_get_id(kcmd),
+			  ipu_fw_psys_pg_load_cycles(kcmd),
+			  ipu_fw_psys_pg_init_cycles(kcmd),
+			  ipu_fw_psys_pg_processing_cycles(kcmd));
+
+	switch (kcmd->state) {
+	case KCMD_STATE_RUN_PREPARED:
+		kcmd->state = KCMD_STATE_RUNNING;
+		psys->active_kcmds++;
+		kcmd->watchdog.expires = jiffies +
+		    msecs_to_jiffies(psys->timeout);
+		add_timer(&kcmd->watchdog);
+		break;
+	case KCMD_STATE_START_PREPARED:
+		kcmd->state = KCMD_STATE_STARTED;
+		psys->started_kcmds++;
+		list_add_tail(&kcmd->started_list, &psys->started_kcmds_list);
+		break;
+	default:
+		WARN_ON(1);
+		ret = -EINVAL;
+		goto error;
+	}
+	return 0;
+
+error:
+	dev_err(&psys->adev->dev, "failed to start process group\n");
+	ipu_psys_kcmd_complete(psys, kcmd, -EIO);
+	return ret;
+}
+
+static int ipu_psys_kcmd_queue(struct ipu_psys *psys,
+			       struct ipu_psys_kcmd *kcmd)
+{
+	int ret;
+
+	if (kcmd->state != KCMD_STATE_NEW) {
+		WARN_ON(1);
+		return -EINVAL;
+	}
+
+	if (!psys->started_kcmds) {
+		ret = ipu_psys_allocate_resources(&psys->adev->dev,
+						  kcmd->kpg->pg,
+						  kcmd->pg_manifest,
+						  &kcmd->resource_alloc,
+						  &psys->resource_pool_running);
+		if (!ret) {
+			kcmd->state = KCMD_STATE_RUN_PREPARED;
+			return ipu_psys_kcmd_start(psys, kcmd);
+		}
+
+		if (ret != -ENOSPC || !psys->active_kcmds) {
+			dev_err(&psys->adev->dev,
+				"kcmd %p failed to alloc resources (running)\n",
+				kcmd);
+			ipu_psys_kcmd_complete(psys, kcmd, ret);
+			/* kcmd_complete doesn't handle PM for KCMD_STATE_NEW */
+			pm_runtime_put(&psys->adev->dev);
+			return -EINVAL;
+		}
+	}
+
+	ret = ipu_psys_allocate_resources(&psys->adev->dev,
+					  kcmd->kpg->pg,
+					  kcmd->pg_manifest,
+					  &kcmd->resource_alloc,
+					  &psys->resource_pool_started);
+	if (!ret) {
+		kcmd->state = KCMD_STATE_START_PREPARED;
+		return ipu_psys_kcmd_start(psys, kcmd);
+	}
+
+	if (ret != -ENOSPC || !psys->started_kcmds) {
+		dev_err(&psys->adev->dev,
+			"kcmd %p failed to alloc resources (started)\n", kcmd);
+		ipu_psys_kcmd_complete(psys, kcmd, ret);
+		/* kcmd_complete doesn't handle PM for KCMD_STATE_NEW */
+		pm_runtime_put(&psys->adev->dev);
+		ret = -EINVAL;
+	}
+	return ret;
+}
+
+/*
+ * Schedule next kcmd by finding a runnable kcmd from the highest
+ * priority queue in a round-robin fashion versus the client
+ * queues and running it.
+ * Any kcmds which fail to start are completed with an error.
+ */
+static void ipu_psys_run_next(struct ipu_psys *psys)
+{
+	int p;
+
+	/*
+	 * Code below will crash if fhs is empty. Normally this
+	 * shouldn't happen.
+	 */
+	if (list_empty(&psys->fhs)) {
+		WARN_ON(1);
+		return;
+	}
+
+	for (p = 0; p < IPU_PSYS_CMD_PRIORITY_NUM; p++) {
+		int removed;
+
+		do {
+			struct ipu_psys_fh *fh = list_first_entry(&psys->fhs,
+								  struct
+								  ipu_psys_fh,
+								  list);
+			struct ipu_psys_fh *fh_last =
+			    list_last_entry(&psys->fhs,
+					    struct ipu_psys_fh,
+					    list);
+			/*
+			 * When a kcmd is scheduled from a fh, it might expose
+			 * more runnable kcmds behind it in the same queue.
+			 * Therefore loop running kcmds as long as some were
+			 * scheduled.
+			 */
+			removed = 0;
+			do {
+				struct ipu_psys_fh *fh_next =
+				    list_next_entry(fh, list);
+				struct ipu_psys_kcmd *kcmd;
+				int ret;
+
+				mutex_lock(&fh->mutex);
+
+				kcmd = fh->new_kcmd_tail[p];
+				/*
+				 * If concurrency is disabled and there are
+				 * already commands running on the PSYS, do not
+				 * run new commands.
+				 */
+				if (!enable_concurrency &&
+				    psys->active_kcmds > 0) {
+					mutex_unlock(&fh->mutex);
+					return;
+				}
+
+				/* Are there new kcmds available for running? */
+				if (!kcmd)
+					goto next;
+
+				ret = ipu_psys_kcmd_queue(psys, kcmd);
+				if (ret == -ENOSPC)
+					goto next;
+
+				/* Update pointer to the first new kcmd */
+				fh->new_kcmd_tail[p] = NULL;
+				while (kcmd != list_last_entry(&fh->kcmds[p],
+							       struct
+							       ipu_psys_kcmd,
+							       list)) {
+					kcmd = list_next_entry(kcmd, list);
+					if (kcmd->state == KCMD_STATE_NEW) {
+						fh->new_kcmd_tail[p] = kcmd;
+						break;
+					}
+				}
+
+				list_move_tail(&fh->list, &psys->fhs);
+				removed++;
+next:
+				mutex_unlock(&fh->mutex);
+				if (fh == fh_last)
+					break;
+				fh = fh_next;
+			} while (1);
+		} while (removed > 0);
+	}
+}
+
+/*
+ * Move all kcmds in all queues forcily into completed state.
+ */
+static void ipu_psys_flush_kcmds(struct ipu_psys *psys, int error)
+{
+	struct ipu_psys_fh *fh;
+	struct ipu_psys_kcmd *kcmd;
+	int p;
+
+	dev_err(&psys->dev, "flushing all commands with error: %d\n", error);
+
+	list_for_each_entry(fh, &psys->fhs, list) {
+		mutex_lock(&fh->mutex);
+		for (p = 0; p < IPU_PSYS_CMD_PRIORITY_NUM; p++) {
+			fh->new_kcmd_tail[p] = NULL;
+			list_for_each_entry(kcmd, &fh->kcmds[p], list) {
+				if (kcmd->state == KCMD_STATE_COMPLETE)
+					continue;
+				ipu_psys_kcmd_complete(psys, kcmd, error);
+			}
+		}
+		mutex_unlock(&fh->mutex);
+	}
+}
+
+/*
+ * Abort all currently running process groups and reset PSYS
+ * by power cycling it. PSYS power must not be acquired
+ * except by running kcmds when calling this.
+ */
+static void ipu_psys_reset(struct ipu_psys *psys)
+{
+#ifdef CONFIG_PM
+	struct device *d = &psys->adev->isp->psys_iommu->dev;
+	int r;
+
+	pm_runtime_dont_use_autosuspend(&psys->adev->dev);
+	r = pm_runtime_get_sync(d);
+	if (r < 0) {
+		pm_runtime_put_noidle(d);
+		dev_err(&psys->adev->dev, "power management failed\n");
+		return;
+	}
+
+	ipu_psys_flush_kcmds(psys, -EIO);
+	flush_workqueue(pm_wq);
+	r = pm_runtime_put_sync(d);	/* Turn big red power knob off here */
+	/* Power was successfully turned off if and only if zero was returned */
+	if (r)
+		dev_warn(&psys->adev->dev,
+			 "power management failed, PSYS reset may be incomplete\n");
+	pm_runtime_use_autosuspend(&psys->adev->dev);
+	ipu_psys_run_next(psys);
+#else
+	dev_err(&psys->adev->dev,
+		"power management disabled, can not reset PSYS\n");
+#endif
+}
+
+static void ipu_psys_watchdog_work(struct work_struct *work)
+{
+	struct ipu_psys *psys = container_of(work,
+					     struct ipu_psys, watchdog_work);
+	struct ipu_psys_fh *fh;
+
+	mutex_lock(&psys->mutex);
+
+	/* Loop over all running kcmds */
+	list_for_each_entry(fh, &psys->fhs, list) {
+		int p, r;
+
+		mutex_lock(&fh->mutex);
+		for (p = 0; p < IPU_PSYS_CMD_PRIORITY_NUM; p++) {
+			struct ipu_psys_kcmd *kcmd;
+
+			list_for_each_entry(kcmd, &fh->kcmds[p], list) {
+				if (fh->new_kcmd_tail[p] == kcmd)
+					break;
+				if (kcmd->state != KCMD_STATE_RUNNING)
+					continue;
+				if (timer_pending(&kcmd->watchdog))
+					continue;
+				/* Found an expired but running command */
+				dev_err(&psys->adev->dev,
+					"kcmd:0x%llx[0x%llx] taking too long\n",
+					kcmd->user_token, kcmd->issue_id);
+				r = ipu_psys_kcmd_abort(psys, kcmd, -ETIME);
+				if (r)
+					goto stop_failed;
+			}
+		}
+		mutex_unlock(&fh->mutex);
+	}
+
+	/* Kick command scheduler thread */
+	atomic_set(&psys->wakeup_sched_thread_count, 1);
+	wake_up_interruptible(&psys->sched_cmd_wq);
+	mutex_unlock(&psys->mutex);
+	return;
+
+stop_failed:
+	mutex_unlock(&fh->mutex);
+	ipu_psys_reset(psys);
+	mutex_unlock(&psys->mutex);
+}
+
+static void ipu_psys_watchdog(unsigned long data)
+{
+	struct ipu_psys_kcmd *kcmd = (struct ipu_psys_kcmd *)data;
+	struct ipu_psys *psys = kcmd->fh->psys;
+
+	queue_work(IPU_PSYS_WORK_QUEUE, &psys->watchdog_work);
+}
+
+
+static int ipu_psys_config_legacy_pg(struct ipu_psys_kcmd *kcmd)
+{
+	struct ipu_psys *psys = kcmd->fh->psys;
+	unsigned int i;
+	int ret;
+
+	ret = ipu_fw_psys_pg_set_ipu_vaddress(kcmd, kcmd->kpg->pg_dma_addr);
+	if (ret) {
+		ret = -EIO;
+		goto error;
+	}
+
+	for (i = 0; i < kcmd->nbuffers; i++) {
+		struct ipu_fw_psys_terminal *terminal;
+		u32 buffer;
+
+		terminal = ipu_fw_psys_pg_get_terminal(kcmd, i);
+		if (!terminal)
+			continue;
+
+		buffer = (u32) kcmd->kbufs[i]->dma_addr +
+		    kcmd->buffers[i].data_offset;
+
+		ret = ipu_fw_psys_terminal_set(terminal, i, kcmd,
+					       buffer, kcmd->kbufs[i]->len);
+		if (ret == -EAGAIN)
+			continue;
+
+		if (ret) {
+			dev_err(&psys->adev->dev, "Unable to set terminal\n");
+			goto error;
+		}
+	}
+
+	ipu_fw_psys_pg_set_token(kcmd, (u64) kcmd);
+
+	ret = ipu_fw_psys_pg_submit(kcmd);
+	if (ret) {
+		dev_err(&psys->adev->dev, "failed to submit kcmd!\n");
+		goto error;
+	}
+
+	return 0;
+
+error:
+	dev_err(&psys->adev->dev, "failed to config legacy pg\n");
+	return ret;
+}
+
+static int ipu_psys_kcmd_new(struct ipu_psys_command *cmd,
+			     struct ipu_psys_fh *fh)
+{
+	struct ipu_psys *psys = fh->psys;
+	struct ipu_psys_kcmd *kcmd;
+	size_t pg_size;
+	int ret;
+
+	if (psys->adev->isp->flr_done)
+		return -EIO;
+
+	kcmd = ipu_psys_copy_cmd(cmd, fh);
+	if (!kcmd)
+		return -EINVAL;
+
+	ipu_psys_resource_alloc_init(&kcmd->resource_alloc);
+
+	init_timer(&kcmd->watchdog);
+	kcmd->watchdog.data = (unsigned long)kcmd;
+	kcmd->watchdog.function = &ipu_psys_watchdog;
+
+	if (cmd->min_psys_freq) {
+		kcmd->constraint.min_freq = cmd->min_psys_freq;
+		ipu_buttress_add_psys_constraint(psys->adev->isp,
+						 &kcmd->constraint);
+	}
+
+	pg_size = ipu_fw_psys_pg_get_size(kcmd);
+	if (pg_size > kcmd->kpg->pg_size) {
+		dev_dbg(&psys->adev->dev, "pg size mismatch %lu %lu\n",
+			pg_size, kcmd->kpg->pg_size);
+		ret = -EINVAL;
+		goto error;
+	}
+
+	ret = ipu_psys_config_legacy_pg(kcmd);
+
+	if (ret)
+		goto error;
+
+	mutex_lock(&fh->mutex);
+	list_add_tail(&kcmd->list, &fh->kcmds[cmd->priority]);
+	if (!fh->new_kcmd_tail[cmd->priority] && kcmd->state == KCMD_STATE_NEW) {
+		fh->new_kcmd_tail[cmd->priority] = kcmd;
+		/* Kick command scheduler thread */
+		atomic_set(&psys->wakeup_sched_thread_count, 1);
+		wake_up_interruptible(&psys->sched_cmd_wq);
+	}
+	mutex_unlock(&fh->mutex);
+
+	dev_dbg(&psys->adev->dev,
+		"IOC_QCMD: user_token:%llx issue_id:0x%llx pri:%d\n",
+		cmd->user_token, cmd->issue_id, cmd->priority);
+
+	return 0;
+
+error:
+	ipu_psys_kcmd_free(kcmd);
+
+	return ret;
+}
+
+static struct ipu_psys_kcmd *__ipu_get_completed_kcmd(struct ipu_psys *psys,
+						      struct ipu_psys_fh *fh)
+{
+	int p;
+
+	for (p = 0; p < IPU_PSYS_CMD_PRIORITY_NUM; p++) {
+		struct ipu_psys_kcmd *kcmd;
+
+		if (list_empty(&fh->kcmds[p]))
+			continue;
+		kcmd = list_first_entry(&fh->kcmds[p],
+					struct ipu_psys_kcmd, list);
+		if (kcmd->state != KCMD_STATE_COMPLETE)
+			continue;
+		/* Found a kcmd in completed state */
+		return kcmd;
+	}
+
+	return NULL;
+}
+
+static struct ipu_psys_kcmd *ipu_get_completed_kcmd(struct ipu_psys *psys,
+						    struct ipu_psys_fh *fh)
+{
+	struct ipu_psys_kcmd *kcmd;
+
+	mutex_lock(&fh->mutex);
+	kcmd = __ipu_get_completed_kcmd(psys, fh);
+	mutex_unlock(&fh->mutex);
+
+	return kcmd;
+}
+
+static long ipu_ioctl_dqevent(struct ipu_psys_event *event,
+			      struct ipu_psys_fh *fh, unsigned int f_flags)
+{
+	struct ipu_psys *psys = fh->psys;
+	struct ipu_psys_kcmd *kcmd = NULL;
+	int rval;
+
+	dev_dbg(&psys->adev->dev, "IOC_DQEVENT\n");
+
+	if (!(f_flags & O_NONBLOCK)) {
+		rval = wait_event_interruptible(fh->wait,
+						(kcmd =
+						 ipu_get_completed_kcmd(psys,
+									fh)));
+		if (rval == -ERESTARTSYS)
+			return rval;
+	}
+
+	mutex_lock(&fh->mutex);
+	if (!kcmd) {
+		kcmd = __ipu_get_completed_kcmd(psys, fh);
+		if (!kcmd) {
+			mutex_unlock(&fh->mutex);
+			return -ENODATA;
+		}
+	}
+
+	*event = kcmd->ev;
+	ipu_psys_kcmd_free(kcmd);
+	mutex_unlock(&fh->mutex);
+
+	return 0;
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static long ipu_psys_mapbuf(int fd, struct ipu_psys_fh *fh)
 {
 	struct ipu_psys *psys = fh->psys;
@@ -676,6 +1779,11 @@ static long ipu_psys_mapbuf(int fd, struct ipu_psys_fh *fh)
 			return -ENOMEM;
 		}
 
+<<<<<<< HEAD
+=======
+		kbuf->psys = psys;
+		kbuf->fh = fh;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		list_add_tail(&kbuf->list, &fh->bufmap);
 	}
 
@@ -749,7 +1857,11 @@ static long ipu_psys_mapbuf(int fd, struct ipu_psys_fh *fh)
 	return ret;
 }
 
+<<<<<<< HEAD
 long ipu_psys_unmapbuf(int fd, struct ipu_psys_fh *fh)
+=======
+static long ipu_psys_unmapbuf(int fd, struct ipu_psys_fh *fh)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	struct ipu_psys_kbuffer *kbuf;
 	struct ipu_psys *psys = fh->psys;
@@ -800,7 +1912,11 @@ static unsigned int ipu_psys_poll(struct file *file,
 
 	poll_wait(file, &fh->wait, wait);
 
+<<<<<<< HEAD
 	if (ipu_get_completed_kcmd(fh))
+=======
+	if (ipu_get_completed_kcmd(psys, fh))
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		res = POLLIN;
 
 	dev_dbg(&psys->adev->dev, "ipu psys poll res %u\n", res);
@@ -888,7 +2004,11 @@ static long ipu_psys_ioctl(struct file *file, unsigned int cmd,
 		err = ipu_psys_unmapbuf(arg, fh);
 		break;
 	case IPU_IOC_QUERYCAP:
+<<<<<<< HEAD
 		karg.caps = fh->psys->caps;
+=======
+		karg.caps = caps;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		break;
 	case IPU_IOC_GETBUF:
 		err = ipu_psys_getbuf(&karg.buf, fh);
@@ -970,7 +2090,11 @@ static int psys_runtime_pm_resume(struct device *dev)
 		return 0;
 	}
 
+<<<<<<< HEAD
 	ipu_psys_setup_hw(psys);
+=======
+	psys_setup_hw(psys);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	ipu_trace_restore(&psys->adev->dev);
 
@@ -1056,7 +2180,11 @@ static int cpd_fw_reload(struct ipu_device *isp)
 		dev_info(&isp->pdev->dev, "Old FW removed\n");
 	}
 
+<<<<<<< HEAD
 	rval = request_cpd_fw(&isp->cpd_fw, isp->cpd_fw_name,
+=======
+	rval = request_firmware(&isp->cpd_fw, isp->cpd_fw_name,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 				&isp->pdev->dev);
 	if (rval) {
 		dev_err(&isp->pdev->dev, "Requesting firmware(%s) failed\n",
@@ -1180,11 +2308,14 @@ static int ipu_psys_init_debugfs(struct ipu_psys *psys)
 
 	psys->debugfsdir = dir;
 
+<<<<<<< HEAD
 #ifdef IPU_PSYS_GPC
 	if (ipu_psys_gpc_init_debugfs(psys))
 		return -ENOMEM;
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return 0;
 err:
 	debugfs_remove_recursive(dir);
@@ -1246,6 +2377,7 @@ static int query_sp(struct ipu_bus_device *adev)
 
 static int ipu_psys_fw_init(struct ipu_psys *psys)
 {
+<<<<<<< HEAD
 	struct ipu_fw_syscom_queue_config
 		fw_psys_cmd_queue_cfg[IPU_FW_PSYS_N_PSYS_CMD_QUEUE_ID];
 	struct ipu_fw_syscom_queue_config fw_psys_event_queue_cfg[] = {
@@ -1257,6 +2389,19 @@ static int ipu_psys_fw_init(struct ipu_psys *psys)
 	struct ipu_fw_psys_srv_init server_init = {
 		.ddr_pkg_dir_address = 0,
 		.host_ddr_pkg_dir = NULL,
+=======
+	struct ia_css_syscom_queue_config
+		ia_css_psys_cmd_queue_cfg[IPU_FW_PSYS_N_PSYS_CMD_QUEUE_ID];
+
+	struct ia_css_syscom_queue_config ia_css_psys_event_queue_cfg[] = {
+		{IPU_FW_PSYS_EVENT_QUEUE_SIZE,
+		 sizeof(struct ipu_fw_psys_event)}
+	};
+
+	struct ipu_fw_psys_srv_init server_init = {
+		.ddr_pkg_dir_address = 0,
+		.host_ddr_pkg_dir = 0,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.pkg_dir_size = 0,
 		.icache_prefetch_sp = psys->icache_prefetch_sp,
 		.icache_prefetch_isp = psys->icache_prefetch_isp,
@@ -1264,7 +2409,11 @@ static int ipu_psys_fw_init(struct ipu_psys *psys)
 	struct ipu_fw_com_cfg fwcom = {
 		.num_input_queues = IPU_FW_PSYS_N_PSYS_CMD_QUEUE_ID,
 		.num_output_queues = IPU_FW_PSYS_N_PSYS_EVENT_QUEUE_ID,
+<<<<<<< HEAD
 		.output = fw_psys_event_queue_cfg,
+=======
+		.output = ia_css_psys_event_queue_cfg,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.specific_addr = &server_init,
 		.specific_size = sizeof(server_init),
 		.cell_start = start_sp,
@@ -1273,6 +2422,7 @@ static int ipu_psys_fw_init(struct ipu_psys *psys)
 	int rval, i;
 
 	for (i = 0; i < IPU_FW_PSYS_N_PSYS_CMD_QUEUE_ID; i++) {
+<<<<<<< HEAD
 		fw_psys_cmd_queue_cfg[i].queue_size =
 			IPU_FW_PSYS_CMD_QUEUE_SIZE;
 		fw_psys_cmd_queue_cfg[i].token_size =
@@ -1280,6 +2430,15 @@ static int ipu_psys_fw_init(struct ipu_psys *psys)
 	}
 
 	fwcom.input = fw_psys_cmd_queue_cfg;
+=======
+		ia_css_psys_cmd_queue_cfg[i].queue_size =
+			IPU_FW_PSYS_CMD_QUEUE_SIZE;
+		ia_css_psys_cmd_queue_cfg[i].token_size =
+			sizeof(struct ipu_fw_psys_cmd);
+	}
+
+	fwcom.input = ia_css_psys_cmd_queue_cfg;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	fwcom.dmem_addr = psys->pdata->ipdata->hw_variant.dmem_offset;
 
@@ -1448,9 +2607,15 @@ static int ipu_psys_probe(struct ipu_bus_device *adev)
 	isp->pkg_dir_dma_addr = psys->pkg_dir_dma_addr;
 	isp->pkg_dir_size = psys->pkg_dir_size;
 
+<<<<<<< HEAD
 	psys->caps.pg_count = ipu_cpd_pkg_dir_get_num_entries(psys->pkg_dir);
 
 	dev_info(&adev->dev, "pkg_dir entry count:%d\n", psys->caps.pg_count);
+=======
+	caps.pg_count = ipu_cpd_pkg_dir_get_num_entries(psys->pkg_dir);
+
+	dev_info(&adev->dev, "pkg_dir entry count:%d\n", caps.pg_count);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (async_fw_init) {
 		INIT_DELAYED_WORK((struct delayed_work *)&fw_init_task,
 				  run_fw_init_work);
@@ -1477,8 +2642,13 @@ static int ipu_psys_probe(struct ipu_bus_device *adev)
 	}
 
 	/* Add the hw stepping information to caps */
+<<<<<<< HEAD
 	strlcpy(psys->caps.dev_model, IPU_MEDIA_DEV_MODEL_NAME,
 		sizeof(psys->caps.dev_model));
+=======
+	strlcpy(caps.dev_model, IPU_MEDIA_DEV_MODEL_NAME,
+		sizeof(caps.dev_model));
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	pm_runtime_allow(&adev->dev);
 	pm_runtime_enable(&adev->dev);
@@ -1541,8 +2711,12 @@ static void ipu_psys_remove(struct ipu_bus_device *adev)
 	struct ipu_psys *psys = ipu_bus_get_drvdata(adev);
 	struct ipu_psys_pg *kpg, *kpg0;
 
+<<<<<<< HEAD
 	if (isp->ipu_dir)
 		debugfs_remove_recursive(psys->debugfsdir);
+=======
+	debugfs_remove_recursive(psys->debugfsdir);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	flush_workqueue(IPU_PSYS_WORK_QUEUE);
 
@@ -1593,6 +2767,73 @@ static void ipu_psys_remove(struct ipu_bus_device *adev)
 	dev_info(&adev->dev, "removed\n");
 }
 
+<<<<<<< HEAD
+=======
+static bool ipu_psys_kcmd_is_valid(struct ipu_psys *psys,
+				   struct ipu_psys_kcmd *kcmd)
+{
+	struct ipu_psys_fh *fh;
+	struct ipu_psys_kcmd *kcmd0;
+	int p;
+
+	list_for_each_entry(fh, &psys->fhs, list) {
+		mutex_lock(&fh->mutex);
+		for (p = 0; p < IPU_PSYS_CMD_PRIORITY_NUM; p++) {
+			list_for_each_entry(kcmd0, &fh->kcmds[p], list) {
+				if (kcmd0 == kcmd) {
+					mutex_unlock(&fh->mutex);
+					return true;
+				}
+			}
+		}
+		mutex_unlock(&fh->mutex);
+	}
+
+	return false;
+}
+
+static void ipu_psys_handle_events(struct ipu_psys *psys)
+{
+	struct ipu_psys_kcmd *kcmd = NULL;
+	struct ipu_fw_psys_event event;
+	bool error;
+
+	do {
+		memset(&event, 0, sizeof(event));
+		if (!ipu_fw_psys_rcv_event(psys, &event))
+			break;
+
+		error = false;
+		kcmd = (struct ipu_psys_kcmd *)event.token;
+		error = IS_ERR_OR_NULL(kcmd) ? true : false;
+
+		dev_dbg(&psys->adev->dev, "psys received event status:%d\n",
+			event.status);
+
+		if (error) {
+			dev_err(&psys->adev->dev,
+				"no token received, command unknown\n");
+			pm_runtime_put(&psys->adev->dev);
+			ipu_psys_reset(psys);
+			pm_runtime_get(&psys->adev->dev);
+			break;
+		}
+
+		if (ipu_psys_kcmd_is_valid(psys, kcmd))
+			ipu_psys_kcmd_complete(psys, kcmd,
+					       event.status ==
+					       IPU_PSYS_EVENT_CMD_COMPLETE ||
+					       event.status ==
+					       IPU_PSYS_EVENT_FRAGMENT_COMPLETE
+					       ? 0 : -EIO);
+
+		/* Kick command scheduler thread */
+		atomic_set(&psys->wakeup_sched_thread_count, 1);
+		wake_up_interruptible(&psys->sched_cmd_wq);
+	} while (1);
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static irqreturn_t psys_isr_threaded(struct ipu_bus_device *adev)
 {
 	struct ipu_psys *psys = ipu_bus_get_drvdata(adev);
@@ -1630,6 +2871,7 @@ static irqreturn_t psys_isr_threaded(struct ipu_bus_device *adev)
 	return status ? IRQ_HANDLED : IRQ_NONE;
 }
 
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 static int ipu_psys_isr_run(void *data)
 {
@@ -1663,6 +2905,8 @@ static int ipu_psys_isr_run(void *data)
 	return 0;
 }
 #endif /* IPU_IRQ_POLL */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static struct ipu_bus_driver ipu_psys_driver = {
 	.probe = ipu_psys_probe,
diff --git a/drivers/media/pci/intel/ipu-psys.h b/drivers/media/pci/intel/ipu-psys.h
index aea2d50..f8fd633 100644
--- a/drivers/media/pci/intel/ipu-psys.h
+++ b/drivers/media/pci/intel/ipu-psys.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_PSYS_H
@@ -9,11 +13,18 @@
 
 #include "ipu.h"
 #include "ipu-pdata.h"
+<<<<<<< HEAD
 #include "ipu-fw-psys.h"
 #if defined(CONFIG_VIDEO_INTEL_IPU_ACRN) && defined(CONFIG_VIDEO_INTEL_IPU_VIRTIO_BE)
 #include "ipu-psys-virt.h"
 #endif
 #include "ipu-platform-psys.h"
+=======
+#include "ipu-resources.h"
+#include "ipu-fw-psys.h"
+
+#include <uapi/linux/ipu-psys.h>
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define IPU_PSYS_PG_POOL_SIZE 16
 #define IPU_PSYS_PG_MAX_SIZE 2048
@@ -22,6 +33,7 @@
 #define IPU_PSYS_EVENT_FRAGMENT_COMPLETE IPU_FW_PSYS_EVENT_TYPE_SUCCESS
 #define IPU_PSYS_CLOSE_TIMEOUT_US   50
 #define IPU_PSYS_CLOSE_TIMEOUT (100000 / IPU_PSYS_CLOSE_TIMEOUT_US)
+<<<<<<< HEAD
 #define IPU_PSYS_WORK_QUEUE		system_power_efficient_wq
 #define IPU_MAX_RESOURCES 128
 
@@ -80,6 +92,14 @@ struct ipu_psys_resource_alloc {
 struct task_struct;
 struct ipu_psys {
 	struct ipu_psys_capability caps;
+=======
+#define IPU_PSYS_BUF_SET_POOL_SIZE 16
+#define IPU_PSYS_BUF_SET_MAX_SIZE 1024
+
+struct task_struct;
+
+struct ipu_psys {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct cdev cdev;
 	struct device dev;
 
@@ -97,9 +117,12 @@ struct ipu_psys {
 	struct ia_css_syscom_context *dev_ctx;
 	struct ia_css_syscom_config *syscom_config;
 	struct ia_css_psys_server_init *server_init;
+<<<<<<< HEAD
 #ifdef IPU_IRQ_POLL
 	struct task_struct *isr_thread;
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct task_struct *sched_cmd_thread;
 	struct work_struct watchdog_work;
 	wait_queue_head_t sched_cmd_wq;
@@ -122,15 +145,27 @@ struct ipu_psys {
 };
 
 struct ipu_psys_fh {
+<<<<<<< HEAD
 #if defined(CONFIG_VIDEO_INTEL_IPU_ACRN) && defined(CONFIG_VIDEO_INTEL_IPU_VIRTIO_BE)
 	const struct psys_fops_virt *vfops;
 #endif
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct ipu_psys *psys;
 	struct mutex mutex;	/* Protects bufmap & kcmds fields */
 	struct list_head list;
 	struct list_head bufmap;
+<<<<<<< HEAD
 	wait_queue_head_t wait;
 	struct ipu_psys_scheduler sched;
+=======
+	struct list_head kcmds[IPU_PSYS_CMD_PRIORITY_NUM];
+	struct ipu_psys_kcmd
+	*new_kcmd_tail[IPU_PSYS_CMD_PRIORITY_NUM];
+	wait_queue_head_t wait;
+	struct mutex bs_mutex;	/* Protects buf_set field */
+	struct list_head buf_sets;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct ipu_psys_pg {
@@ -139,7 +174,30 @@ struct ipu_psys_pg {
 	size_t pg_size;
 	dma_addr_t pg_dma_addr;
 	struct list_head list;
+<<<<<<< HEAD
 	struct ipu_psys_resource_alloc resource_alloc;
+=======
+	struct ipu_psys_resource_alloc *resource_alloc;
+};
+
+enum ipu_psys_cmd_state {
+	KCMD_STATE_NEW,
+	KCMD_STATE_START_PREPARED,
+	KCMD_STATE_STARTED,
+	KCMD_STATE_RUN_PREPARED,
+	KCMD_STATE_RUNNING,
+	KCMD_STATE_COMPLETE
+};
+
+struct ipu_psys_buffer_set {
+	struct list_head list;
+	struct ipu_fw_psys_buffer_set *buf_set;
+	size_t size;
+	size_t buf_set_size;
+	dma_addr_t dma_addr;
+	void *kaddr;
+	struct ipu_psys_kcmd *kcmd;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct ipu_psys_kcmd {
@@ -158,6 +216,12 @@ struct ipu_psys_kcmd {
 	u64 issue_id;
 	u32 priority;
 	struct ipu_buttress_constraint constraint;
+<<<<<<< HEAD
+=======
+	struct ipu_psys_buffer_set *kbuf_set;
+
+	struct ipu_psys_resource_alloc resource_alloc;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct ipu_psys_event ev;
 	struct timer_list watchdog;
 };
@@ -183,6 +247,11 @@ struct ipu_psys_kbuffer {
 	struct sg_table *sgt;
 	struct dma_buf_attachment *db_attach;
 	struct dma_buf *dbuf;
+<<<<<<< HEAD
+=======
+	struct ipu_psys *psys;
+	struct ipu_psys_fh *fh;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	bool valid;	/* True when buffer is usable */
 };
 
@@ -195,6 +264,7 @@ long ipu_psys_compat_ioctl32(struct file *file, unsigned int cmd,
 			     unsigned long arg);
 #endif
 
+<<<<<<< HEAD
 void ipu_psys_setup_hw(struct ipu_psys *psys);
 void ipu_psys_handle_events(struct ipu_psys *psys);
 int ipu_psys_kcmd_new(struct ipu_psys_command *cmd, struct ipu_psys_fh *fh);
@@ -213,5 +283,8 @@ void ipu_psys_resource_pool_cleanup(struct ipu_psys_resource_pool *pool);
 struct ipu_psys_kcmd *ipu_get_completed_kcmd(struct ipu_psys_fh *fh);
 long ipu_ioctl_dqevent(struct ipu_psys_event *event,
 		       struct ipu_psys_fh *fh, unsigned int f_flags);
+=======
+void psys_setup_hw(struct ipu_psys *psys);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #endif /* IPU_PSYS_H */
diff --git a/drivers/media/pci/intel/ipu-resources.c b/drivers/media/pci/intel/ipu-resources.c
new file mode 100644
index 00000000..38a959e
--- /dev/null
+++ b/drivers/media/pci/intel/ipu-resources.c
@@ -0,0 +1,455 @@
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2015 - 2018 Intel Corporation
+
+#include <linux/bitmap.h>
+#include <linux/errno.h>
+#include <linux/gfp.h>
+#include <linux/slab.h>
+#include <linux/device.h>
+
+#include <uapi/linux/ipu-psys.h>
+
+#include "ipu-fw-psys.h"
+#include "ipu-psys.h"
+#include "ipu-fw-resources.h"
+
+static int ipu_resource_init(struct ipu_resource *res, u32 id, int elements)
+{
+	if (elements <= 0) {
+		res->bitmap = NULL;
+		return 0;
+	}
+
+	res->bitmap = kcalloc(BITS_TO_LONGS(elements), sizeof(long),
+			      GFP_KERNEL);
+	if (!res->bitmap)
+		return -ENOMEM;
+	res->elements = elements;
+	res->id = id;
+	return 0;
+}
+
+
+static unsigned long
+ipu_resource_alloc(struct ipu_resource *res, int n,
+		   struct ipu_resource_alloc *alloc,
+		   enum ipu_resource_type type)
+{
+	unsigned long p;
+
+	if (n <= 0) {
+		alloc->elements = 0;
+		return 0;
+	}
+
+	if (!res->bitmap)
+		return (unsigned long)(-ENOSPC);
+
+	p = bitmap_find_next_zero_area(res->bitmap, res->elements, 0, n, 0);
+	alloc->resource = NULL;
+
+	if (p >= res->elements)
+		return (unsigned long)(-ENOSPC);
+	bitmap_set(res->bitmap, p, n);
+	alloc->resource = res;
+	alloc->elements = n;
+	alloc->pos = p;
+	alloc->type = type;
+
+	return p;
+}
+
+static void ipu_resource_free(struct ipu_resource_alloc *alloc)
+{
+	if (alloc->elements <= 0)
+		return;
+
+	if (alloc->type == IPU_RESOURCE_DFM)
+		*alloc->resource->bitmap &= ~(unsigned long)(alloc->elements);
+	else
+		bitmap_clear(alloc->resource->bitmap, alloc->pos,
+			     alloc->elements);
+	alloc->resource = NULL;
+}
+
+static void ipu_resource_cleanup(struct ipu_resource *res)
+{
+	kfree(res->bitmap);
+	res->bitmap = NULL;
+}
+
+/********** IPU PSYS-specific resource handling **********/
+
+int ipu_psys_resource_pool_init(struct ipu_psys_resource_pool
+				*pool)
+{
+	int i, j, k, ret;
+
+	pool->cells = 0;
+
+	for (i = 0; i < res_defs->num_dev_channels; i++) {
+		ret = ipu_resource_init(&pool->dev_channels[i], i,
+					res_defs->dev_channels[i]);
+		if (ret)
+			goto error;
+	}
+
+	for (j = 0; j < res_defs->num_ext_mem_ids; j++) {
+		ret = ipu_resource_init(&pool->ext_memory[j], j,
+					res_defs->ext_mem_ids[j]);
+		if (ret)
+			goto memory_error;
+	}
+
+	for (k = 0; k < res_defs->num_dfm_ids; k++) {
+		ret = ipu_resource_init(&pool->dfms[k], k, res_defs->dfms[k]);
+		if (ret)
+			goto dfm_error;
+	}
+
+	return 0;
+
+dfm_error:
+	for (k--; k >= 0; k--)
+		ipu_resource_cleanup(&pool->dfms[k]);
+
+memory_error:
+	for (j--; j >= 0; j--)
+		ipu_resource_cleanup(&pool->ext_memory[j]);
+
+error:
+	for (i--; i >= 0; i--)
+		ipu_resource_cleanup(&pool->dev_channels[i]);
+	return ret;
+}
+
+void ipu_psys_resource_pool_cleanup(struct ipu_psys_resource_pool
+				    *pool)
+{
+	u32 i;
+
+	for (i = 0; i < res_defs->num_dev_channels; i++)
+		ipu_resource_cleanup(&pool->dev_channels[i]);
+
+	for (i = 0; i < res_defs->num_ext_mem_ids; i++)
+		ipu_resource_cleanup(&pool->ext_memory[i]);
+
+	for (i = 0; i < res_defs->num_dfm_ids; i++)
+		ipu_resource_cleanup(&pool->dfms[i]);
+}
+
+void ipu_psys_resource_alloc_init(struct ipu_psys_resource_alloc
+				  *alloc)
+{
+	alloc->cells = 0;
+	alloc->resources = 0;
+}
+
+static int ipu_psys_allocate_one_resource(const struct device *dev,
+				struct ipu_fw_psys_process *process,
+				struct ipu_resource *resource,
+				struct ipu_fw_generic_program_manifest *pm,
+				u32 resource_id,
+				struct ipu_psys_resource_alloc *alloc)
+{
+	const u16 resource_req = pm->dev_chn_size[resource_id];
+	unsigned long retl;
+
+	if (resource_req <= 0)
+		return 0;
+
+	if (alloc->resources >= IPU_MAX_RESOURCES) {
+		dev_err(dev, "out of resource handles\n");
+		return -ENOSPC;
+	}
+		retl = ipu_resource_alloc
+		    (resource, resource_req,
+		     &alloc->resource_alloc[alloc->resources],
+		     IPU_RESOURCE_DEV_CHN);
+	if (IS_ERR_VALUE(retl)) {
+		dev_dbg(dev, "out of device channel resources\n");
+		return (int)retl;
+	}
+	alloc->resources++;
+	ipu_fw_psys_set_process_dev_chn_offset(process, resource_id, retl);
+
+	return 0;
+}
+
+
+/*
+ * ext_mem_type_id is a generic type id for memory (like DMEM, VMEM)
+ * ext_mem_bank_id is detailed type id for  memory (like DMEM0, DMEM1 etc.)
+ */
+static int ipu_psys_allocate_memory_resource(
+				const struct device *dev,
+				struct ipu_fw_psys_process *process,
+				struct ipu_resource *resource,
+				struct ipu_fw_generic_program_manifest *pm,
+				u32 ext_mem_type_id, u32 ext_mem_bank_id,
+				struct ipu_psys_resource_alloc *alloc)
+{
+	const u16 memory_resource_req = pm->ext_mem_size[ext_mem_type_id];
+
+	unsigned long retl;
+
+	if (memory_resource_req <= 0)
+		return 0;
+
+	if (alloc->resources >= IPU_MAX_RESOURCES) {
+		dev_err(dev, "out of resource handles\n");
+		return -ENOSPC;
+	}
+		retl = ipu_resource_alloc
+		    (resource, memory_resource_req,
+		     &alloc->resource_alloc[alloc->resources],
+		     IPU_RESOURCE_EXT_MEM);
+	if (IS_ERR_VALUE(retl)) {
+		dev_dbg(dev, "out of memory resources\n");
+		return (int)retl;
+	}
+
+	alloc->resources++;
+
+	ipu_fw_psys_set_process_ext_mem_id(process, ext_mem_type_id,
+					   ext_mem_bank_id);
+	ipu_fw_psys_set_process_ext_mem_offset(process, ext_mem_type_id, retl);
+
+	return 0;
+}
+
+/*
+ * Allocate resources for pg from `pool'. Mark the allocated
+ * resources into `alloc'. Returns 0 on success, -ENOSPC
+ * if there are no enough resources, in which cases resources
+ * are not allocated at all, or some other error on other conditions.
+ */
+int ipu_psys_allocate_resources(const struct device *dev,
+				struct ipu_fw_psys_process_group *pg,
+				void *pg_manifest,
+				struct ipu_psys_resource_alloc
+				*alloc, struct ipu_psys_resource_pool
+				*pool)
+{
+	u32 resid;
+	u32 mem_type_id;
+	int ret, i;
+	u16 *process_offset_table;
+	u8 processes;
+	u32 cells = 0;
+
+	if (!pg)
+		return -EINVAL;
+	process_offset_table = (u16 *)((u8 *) pg + pg->processes_offset);
+	processes = pg->process_count;
+
+	for (i = 0; i < processes; i++) {
+		u32 cell;
+		struct ipu_fw_psys_process *process =
+		    (struct ipu_fw_psys_process *)
+		    ((char *)pg + process_offset_table[i]);
+		struct ipu_fw_generic_program_manifest pm;
+
+		if (!process) {
+			dev_err(dev, "can not get process\n");
+			ret = -ENOENT;
+			goto free_out;
+		}
+
+		ret = ipu_fw_psys_get_program_manifest_by_process
+		    (&pm, pg_manifest, process);
+		if (ret < 0) {
+			dev_err(dev, "can not get manifest\n");
+			goto free_out;
+		}
+
+		if (pm.cell_id == res_defs->num_cells &&
+		    pm.cell_type_id == res_defs->num_cells_type) {
+			dev_dbg(dev, "ignore the cell requirement\n");
+			cell = res_defs->num_cells;
+		} else if ((pm.cell_id != res_defs->num_cells &&
+			    pm.cell_type_id == res_defs->num_cells_type)) {
+			cell = ipu_fw_psys_get_process_cell_id(process, 0);
+		} else {
+			/* Find a free cell of desired type */
+			u32 type = pm.cell_type_id;
+
+			for (cell = 0; cell < res_defs->num_cells; cell++)
+				if (res_defs->cells[cell] == type &&
+				    ((pool->cells | cells) & (1 << cell)) == 0)
+					break;
+			if (cell >= res_defs->num_cells) {
+				dev_dbg(dev, "no free cells of right type\n");
+				ret = -ENOSPC;
+				goto free_out;
+			}
+			pg->resource_bitmap |= 1 << cell;
+			ipu_fw_psys_set_process_cell_id(process, 0, cell);
+		}
+		if (cell < res_defs->num_cells)
+			cells |= 1 << cell;
+		if (pool->cells & cells) {
+			dev_dbg(dev, "out of cell resources\n");
+			ret = -ENOSPC;
+			goto free_out;
+		}
+		for (resid = 0; resid < res_defs->num_dev_channels; resid++) {
+			ret = ipu_psys_allocate_one_resource
+			    (dev, process,
+			     &pool->dev_channels[resid], &pm, resid, alloc);
+			if (ret)
+				goto free_out;
+		}
+
+
+		for (mem_type_id = 0;
+		     mem_type_id < res_defs->num_ext_mem_types; mem_type_id++) {
+			u32 mem_bank_id = res_defs->num_ext_mem_ids;
+
+			if (cell != res_defs->num_cells)
+				mem_bank_id =
+				    res_defs->cell_mem[res_defs->cell_mem_row *
+						       cell + mem_type_id];
+			if (mem_bank_id == res_defs->num_ext_mem_ids)
+				continue;
+
+			ret = ipu_psys_allocate_memory_resource
+			    (dev, process,
+			     &pool->ext_memory[mem_bank_id],
+			     &pm, mem_type_id, mem_bank_id, alloc);
+			if (ret)
+				goto free_out;
+		}
+	}
+	alloc->cells |= cells;
+	pool->cells |= cells;
+	return 0;
+
+free_out:
+	for (; i >= 0; i--) {
+		struct ipu_fw_psys_process *process =
+		    (struct ipu_fw_psys_process *)
+		    ((char *)pg + process_offset_table[i]);
+		struct ipu_fw_generic_program_manifest pm;
+		int retval;
+
+		if (!process)
+			break;
+
+		retval = ipu_fw_psys_get_program_manifest_by_process
+		    (&pm, pg_manifest, process);
+		if (retval < 0)
+			break;
+		if ((pm.cell_id != res_defs->num_cells &&
+		     pm.cell_type_id == res_defs->num_cells_type))
+			continue;
+		pg->resource_bitmap &=
+		    ~(1 << ipu_fw_psys_get_process_cell_id(process, 0));
+		ipu_fw_psys_set_process_cell_id(process, 0, 0);
+	}
+
+	ipu_psys_free_resources(alloc, pool);
+	return ret;
+}
+
+int ipu_psys_move_resources(const struct device *dev,
+			    struct ipu_psys_resource_alloc *alloc,
+			    struct ipu_psys_resource_pool
+			    *source_pool, struct ipu_psys_resource_pool
+			    *target_pool)
+{
+	int i;
+
+	if (target_pool->cells & alloc->cells) {
+		dev_dbg(dev, "out of cell resources\n");
+		return -ENOSPC;
+	}
+
+	for (i = 0; i < alloc->resources; i++) {
+		unsigned long bitmap = 0;
+		unsigned int id = alloc->resource_alloc[i].resource->id;
+		unsigned long fbit, end;
+
+		switch (alloc->resource_alloc[i].type) {
+		case IPU_RESOURCE_DEV_CHN:
+			bitmap_set(&bitmap, alloc->resource_alloc[i].pos,
+				   alloc->resource_alloc[i].elements);
+			if (*target_pool->dev_channels[id].bitmap & bitmap)
+				return -ENOSPC;
+			break;
+		case IPU_RESOURCE_EXT_MEM:
+			end = alloc->resource_alloc[i].elements +
+			    alloc->resource_alloc[i].pos;
+
+			fbit = find_next_bit(target_pool->ext_memory[id].bitmap,
+					     end, alloc->resource_alloc[i].pos);
+			/* if find_next_bit returns "end" it didn't find 1bit */
+			if (end != fbit)
+				return -ENOSPC;
+			break;
+		case IPU_RESOURCE_DFM:
+			bitmap = alloc->resource_alloc[i].elements;
+			if (*target_pool->dfms[id].bitmap & bitmap)
+				return -ENOSPC;
+			break;
+		default:
+			dev_err(dev, "Illegal resource type\n");
+			return -EINVAL;
+		}
+	}
+
+	for (i = 0; i < alloc->resources; i++) {
+		u32 id = alloc->resource_alloc[i].resource->id;
+
+		switch (alloc->resource_alloc[i].type) {
+		case IPU_RESOURCE_DEV_CHN:
+			bitmap_set(target_pool->dev_channels[id].bitmap,
+				   alloc->resource_alloc[i].pos,
+				   alloc->resource_alloc[i].elements);
+			ipu_resource_free(&alloc->resource_alloc[i]);
+			alloc->resource_alloc[i].resource =
+			    &target_pool->dev_channels[id];
+			break;
+		case IPU_RESOURCE_EXT_MEM:
+			bitmap_set(target_pool->ext_memory[id].bitmap,
+				   alloc->resource_alloc[i].pos,
+				   alloc->resource_alloc[i].elements);
+			ipu_resource_free(&alloc->resource_alloc[i]);
+			alloc->resource_alloc[i].resource =
+			    &target_pool->ext_memory[id];
+			break;
+		case IPU_RESOURCE_DFM:
+			*target_pool->dfms[id].bitmap |=
+			    alloc->resource_alloc[i].elements;
+			*alloc->resource_alloc[i].resource->bitmap &=
+			    ~(alloc->resource_alloc[i].elements);
+			alloc->resource_alloc[i].resource =
+			    &target_pool->dfms[id];
+			break;
+		default:
+			/*
+			 * Just keep compiler happy. This case failed already
+			 * in above loop.
+			 */
+			break;
+		}
+	}
+
+	target_pool->cells |= alloc->cells;
+	source_pool->cells &= ~alloc->cells;
+
+	return 0;
+}
+
+/* Free resources marked in `alloc' from `resources' */
+void ipu_psys_free_resources(struct ipu_psys_resource_alloc
+			     *alloc, struct ipu_psys_resource_pool *pool)
+{
+	unsigned int i;
+
+	pool->cells &= ~alloc->cells;
+	alloc->cells = 0;
+	for (i = 0; i < alloc->resources; i++)
+		ipu_resource_free(&alloc->resource_alloc[i]);
+	alloc->resources = 0;
+}
diff --git a/drivers/media/pci/intel/ipu-resources.h b/drivers/media/pci/intel/ipu-resources.h
new file mode 100644
index 00000000..39ed8e1
--- /dev/null
+++ b/drivers/media/pci/intel/ipu-resources.h
@@ -0,0 +1,154 @@
+/* SPDX-License_Identifier: GPL-2.0 */
+/* Copyright (C) 2015 - 2018 Intel Corporation */
+
+#include "ipu-fw-psys.h"
+#include "ipu-platform-resources.h"
+
+#ifndef IPU_RESOURCES_H
+#define IPU_RESOURCES_H
+
+/********** Generic resource handling **********/
+
+extern const u32 ipu_fw_psys_cell_types[];
+extern const u16 ipu_num_dev_channels[];
+extern const u16 ipu_fw_psys_mem_size[];
+
+extern const enum ipu_mem_id ipu_fw_psys_cell_mem
+	[IPU_FW_PSYS_N_CELL_ID][IPU_FW_PSYS_N_DATA_MEM_TYPE_ID];
+extern const struct ipu_resource_definitions *res_defs;
+
+/* Opaque structure. Do not access fields. */
+struct ipu_resource {
+	u32 id;
+	int elements;	/* Number of elements available to allocation */
+	unsigned long *bitmap;	/* Allocation bitmap, a bit for each element */
+};
+
+enum ipu_resource_type {
+	IPU_RESOURCE_DEV_CHN = 0,
+	IPU_RESOURCE_EXT_MEM,
+	IPU_RESOURCE_DFM
+};
+
+/* Allocation of resource(s) */
+/* Opaque structure. Do not access fields. */
+struct ipu_resource_alloc {
+	enum ipu_resource_type type;
+	struct ipu_resource *resource;
+	int elements;
+	int pos;
+};
+
+/********** IPU PSYS-specific resource handling **********/
+
+#define IPU_MAX_RESOURCES 32
+
+struct ipu_fw_psys_program_group_manifest {
+	u32 kernel_bitmap[IPU_FW_PSYS_KERNEL_BITMAP_NOF_ELEMS];
+	u32 ID;
+	u16 program_manifest_offset;
+	u16 terminal_manifest_offset;
+	u16 private_data_offset;
+	u16 rbm_manifest_offset;
+	u16 size;
+	u8 alignment;
+	u8 kernel_count;
+	u8 program_count;
+	u8 terminal_count;
+	u8 subgraph_count;
+	u8 reserved[5];
+};
+
+struct ipu_fw_generic_program_manifest {
+	u16 *dev_chn_size;
+	u16 *dev_chn_offset;
+	u16 *ext_mem_size;
+	u16 *ext_mem_offset;
+	u8 cell_id;
+	u8 cells[IPU_FW_PSYS_PROCESS_MAX_CELLS];
+	u8 cell_type_id;
+	u8 *is_dfm_relocatable;
+	u32 *dfm_port_bitmap;
+	u32 *dfm_active_port_bitmap;
+};
+
+struct ipu_fw_generic_process {
+	u16 ext_mem_id;
+	u16 ext_mem_offset;
+	u16 dev_chn_offset;
+	u16 cell_id;
+	u16 dfm_port_bitmap;
+	u16 dfm_active_port_bitmap;
+};
+
+struct ipu_resource_definitions {
+	u32 num_cells;
+	u32 num_cells_type;
+	const u32 *cells;
+	u32 num_dev_channels;
+	const u16 *dev_channels;
+
+	u32 num_ext_mem_types;
+	u32 num_ext_mem_ids;
+	const u16 *ext_mem_ids;
+
+	u32 num_dfm_ids;
+	const u16 *dfms;
+
+	u32 cell_mem_row;
+	const enum ipu_mem_id *cell_mem;
+	struct ipu_fw_generic_process process;
+};
+
+/*
+ * This struct represents all of the currently allocated
+ * resources from IPU model. It is used also for allocating
+ * resources for the next set of PGs to be run on IPU
+ * (ie. those PGs which are not yet being run and which don't
+ * yet reserve real IPU resources).
+ */
+#define IPU_PSYS_RESOURCE_OVERALLOC 2	/* Some room for ABI / ext lib delta */
+struct ipu_psys_resource_pool {
+	u32 cells;	/* Bitmask of cells allocated */
+	struct ipu_resource dev_channels[IPU_FW_PSYS_N_DEV_CHN_ID +
+					 IPU_PSYS_RESOURCE_OVERALLOC];
+	struct ipu_resource ext_memory[IPU_FW_PSYS_N_MEM_ID +
+				       IPU_PSYS_RESOURCE_OVERALLOC];
+	struct ipu_resource dfms[IPU_FW_PSYS_N_DEV_DFM_ID +
+				 IPU_PSYS_RESOURCE_OVERALLOC];
+};
+
+/*
+ * This struct keeps book of the resources allocated for a specific PG.
+ * It is used for freeing up resources from struct ipu_psys_resources
+ * when the PG is released from IPU4 (or model of IPU4).
+ */
+struct ipu_psys_resource_alloc {
+	u32 cells;	/* Bitmask of cells needed */
+	struct ipu_resource_alloc
+	 resource_alloc[IPU_MAX_RESOURCES];
+	int resources;
+};
+
+struct ipu_fw_psys_process_group;
+
+int ipu_psys_resource_pool_init(struct ipu_psys_resource_pool *pool);
+
+void ipu_psys_resource_pool_cleanup(struct ipu_psys_resource_pool *pool);
+
+void ipu_psys_resource_alloc_init(struct ipu_psys_resource_alloc *alloc);
+
+int ipu_psys_allocate_resources(const struct device *dev,
+				struct ipu_fw_psys_process_group *pg,
+				void *pg_manifest,
+				struct ipu_psys_resource_alloc *alloc,
+				struct ipu_psys_resource_pool *pool);
+int ipu_psys_move_resources(const struct device *dev,
+			    struct ipu_psys_resource_alloc *alloc,
+			    struct ipu_psys_resource_pool *source_pool,
+			    struct ipu_psys_resource_pool *target_pool);
+
+void ipu_psys_free_resources(struct ipu_psys_resource_alloc *alloc,
+			     struct ipu_psys_resource_pool *pool);
+
+#endif
diff --git a/drivers/media/pci/intel/ipu-trace-event.h b/drivers/media/pci/intel/ipu-trace-event.h
index b5e8d4b..7296691 100644
--- a/drivers/media/pci/intel/ipu-trace-event.h
+++ b/drivers/media/pci/intel/ipu-trace-event.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation */
 
 #undef TRACE_SYSTEM
@@ -26,6 +30,7 @@ TRACE_EVENT(ipu_sof_seqid,
 	);
 #endif
 
+<<<<<<< HEAD
 #ifdef IPU_EOF_SEQID_TRACE
 TRACE_EVENT(ipu_eof_seqid,
 	    TP_PROTO(unsigned int seqid, unsigned int csiport,
@@ -43,6 +48,8 @@ TRACE_EVENT(ipu_eof_seqid,
 	);
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #ifdef IPU_PERF_REG_TRACE
 TRACE_EVENT(ipu_perf_reg,
 	    TP_PROTO(unsigned int addr, unsigned int val),
diff --git a/drivers/media/pci/intel/ipu-trace.c b/drivers/media/pci/intel/ipu-trace.c
index 5e0795d..d332b3f68 100644
--- a/drivers/media/pci/intel/ipu-trace.c
+++ b/drivers/media/pci/intel/ipu-trace.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2014 - 2018 Intel Corporation
 
 #include <linux/debugfs.h>
@@ -157,7 +161,11 @@ int ipu_trace_get_timer(struct device *dev, u64 *timer)
 }
 EXPORT_SYMBOL_GPL(ipu_trace_get_timer);
 
+<<<<<<< HEAD
 static void __ipu_trace_restore(struct device *dev)
+=======
+void __ipu_trace_restore(struct device *dev)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	struct ipu_bus_device *adev = to_ipu_bus_device(dev);
 	struct ipu_device *isp = adev->isp;
@@ -262,7 +270,11 @@ void ipu_trace_restore(struct device *dev)
 }
 EXPORT_SYMBOL_GPL(ipu_trace_restore);
 
+<<<<<<< HEAD
 static void __ipu_trace_stop(struct device *dev)
+=======
+void __ipu_trace_stop(struct device *dev)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	struct ipu_subsystem_trace_config *sys =
 	    to_ipu_bus_device(dev)->trace_cfg;
@@ -371,6 +383,7 @@ static int update_register_cache(struct ipu_device *isp, u32 reg, u32 value)
 	int i, range;
 	int rval = -EINVAL;
 
+<<<<<<< HEAD
 	if (dctrl->isys.offset == dctrl->psys.offset) {
 		/* For the IPU with uniform address space */
 		if (reg >= IPU_ISYS_OFFSET &&
@@ -393,6 +406,18 @@ static int update_register_cache(struct ipu_device *isp, u32 reg, u32 value)
 		else
 			goto error;
 	}
+=======
+	if (dctrl->isys.offset &&
+	    reg >= dctrl->isys.offset &&
+	    reg < dctrl->isys.offset + TRACE_REG_MAX_ISYS_OFFSET)
+		sys = &dctrl->isys;
+	else if (dctrl->psys.offset &&
+		 reg >= dctrl->psys.offset &&
+		 reg < dctrl->psys.offset + TRACE_REG_MAX_PSYS_OFFSET)
+		sys = &dctrl->psys;
+	else
+		goto error;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	blocks = sys->blocks;
 	dev = sys->dev;
diff --git a/drivers/media/pci/intel/ipu-trace.h b/drivers/media/pci/intel/ipu-trace.h
index 9167c04..7c25f05 100644
--- a/drivers/media/pci/intel/ipu-trace.h
+++ b/drivers/media/pci/intel/ipu-trace.h
@@ -1,10 +1,19 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation */
 
 #ifndef IPU_TRACE_H
 #define IPU_TRACE_H
 #include <linux/debugfs.h>
 
+<<<<<<< HEAD
+=======
+#define TRACE_REG_MAX_ISYS_OFFSET	0x0fffff
+#define TRACE_REG_MAX_PSYS_OFFSET	0xffffff
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define TRACE_REG_MAX_BLOCK_SIZE	0x0fff
 
 #define TRACE_REG_END_MARK 0xffff
diff --git a/drivers/media/pci/intel/ipu-wrapper.c b/drivers/media/pci/intel/ipu-wrapper.c
index 8539573..c40cfb1 100644
--- a/drivers/media/pci/intel/ipu-wrapper.c
+++ b/drivers/media/pci/intel/ipu-wrapper.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <asm/cacheflush.h>
@@ -14,10 +18,13 @@
 #include "ipu-dma.h"
 #include "ipu-mmu.h"
 #include "ipu-wrapper.h"
+<<<<<<< HEAD
 #include "vied_subsystem_access.h"
 #include "vied_subsystem_access_initialization.h"
 #include "shared_memory_map.h"
 #include "shared_memory_access.h"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 struct wrapper_base {
 	void __iomem *sys_base;
@@ -29,8 +36,13 @@ struct wrapper_base {
 	struct device *dev;
 };
 
+<<<<<<< HEAD
 static struct wrapper_base isys;
 static struct wrapper_base psys;
+=======
+struct wrapper_base isys;
+struct wrapper_base psys;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 struct my_css_memory_buffer_item {
 	struct list_head list;
@@ -44,6 +56,14 @@ struct my_css_memory_buffer_item {
 #endif
 };
 
+<<<<<<< HEAD
+=======
+unsigned long long get_hrt_base_address(void)
+{
+	return 0;
+}
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static struct wrapper_base *get_mem_sub_system(int mmid)
 {
 	if (mmid == ISYS_MMID)
@@ -84,22 +104,38 @@ static void *host_addr(int ssid, u32 addr)
 	return NULL;
 }
 
+<<<<<<< HEAD
 void vied_subsystem_store_32(unsigned int ssid, u32 addr, u32 data)
+=======
+void vied_subsystem_store_32(int ssid, u32 addr, u32 data)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	writel(data, host_addr(ssid, addr));
 }
 
+<<<<<<< HEAD
 void vied_subsystem_store_16(unsigned int ssid, u32 addr, u16 data)
+=======
+void vied_subsystem_store_16(int ssid, u32 addr, u16 data)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	writew(data, host_addr(ssid, addr));
 }
 
+<<<<<<< HEAD
 void vied_subsystem_store_8(unsigned int ssid, u32 addr, u8 data)
+=======
+void vied_subsystem_store_8(int ssid, u32 addr, u8 data)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	writeb(data, host_addr(ssid, addr));
 }
 
+<<<<<<< HEAD
 void vied_subsystem_store(unsigned int ssid,
+=======
+void vied_subsystem_store(int ssid,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			  u32 addr, const void *data, unsigned int size)
 {
 	void *dst = host_addr(ssid, addr);
@@ -119,23 +155,39 @@ void vied_subsystem_store(unsigned int ssid,
 		writeb(*(u8 *) data, dst);
 }
 
+<<<<<<< HEAD
 u32 vied_subsystem_load_32(unsigned int ssid, u32 addr)
+=======
+u32 vied_subsystem_load_32(int ssid, u32 addr)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	return readl(host_addr(ssid, addr));
 }
 
+<<<<<<< HEAD
 u16 vied_subsystem_load_16(unsigned int ssid, u32 addr)
+=======
+u16 vied_subsystem_load_16(int ssid, u32 addr)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	return readw(host_addr(ssid, addr));
 }
 
+<<<<<<< HEAD
 u8 vied_subsystem_load_8(unsigned int ssid, u32 addr)
+=======
+u8 vied_subsystem_load_8(int ssid, u32 addr)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	return readb(host_addr(ssid, addr));
 }
 
+<<<<<<< HEAD
 void vied_subsystem_load(unsigned int ssid, u32 addr,
 			 void *data, unsigned int size)
+=======
+void vied_subsystem_load(int ssid, u32 addr, void *data, unsigned int size)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	void *src = host_addr(ssid, addr);
 
@@ -156,7 +208,11 @@ void vied_subsystem_load(unsigned int ssid, u32 addr,
 /*
  * Initialize base address for subsystem
  */
+<<<<<<< HEAD
 void vied_subsystem_access_initialize(unsigned int system)
+=======
+void vied_subsystem_access_initialize(int system)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 }
 
@@ -172,7 +228,11 @@ void vied_subsystem_access_initialize(unsigned int system)
  * \param memory_size: size of ddr memory in bytes
  * \param ps: size of page in bytes (for instance 4096)
  */
+<<<<<<< HEAD
 int shared_memory_allocation_initialize(unsigned int mmid, u64 host_ddr_addr,
+=======
+int shared_memory_allocation_initialize(int mmid, u64 host_ddr_addr,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 					size_t memory_size, size_t ps)
 {
 	return 0;
@@ -182,7 +242,11 @@ int shared_memory_allocation_initialize(unsigned int mmid, u64 host_ddr_addr,
  * \brief De-initialize the shared memory interface administration on the host.
  *
  */
+<<<<<<< HEAD
 void shared_memory_allocation_uninitialize(unsigned int mmid)
+=======
+void shared_memory_allocation_uninitialize(int mmid)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 }
 
@@ -196,10 +260,16 @@ void shared_memory_allocation_uninitialize(unsigned int mmid)
  * \param inv_tlb: invalidate tbl
  * \param sbt: set l1 base address
  */
+<<<<<<< HEAD
 int shared_memory_map_initialize(unsigned int ssid, unsigned int mmid,
 				 size_t mmu_ps, size_t mmu_pnrs, u64 ddr_addr,
 				 shared_memory_invalidate_mmu_tlb inv_tlb,
 				 shared_memory_set_page_table_base_address sbt)
+=======
+int shared_memory_map_initialize(int ssid, int mmid, size_t mmu_ps,
+				 size_t mmu_pnrs, u64 ddr_addr,
+				 int inv_tlb, int sbt)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	return 0;
 }
@@ -207,7 +277,11 @@ int shared_memory_map_initialize(unsigned int ssid, unsigned int mmid,
 /**
  * \brief De-initialize the shared memory interface administration on the host.
  */
+<<<<<<< HEAD
 void shared_memory_map_uninitialize(unsigned int ssid, unsigned int mmid)
+=======
+void shared_memory_map_uninitialize(int ssid, int mmid)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 }
 
@@ -217,17 +291,24 @@ static u8 alloc_cookie;
  * \brief Allocate (DDR) shared memory space and return a host virtual address.
  * \Returns NULL when insufficient memory available
  */
+<<<<<<< HEAD
 u64 shared_memory_alloc(unsigned int mmid, size_t bytes)
+=======
+u64 shared_memory_alloc(int mmid, size_t bytes)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	struct wrapper_base *mine = get_mem_sub_system(mmid);
 	struct my_css_memory_buffer_item *buf;
 	unsigned long flags;
 
+<<<<<<< HEAD
 	if (!mine) {
                 pr_err("Invalid mem subsystem, return. mmid=%d", mmid);
                 return 0;
         }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	dev_dbg(mine->dev, "%s: in, size: %zu\n", __func__, bytes);
 
 	if (!bytes)
@@ -265,18 +346,26 @@ u64 shared_memory_alloc(unsigned int mmid, size_t bytes)
 /**
  * \brief Free (DDR) shared memory space.
  */
+<<<<<<< HEAD
 void shared_memory_free(unsigned int mmid, u64 addr)
+=======
+void shared_memory_free(int mmid, u64 addr)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	struct wrapper_base *mine = get_mem_sub_system(mmid);
 	struct my_css_memory_buffer_item *buf = NULL;
 	unsigned long flags;
 
+<<<<<<< HEAD
 	if (!mine) {
                 pr_err("Invalid mem subsystem, return. mmid=%d", mmid);
                 return;
         }
 
 	if ((void *)(unsigned long)addr == &alloc_cookie)
+=======
+	if ((void *)addr == &alloc_cookie)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		return;
 
 	might_sleep();
@@ -310,18 +399,26 @@ void shared_memory_free(unsigned int mmid, u64 addr)
  * \brief Convert a host virtual address to a CSS virtual address and
  * \update the MMU.
  */
+<<<<<<< HEAD
 u32 shared_memory_map(unsigned int ssid, unsigned int mmid, u64 addr)
+=======
+u32 shared_memory_map(int ssid, int mmid, u64 addr)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	struct wrapper_base *mine = get_mem_sub_system(mmid);
 	struct my_css_memory_buffer_item *buf = NULL;
 	unsigned long flags;
 
+<<<<<<< HEAD
 	if (!mine) {
 		pr_err("Invalid mem subsystem, return NULL. mmid=%d", mmid);
 		return 0;
 	}
 
 	if ((void *)(unsigned long)addr == &alloc_cookie)
+=======
+	if ((void *)addr == &alloc_cookie)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		return 0;
 
 	spin_lock_irqsave(&mine->lock, flags);
@@ -342,7 +439,11 @@ u32 shared_memory_map(unsigned int ssid, unsigned int mmid, u64 addr)
 /**
  * \brief Free a CSS virtual address and update the MMU.
  */
+<<<<<<< HEAD
 void shared_memory_unmap(unsigned int ssid, unsigned int mmid, u32 addr)
+=======
+void shared_memory_unmap(int ssid, int mmid, u32 addr)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 }
 
@@ -350,6 +451,7 @@ void shared_memory_unmap(unsigned int ssid, unsigned int mmid, u32 addr)
  * \brief Store a byte into (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 void shared_memory_store_8(unsigned int mmid, u64 addr, u8 data)
 {
 	if (get_mem_sub_system(mmid))
@@ -360,12 +462,24 @@ void shared_memory_store_8(unsigned int mmid, u64 addr, u8 data)
 	*((u8 *)(unsigned long) addr) = data;
 	/*Invalidate the cache lines to flush the content to ddr. */
 	clflush_cache_range((void *)(unsigned long)addr, sizeof(u8));
+=======
+void shared_memory_store_8(int mmid, u64 addr, u8 data)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%x\n",
+		__func__, addr, data);
+
+	*((u8 *) addr) = data;
+	/*Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u8));
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /**
  * \brief Store a 16-bit word into (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 void shared_memory_store_16(unsigned int mmid, u64 addr, u16 data)
 {
 	if (get_mem_sub_system(mmid))
@@ -376,12 +490,24 @@ void shared_memory_store_16(unsigned int mmid, u64 addr, u16 data)
 	*((u16 *)(unsigned long) addr) = data;
 	/*Invalidate the cache lines to flush the content to ddr. */
 	clflush_cache_range((void *)(unsigned long) addr, sizeof(u16));
+=======
+void shared_memory_store_16(int mmid, u64 addr, u16 data)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%x\n",
+		__func__, addr, data);
+
+	*((u16 *) addr) = data;
+	/*Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u16));
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /**
  * \brief Store a 32-bit word into (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 void shared_memory_store_32(unsigned int mmid, u64 addr, u32 data)
 {
 	if (get_mem_sub_system(mmid))
@@ -392,12 +518,24 @@ void shared_memory_store_32(unsigned int mmid, u64 addr, u32 data)
 	*((u32 *)(unsigned long) addr) = data;
 	/* Invalidate the cache lines to flush the content to ddr. */
 	clflush_cache_range((void *)(unsigned long) addr, sizeof(u32));
+=======
+void shared_memory_store_32(int mmid, u64 addr, u32 data)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%x\n",
+		__func__, addr, data);
+
+	*((u32 *) addr) = data;
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u32));
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /**
  * \brief Store a number of bytes into (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 void shared_memory_store(unsigned int mmid, u64 addr, const void *data,
 			 size_t bytes)
 {
@@ -417,13 +555,31 @@ void shared_memory_store(unsigned int mmid, u64 addr, const void *data,
 	} else {
 		const u8 *pdata = data;
 		u8 *paddr = (u8 *)(unsigned long)addr;
+=======
+void shared_memory_store(int mmid, u64 addr, const void *data, size_t bytes)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%lx bytes = 0x%lx\n", __func__,
+		(unsigned long)addr, bytes);
+
+	if (!data) {
+		dev_err(get_mem_sub_system(mmid)->dev,
+			"%s: data ptr is null\n", __func__);
+	} else {
+		const u8 *pdata = data;
+		u8 *paddr = (u8 *) addr;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		size_t i = 0;
 
 		for (; i < bytes; ++i)
 			*paddr++ = *pdata++;
 
 		/* Invalidate the cache lines to flush the content to ddr. */
+<<<<<<< HEAD
 		clflush_cache_range((void *)(unsigned long) addr, bytes);
+=======
+		clflush_cache_range((void *)addr, bytes);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 }
 
@@ -431,6 +587,7 @@ void shared_memory_store(unsigned int mmid, u64 addr, const void *data,
  * \brief Set a number of bytes of (DDR) shared memory space to 0 using a host
  * \virtual address
  */
+<<<<<<< HEAD
 void shared_memory_zero(unsigned int mmid, u64 addr, size_t bytes)
 {
 	if (get_mem_sub_system(mmid))
@@ -440,12 +597,23 @@ void shared_memory_zero(unsigned int mmid, u64 addr, size_t bytes)
 
 	memset((void *)(unsigned long)addr, 0, bytes);
 	clflush_cache_range((void *)(unsigned long)addr, bytes);
+=======
+void shared_memory_zero(int mmid, u64 addr, size_t bytes)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%lx\n",
+		__func__, addr, bytes);
+
+	memset((void *)addr, 0, bytes);
+	clflush_cache_range((void *)addr, bytes);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /**
  * \brief Load a byte from (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 u8 shared_memory_load_8(unsigned int mmid, u64 addr)
 {
 	u8 data = 0;
@@ -457,6 +625,18 @@ u8 shared_memory_load_8(unsigned int mmid, u64 addr)
 	/* Invalidate the cache lines to flush the content to ddr. */
 	clflush_cache_range((void *)(unsigned long)addr, sizeof(u8));
 	data = *(u8 *)(unsigned long) addr;
+=======
+u8 shared_memory_load_8(int mmid, u64 addr)
+{
+	u8 data = 0;
+
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx\n", __func__, addr);
+
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u8));
+	data = *(u8 *) addr;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return data;
 }
 
@@ -464,6 +644,7 @@ u8 shared_memory_load_8(unsigned int mmid, u64 addr)
  * \brief Load a 16-bit word from (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 u16 shared_memory_load_16(unsigned int mmid, u64 addr)
 {
 	u16 data = 0;
@@ -475,6 +656,18 @@ u16 shared_memory_load_16(unsigned int mmid, u64 addr)
 	/* Invalidate the cache lines to flush the content to ddr. */
 	clflush_cache_range((void *)(unsigned long)addr, sizeof(u16));
 	data = *(u16 *)(unsigned long)addr;
+=======
+u16 shared_memory_load_16(int mmid, u64 addr)
+{
+	u16 data = 0;
+
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx\n", __func__, addr);
+
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u16));
+	data = *(u16 *) addr;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return data;
 }
 
@@ -482,6 +675,7 @@ u16 shared_memory_load_16(unsigned int mmid, u64 addr)
  * \brief Load a 32-bit word from (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 u32 shared_memory_load_32(unsigned int mmid, u64 addr)
 {
 	u32 data = 0;
@@ -493,6 +687,18 @@ u32 shared_memory_load_32(unsigned int mmid, u64 addr)
 	/* Invalidate the cache lines to flush the content to ddr. */
 	clflush_cache_range((void *)(unsigned long)addr, sizeof(u32));
 	data = *(u32 *)(unsigned long)addr;
+=======
+u32 shared_memory_load_32(int mmid, u64 addr)
+{
+	u32 data = 0;
+
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx\n", __func__, addr);
+
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u32));
+	data = *(u32 *) addr;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return data;
 }
 
@@ -500,6 +706,7 @@ u32 shared_memory_load_32(unsigned int mmid, u64 addr)
  * \brief Load a number of bytes from (DDR) shared memory space using a host
  * \virtual address
  */
+<<<<<<< HEAD
 void shared_memory_load(unsigned int mmid, u64 addr, void *data, size_t bytes)
 {
 	if (get_mem_sub_system(mmid))
@@ -522,6 +729,25 @@ void shared_memory_load(unsigned int mmid, u64 addr, void *data, size_t bytes)
 
 		/* Invalidate the cache lines to flush the content to ddr. */
 		clflush_cache_range((void *)(unsigned long)addr, bytes);
+=======
+void shared_memory_load(int mmid, u64 addr, void *data, size_t bytes)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%lx bytes = 0x%lx\n", __func__,
+		(unsigned long)addr, bytes);
+
+	if (!data) {
+		dev_err(get_mem_sub_system(mmid)->dev,
+			"%s: data ptr is null\n", __func__);
+
+	} else {
+		u8 *pdata = data;
+		u8 *paddr = (u8 *) addr;
+		size_t i = 0;
+
+		/* Invalidate the cache lines to flush the content to ddr. */
+		clflush_cache_range((void *)addr, bytes);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		for (; i < bytes; ++i)
 			*pdata++ = *paddr++;
 	}
@@ -541,10 +767,13 @@ void ipu_wrapper_init(int mmid, struct device *dev, void __iomem *base)
 {
 	struct wrapper_base *sys = get_mem_sub_system(mmid);
 
+<<<<<<< HEAD
 	if (!sys) {
                 pr_err("Invalid mem subsystem, return. mmid=%d", mmid);
                 return;
         }
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	init_wrapper(sys);
 	sys->dev = dev;
 	sys->sys_base = base;
diff --git a/drivers/media/pci/intel/ipu-wrapper.h b/drivers/media/pci/intel/ipu-wrapper.h
index b7df285..990ebd0 100644
--- a/drivers/media/pci/intel/ipu-wrapper.h
+++ b/drivers/media/pci/intel/ipu-wrapper.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_WRAPPER_H
@@ -11,6 +15,13 @@
 #define PSYS_MMID 0
 
 struct device;
+<<<<<<< HEAD
+=======
+struct ia_css_env;
+struct ipu_isys_iomem_filter;
+struct iommu_domain;
+struct firmware;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 void ipu_wrapper_init(int mmid, struct device *dev, void __iomem *base);
 
diff --git a/drivers/media/pci/intel/ipu.c b/drivers/media/pci/intel/ipu.c
index 27d97c9..73fabdb 100644
--- a/drivers/media/pci/intel/ipu.c
+++ b/drivers/media/pci/intel/ipu.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include <linux/debugfs.h>
@@ -272,6 +276,7 @@ static int ipu_init_debugfs(struct ipu_device *isp)
 
 static void ipu_remove_debugfs(struct ipu_device *isp)
 {
+<<<<<<< HEAD
 	/*
 	 * Since isys and psys debugfs dir will be created under ipu root dir,
 	 * mark its dentry to NULL to avoid duplicate removal.
@@ -281,6 +286,12 @@ static void ipu_remove_debugfs(struct ipu_device *isp)
 }
 
 static int ipu_pci_config_setup(struct pci_dev *dev)
+=======
+	debugfs_remove_recursive(isp->ipu_dir);
+}
+
+int ipu_pci_config_setup(struct pci_dev *dev)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	u16 pci_command;
 	int rval = pci_enable_msi(dev);
@@ -298,7 +309,11 @@ static int ipu_pci_config_setup(struct pci_dev *dev)
 	return 0;
 }
 
+<<<<<<< HEAD
 static void ipu_configure_vc_mechanism(struct ipu_device *isp)
+=======
+void ipu_configure_vc_mechanism(struct ipu_device *isp)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	u32 val = readl(isp->base + BUTTRESS_REG_BTRS_CTRL);
 
@@ -315,6 +330,7 @@ static void ipu_configure_vc_mechanism(struct ipu_device *isp)
 	writel(val, isp->base + BUTTRESS_REG_BTRS_CTRL);
 }
 
+<<<<<<< HEAD
 int request_cpd_fw(const struct firmware **firmware_p, const char *name,
 		 struct device *device)
 {
@@ -350,6 +366,8 @@ int request_cpd_fw(const struct firmware **firmware_p, const char *name,
 }
 EXPORT_SYMBOL(request_cpd_fw);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static int ipu_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 {
 	struct ipu_device *isp;
@@ -367,7 +385,10 @@ static int ipu_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 	if (!isp)
 		return -ENOMEM;
 
+<<<<<<< HEAD
 	dev_set_name(&pdev->dev, "intel-ipu");
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	isp->pdev = pdev;
 	INIT_LIST_HEAD(&isp->devices);
 
@@ -447,7 +468,11 @@ static int ipu_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 
 	dev_info(&pdev->dev, "cpd file name: %s\n", isp->cpd_fw_name);
 
+<<<<<<< HEAD
 	rval = request_cpd_fw(&isp->cpd_fw, isp->cpd_fw_name, &pdev->dev);
+=======
+	rval = request_firmware(&isp->cpd_fw, isp->cpd_fw_name, &pdev->dev);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (rval) {
 		dev_err(&isp->pdev->dev, "Requesting signed firmware failed\n");
 		trace_printk("E|TMWK\n");
@@ -538,9 +563,12 @@ static int ipu_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 	pm_runtime_put_noidle(&pdev->dev);
 	pm_runtime_allow(&pdev->dev);
 
+<<<<<<< HEAD
 	dev_info(&pdev->dev, "IPU driver verion %d.%d\n", IPU_MAJOR_VERSION,
 		 IPU_MINOR_VERSION);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	trace_printk("E|TMWK\n");
 	return 0;
 
diff --git a/drivers/media/pci/intel/ipu.h b/drivers/media/pci/intel/ipu.h
index 5229671..48b36a8 100644
--- a/drivers/media/pci/intel/ipu.h
+++ b/drivers/media/pci/intel/ipu.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_H
@@ -19,6 +23,7 @@
 #define IPU_PCI_ID	0x5a19
 #endif
 
+<<<<<<< HEAD
 /*
  * IPU version definitions to reflect the IPU driver changes.
  * Both ISYS and PSYS share the same version.
@@ -27,6 +32,8 @@
 #define IPU_MINOR_VERSION 0
 #define IPU_DRIVER_VERSION (IPU_MAJOR_VERSION << 16 | IPU_MINOR_VERSION)
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* processing system frequency: 25Mhz x ratio, Legal values [8,32] */
 #define PS_FREQ_CTL_DEFAULT_RATIO	0x12
 
@@ -34,6 +41,11 @@
 #define IS_FREQ_SOURCE			1600000000
 #define IS_FREQ_CTL_DIVISOR		0x4
 
+<<<<<<< HEAD
+=======
+#define IPU_ISYS_NUM_STREAMS		8	/* Max 8 */
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /*
  * ISYS DMA can overshoot. For higher resolutions over allocation is one line
  * but it must be at minimum 1024 bytes. Value could be different in
@@ -95,7 +107,10 @@ void ipu_configure_spc(struct ipu_device *isp,
 		       const struct ipu_hw_variants *hw_variant,
 		       int pkg_dir_idx, void __iomem *base, u64 *pkg_dir,
 		       dma_addr_t pkg_dir_dma_addr);
+<<<<<<< HEAD
 int request_cpd_fw(const struct firmware **firmware_p, const char *name,
 		   struct device *device);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* IPU_H */
diff --git a/drivers/media/pci/intel/ipu4/Makefile b/drivers/media/pci/intel/ipu4/Makefile
index a0e41f9..465fd9f 100644
--- a/drivers/media/pci/intel/ipu4/Makefile
+++ b/drivers/media/pci/intel/ipu4/Makefile
@@ -1,10 +1,26 @@
+<<<<<<< HEAD
 # SPDX-License-Identifier: GPL-2.0
 # Copyright (c) 2010 - 2018, Intel Corporation.
+=======
+#
+#  Copyright (c) 2010 - 2018, Intel Corporation.
+#
+#  This program is free software; you can redistribute it and/or modify it
+#  under the terms and conditions of the GNU General Public License,
+#  version 2, as published by the Free Software Foundation.
+#
+#  This program is distributed in the hope it will be useful, but WITHOUT
+#  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+#  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+#  more details.
+#
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ifneq ($(EXTERNAL_BUILD), 1)
 srcpath := $(srctree)
 endif
 
+<<<<<<< HEAD
 ifdef CONFIG_VIDEO_INTEL_IPU4
 ccflags-y += -DHAS_DUAL_CMD_CTX_SUPPORT=0
 ccflags-y += -DIPU_META_DATA_SUPPORT -DI2C_DYNAMIC
@@ -27,6 +43,38 @@ intel-ipu4-isys-objs			+= ../ipu-isys.o \
 					   ../ipu-isys-csi2.o \
 					   ipu4-isys.o \
 					   ipu4-isys-csi2.o \
+=======
+#
+#config for bxt-p platform
+#
+ifdef CONFIG_VIDEO_INTEL_IPU4
+
+IPU_STEP = bxtB0
+ccflags-y += -DHAS_DUAL_CMD_CTX_SUPPORT=0
+
+ifndef IPU_STEP
+  $(error No IPU_STEP was defined. Stopping.)
+endif
+
+intel-ipu4-mod-$(IPU_STEP)-objs			+= \
+						../ipu.o \
+						../ipu-bus.o \
+						../ipu-dma.o \
+						../ipu-buttress.o \
+						../ipu-trace.o \
+						../ipu-cpd.o \
+						../ipu-fw-com.o \
+						ipu4.o
+
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-mod-$(IPU_STEP).o
+intel-ipu4-mmu-$(IPU_STEP)-objs		+= ../ipu-mmu.o
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-mmu-$(IPU_STEP).o
+intel-ipu4-isys-mod-$(IPU_STEP)-objs	+= ../ipu-isys.o \
+					   ../ipu-isys-csi2.o \
+					   ipu4-isys.o \
+					   ipu4-isys-csi2.o \
+					   ../ipu-isys-media.o \
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 					   ../ipu-isys-csi2-be-soc.o \
 					   ../ipu-isys-csi2-be.o \
 					   ../ipu-fw-isys.o \
@@ -35,6 +83,7 @@ intel-ipu4-isys-objs			+= ../ipu-isys.o \
 					   ../ipu-isys-queue.o \
 					   ../ipu-isys-subdev.o \
 					   ../ipu-isys-tpg.o
+<<<<<<< HEAD
 
 obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-isys.o
 
@@ -52,6 +101,26 @@ intel-ipu4-psys-objs			+= ../ipu-psys-compat32.o
 endif
 
 obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-psys.o
+=======
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-isys-mod-$(IPU_STEP).o
+
+intel-ipu4-psys-mod-$(IPU_STEP)-objs	+= \
+					../ipu-psys.o \
+					../ipu-resources.o \
+					ipu4-psys.o \
+					ipu4-resource-tables.o \
+
+ifndef CONFIG_VIDEO_INTEL_IPU_FW_LIB
+intel-ipu4-psys-mod-$(IPU_STEP)-objs	+= ipu4-fw-resources.o \
+					../ipu-fw-psys.o
+endif
+
+ifeq ($(CONFIG_COMPAT),y)
+intel-ipu4-psys-mod-$(IPU_STEP)-objs	+= ../ipu-psys-compat32.o
+endif
+
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-psys-mod-$(IPU_STEP).o
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ifdef CONFIG_VIDEO_INTEL_IPU_FW_LIB
 include $(srcpath)/$(src)/ipu4-css/Makefile.isyslib
@@ -61,6 +130,7 @@ endif
 ccflags-y += -I$(srcpath)/$(src)/../../../../../include/
 ccflags-y += -I$(srcpath)/$(src)/../
 ccflags-y += -I$(srcpath)/$(src)/
+<<<<<<< HEAD
 ifdef CONFIG_VIDEO_INTEL_IPU_FW_LIB
 ccflags-y += -I$(srcpath)/$(src)/ipu4-css
 endif
@@ -90,6 +160,44 @@ intel-ipu4p-isys-objs			+= ../ipu-isys.o \
 					   ../ipu-isys-csi2.o \
 					   ipu4-isys.o \
 					   ipu4p-isys-csi2.o \
+=======
+ccflags-y += -I$(srcpath)/$(src)/ipu4-css
+
+ccflags-y += -DPARAMETER_INTERFACE_V2
+
+endif
+
+#
+#config for cnl platform
+#
+ifdef CONFIG_VIDEO_INTEL_IPU4P
+
+IPU_STEP = cnl
+ccflags-y += -DHAS_DUAL_CMD_CTX_SUPPORT=0
+
+ifndef IPU_STEP
+  $(error No IPU_STEP was defined. Stopping.)
+endif
+
+intel-ipu4-mod-$(IPU_STEP)-objs			+= \
+						../ipu.o \
+						../ipu-bus.o \
+						../ipu-dma.o \
+						../ipu-buttress.o \
+						../ipu-trace.o \
+						../ipu-cpd.o \
+						../ipu-fw-com.o \
+						ipu4.o
+
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-mod-$(IPU_STEP).o
+intel-ipu4-mmu-$(IPU_STEP)-objs		+= ../ipu-mmu.o
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-mmu-$(IPU_STEP).o
+intel-ipu4-isys-mod-$(IPU_STEP)-objs	+= ../ipu-isys.o \
+					   ../ipu-isys-csi2.o \
+					   ipu4-isys.o \
+					   ipu4p-isys-csi2.o \
+					   ../ipu-isys-media.o \
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 					   ../ipu-isys-csi2-be-soc.o \
 					   ../ipu-isys-csi2-be.o \
 					   ../ipu-fw-isys.o \
@@ -98,6 +206,7 @@ intel-ipu4p-isys-objs			+= ../ipu-isys.o \
 					   ../ipu-isys-queue.o \
 					   ../ipu-isys-subdev.o \
 					   ../ipu-isys-tpg.o
+<<<<<<< HEAD
 obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4p-isys.o
 
 intel-ipu4p-psys-objs			+= ../ipu-psys.o \
@@ -114,6 +223,26 @@ intel-ipu4p-psys-objs			+= ../ipu-psys-compat32.o
 endif
 
 obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4p-psys.o
+=======
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-isys-mod-$(IPU_STEP).o
+
+intel-ipu4-psys-mod-$(IPU_STEP)-objs	+= \
+					../ipu-psys.o \
+					../ipu-resources.o \
+					ipu4-psys.o \
+					ipu4-resource-tables.o \
+
+ifndef CONFIG_VIDEO_INTEL_IPU_FW_LIB
+intel-ipu4-psys-mod-$(IPU_STEP)-objs	+= ipu4-fw-resources.o \
+					../ipu-fw-psys.o
+endif
+
+ifeq ($(CONFIG_COMPAT),y)
+intel-ipu4-psys-mod-$(IPU_STEP)-objs	+= ../ipu-psys-compat32.o
+endif
+
+obj-$(CONFIG_VIDEO_INTEL_IPU)		+= intel-ipu4-psys-mod-$(IPU_STEP).o
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ifdef CONFIG_VIDEO_INTEL_IPU_FW_LIB
 include $(srcpath)/$(src)/ipu4p-css/Makefile.isyslib
@@ -123,9 +252,16 @@ endif
 ccflags-y += -I$(srcpath)/$(src)/../../../../../include/
 ccflags-y += -I$(srcpath)/$(src)/../
 ccflags-y += -I$(srcpath)/$(src)/
+<<<<<<< HEAD
 ifdef CONFIG_VIDEO_INTEL_IPU_FW_LIB
 ccflags-y += -I$(srcpath)/$(src)/ipu4p-css
 endif
 
 ccflags-y += -DPARAMETER_INTERFACE_V2
+=======
+ccflags-y += -I$(srcpath)/$(src)/ipu4p-css
+
+ccflags-y += -DPARAMETER_INTERFACE_V2
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 endif
diff --git a/drivers/media/pci/intel/ipu4/ipu-platform-buttress-regs.h b/drivers/media/pci/intel/ipu4/ipu-platform-buttress-regs.h
index ffd770c..d2eef96 100644
--- a/drivers/media/pci/intel/ipu4/ipu-platform-buttress-regs.h
+++ b/drivers/media/pci/intel/ipu4/ipu-platform-buttress-regs.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation */
 
 #ifndef IPU_PLATFORM_BUTTRESS_REGS_H
diff --git a/drivers/media/pci/intel/ipu4/ipu-platform-isys-csi2-reg.h b/drivers/media/pci/intel/ipu4/ipu-platform-isys-csi2-reg.h
index 2d1c5a4..ebb382d 100644
--- a/drivers/media/pci/intel/ipu4/ipu-platform-isys-csi2-reg.h
+++ b/drivers/media/pci/intel/ipu4/ipu-platform-isys-csi2-reg.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_PLATFORM_ISYS_CSI2_REG_H
@@ -60,9 +64,12 @@
 #define CSI2_IRQ_FE_VC(chn)	(0x20000 << ((chn) * 4))
 #define CSI2_IRQ_LS_VC(chn)	(0x40000 << ((chn) * 4))
 #define CSI2_IRQ_LE_VC(chn)	(0x80000 << ((chn) * 4))
+<<<<<<< HEAD
 #define CSI2_REG_CL0_IBUFCTL_EN_FLUSH_FOR_IDRAIN	0x6002c
 #define CSI2_REG_CL1_IBUFCTL_EN_FLUSH_FOR_IDRAIN	0x6802c
 #define IPU_REG_ISYS_IBUFCTL_EN_FLUSH_FOR_IDRAIN	0xb602c
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* CONFIG_VIDEO_INTEL_IPU4P */
 
 #ifdef CONFIG_VIDEO_INTEL_IPU4
diff --git a/drivers/media/pci/intel/ipu4/ipu-platform-isys.h b/drivers/media/pci/intel/ipu4/ipu-platform-isys.h
index 51f26f2..6bb94cdbc 100644
--- a/drivers/media/pci/intel/ipu4/ipu-platform-isys.h
+++ b/drivers/media/pci/intel/ipu4/ipu-platform-isys.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2018 Intel Corporation */
 
 #ifndef IPU_PLATFORM_ISYS_H
diff --git a/drivers/media/pci/intel/ipu4/ipu-platform-regs.h b/drivers/media/pci/intel/ipu4/ipu-platform-regs.h
index e54b2b5..1a64e06 100644
--- a/drivers/media/pci/intel/ipu4/ipu-platform-regs.h
+++ b/drivers/media/pci/intel/ipu4/ipu-platform-regs.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation */
 
 #ifndef IPU_PLATFORM_REGS_H
@@ -181,10 +185,13 @@
 #define IPU_INFO_ZLW                               BIT(2)
 #define IPU_INFO_STREAM_ID_SET(a)	((a & 0xF) << 4)
 #define IPU_INFO_ADDRESS_SWIZZ                     BIT(8)
+<<<<<<< HEAD
 
 /* Trace unit related register definitions */
 #define TRACE_REG_MAX_ISYS_OFFSET	0x0fffff
 #define TRACE_REG_MAX_PSYS_OFFSET	0xffffff
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* ISYS trace registers - offsets to isys base address */
 /* Trace unit base offset */
 #define TRACE_REG_IS_TRACE_UNIT_BASE			0x07d000
@@ -259,5 +266,8 @@
 #define IPU_REG_PSYS_GPDEV_FWIRQ(n)		(4 * (n) + 0x60100)
 /* CDC Burst collector thresholds for psys - 4 FIFOs i= 0..3 */
 #define IPU_REG_PSYS_CDC_THRESHOLD(i)           (0x60600 + ((i) * 4))
+<<<<<<< HEAD
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* IPU_REGS_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu-platform-resources.h b/drivers/media/pci/intel/ipu4/ipu-platform-resources.h
index 59b2cd4..e01776f 100644
--- a/drivers/media/pci/intel/ipu4/ipu-platform-resources.h
+++ b/drivers/media/pci/intel/ipu4/ipu-platform-resources.h
@@ -1,11 +1,18 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef IPU_PLATFORM_RESOURCES_H
 #define IPU_PLATFORM_RESOURCES_H
 
+<<<<<<< HEAD
 #include <linux/kernel.h>
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* ia_css_psys_program_group_private.h */
 /* ia_css_psys_process_group_cmd_impl.h */
 #ifdef CONFIG_VIDEO_INTEL_IPU4P
@@ -203,6 +210,7 @@ struct ipu_fw_psys_process {
 	u8 padding[IPU_FW_PSYS_N_PADDING_UINT8_IN_PROCESS_STRUCT];
 };
 
+<<<<<<< HEAD
 struct ipu_psys_resource_alloc;
 struct ipu_fw_psys_process_group;
 struct ipu_psys_resource_pool;
@@ -222,3 +230,6 @@ void ipu_psys_free_resources(struct ipu_psys_resource_alloc *alloc,
 extern const struct ipu_fw_resource_definitions *res_defs;
 
 #endif /* IPU_PLATFORM_RESOURCES_H */
+=======
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu-platform.h b/drivers/media/pci/intel/ipu4/ipu-platform.h
index 3295612..9d4c4af 100644
--- a/drivers/media/pci/intel/ipu4/ipu-platform.h
+++ b/drivers/media/pci/intel/ipu4/ipu-platform.h
@@ -1,11 +1,18 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef IPU_PLATFORM_H
 #define IPU_PLATFORM_H
 
 #define IPU_NAME			"intel-ipu4"
+<<<<<<< HEAD
 #define IPU_ISYS_NUM_STREAMS            8       /* Max 8 */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #ifdef CONFIG_VIDEO_INTEL_IPU4
 #define IPU_CPD_FIRMWARE_NAME	"ipu4_cpd_b0.bin"
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4isys_inc b/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4isys_inc
index 48a4ede..d188027 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4isys_inc
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4isys_inc
@@ -19,7 +19,10 @@ IPU_ISYSLIB_INC = \
 	-I$(IPU_ISYSLIB_ROOT)/regmem/src \
 	-I$(IPU_ISYSLIB_ROOT)/support \
 	-I$(IPU_ISYSLIB_ROOT)/syscom/interface \
+<<<<<<< HEAD
 	-I$(IPU_ISYSLIB_ROOT)/syscom/src \
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	-I$(IPU_ISYSLIB_ROOT)/trace/interface \
 	-I$(IPU_ISYSLIB_ROOT)/utils/system_defs/ \
 	-I$(IPU_ISYSLIB_ROOT)/vied \
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4psys_inc b/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4psys_inc
index abc6147..cbd7954 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4psys_inc
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.ipu4psys_inc
@@ -43,7 +43,10 @@ IPU_PSYSLIB_INC = \
 	-I$(IPU_PSYSLIB_ROOT)/routing_bitmap/src \
 	-I$(IPU_PSYSLIB_ROOT)/support \
 	-I$(IPU_PSYSLIB_ROOT)/syscom/interface \
+<<<<<<< HEAD
 	-I$(IPU_PSYSLIB_ROOT)/syscom/src \
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	-I$(IPU_PSYSLIB_ROOT)/trace/interface \
 	-I$(IPU_PSYSLIB_ROOT)/vied \
 	-I$(IPU_PSYSLIB_ROOT)/vied/vied/ \
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.isyslib b/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.isyslib
index 33a3df8..68e0a73 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.isyslib
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/Makefile.isyslib
@@ -10,6 +10,7 @@ IPU_ISYSLIB_ROOT = $(srcpath)/$(src)/$(IPU_ISYSLIB_ROOT_REL)
 include $(srcpath)/$(src)/ipu4-css/Makefile.ipu4isys_inc
 include $(srcpath)/$(src)/ipu4-css/Makefile.ipu4isys_src
 
+<<<<<<< HEAD
 intel-ipu4-isys-csslib-objs := \
 			ipu4-css/libintel-ipu4.o \
 			$(IPU_ISYSLIB_SRC)
@@ -20,11 +21,32 @@ endif
 obj-$(CONFIG_VIDEO_INTEL_IPU)	+= intel-ipu4-isys-csslib.o
 
 INCLUDES := -I$(srcpath)/$(src)/$(IPU_ISYSLIB_ROOT_REL) \
+=======
+#
+# copy wrapper here only for isys usage, psys would use the original one
+#
+$(shell cp -f $(srcpath)/$(src)/../ipu-wrapper.c $(srcpath)/$(src)/ipu4-css/ipu-wrapper.c)
+
+lib2600-mod-$(IPU_STEP)-objs := \
+	ipu4-css/libintel-ipu4.o \
+	../libintel-checker.o \
+	$(IPU_ISYSLIB_SRC)
+
+ifeq ($(CONFIG_VIDEO_INTEL_IPU), m)
+lib2600-mod-$(IPU_STEP)-objs += ipu4-css/ipu-wrapper.o
+endif
+
+obj-$(CONFIG_VIDEO_INTEL_IPU)	+= lib2600-mod-$(IPU_STEP).o
+
+INCLUDES := \
+	-I$(srcpath)/$(src)/$(IPU_ISYSLIB_ROOT_REL) \
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	-I$(srcpath)/$(src) \
 	$(IPU_ISYSLIB_INC)
 
 DEFINES:= -D__HOST__ -D__KERNEL__ -DISYS_FPGA -DPSYS_FPGA
 
+<<<<<<< HEAD
 DEFINES += -DSSID=1
 DEFINES += -DMMID=1
 DEFINES += -DPROGNAME=isys_fw
@@ -38,5 +60,20 @@ DEFINES += -DCFG_VIED_SUBSYSTEM_ACCESS_LIB_IMPL=1
 DEFINES += -DHRT_ON_VIED_SUBSYSTEM_ACCESS=0
 DEFINES += -DHRT_USE_VIR_ADDRS
 DEFINES += -DHRT_HW
+=======
+ DEFINES += -DSSID=1
+ DEFINES += -DMMID=1
+ DEFINES += -DPROGNAME=isys_fw
+ DEFINES += -DPROGMAP=\"isys_fw.map.h\"
+ DEFINES += -DSUBSYSTEM_INCLUDE=\<isys.h\>
+ DEFINES += -DCELL=input_system_unis_logic_sp_control_tile_sp
+ DEFINES += -DSPMAIN=isys_fw
+ DEFINES += -DRUN_INTEGRATION
+ DEFINES += -DDEBUG_SP_NCI
+ DEFINES += -DCFG_VIED_SUBSYSTEM_ACCESS_LIB_IMPL=1
+ DEFINES += -DHRT_ON_VIED_SUBSYSTEM_ACCESS=0
+ DEFINES += -DHRT_USE_VIR_ADDRS
+ DEFINES += -DHRT_HW
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ccflags-y += $(INCLUDES) $(DEFINES) -fno-common
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/ia_css_fw_pkg_release.h b/drivers/media/pci/intel/ipu4/ipu4-css/ia_css_fw_pkg_release.h
index 37a8016..739e0f6 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/ia_css_fw_pkg_release.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/ia_css_fw_pkg_release.h
@@ -11,4 +11,8 @@
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 */
+<<<<<<< HEAD
 #define IA_CSS_FW_PKG_RELEASE  0x20191115
+=======
+#define IA_CSS_FW_PKG_RELEASE  0x20180412
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c b/drivers/media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c
deleted file mode 120000
index 3167dda..00000000
--- a/drivers/media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c
+++ /dev/null
@@ -1 +0,0 @@
-../../ipu-wrapper.c
\ No newline at end of file
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c b/drivers/media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c
new file mode 100644
index 00000000..736f15d
--- /dev/null
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/ipu-wrapper.c
@@ -0,0 +1,512 @@
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2013 - 2018 Intel Corporation
+
+#include <asm/cacheflush.h>
+#include <linux/io.h>
+
+#include <linux/delay.h>
+#include <linux/dma-mapping.h>
+#include <linux/module.h>
+#include <linux/slab.h>
+#include <linux/spinlock.h>
+
+#include "ipu-bus.h"
+#include "ipu-dma.h"
+#include "ipu-mmu.h"
+#include "ipu-wrapper.h"
+
+struct wrapper_base {
+	void __iomem *sys_base;
+	const struct dma_map_ops *ops;
+	/* Protect shared memory buffers */
+	spinlock_t lock;
+	struct list_head buffers;
+	u32 css_map_done;
+	struct device *dev;
+};
+
+struct wrapper_base isys;
+struct wrapper_base psys;
+
+struct my_css_memory_buffer_item {
+	struct list_head list;
+	dma_addr_t iova;
+	unsigned long *addr;
+	size_t bytes;
+#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 8, 0)
+	struct dma_attrs attrs;
+#else
+	unsigned long attrs;
+#endif
+};
+
+unsigned long long get_hrt_base_address(void)
+{
+	return 0;
+}
+
+static struct wrapper_base *get_mem_sub_system(int mmid)
+{
+	if (mmid == ISYS_MMID)
+		return &isys;
+
+	if (mmid == PSYS_MMID)
+		return &psys;
+	WARN(1, "Invalid mem subsystem");
+	return NULL;
+}
+
+static struct wrapper_base *get_sub_system(int ssid)
+{
+	if (ssid == ISYS_SSID)
+		return &isys;
+
+	if (ssid == PSYS_SSID)
+		return &psys;
+	WARN(1, "Invalid subsystem");
+	return NULL;
+}
+
+/*
+ * Subsystem access functions to access IUNIT MMIO space
+ */
+static void *host_addr(int ssid, u32 addr)
+{
+	if (ssid == ISYS_SSID)
+		return isys.sys_base + addr;
+	else if (ssid == PSYS_SSID)
+		return psys.sys_base + addr;
+	/*
+	 * Calling WARN_ON is a bit brutal but better to capture wrong register
+	 * accesses immediately. We have no way to return an error here.
+	 */
+	WARN_ON(1);
+
+	return NULL;
+}
+
+void vied_subsystem_store_32(int ssid, u32 addr, u32 data)
+{
+	writel(data, host_addr(ssid, addr));
+}
+
+void vied_subsystem_store_16(int ssid, u32 addr, u16 data)
+{
+	writew(data, host_addr(ssid, addr));
+}
+
+void vied_subsystem_store_8(int ssid, u32 addr, u8 data)
+{
+	writeb(data, host_addr(ssid, addr));
+}
+
+void vied_subsystem_store(int ssid,
+			  u32 addr, const void *data, unsigned int size)
+{
+	void *dst = host_addr(ssid, addr);
+
+	dev_dbg(get_sub_system(ssid)->dev, "access: %s 0x%x size: %d\n",
+		__func__, addr, size);
+
+	for (; size >= sizeof(u32); size -= sizeof(u32),
+	     dst += sizeof(u32), data += sizeof(u32)) {
+		writel(*(u32 *) data, dst);
+	}
+	if (size >= sizeof(u16)) {
+		writew(*(u16 *) data, dst);
+		size -= sizeof(u16), dst += sizeof(u16), data += sizeof(u16);
+	}
+	if (size)
+		writeb(*(u8 *) data, dst);
+}
+
+u32 vied_subsystem_load_32(int ssid, u32 addr)
+{
+	return readl(host_addr(ssid, addr));
+}
+
+u16 vied_subsystem_load_16(int ssid, u32 addr)
+{
+	return readw(host_addr(ssid, addr));
+}
+
+u8 vied_subsystem_load_8(int ssid, u32 addr)
+{
+	return readb(host_addr(ssid, addr));
+}
+
+void vied_subsystem_load(int ssid, u32 addr, void *data, unsigned int size)
+{
+	void *src = host_addr(ssid, addr);
+
+	dev_dbg(get_sub_system(ssid)->dev, "access: %s 0x%x size: %d\n",
+		__func__, addr, size);
+
+	for (; size >= sizeof(u32); size -= sizeof(u32),
+	     src += sizeof(u32), data += sizeof(u32))
+		*(u32 *) data = readl(src);
+	if (size >= sizeof(u16)) {
+		*(u16 *) data = readw(src);
+		size -= sizeof(u16), src += sizeof(u16), data += sizeof(u16);
+	}
+	if (size)
+		*(u8 *) data = readb(src);
+}
+
+/*
+ * Initialize base address for subsystem
+ */
+void vied_subsystem_access_initialize(int system)
+{
+}
+
+/*
+ * Shared memory access codes written by Dash Biswait,
+ * copied from FPGA environment
+ */
+
+/**
+ * \brief Initialize the shared memory interface administration on the host.
+ * \param mmid: id of ddr memory
+ * \param host_ddr_addr: physical address of memory as seen from host
+ * \param memory_size: size of ddr memory in bytes
+ * \param ps: size of page in bytes (for instance 4096)
+ */
+int shared_memory_allocation_initialize(int mmid, u64 host_ddr_addr,
+					size_t memory_size, size_t ps)
+{
+	return 0;
+}
+
+/**
+ * \brief De-initialize the shared memory interface administration on the host.
+ *
+ */
+void shared_memory_allocation_uninitialize(int mmid)
+{
+}
+
+/**
+ * \brief Initialize the shared memory interface administration on the host.
+ * \param ssid: id of subsystem
+ * \param mmid: id of ddr memory
+ * \param mmu_ps: size of page in bits
+ * \param mmu_pnrs: page numbers
+ * \param ddr_addr: base address
+ * \param inv_tlb: invalidate tbl
+ * \param sbt: set l1 base address
+ */
+int shared_memory_map_initialize(int ssid, int mmid, size_t mmu_ps,
+				 size_t mmu_pnrs, u64 ddr_addr,
+				 int inv_tlb, int sbt)
+{
+	return 0;
+}
+
+/**
+ * \brief De-initialize the shared memory interface administration on the host.
+ */
+void shared_memory_map_uninitialize(int ssid, int mmid)
+{
+}
+
+static u8 alloc_cookie;
+
+/**
+ * \brief Allocate (DDR) shared memory space and return a host virtual address.
+ * \Returns NULL when insufficient memory available
+ */
+u64 shared_memory_alloc(int mmid, size_t bytes)
+{
+	struct wrapper_base *mine = get_mem_sub_system(mmid);
+	struct my_css_memory_buffer_item *buf;
+	unsigned long flags;
+
+	dev_dbg(mine->dev, "%s: in, size: %zu\n", __func__, bytes);
+
+	if (!bytes)
+		return (unsigned long)&alloc_cookie;
+
+	might_sleep();
+
+	buf = kzalloc(sizeof(*buf), GFP_KERNEL);
+	if (!buf)
+		return 0;
+
+	/*alloc using ipu dma driver */
+	buf->bytes = PAGE_ALIGN(bytes);
+
+	buf->addr = dma_alloc_attrs(mine->dev, buf->bytes, &buf->iova,
+				    GFP_KERNEL,
+#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 8, 0)
+				    NULL
+#else
+				    0
+#endif
+	    );
+	if (!buf->addr) {
+		kfree(buf);
+		return 0;
+	}
+
+	spin_lock_irqsave(&mine->lock, flags);
+	list_add(&buf->list, &mine->buffers);
+	spin_unlock_irqrestore(&mine->lock, flags);
+
+	return (unsigned long)buf->addr;
+}
+
+/**
+ * \brief Free (DDR) shared memory space.
+ */
+void shared_memory_free(int mmid, u64 addr)
+{
+	struct wrapper_base *mine = get_mem_sub_system(mmid);
+	struct my_css_memory_buffer_item *buf = NULL;
+	unsigned long flags;
+
+	if ((void *)addr == &alloc_cookie)
+		return;
+
+	might_sleep();
+
+	dev_dbg(mine->dev, "looking for iova %8.8llx\n", addr);
+
+	spin_lock_irqsave(&mine->lock, flags);
+	list_for_each_entry(buf, &mine->buffers, list) {
+		dev_dbg(mine->dev, "buffer addr %8.8lx\n", (long)buf->addr);
+		if ((long)buf->addr != addr)
+			continue;
+
+		dev_dbg(mine->dev, "found it!\n");
+		list_del(&buf->list);
+		spin_unlock_irqrestore(&mine->lock, flags);
+		dma_free_attrs(mine->dev, buf->bytes, buf->addr, buf->iova,
+#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 8, 0)
+			       &buf->attrs
+#else
+			       buf->attrs
+#endif
+		    );
+		kfree(buf);
+		return;
+	}
+	dev_warn(mine->dev, "Can't find mem object %8.8llx\n", addr);
+	spin_unlock_irqrestore(&mine->lock, flags);
+}
+
+/**
+ * \brief Convert a host virtual address to a CSS virtual address and
+ * \update the MMU.
+ */
+u32 shared_memory_map(int ssid, int mmid, u64 addr)
+{
+	struct wrapper_base *mine = get_mem_sub_system(mmid);
+	struct my_css_memory_buffer_item *buf = NULL;
+	unsigned long flags;
+
+	if ((void *)addr == &alloc_cookie)
+		return 0;
+
+	spin_lock_irqsave(&mine->lock, flags);
+	list_for_each_entry(buf, &mine->buffers, list) {
+		dev_dbg(mine->dev, "%s %8.8lx\n", __func__, (long)buf->addr);
+		if ((long)buf->addr != addr)
+			continue;
+
+		dev_dbg(mine->dev, "mapped!!\n");
+		spin_unlock_irqrestore(&mine->lock, flags);
+		return buf->iova;
+	}
+	dev_err(mine->dev, "Can't find mapped object %8.8llx\n", addr);
+	spin_unlock_irqrestore(&mine->lock, flags);
+	return 0;
+}
+
+/**
+ * \brief Free a CSS virtual address and update the MMU.
+ */
+void shared_memory_unmap(int ssid, int mmid, u32 addr)
+{
+}
+
+/**
+ * \brief Store a byte into (DDR) shared memory space using a host
+ * \virtual address
+ */
+void shared_memory_store_8(int mmid, u64 addr, u8 data)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%x\n",
+		__func__, addr, data);
+
+	*((u8 *) addr) = data;
+	/*Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u8));
+}
+
+/**
+ * \brief Store a 16-bit word into (DDR) shared memory space using a host
+ * \virtual address
+ */
+void shared_memory_store_16(int mmid, u64 addr, u16 data)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%x\n",
+		__func__, addr, data);
+
+	*((u16 *) addr) = data;
+	/*Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u16));
+}
+
+/**
+ * \brief Store a 32-bit word into (DDR) shared memory space using a host
+ * \virtual address
+ */
+void shared_memory_store_32(int mmid, u64 addr, u32 data)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%x\n",
+		__func__, addr, data);
+
+	*((u32 *) addr) = data;
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u32));
+}
+
+/**
+ * \brief Store a number of bytes into (DDR) shared memory space using a host
+ * \virtual address
+ */
+void shared_memory_store(int mmid, u64 addr, const void *data, size_t bytes)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%lx bytes = 0x%lx\n", __func__,
+		(unsigned long)addr, bytes);
+
+	if (!data) {
+		dev_err(get_mem_sub_system(mmid)->dev,
+			"%s: data ptr is null\n", __func__);
+	} else {
+		const u8 *pdata = data;
+		u8 *paddr = (u8 *) addr;
+		size_t i = 0;
+
+		for (; i < bytes; ++i)
+			*paddr++ = *pdata++;
+
+		/* Invalidate the cache lines to flush the content to ddr. */
+		clflush_cache_range((void *)addr, bytes);
+	}
+}
+
+/**
+ * \brief Set a number of bytes of (DDR) shared memory space to 0 using a host
+ * \virtual address
+ */
+void shared_memory_zero(int mmid, u64 addr, size_t bytes)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx data = 0x%lx\n",
+		__func__, addr, bytes);
+
+	memset((void *)addr, 0, bytes);
+	clflush_cache_range((void *)addr, bytes);
+}
+
+/**
+ * \brief Load a byte from (DDR) shared memory space using a host
+ * \virtual address
+ */
+u8 shared_memory_load_8(int mmid, u64 addr)
+{
+	u8 data = 0;
+
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx\n", __func__, addr);
+
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u8));
+	data = *(u8 *) addr;
+	return data;
+}
+
+/**
+ * \brief Load a 16-bit word from (DDR) shared memory space using a host
+ * \virtual address
+ */
+u16 shared_memory_load_16(int mmid, u64 addr)
+{
+	u16 data = 0;
+
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx\n", __func__, addr);
+
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u16));
+	data = *(u16 *) addr;
+	return data;
+}
+
+/**
+ * \brief Load a 32-bit word from (DDR) shared memory space using a host
+ * \virtual address
+ */
+u32 shared_memory_load_32(int mmid, u64 addr)
+{
+	u32 data = 0;
+
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%llx\n", __func__, addr);
+
+	/* Invalidate the cache lines to flush the content to ddr. */
+	clflush_cache_range((void *)addr, sizeof(u32));
+	data = *(u32 *) addr;
+	return data;
+}
+
+/**
+ * \brief Load a number of bytes from (DDR) shared memory space using a host
+ * \virtual address
+ */
+void shared_memory_load(int mmid, u64 addr, void *data, size_t bytes)
+{
+	dev_dbg(get_mem_sub_system(mmid)->dev,
+		"access: %s: Enter addr = 0x%lx bytes = 0x%lx\n", __func__,
+		(unsigned long)addr, bytes);
+
+	if (!data) {
+		dev_err(get_mem_sub_system(mmid)->dev,
+			"%s: data ptr is null\n", __func__);
+
+	} else {
+		u8 *pdata = data;
+		u8 *paddr = (u8 *) addr;
+		size_t i = 0;
+
+		/* Invalidate the cache lines to flush the content to ddr. */
+		clflush_cache_range((void *)addr, bytes);
+		for (; i < bytes; ++i)
+			*pdata++ = *paddr++;
+	}
+}
+
+static int init_wrapper(struct wrapper_base *sys)
+{
+	INIT_LIST_HEAD(&sys->buffers);
+	spin_lock_init(&sys->lock);
+	return 0;
+}
+
+/*
+ * Wrapper driver set base address for library use
+ */
+void ipu_wrapper_init(int mmid, struct device *dev, void __iomem *base)
+{
+	struct wrapper_base *sys = get_mem_sub_system(mmid);
+
+	init_wrapper(sys);
+	sys->dev = dev;
+	sys->sys_base = base;
+}
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h
index dbf1cf9..106d1ce 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h
@@ -71,6 +71,13 @@ typedef enum ia_css_terminal_type {
  * Dimensions of the data objects. Note that a C-style
  * data order is assumed. Data stored by row.
  */
+<<<<<<< HEAD
+=======
+/* A strange problem with hivecc compiler which is described
+ * here https://icggerrit.ir.intel.com/#/c/51630/1 forces this
+ * enum to be explicitly initialized for the moment
+ */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 typedef enum ia_css_dimension {
 	/**< The number of columns, i.e. the size of the row */
 	IA_CSS_COL_DIMENSION = 0,
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h
index 5e47fe7..d798e78 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h
@@ -61,7 +61,10 @@ struct ia_css_isys_resolution_comm {
  * @out_buf_id: Points to output pin buffer - buffer identifier
  * @addr: Points to output pin buffer - CSS Virtual Address
  * @compress: Request frame compression (1), or  not (0)
+<<<<<<< HEAD
  * This must be the same as ia_css_isys_output_pin_info_comm::reserve_compression
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 struct ia_css_isys_output_pin_payload_comm {
 	aligned_uint64(ia_css_return_token, out_buf_id);
@@ -273,8 +276,11 @@ struct ia_css_isys_frame_buff_set_comm {
 	aligned_struct(struct ia_css_isys_param_pin_comm, process_group_light);
 	aligned_uint8(unsigned int, send_irq_sof);
 	aligned_uint8(unsigned int, send_irq_eof);
+<<<<<<< HEAD
 	aligned_uint8(unsigned int, send_irq_capture_ack);
 	aligned_uint8(unsigned int, send_irq_capture_done);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	aligned_uint8(unsigned int, send_resp_sof);
 	aligned_uint8(unsigned int, send_resp_eof);
 	aligned_uint8(unsigned int, frame_counter);
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi.h
index abbc8b8..f014830 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi.h
@@ -15,6 +15,14 @@
 #ifndef __IA_CSS_ISYSAPI_H
 #define __IA_CSS_ISYSAPI_H
 
+<<<<<<< HEAD
+=======
+/**
+ * errno.h specified error codes to be used
+ * URL:http://man7.org/linux/man-pages/man3/errno.3.html>
+ */
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* The following is needed for the function arguments */
 #include "ia_css_isysapi_types.h"
@@ -40,6 +48,7 @@ extern int ia_css_isys_context_create(
 	HANDLE * context,
 	const struct ia_css_isys_device_cfg_data *config
 );
+<<<<<<< HEAD
 extern int ia_css_isys_context_store_dmem(
 	const HANDLE *context,
 	const struct ia_css_isys_device_cfg_data *config
@@ -47,6 +56,8 @@ extern int ia_css_isys_context_store_dmem(
 extern bool ia_css_isys_ab_spc_ready(
 	HANDLE *context
 );
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 extern int ia_css_isys_device_open(
 	const struct ia_css_isys_device_cfg_data *config
 );
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h
index c002b33..242aadda9 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h
@@ -110,4 +110,16 @@ struct ia_css_proxy_write_region_description ipu4p_b0_reg_write_desc[N_IPU4P_B0_
 
 #endif /*defined(IPU4P_B0_PROXY_INT)*/
 
+<<<<<<< HEAD
+=======
+/*
+ */
+
+
+
+/*
+ */
+
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* __IA_CSS_ISYSAPI_PROXY_REGION_DEFS_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_types.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_types.h
index 481a7dc..f8fc11b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_types.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/interface/ia_css_isysapi_types.h
@@ -71,7 +71,10 @@ struct ia_css_isys_device_cfg_data {
 	struct ia_css_isys_buffer_partition buffer_partition;
 	struct ia_css_driver_proxy_config driver_proxy;
 	bool secure;
+<<<<<<< HEAD
 	unsigned vtl0_addr_mask; /* only applicable in 'secure' case */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 /**
@@ -89,7 +92,10 @@ struct ia_css_isys_resolution {
  * @out_buf_id: Points to output pin buffer - buffer identifier
  * @addr: Points to output pin buffer - CSS Virtual Address
  * @compressed: Request frame compression (1), or  not (0)
+<<<<<<< HEAD
  * This must be the same as ia_css_isys_output_pin_info::reserve_compression
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 struct ia_css_isys_output_pin_payload {
 	ia_css_return_token out_buf_id;
@@ -273,8 +279,11 @@ struct ia_css_isys_frame_buff_set {
 	struct ia_css_isys_param_pin process_group_light;
 	unsigned int send_irq_sof;
 	unsigned int send_irq_eof;
+<<<<<<< HEAD
 	unsigned int send_irq_capture_ack;
 	unsigned int send_irq_capture_done;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	unsigned int send_resp_sof;
 	unsigned int send_resp_eof;
 	uint8_t      frame_counter;
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/isysapi.mk b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/isysapi.mk
index 0911959..982f173 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/isysapi.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/isysapi.mk
@@ -14,8 +14,11 @@
 #
 # MODULE is ISYSAPI
 
+<<<<<<< HEAD
 include $(MODULES_DIR)/config/isys/subsystem_$(IPU_SYSVER).mk
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 ISYSAPI_DIR=$${MODULES_DIR}/isysapi
 
 ISYSAPI_INTERFACE=$(ISYSAPI_DIR)/interface
@@ -62,10 +65,13 @@ ISYSAPI_FW_CPPFLAGS += -I$(HIVESDK)/include/ipu/dai
 ISYSAPI_FW_CPPFLAGS += -I$(HIVESDK)/include/ipu
 
 ISYSAPI_FW_CPPFLAGS += -DWA_HSD1805168877=$(WA_HSD1805168877)
+<<<<<<< HEAD
 ISYSAPI_FW_CPPFLAGS += -DWA_DISABLE_IBUF_PREQUEUE=$(WA_DISABLE_IBUF_PREQUEUE)
 
 ISYSAPI_HOST_CPPFLAGS += -DREGMEM_OFFSET=$(REGMEM_OFFSET)
 ISYSAPI_HOST_CPPFLAGS += -DWA_DISABLE_IBUF_PREQUEUE=$(WA_DISABLE_IBUF_PREQUEUE)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ifeq ($(ISYS_HAS_DUAL_CMD_CTX_SUPPORT), 1)
 ISYSAPI_HOST_CPPFLAGS += -DHAS_DUAL_CMD_CTX_SUPPORT=$(ISYS_HAS_DUAL_CMD_CTX_SUPPORT)
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_private.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_private.c
index ec92f14..b8653ec 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_private.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_private.c
@@ -601,10 +601,13 @@ STORAGE_CLASS_INLINE void frame_buff_set_host_to_css(
 			frame_buff_set_host->send_irq_sof ? 1 : 0;
 	frame_buff_set_css->send_irq_eof =
 			frame_buff_set_host->send_irq_eof ? 1 : 0;
+<<<<<<< HEAD
 	frame_buff_set_css->send_irq_capture_done =
 			(uint8_t)frame_buff_set_host->send_irq_capture_done;
 	frame_buff_set_css->send_irq_capture_ack =
 			frame_buff_set_host->send_irq_capture_ack ? 1 : 0;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	frame_buff_set_css->send_resp_sof =
 			frame_buff_set_host->send_irq_sof ?
 				1 : frame_buff_set_host->send_resp_sof;
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_public.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_public.c
index 960f646..72c12ca 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_public.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/isysapi/src/ia_css_isys_public.c
@@ -218,9 +218,12 @@ static int isys_context_create(
 	/* parameters size */
 	sys.specific_size = sizeof(isys_fw_cfg);
 	sys.secure = config->secure;
+<<<<<<< HEAD
 	if (config->secure) {
 		sys.vtl0_addr_mask = config->vtl0_addr_mask;
 	}
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	IA_CSS_TRACE_0(ISYSAPI, VERBOSE,
 		"isys_context_create || call ia_css_syscom_open()\n");
@@ -294,6 +297,7 @@ int ia_css_isys_context_create(
 	return isys_context_create(context, config);
 }
 
+<<<<<<< HEAD
 /* push context information to DMEM for FW to access */
 int ia_css_isys_context_store_dmem(
 	const HANDLE * context,
@@ -312,6 +316,8 @@ bool ia_css_isys_ab_spc_ready(
 	return ia_css_syscom_is_ab_spc_ready(ctx->sys);
 }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ia_css_isys_device_open(
 	const struct ia_css_isys_device_cfg_data *config)
 {
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/regmem/interface/regmem_access.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/regmem/interface/regmem_access.h
index d4576af..d8a15cb 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/regmem/interface/regmem_access.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/regmem/interface/regmem_access.h
@@ -28,6 +28,7 @@ enum regmem_id {
 	SYSCOM_COMMAND_REG	= 3,
 	/* Store interrupt status - updated by SP */
 	SYSCOM_IRQ_REG		= 4,
+<<<<<<< HEAD
 	/* Store VTL0_ADDR_MASK in trusted secure regision - provided by host.*/
 	SYSCOM_VTL0_ADDR_MASK	= 5,
 #if HAS_DUAL_CMD_CTX_SUPPORT
@@ -51,6 +52,12 @@ enum regmem_id {
 #define SYSCOM_IRQ_VTL1_MASK 0x2
 #endif
 
+=======
+	/* first syscom queue pointer register */
+	SYSCOM_QPR_BASE_REG	= 5
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 STORAGE_CLASS_INLINE unsigned int
 regmem_load_32(unsigned int mem_address, unsigned int reg, unsigned int ssid);
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/assert_support.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/assert_support.h
index f904a49..2b36d84 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/assert_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/assert_support.h
@@ -39,6 +39,12 @@
  * should not depend on assert to function (actually the assert
  * could be disabled in a release build) it was decided to
  * disable the assert for KW scans (by defining NDEBUG)
+<<<<<<< HEAD
+=======
+ * see also:
+ * http://www.klocwork.com/products/documentation/current/
+ * Tuning_C/C%2B%2B_analysis#Assertions
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 #define NDEBUG
 #endif /* __KLOCWORK__ */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/math_support.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/math_support.h
index 633f86f..53efe9b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/math_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/support/math_support.h
@@ -44,7 +44,10 @@
 #define IS_ODD(a) ((a) & 0x1)
 #define IS_EVEN(a) (!IS_ODD(a))
 #define IS_POWER2(a) (!((a)&((a)-1)))
+<<<<<<< HEAD
 #define IS_MASK_BITS_SET(a, b)	((a & b) != 0)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*To Find next power of 2 number from x */
 #define bit2(x)            ((x)      | ((x) >> 1))
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom.h
index 5426d6d..c7d7eef 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom.h
@@ -206,6 +206,7 @@ ia_css_syscom_recv_port_transfer(
 	void *token
 );
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /**
  * ia_css_syscom_store_dmem() - store subsystem context information in DMEM
@@ -244,4 +245,6 @@ ia_css_syscom_is_ab_spc_ready(
 );
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* __IA_CSS_SYSCOM_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom_config.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom_config.h
index 8c827c2..0f2b977 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom_config.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/interface/ia_css_syscom_config.h
@@ -91,7 +91,10 @@ struct ia_css_syscom_config {
 	 * if false, non-secure syscom
 	 */
 	bool secure;
+<<<<<<< HEAD
 	unsigned int vtl0_addr_mask; /* only applicable in 'secure' case */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 #endif /* __IA_CSS_SYSCOM_CONFIG_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom.c
index cdf9df0..793790a 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom.c
@@ -349,7 +349,10 @@ ia_css_syscom_open(
 	ia_css_cpu_mem_cache_flush((void *)HOST_ADDRESS(ctx->config_host_addr),
 				    sizeof(struct ia_css_syscom_config_fw));
 
+<<<<<<< HEAD
 #if !HAS_DUAL_CMD_CTX_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* store syscom uninitialized state */
 	IA_CSS_TRACE_3(SYSCOM, INFO, "ia_css_syscom_open store STATE_REG (%#x) @ dmem_addr %#x ssid %d\n",
 		       SYSCOM_STATE_UNINIT, ctx->cell_dmem_addr, cfg->ssid);
@@ -365,6 +368,12 @@ ia_css_syscom_open(
 		       ctx->config_vied_addr, ctx->cell_dmem_addr, cfg->ssid);
 	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_CONFIG_REG,
 			ctx->config_vied_addr, cfg->ssid);
+<<<<<<< HEAD
+=======
+#if HAS_DUAL_CMD_CTX_SUPPORT
+	/* clear IRQ status */
+	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_IRQ_REG, 0x0, cfg->ssid);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 	/* Indicate if ctx is created for secure stream purpose */
@@ -563,6 +572,7 @@ ia_css_syscom_recv_port_transfer(
 
 	return recv_port_transfer(ctx->recv_port + port, token);
 }
+<<<<<<< HEAD
 
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /*
@@ -648,3 +658,5 @@ ia_css_syscom_is_ab_spc_ready(
 	return (value == AB_SPC_READY);
 }
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom_config_fw.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom_config_fw.h
index 0cacd5a..9bb3209 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom_config_fw.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/src/ia_css_syscom_config_fw.h
@@ -33,6 +33,7 @@ enum {
 	SYSCOM_COMMAND_INACTIVE = 0x57A7F001
 };
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 enum {
 	/* Program load or explicit host setting should init to this */
@@ -51,6 +52,8 @@ enum {
 };
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* firmware config: data that sent from the host to SP via DDR */
 /* Cell copies data into a context */
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/syscom.mk b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/syscom.mk
index 8d36b89..fabb815 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/syscom.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600/syscom/syscom.mk
@@ -22,7 +22,10 @@ SYSCOM_SOURCES1=$(SYSCOM_DIR)/src
 SYSCOM_HOST_FILES += $(SYSCOM_SOURCES1)/ia_css_syscom.c
 
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_INTERFACE)
+<<<<<<< HEAD
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_SOURCES1)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 SYSCOM_HOST_CPPFLAGS += -I$${MODULES_DIR}/devices
 ifdef REGMEM_SECURE_OFFSET
 SYSCOM_HOST_CPPFLAGS += -DREGMEM_SECURE_OFFSET=$(REGMEM_SECURE_OFFSET)
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/Makefile b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/Makefile
index b1549d4..f108242 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/Makefile
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/Makefile
@@ -20,13 +20,21 @@ include $(srcpath)/$(src)/../Makefile.ipu4psys_inc
 
 SSID        = 0
 MMID        = 0
+<<<<<<< HEAD
+=======
+IPU_SYSVER  = bxtB0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 IPU_PSYSLIB_ROOT_REL = lib
 IPU_PSYSLIB_ROOT = $(srcpath)/$(src)/$(IPU_PSYSLIB_ROOT_REL)
 
 ccflags-y += -I$(srcpath)/$(src)/../../../
 ccflags-y += -I$(srcpath)/$(src)/../../
+<<<<<<< HEAD
 ccflags-y += -DHAS_DUAL_CMD_CTX_SUPPORT=0 -DHAS_LATE_BINDING_SUPPORT=0
+=======
+ccflags-y += -DHAS_DUAL_CMD_CTX_SUPPORT=0 -DHAS_LATE_BINDING_SUPPORT=0 -DIPU_PSYS_LEGACY
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 IPU_PSYSLIB_SRC += libcsspsys2600.o
 
@@ -42,9 +50,16 @@ HOST_DEFINES += -DFIRMWARE_RELEASE_VERSION
 HOST_DEFINES += -DPSYS_SERVER_ON_SPC
 HOST_DEFINES += -DAPI_SPLIT_START_STATE_UPDATE
 
+<<<<<<< HEAD
 intel-ipu4-psys-csslib-objs := ../../../ipu-wrapper.o \
 			$(IPU_PSYSLIB_SRC)
 
 obj-$(CONFIG_VIDEO_INTEL_IPU)	+= intel-ipu4-psys-csslib.o
+=======
+lib2600psys-mod-$(IPU_SYSVER)-objs := ../../../ipu-wrapper.o \
+	$(IPU_PSYSLIB_SRC)
+
+obj-$(CONFIG_VIDEO_INTEL_IPU)	+= lib2600psys-mod-$(IPU_SYSVER).o
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 ccflags-y += $(IPU_PSYSLIB_INC) $(HOST_DEFINES) -fno-common -v
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/DSS_V2_program_group/ia_css_fw_pkg_release.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/DSS_V2_program_group/ia_css_fw_pkg_release.h
index 37a8016..739e0f6 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/DSS_V2_program_group/ia_css_fw_pkg_release.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/DSS_V2_program_group/ia_css_fw_pkg_release.h
@@ -11,4 +11,8 @@
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 */
+<<<<<<< HEAD
 #define IA_CSS_FW_PKG_RELEASE  0x20191115
+=======
+#define IA_CSS_FW_PKG_RELEASE  0x20180412
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/config/psys/subsystem_bxtB0.mk b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/config/psys/subsystem_bxtB0.mk
index 2f60853..741a539 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/config/psys/subsystem_bxtB0.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/config/psys/subsystem_bxtB0.mk
@@ -48,6 +48,7 @@ HAS_ISP3			= 1
 
 # Specification for Psys server's fixed globals' locations
 REGMEM_OFFSET				= 0	# Starting from 0
+<<<<<<< HEAD
 REGMEM_SIZE				= 18
 REGMEM_WORD_BYTES			= 4
 REGMEM_SIZE_BYTES			= 72
@@ -56,6 +57,16 @@ GPC_ISP_PERF_DATA_SIZE_BYTES		= 80
 FW_LOAD_NO_OF_REQUEST_OFFSET		= 152	# Taken from GPC_ISP_PERF_DATA_OFFSET + GPC_ISP_PERF_DATA_SIZE_BYTES
 FW_LOAD_NO_OF_REQUEST_SIZE_BYTES	= 4
 DISPATCHER_SCRATCH_SPACE_OFFSET		= 156	# Taken from FW_LOAD_NO_OF_REQUEST_OFFSET + FW_LOAD_NO_OF_REQUEST_SIZE_BYTES
+=======
+REGMEM_SIZE				= 17
+REGMEM_WORD_BYTES			= 4
+REGMEM_SIZE_BYTES			= 68
+GPC_ISP_PERF_DATA_OFFSET		= 68	# Taken from REGMEM_OFFSET + REGMEM_SIZE_BYTES
+GPC_ISP_PERF_DATA_SIZE_BYTES		= 80
+FW_LOAD_NO_OF_REQUEST_OFFSET		= 148	# Taken from GPC_ISP_PERF_DATA_OFFSET + GPC_ISP_PERF_DATA_SIZE_BYTES
+FW_LOAD_NO_OF_REQUEST_SIZE_BYTES	= 4
+DISPATCHER_SCRATCH_SPACE_OFFSET		= 152	# Taken from FW_LOAD_NO_OF_REQUEST_OFFSET + FW_LOAD_NO_OF_REQUEST_SIZE_BYTES
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 # TODO  use version naming scheme "v#" to decouple
 # IPU_SYSVER from version.
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h
index dbf1cf9..106d1ce 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h
@@ -71,6 +71,13 @@ typedef enum ia_css_terminal_type {
  * Dimensions of the data objects. Note that a C-style
  * data order is assumed. Data stored by row.
  */
+<<<<<<< HEAD
+=======
+/* A strange problem with hivecc compiler which is described
+ * here https://icggerrit.ir.intel.com/#/c/51630/1 forces this
+ * enum to be explicitly initialized for the moment
+ */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 typedef enum ia_css_dimension {
 	/**< The number of columns, i.e. the size of the row */
 	IA_CSS_COL_DIMENSION = 0,
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/psys_server.mk b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/psys_server.mk
index c4462c9..e3abbfd 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/psys_server.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/psys_server.mk
@@ -63,7 +63,10 @@ PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/$(IPU_SYSVER)
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/$(PSYS_SERVER_VERSION)
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/loader/$(PSYS_SERVER_LOADER_VERSION)
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/access_blocker/$(PSYS_ACCESS_BLOCKER_VERSION)
+<<<<<<< HEAD
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/access_blocker/src
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 PSYS_SERVER_FW_CPPFLAGS += -DSSID=$(SSID)
 PSYS_SERVER_FW_CPPFLAGS += -DMMID=$(MMID)
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c
index 6f8aea7..a8010dd 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c
@@ -27,6 +27,7 @@
 #include "cpu_mem_support.h"
 #include "ia_css_bxt_spctrl_trace.h"
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 #define MAX_CLIENT_PGS 8 /* same as test_params.h */
 struct ia_css_process_group_context {
@@ -85,6 +86,8 @@ int ia_css_process_group_store(ia_css_process_group_t *process_group, bool secur
 }
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ia_css_process_group_on_create(
 	ia_css_process_group_t			*process_group,
 	const ia_css_program_group_manifest_t	*program_group_manifest,
@@ -160,7 +163,11 @@ int ia_css_process_group_exec_cmd(
 			"ia_css_process_group_exec_cmd(): IA_CSS_PROCESS_GROUP_CMD_DISOWN:\n");
 		verifexit(state == IA_CSS_PROCESS_GROUP_STARTED);
 
+<<<<<<< HEAD
 		cmd_queue_full = ia_css_is_psys_cmd_queue_full(ia_css_process_group_get_context(process_group),
+=======
+		cmd_queue_full = ia_css_is_psys_cmd_queue_full(psys_syscom,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 					IA_CSS_PSYS_CMD_QUEUE_COMMAND_ID);
 		retval = EBUSY;
 		verifexit(cmd_queue_full == false);
@@ -171,7 +178,11 @@ int ia_css_process_group_exec_cmd(
 
 		verifexit(ia_css_process_group_print(process_group, NULL) == 0);
 
+<<<<<<< HEAD
 		retval = ia_css_psys_cmd_queue_send(ia_css_process_group_get_context(process_group),
+=======
+		retval = ia_css_psys_cmd_queue_send(psys_syscom,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 				IA_CSS_PSYS_CMD_QUEUE_COMMAND_ID, &psys_cmd);
 		verifexit(retval > 0);
 		break;
@@ -180,7 +191,11 @@ int ia_css_process_group_exec_cmd(
 		IA_CSS_TRACE_0(BXT_SPCTRL, INFO,
 			"ia_css_process_group_exec_cmd(): IA_CSS_PROCESS_GROUP_CMD_STOP:\n");
 
+<<<<<<< HEAD
 		cmd_queue_full = ia_css_is_psys_cmd_queue_full(ia_css_process_group_get_context(process_group),
+=======
+		cmd_queue_full = ia_css_is_psys_cmd_queue_full(psys_syscom,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 					IA_CSS_PSYS_CMD_QUEUE_COMMAND_ID);
 		retval = EBUSY;
 		verifexit(cmd_queue_full == false);
@@ -192,7 +207,11 @@ int ia_css_process_group_exec_cmd(
 		queue_id = ia_css_process_group_get_base_queue_id(process_group);
 		verifexit(queue_id < IA_CSS_N_PSYS_CMD_QUEUE_ID);
 
+<<<<<<< HEAD
 		retval = ia_css_psys_cmd_queue_send(ia_css_process_group_get_context(process_group),
+=======
+		retval = ia_css_psys_cmd_queue_send(psys_syscom,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 				queue_id, &psys_cmd);
 		verifexit(retval > 0);
 		break;
@@ -206,7 +225,11 @@ int ia_css_process_group_exec_cmd(
 		 */
 		verifexit(state == IA_CSS_PROCESS_GROUP_BLOCKED);
 
+<<<<<<< HEAD
 		cmd_queue_full = ia_css_is_psys_cmd_queue_full(ia_css_process_group_get_context(process_group),
+=======
+		cmd_queue_full = ia_css_is_psys_cmd_queue_full(psys_syscom,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 					IA_CSS_PSYS_CMD_QUEUE_COMMAND_ID);
 		retval = EBUSY;
 		verifexit(cmd_queue_full == false);
@@ -215,7 +238,11 @@ int ia_css_process_group_exec_cmd(
 		psys_cmd.msg = 0;
 		psys_cmd.context_handle = process_group->ipu_virtual_address;
 
+<<<<<<< HEAD
 		retval = ia_css_psys_cmd_queue_send(ia_css_process_group_get_context(process_group),
+=======
+		retval = ia_css_psys_cmd_queue_send(psys_syscom,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 			IA_CSS_PSYS_CMD_QUEUE_DEVICE_ID, &psys_cmd);
 		verifexit(retval > 0);
 		break;
@@ -256,7 +283,11 @@ STORAGE_CLASS_INLINE int enqueue_buffer_set_cmd(
 		queue_offset;
 	verifexit(queue_id < IA_CSS_N_PSYS_CMD_QUEUE_ID);
 
+<<<<<<< HEAD
 	cmd_queue_full = ia_css_is_psys_cmd_queue_full(ia_css_process_group_get_context(process_group), queue_id);
+=======
+	cmd_queue_full = ia_css_is_psys_cmd_queue_full(psys_syscom, queue_id);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	retval = EBUSY;
 	verifexit(cmd_queue_full == false);
 
@@ -265,7 +296,11 @@ STORAGE_CLASS_INLINE int enqueue_buffer_set_cmd(
 	psys_cmd.context_handle =
 		ia_css_buffer_set_get_ipu_address(buffer_set);
 
+<<<<<<< HEAD
 	retval = ia_css_psys_cmd_queue_send(ia_css_process_group_get_context(process_group), queue_id, &psys_cmd);
+=======
+	retval = ia_css_psys_cmd_queue_send(psys_syscom, queue_id, &psys_cmd);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	verifexit(retval > 0);
 
 	retval = 0;
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h
index f08a057..3918c58 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h
@@ -336,7 +336,11 @@ int ia_css_frame_descriptor_print(
 	if (IA_CSS_N_DATA_DIMENSION > 2) {
 		for (i = 0; i < (int)IA_CSS_N_DATA_DIMENSION - 2; i++) {
 			IA_CSS_TRACE_1(PSYSAPI_DATA, INFO,
+<<<<<<< HEAD
 				"\t%4d,\n", frame_descriptor->stride[i]);
+=======
+			       "\t%4d,\n", frame_descriptor->stride[i]);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		}
 	}
 	IA_CSS_TRACE_1(PSYSAPI_DATA, INFO,
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h
index dc8fa531..9132738 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h
@@ -105,10 +105,16 @@ extern struct ia_css_syscom_config *ia_css_psys_specify(void);
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /*! Create the syscom creation descriptor for secure stream
 
+<<<<<<< HEAD
  @param	vtl0_addr_mask[in]	VTL0 address mask that will be stored in 'secure' ctx
  @return NULL on error
  */
 extern struct ia_css_syscom_config *ia_css_psys_specify_secure(unsigned int vtl0_addr_mask);
+=======
+ @return NULL on error
+ */
+extern struct ia_css_syscom_config *ia_css_psys_specify_secure(void);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 /*! Compute the size of storage required for allocating the Psys syscom object
@@ -137,6 +143,7 @@ extern struct ia_css_syscom_context *ia_css_psys_context_create(
 	const struct ia_css_psys_buffer_s *buffer,
 	struct ia_css_syscom_config *config);
 
+<<<<<<< HEAD
 /*! Store the parameters of the Psys syscom object in DMEM, so
     they can be communicated with FW. This step needs to be invoked
     after SPC starts in ia_css_psys_open(), so SPC DMEM access blocker
@@ -150,6 +157,8 @@ extern int ia_css_psys_context_store_dmem(
 	struct ia_css_syscom_context *context,
 	struct ia_css_syscom_config *config);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /*! Start PSYS Server. Psys syscom object must have been created already.
     Target for VTIO usage where multiple syscom objects need to be
     created first before this API is invoked.
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c
index c3ed98a..7937e5e 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c
@@ -16,7 +16,10 @@
 #include "ia_css_psys_device.h"
 #include "ia_css_psys_device_trace.h"
 #include "ia_css_psys_init.h"
+<<<<<<< HEAD
 #include "regmem_access.h"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #include <error_support.h>
 #include <print_support.h>
@@ -98,7 +101,10 @@ static void set_syscom_config(struct ia_css_syscom_config *config)
 	}
 	config->input = ia_css_psys_cmd_queue_cfg;
 	config->output = ia_css_psys_event_queue_cfg;
+<<<<<<< HEAD
 	config->vtl0_addr_mask = 0;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 struct ia_css_syscom_config *ia_css_psys_specify(void)
@@ -113,6 +119,7 @@ struct ia_css_syscom_config *ia_css_psys_specify(void)
 }
 
 #if HAS_DUAL_CMD_CTX_SUPPORT
+<<<<<<< HEAD
 struct ia_css_syscom_config *ia_css_psys_specify_secure(unsigned int vtl0_addr_mask)
 {
 	struct ia_css_syscom_config *config = &psys_syscom_config_secure;
@@ -121,6 +128,15 @@ struct ia_css_syscom_config *ia_css_psys_specify_secure(unsigned int vtl0_addr_m
 	set_syscom_config(config);
 	config->secure = true;
 	config->vtl0_addr_mask = vtl0_addr_mask;
+=======
+struct ia_css_syscom_config *ia_css_psys_specify_secure(void)
+{
+	struct ia_css_syscom_config *config = &psys_syscom_config_secure;
+
+	IA_CSS_TRACE_0(PSYSAPI_DEVICE, INFO, "ia_css_psys_specify_secure(): enter:\n");
+	set_syscom_config(config);
+	config->secure = true;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return config;
 }
 #endif
@@ -182,6 +198,7 @@ struct ia_css_syscom_context *ia_css_psys_context_create(
 {
 	return psys_context_create(buffer, config);
 }
+<<<<<<< HEAD
 
 /* push context information to DMEM for FW to access */
 int ia_css_psys_context_store_dmem(
@@ -190,6 +207,8 @@ int ia_css_psys_context_store_dmem(
 {
 	return ia_css_syscom_store_dmem(context, config->ssid, config->vtl0_addr_mask);
 }
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 /* Internal function to start psys server */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h
index 530f93e..e599074 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h
@@ -22,8 +22,13 @@
 #define N_UINT64_IN_PROCESS_GROUP_STRUCT	2
 #define N_UINT32_IN_PROCESS_GROUP_STRUCT	5
 #define N_UINT16_IN_PROCESS_GROUP_STRUCT	5
+<<<<<<< HEAD
 #define N_UINT8_IN_PROCESS_GROUP_STRUCT		7
 #define N_PADDING_UINT8_IN_PROCESS_GROUP_STRUCT	3
+=======
+#define N_UINT8_IN_PROCESS_GROUP_STRUCT		6
+#define N_PADDING_UINT8_IN_PROCESS_GROUP_STRUCT	4
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define SIZE_OF_PROCESS_GROUP_STRUCT_BITS \
 	(IA_CSS_RBM_BITS \
@@ -88,8 +93,11 @@ struct ia_css_process_group_s {
 	uint8_t base_queue_id;
 	/**< Number of dedicated queues used */
 	uint8_t num_queues;
+<<<<<<< HEAD
 	/**< Mask the send_pg_done IRQ */
 	uint8_t mask_irq;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/**< Padding for 64bit alignment */
 	uint8_t padding[N_PADDING_UINT8_IN_PROCESS_GROUP_STRUCT];
 };
@@ -163,6 +171,7 @@ extern int ia_css_enqueue_param_buffer_set(
 	ia_css_process_group_t				*process_group,
 	ia_css_buffer_set_t				*buffer_set);
 
+<<<<<<< HEAD
 /*! Need to store the 'secure' mode for each PG for FW test app only
  *
  * @param	process_group[in]		process group object
@@ -175,4 +184,6 @@ extern int ia_css_process_group_store(
 	bool						secure);
 
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* __IA_CSS_PSYS_PROCESS_GROUP_CMD_IMPL_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c
index f9e060f..b97a42f 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c
@@ -15,7 +15,11 @@
 #include "ia_css_psys_process.h"
 #include "ia_css_psys_dynamic_storage_class.h"
 #include "ia_css_psys_process_private_types.h"
+<<<<<<< HEAD
 #include <misc_support.h>	/* for NOT_USED */
+=======
+#include <misc_support.h>
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*
  * Functions to possibly inline
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c
index be1ef96..64bcfcf 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c
@@ -1059,6 +1059,7 @@ void ia_css_program_manifest_init(
    supported in the firmware
   */
 #if !defined(__HIVECC)
+<<<<<<< HEAD
 
 #if defined(_MSC_VER)
 /* WA for a visual studio compiler bug, refer to
@@ -1067,6 +1068,8 @@ void ia_css_program_manifest_init(
 #pragma optimize("", off)
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ia_css_program_manifest_print(
 	const ia_css_program_manifest_t *manifest,
 	void *fid)
@@ -1231,11 +1234,14 @@ int ia_css_program_manifest_print(
 	}
 	return retval;
 }
+<<<<<<< HEAD
 
 #if defined(_MSC_VER)
 /* WA for a visual studio compiler bug */
 #pragma optimize("", off)
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/regmem/interface/regmem_access.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/regmem/interface/regmem_access.h
index d4576af..d8a15cb 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/regmem/interface/regmem_access.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/regmem/interface/regmem_access.h
@@ -28,6 +28,7 @@ enum regmem_id {
 	SYSCOM_COMMAND_REG	= 3,
 	/* Store interrupt status - updated by SP */
 	SYSCOM_IRQ_REG		= 4,
+<<<<<<< HEAD
 	/* Store VTL0_ADDR_MASK in trusted secure regision - provided by host.*/
 	SYSCOM_VTL0_ADDR_MASK	= 5,
 #if HAS_DUAL_CMD_CTX_SUPPORT
@@ -51,6 +52,12 @@ enum regmem_id {
 #define SYSCOM_IRQ_VTL1_MASK 0x2
 #endif
 
+=======
+	/* first syscom queue pointer register */
+	SYSCOM_QPR_BASE_REG	= 5
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 STORAGE_CLASS_INLINE unsigned int
 regmem_load_32(unsigned int mem_address, unsigned int reg, unsigned int ssid);
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/assert_support.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/assert_support.h
index f904a49..2b36d84 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/assert_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/assert_support.h
@@ -39,6 +39,12 @@
  * should not depend on assert to function (actually the assert
  * could be disabled in a release build) it was decided to
  * disable the assert for KW scans (by defining NDEBUG)
+<<<<<<< HEAD
+=======
+ * see also:
+ * http://www.klocwork.com/products/documentation/current/
+ * Tuning_C/C%2B%2B_analysis#Assertions
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 #define NDEBUG
 #endif /* __KLOCWORK__ */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/math_support.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/math_support.h
index 633f86f..53efe9b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/math_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/support/math_support.h
@@ -44,7 +44,10 @@
 #define IS_ODD(a) ((a) & 0x1)
 #define IS_EVEN(a) (!IS_ODD(a))
 #define IS_POWER2(a) (!((a)&((a)-1)))
+<<<<<<< HEAD
 #define IS_MASK_BITS_SET(a, b)	((a & b) != 0)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*To Find next power of 2 number from x */
 #define bit2(x)            ((x)      | ((x) >> 1))
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h
index 5426d6d..c7d7eef 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h
@@ -206,6 +206,7 @@ ia_css_syscom_recv_port_transfer(
 	void *token
 );
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /**
  * ia_css_syscom_store_dmem() - store subsystem context information in DMEM
@@ -244,4 +245,6 @@ ia_css_syscom_is_ab_spc_ready(
 );
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* __IA_CSS_SYSCOM_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h
index 8c827c2..0f2b977 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h
@@ -91,7 +91,10 @@ struct ia_css_syscom_config {
 	 * if false, non-secure syscom
 	 */
 	bool secure;
+<<<<<<< HEAD
 	unsigned int vtl0_addr_mask; /* only applicable in 'secure' case */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 #endif /* __IA_CSS_SYSCOM_CONFIG_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom.c
index cdf9df0..793790a 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom.c
@@ -349,7 +349,10 @@ ia_css_syscom_open(
 	ia_css_cpu_mem_cache_flush((void *)HOST_ADDRESS(ctx->config_host_addr),
 				    sizeof(struct ia_css_syscom_config_fw));
 
+<<<<<<< HEAD
 #if !HAS_DUAL_CMD_CTX_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* store syscom uninitialized state */
 	IA_CSS_TRACE_3(SYSCOM, INFO, "ia_css_syscom_open store STATE_REG (%#x) @ dmem_addr %#x ssid %d\n",
 		       SYSCOM_STATE_UNINIT, ctx->cell_dmem_addr, cfg->ssid);
@@ -365,6 +368,12 @@ ia_css_syscom_open(
 		       ctx->config_vied_addr, ctx->cell_dmem_addr, cfg->ssid);
 	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_CONFIG_REG,
 			ctx->config_vied_addr, cfg->ssid);
+<<<<<<< HEAD
+=======
+#if HAS_DUAL_CMD_CTX_SUPPORT
+	/* clear IRQ status */
+	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_IRQ_REG, 0x0, cfg->ssid);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 	/* Indicate if ctx is created for secure stream purpose */
@@ -563,6 +572,7 @@ ia_css_syscom_recv_port_transfer(
 
 	return recv_port_transfer(ctx->recv_port + port, token);
 }
+<<<<<<< HEAD
 
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /*
@@ -648,3 +658,5 @@ ia_css_syscom_is_ab_spc_ready(
 	return (value == AB_SPC_READY);
 }
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h
index 0cacd5a..9bb3209 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h
@@ -33,6 +33,7 @@ enum {
 	SYSCOM_COMMAND_INACTIVE = 0x57A7F001
 };
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 enum {
 	/* Program load or explicit host setting should init to this */
@@ -51,6 +52,8 @@ enum {
 };
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* firmware config: data that sent from the host to SP via DDR */
 /* Cell copies data into a context */
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/syscom.mk b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/syscom.mk
index 8d36b89..fabb815 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/syscom.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/syscom/syscom.mk
@@ -22,7 +22,10 @@ SYSCOM_SOURCES1=$(SYSCOM_DIR)/src
 SYSCOM_HOST_FILES += $(SYSCOM_SOURCES1)/ia_css_syscom.c
 
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_INTERFACE)
+<<<<<<< HEAD
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_SOURCES1)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 SYSCOM_HOST_CPPFLAGS += -I$${MODULES_DIR}/devices
 ifdef REGMEM_SECURE_OFFSET
 SYSCOM_HOST_CPPFLAGS += -DREGMEM_SECURE_OFFSET=$(REGMEM_SECURE_OFFSET)
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/vied_parameters/vied_parameters.mk b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/vied_parameters/vied_parameters.mk
index 834a1a4..3a4f549 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/vied_parameters/vied_parameters.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/lib/vied_parameters/vied_parameters.mk
@@ -72,5 +72,9 @@ VIED_PARAMETERS_FW_CPPFLAGS +=  $(VIED_PARAMETERS_SUPPORT_CPPFLAGS)
 #For IPU interface
 include $(MODULES_DIR)/fw_abi_common_types/cpu/fw_abi_cpu_types.mk
 VIED_PARAMETERS_HOST_CPPFLAGS += $(FW_ABI_COMMON_TYPES_HOST_CPPFLAGS)
+<<<<<<< HEAD
+=======
+endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 VIED_PARAMETERS_FW_CPPFLAGS   += $(FW_ABI_COMMON_TYPES_FW_CPPFLAGS)
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/libcsspsys2600.c b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/libcsspsys2600.c
index 3889393..96ae540 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/libcsspsys2600.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/lib2600psys/libcsspsys2600.c
@@ -13,10 +13,18 @@
 
 #include <linux/delay.h>
 #include <linux/module.h>
+<<<<<<< HEAD
+=======
+#include "libcsspsys2600.h"
+#include <vied_nci_psys_resource_model.h>
+#include <ia_css_psys_device.h>
+#include <ipu_device_cell_properties_func.h>
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #include <uapi/linux/ipu-psys.h>
 
 #include "ipu.h"
+<<<<<<< HEAD
 #include "ipu-mmu.h"
 #include "ipu-psys.h"
 #include "ipu-fw-psys.h"
@@ -28,6 +36,130 @@
 #include <ipu_device_cell_properties_func.h>
 #include <ia_css_psys_program_group_private.h>
 #include <ia_css_psys_process_private_types.h>
+=======
+#include "ipu-fw-psys.h"
+#include "ipu-psys.h"
+#include "ipu-fw-resources.h"
+#include "ipu-wrapper.h"
+#include "ipu-mmu.h"
+
+#include <ia_css_psys_process_group_cmd_impl.h>
+#include <ia_css_psys_process_private_types.h>
+#include <ia_css_psys_init.h>
+#include <ia_css_psys_transport.h>
+#include <ia_css_terminal_base_types.h>
+#include <ia_css_terminal_types.h>
+#include <ia_css_program_group_param_types.h>
+#include <ia_css_psys_terminal_private_types.h>
+#include <ia_css_program_group_data.h>
+#include <ia_css_psys_program_group_private.h>
+
+#define BASIC_ABI_CHECK
+
+#ifndef BASIC_ABI_CHECK
+#define ABI_CHECK(a, b, field)					\
+	{								\
+	if (offsetof(typeof(*a), field) != offsetof(typeof(*b), field))	\
+		pr_err("intel_ipu4 psys ABI mismatch %s\n",		\
+		       __stringify(field));		    \
+	}
+#else
+#define ABI_CHECK(a, b, field) { }
+#endif
+
+#define SIZE_OF_CHECK(a, b) \
+	{		    \
+	if (sizeof(*a) != sizeof(*b))\
+		pr_err("intel_ipu4 psys ABI size of mismatch %s\n",	\
+		       __stringify(a));					\
+	}								\
+
+static void abi_sanity_checker(void)
+{
+	struct ipu_fw_psys_process_group *ipu_fw_psys_pg;
+	struct ia_css_process_group_s *ia_css_pg;
+
+	struct ipu_fw_psys_process *ipu_fw_psys_ps;
+	struct ia_css_process_s *ia_css_ps;
+
+	struct ipu_fw_psys_srv_init *ipu_fw_psys_init;
+	struct ia_css_psys_server_init *ia_css_psys_init;
+
+	struct ipu_fw_psys_cmd *ipu_fw_psys_cmd;
+	struct ia_css_psys_cmd_s *ia_css_psys_cmd;
+
+	struct ipu_fw_psys_event *ipu_fw_psys_event;
+	struct ia_css_psys_event_s *ia_css_psys_event;
+
+	struct ipu_fw_psys_terminal *ipu_fw_psys_terminal;
+	struct ia_css_terminal_s *ia_css_terminal;
+
+	struct ipu_fw_psys_param_terminal *ipu_fw_psys_param_terminal;
+	struct ia_css_param_terminal_s *ia_css_param_terminal;
+
+	struct ipu_fw_psys_param_payload *ipu_fw_psys_param_payload;
+	struct ia_css_param_payload_s *ia_css_param_payload;
+
+	struct ipu_fw_psys_data_terminal *ipu_fw_psys_data_terminal;
+	struct ia_css_data_terminal_s *ia_css_data_terminal;
+
+	struct ipu_fw_psys_frame *ipu_fw_psys_frame;
+	struct ia_css_frame_s *ia_css_frame;
+
+	struct ipu_fw_psys_frame_descriptor *ipu_fw_psys_frame_descriptor;
+	struct ia_css_frame_descriptor_s *ia_css_frame_descriptor;
+
+	struct ipu_fw_psys_stream *ipu_fw_psys_stream;
+	struct ia_css_stream_s *ia_css_stream;
+
+	SIZE_OF_CHECK(ipu_fw_psys_pg, ia_css_pg);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, ID);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, process_count);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, processes_offset);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, routing_bitmap);
+
+	SIZE_OF_CHECK(ipu_fw_psys_ps, ia_css_ps);
+	ABI_CHECK(ipu_fw_psys_ps, ia_css_ps, ID);
+	ABI_CHECK(ipu_fw_psys_ps, ia_css_ps, dev_chn_offset);
+	ABI_CHECK(ipu_fw_psys_ps, ia_css_ps, cell_id);
+
+	SIZE_OF_CHECK(ipu_fw_psys_init, ia_css_psys_init);
+	ABI_CHECK(ipu_fw_psys_init, ia_css_psys_init, icache_prefetch_sp);
+	ABI_CHECK(ipu_fw_psys_init, ia_css_psys_init, icache_prefetch_isp);
+
+	SIZE_OF_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd);
+	ABI_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd, command);
+	ABI_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd, msg);
+	ABI_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd, context_handle);
+
+	SIZE_OF_CHECK(ipu_fw_psys_event, ia_css_psys_event);
+	ABI_CHECK(ipu_fw_psys_event, ia_css_psys_event, status);
+	ABI_CHECK(ipu_fw_psys_event, ia_css_psys_event, token);
+
+	SIZE_OF_CHECK(ipu_fw_psys_terminal, ia_css_terminal);
+	ABI_CHECK(ipu_fw_psys_terminal, ia_css_terminal, terminal_type);
+
+	SIZE_OF_CHECK(ipu_fw_psys_param_terminal, ia_css_param_terminal);
+	ABI_CHECK(ipu_fw_psys_param_terminal, ia_css_param_terminal,
+		  param_payload);
+
+	SIZE_OF_CHECK(ipu_fw_psys_param_payload, ia_css_param_payload);
+	ABI_CHECK(ipu_fw_psys_param_payload, ia_css_param_payload, buffer);
+
+	SIZE_OF_CHECK(ipu_fw_psys_data_terminal, ia_css_data_terminal);
+	ABI_CHECK(ipu_fw_psys_data_terminal, ia_css_data_terminal, frame);
+	ABI_CHECK(ipu_fw_psys_data_terminal, ia_css_data_terminal,
+		  connection_type);
+
+	SIZE_OF_CHECK(ipu_fw_psys_frame, ia_css_frame);
+	ABI_CHECK(ipu_fw_psys_frame, ia_css_frame, data_bytes);
+	ABI_CHECK(ipu_fw_psys_frame, ia_css_frame, data);
+	ABI_CHECK(ipu_fw_psys_frame, ia_css_frame, buffer_state);
+
+	SIZE_OF_CHECK(ipu_fw_psys_frame_descriptor, ia_css_frame_descriptor);
+	SIZE_OF_CHECK(ipu_fw_psys_stream, ia_css_stream);
+}
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 int ipu_fw_psys_pg_start(struct ipu_psys_kcmd *kcmd)
 {
@@ -249,15 +381,23 @@ int ipu_fw_psys_pg_get_protocol(
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_pg_get_protocol);
 
+<<<<<<< HEAD
 static int libcsspsys2600_init(void);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ipu_fw_psys_open(struct ipu_psys *psys)
 {
 	bool opened;
 	int retry = IPU_PSYS_OPEN_RETRY;
 
+<<<<<<< HEAD
 	ipu_wrapper_init(PSYS_MMID, &psys->adev->dev, psys->pdata->base);
 	/* When fw psys open, make sure csslib init first */
 	libcsspsys2600_init();
+=======
+	ipu_wrapper_init(PSYS_MMID, &psys->adev->dev,
+				psys->pdata->base);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	server_init->icache_prefetch_sp = psys->icache_prefetch_sp;
 	server_init->icache_prefetch_isp = psys->icache_prefetch_isp;
@@ -268,7 +408,10 @@ int ipu_fw_psys_open(struct ipu_psys *psys)
 			"psys library open failed\n");
 		return -ENODEV;
 	}
+<<<<<<< HEAD
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	do {
 		opened = ia_css_psys_open_is_ready(psys_syscom);
 		if (opened)
@@ -327,7 +470,50 @@ u64 ipu_fw_psys_pg_get_token(struct ipu_psys_kcmd *kcmd)
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_pg_get_token);
 
+<<<<<<< HEAD
 static const struct ipu_fw_resource_definitions default_defs = {
+=======
+int ipu_fw_psys_ppg_set_buffer_set(struct ipu_psys_kcmd *kcmd,
+				    struct ipu_fw_psys_terminal *terminal,
+				    int terminal_idx, u32 buffer)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_set_buffer_set);
+
+size_t
+ipu_fw_psys_ppg_get_buffer_set_size(struct ipu_psys_kcmd *kcmd)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_get_buffer_set_size);
+
+int
+ipu_fw_psys_ppg_buffer_set_vaddress(struct ipu_fw_psys_buffer_set *buf_set,
+				     u32 vaddress)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_buffer_set_vaddress);
+
+struct ipu_fw_psys_buffer_set *
+ipu_fw_psys_ppg_create_buffer_set(struct ipu_psys_kcmd *kcmd,
+				   void *kaddr, u32 frame_counter)
+{
+	return NULL;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_create_buffer_set);
+
+int
+ipu_fw_psys_ppg_enqueue_bufs(struct ipu_psys_kcmd *kcmd,
+			      unsigned int queue_offset)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_enqueue_bufs);
+
+static const struct ipu_resource_definitions default_defs = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.cells = vied_nci_cell_type,
 	.num_cells = VIED_NCI_N_CELL_ID,
 	.num_cells_type = VIED_NCI_N_CELL_TYPE_ID,
@@ -340,6 +526,7 @@ static const struct ipu_fw_resource_definitions default_defs = {
 
 	.cell_mem_row = VIED_NCI_N_MEM_TYPE_ID,
 	.cell_mem = (enum ipu_mem_id *)vied_nci_cell_mem,
+<<<<<<< HEAD
 };
 
 const struct ipu_fw_resource_definitions *res_defs = &default_defs;
@@ -350,11 +537,36 @@ int ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
 {
 	return ia_css_process_set_cell((ia_css_process_t *)ptr,
 				       (vied_nci_cell_ID_t)value);
+=======
+	.process.ext_mem_id = offsetof(struct ia_css_process_s,
+				       ext_mem_id[0]),
+	.process.ext_mem_offset = offsetof(struct ia_css_process_s,
+					   ext_mem_offset[0]),
+	.process.dev_chn_offset = offsetof(struct ia_css_process_s,
+					   dev_chn_offset[0]),
+	.process.cell_id = offsetof(struct ia_css_process_s, cell_id),
+};
+
+const struct ipu_resource_definitions *res_defs = &default_defs;
+EXPORT_SYMBOL_GPL(res_defs);
+
+/*
+ * Extension library gives byte offsets to its internal structures.
+ * use those offsets to update fields. Without extension lib access
+ * structures directly.
+ */
+void ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
+				u8 value)
+{
+	/* Byte offset */
+	*((u8 *)ptr + res_defs->process.cell_id) = value;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_cell_id);
 
 u8 ipu_fw_psys_get_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index)
 {
+<<<<<<< HEAD
 	return ia_css_process_get_cell((ia_css_process_t *)ptr);
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_get_process_cell_id);
@@ -380,6 +592,38 @@ int ipu_fw_psys_set_process_ext_mem(struct ipu_fw_psys_process *ptr,
 	return ia_css_process_set_ext_mem((ia_css_process_t *)ptr, mem_id, offset);
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_ext_mem);
+=======
+	/* Byte offset */
+	return *((u8 *)ptr + res_defs->process.cell_id);
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_get_process_cell_id);
+
+void ipu_fw_psys_set_process_dev_chn_offset(struct ipu_fw_psys_process *ptr,
+				       u16 offset, u16 value)
+{
+	/* dev_chn_offset is a byte offset, offset is u16 index */
+	*((u16 *)((u8 *)ptr + res_defs->process.dev_chn_offset) +
+		 offset) = value;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_dev_chn_offset);
+
+void ipu_fw_psys_set_process_ext_mem_offset(struct ipu_fw_psys_process *ptr,
+				       u16 offset, u16 value)
+{
+	/* ext_mem_offset is a byte offset, offset is u16 index */
+	*((u16 *)((u8 *)ptr + res_defs->process.ext_mem_offset) +
+		  offset) = value;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_ext_mem_offset);
+
+void ipu_fw_psys_set_process_ext_mem_id(struct ipu_fw_psys_process *ptr,
+				   u16 offset, u8 value)
+{
+	/* ext_mem_id is a byte offset, offset parameter is u8 index */
+	*((u8 *)ptr + res_defs->process.ext_mem_id + offset) = value;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_ext_mem_id);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 int ipu_fw_psys_get_program_manifest_by_process(
 	struct ipu_fw_generic_program_manifest *gen_pm,
@@ -415,6 +659,7 @@ int ipu_fw_psys_get_program_manifest_by_process(
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_get_program_manifest_by_process);
 
+<<<<<<< HEAD
 static int libcsspsys2600_init(void)
 {
 	int rval;
@@ -422,20 +667,35 @@ static int libcsspsys2600_init(void)
 
 	if (csslib_init)
 		return 0;
+=======
+static int __init libcsspsys2600_init(void)
+{
+	int rval;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	syscom_buffer = kzalloc(ia_css_sizeof_psys(NULL), GFP_KERNEL);
 	if (!syscom_buffer)
 		return -ENOMEM;
 
+<<<<<<< HEAD
 	syscom_config = kzalloc(sizeof(struct ia_css_syscom_config),
 				GFP_KERNEL);
+=======
+	syscom_config = kzalloc(
+		sizeof(struct ia_css_syscom_config), GFP_KERNEL);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (!syscom_config) {
 		rval = -ENOMEM;
 		goto out_syscom_buffer_free;
 	}
 
+<<<<<<< HEAD
 	server_init = kzalloc(sizeof(struct ia_css_psys_server_init),
 			      GFP_KERNEL);
+=======
+	server_init = kzalloc(
+		sizeof(struct ia_css_psys_server_init), GFP_KERNEL);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (!server_init) {
 		rval = -ENOMEM;
 		goto out_syscom_config_free;
@@ -447,6 +707,7 @@ static int libcsspsys2600_init(void)
 
 	*syscom_config = *ia_css_psys_specify();
 	syscom_config->specific_addr = server_init;
+<<<<<<< HEAD
 	syscom_config->specific_size = sizeof(struct ia_css_psys_server_init);
 	syscom_config->ssid = PSYS_SSID;
 	syscom_config->mmid = PSYS_MMID;
@@ -455,6 +716,19 @@ static int libcsspsys2600_init(void)
 	syscom_config->dmem_addr = ipu_device_cell_memory_address(SPC0,
 					IPU_DEVICE_SP2600_CONTROL_DMEM);
 	csslib_init = true;
+=======
+	syscom_config->specific_size =
+		sizeof(struct ia_css_psys_server_init);
+	syscom_config->ssid = PSYS_SSID;
+	syscom_config->mmid = PSYS_MMID;
+	syscom_config->regs_addr =
+		ipu_device_cell_memory_address(
+			SPC0, IPU_DEVICE_SP2600_CONTROL_REGS);
+	syscom_config->dmem_addr =
+		ipu_device_cell_memory_address(
+			SPC0, IPU_DEVICE_SP2600_CONTROL_DMEM);
+	abi_sanity_checker();
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-css/libintel-ipu4.c b/drivers/media/pci/intel/ipu4/ipu4-css/libintel-ipu4.c
index d770c09..f68a31f 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-css/libintel-ipu4.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-css/libintel-ipu4.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2014 - 2018 Intel Corporation
 
 #include <linux/module.h>
@@ -7,8 +11,12 @@
 #include "ipu-isys.h"
 #include "ipu-wrapper.h"
 #include <ia_css_isysapi.h>
+<<<<<<< HEAD
 
 #include "ipu-platform.h"
+=======
+#include "libintel-checker.h"
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define ipu_lib_call_notrace_unlocked(func, isys, ...)		\
 	({								\
@@ -56,11 +64,17 @@ int ipu_fw_isys_close(struct ipu_isys *isys)
 	 * some time as the FW must stop its actions including code fetch
 	 * to SP icache.
 	 */
+<<<<<<< HEAD
 	mutex_lock(&isys->lib_mutex);
 	spin_lock_irqsave(&isys->power_lock, flags);
 	rval = ipu_lib_call_notrace_unlocked(device_close, isys);
 	spin_unlock_irqrestore(&isys->power_lock, flags);
 	mutex_unlock(&isys->lib_mutex);
+=======
+	spin_lock_irqsave(&isys->power_lock, flags);
+	rval = ipu_lib_call(device_close, isys);
+	spin_unlock_irqrestore(&isys->power_lock, flags);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (rval)
 		dev_err(dev, "Device close failure: %d\n", rval);
 
@@ -182,6 +196,13 @@ struct ipu_fw_isys_resp_info_abi *ipu_fw_isys_get_resp(
 	response->process_group_light.addr =
 		apiresp.process_group_light.addr;
 	response->acc_id = apiresp.acc_id;
+<<<<<<< HEAD
+=======
+#ifdef IPU_OTF_SUPPORT
+	response->frame_counter = apiresp.frame_counter;
+	response->written_direct = apiresp.written_direct;
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return response;
 }
@@ -248,6 +269,12 @@ static void output_pin_info_abi_to_api(
 	api->payload_buf_size = abi->payload_buf_size;
 	api->send_irq = abi->send_irq;
 	api->ft = abi->ft;
+<<<<<<< HEAD
+=======
+#ifdef IPU_OTF_SUPPORT
+	api->link_id = abi->link_id;
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	api->reserve_compression = abi->reserve_compression;
 }
 
@@ -273,7 +300,12 @@ static void isa_cfg_abi_to_api(const struct ipu_fw_isys_isa_cfg_abi *abi,
 {
 	unsigned int i;
 
+<<<<<<< HEAD
 	for (i = 0; i < N_IA_CSS_ISYS_RESOLUTION_INFO; i++)
+=======
+	for (i = 0; i < min(N_IPU_FW_ISYS_RESOLUTION_INFO,
+			    N_IA_CSS_ISYS_RESOLUTION_INFO); i++)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		resolution_abi_to_api(&abi->isa_res[i], &api->isa_res[i]);
 
 	api->blc_enabled = abi->cfg.blc;
@@ -307,7 +339,12 @@ static void stream_cfg_abi_to_api(struct ipu_fw_isys_stream_cfg_data_abi *abi,
 	api->isl_use = abi->isl_use;
 	api->compfmt = abi->compfmt;
 	isa_cfg_abi_to_api(&abi->isa_cfg, &api->isa_cfg);
+<<<<<<< HEAD
 	for (i = 0; i < N_IA_CSS_ISYS_CROPPING_LOCATION; i++)
+=======
+	for (i = 0; i < min(N_IPU_FW_ISYS_CROPPING_LOCATION,
+			    N_IA_CSS_ISYS_CROPPING_LOCATION); i++)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		cropping_abi_to_api(&abi->crop[i], &api->crop[i]);
 
 	api->send_irq_sof_discarded = abi->send_irq_sof_discarded;
@@ -340,8 +377,11 @@ static void frame_buff_set_abi_to_api(
 
 	api->send_irq_sof = abi->send_irq_sof;
 	api->send_irq_eof = abi->send_irq_eof;
+<<<<<<< HEAD
 	api->send_irq_capture_ack = abi->send_irq_capture_ack;
 	api->send_irq_capture_done = abi->send_irq_capture_done;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 int ipu_fw_isys_complex_cmd(struct ipu_isys *isys,
@@ -383,5 +423,21 @@ int ipu_fw_isys_complex_cmd(struct ipu_isys *isys,
 }
 EXPORT_SYMBOL_GPL(ipu_fw_isys_complex_cmd);
 
+<<<<<<< HEAD
+=======
+static int __init library_init(void)
+{
+	ipu_isys_abi_checker();
+	return 0;
+}
+
+static void __exit library_exit(void)
+{
+}
+
+module_init(library_init);
+module_exit(library_exit);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("Intel ipu library");
diff --git a/drivers/media/pci/intel/ipu4/ipu4-fw-resources.c b/drivers/media/pci/intel/ipu4/ipu4-fw-resources.c
index 581b737..143c933 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-fw-resources.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-fw-resources.c
@@ -1,3 +1,4 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
 // Copyright (C) 2015 - 2018 Intel Corporation
 
@@ -191,11 +192,23 @@ ipu_fw_psys_cell_mem[IPU_FW_PSYS_N_CELL_ID][IPU_FW_PSYS_N_MEM_TYPE_ID] = {
 };
 
 static const struct ipu_fw_resource_definitions default_defs = {
+=======
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2015 - 2018 Intel Corporation
+
+#include "ipu-fw-resources.h"
+
+static const struct ipu_resource_definitions default_defs = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.cells = ipu_fw_psys_cell_types,
 	.num_cells = IPU_FW_PSYS_N_CELL_ID,
 	.num_cells_type = IPU_FW_PSYS_N_CELL_TYPE_ID,
 
+<<<<<<< HEAD
 	.dev_channels = ipu_fw_num_dev_channels,
+=======
+	.dev_channels = ipu_num_dev_channels,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.num_dev_channels = IPU_FW_PSYS_N_DEV_CHN_ID,
 
 	.num_ext_mem_types = IPU_FW_PSYS_N_DATA_MEM_TYPE_ID,
@@ -204,7 +217,11 @@ static const struct ipu_fw_resource_definitions default_defs = {
 
 	.num_dfm_ids = IPU_FW_PSYS_N_DEV_DFM_ID,
 
+<<<<<<< HEAD
 	.cell_mem_row = IPU_FW_PSYS_N_MEM_TYPE_ID,
+=======
+	.cell_mem_row = IPU_FW_PSYS_N_DATA_MEM_TYPE_ID,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.cell_mem = &ipu_fw_psys_cell_mem[0][0],
 
 	.process.ext_mem_id = offsetof(struct ipu_fw_psys_process,
@@ -216,7 +233,11 @@ static const struct ipu_fw_resource_definitions default_defs = {
 	.process.cell_id = offsetof(struct ipu_fw_psys_process, cell_id),
 };
 
+<<<<<<< HEAD
 const struct ipu_fw_resource_definitions *res_defs = &default_defs;
+=======
+const struct ipu_resource_definitions *res_defs = &default_defs;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /********** Generic resource handling **********/
 
@@ -225,6 +246,7 @@ const struct ipu_fw_resource_definitions *res_defs = &default_defs;
  * use those offsets to update fields. Without extension lib access
  * structures directly.
  */
+<<<<<<< HEAD
 int ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
 				    u8 value)
 {
@@ -236,6 +258,12 @@ int ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
 	parent->resource_bitmap |= 1 << value;
 
 	return 0;
+=======
+void ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
+				     u8 value)
+{
+	ptr->cell_id = value;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 u8 ipu_fw_psys_get_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index)
@@ -243,6 +271,7 @@ u8 ipu_fw_psys_get_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index)
 	return ptr->cell_id;
 }
 
+<<<<<<< HEAD
 int ipu_fw_psys_clear_process_cell(struct ipu_fw_psys_process *ptr)
 {
 	struct ipu_fw_psys_process_group *parent;
@@ -275,6 +304,24 @@ int ipu_fw_psys_set_process_ext_mem(struct ipu_fw_psys_process *ptr,
 	ptr->ext_mem_id[type_id] = mem_id;
 
 	return 0;
+=======
+void ipu_fw_psys_set_process_dev_chn_offset(struct ipu_fw_psys_process *ptr,
+					    u16 offset, u16 value)
+{
+	ptr->dev_chn_offset[offset] = value;
+}
+
+void ipu_fw_psys_set_process_ext_mem_offset(struct ipu_fw_psys_process *ptr,
+					    u16 offset, u16 value)
+{
+	ptr->ext_mem_offset[offset] = value;
+}
+
+void ipu_fw_psys_set_process_ext_mem_id(struct ipu_fw_psys_process *ptr,
+					u16 offset, u8 value)
+{
+	ptr->ext_mem_id[offset] = value;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static struct ipu_fw_psys_program_manifest *
@@ -330,4 +377,7 @@ int ipu_fw_psys_get_program_manifest_by_process(
 	}
 	return -ENOENT;
 }
+<<<<<<< HEAD
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c b/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c
index 1484a197..0cd95b0 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-isys-csi2.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2013 - 2018 Intel Corporation
 
 #include "ipu.h"
@@ -312,9 +316,13 @@ static u64 tunit_time_to_us(struct ipu_isys *isys, u64 time)
 	struct ipu_bus_device *adev = to_ipu_bus_device(isys->adev->iommu);
 	u64 isys_clk = IS_FREQ_SOURCE / adev->ctrl->divisor / 1000000;
 
+<<<<<<< HEAD
 	do_div(time, isys_clk);
 
 	return time;
+=======
+	return time / isys_clk;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static int update_timer_base(struct ipu_isys *isys)
@@ -561,12 +569,16 @@ static u64 tsc_time_to_tunit_time(struct ipu_isys *isys,
 	u64 isys_clk = IS_FREQ_SOURCE / adev->ctrl->divisor / 100000;
 	u64 tsc_clk = IPU_BUTTRESS_TSC_CLK / 100000;
 
+<<<<<<< HEAD
 	tsc_time *= isys_clk;
 	tsc_base *= isys_clk;
 	do_div(tsc_time, tsc_clk);
 	do_div(tsc_base, tsc_clk);
 
 	return tunit_base + tsc_time - tsc_base;
+=======
+	return (tsc_time - tsc_base) * isys_clk / tsc_clk + tunit_base;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /* Extract the timestamp from trace message.
@@ -610,8 +622,11 @@ ipu_isys_csi2_get_current_field(struct ipu_isys_pipeline *ip,
 	bool msg_matched = false;
 	unsigned int monitor_id;
 
+<<<<<<< HEAD
 	update_timer_base(isys);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ip->csi2->index >= IPU_ISYS_MAX_CSI2_LEGACY_PORTS)
 		monitor_id = TRACE_REG_CSI2_3PH_TM_MONITOR_ID;
 	else
@@ -656,7 +671,10 @@ ipu_isys_csi2_get_current_field(struct ipu_isys_pipeline *ip,
 	if (!msg_matched)
 		/* We have walked through the whole buffer. */
 		dev_dbg(&isys->adev->dev, "No matched trace message found.\n");
+<<<<<<< HEAD
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return field;
 }
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c b/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c
index e5af62a..307066e 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-isys-isa.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2014 - 2018 Intel Corporation
 
 #include <linux/device.h>
@@ -8,7 +12,10 @@
 #include <media/ipu-isys.h>
 #include <media/media-entity.h>
 #include <media/v4l2-device.h>
+<<<<<<< HEAD
 #include <media/v4l2-event.h>
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <media/v4l2-ioctl.h>
 #include <media/videobuf2-dma-contig.h>
 
@@ -99,7 +106,11 @@ static int isa_config_vidioc_g_fmt_vid_out_mplane(struct file *file, void *fh,
 	return 0;
 }
 
+<<<<<<< HEAD
 static const struct ipu_isys_pixelformat *
+=======
+const struct ipu_isys_pixelformat *
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 isa_config_try_fmt_vid_out_mplane(struct ipu_isys_video *av,
 				  struct v4l2_pix_format_mplane *mpix)
 {
@@ -172,8 +183,11 @@ static const struct v4l2_ioctl_ops isa_config_ioctl_ops = {
 };
 
 static const struct v4l2_subdev_core_ops isa_sd_core_ops = {
+<<<<<<< HEAD
 	.subscribe_event = v4l2_ctrl_subdev_subscribe_event,
 	.unsubscribe_event = v4l2_event_subdev_unsubscribe,
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static int set_stream(struct v4l2_subdev *sd, int enable)
@@ -211,6 +225,10 @@ static struct v4l2_subdev_ops isa_sd_ops = {
 
 static int isa_link_validate(struct media_link *link)
 {
+<<<<<<< HEAD
+=======
+	struct ipu_isys_video *av;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct ipu_isys_pipeline *ip;
 	struct media_pipeline *pipe;
 
@@ -218,6 +236,10 @@ static int isa_link_validate(struct media_link *link)
 	if (is_media_entity_v4l2_subdev(link->source->entity))
 		return v4l2_subdev_link_validate(link);
 
+<<<<<<< HEAD
+=======
+	av = container_of(link->source, struct ipu_isys_video, pad);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	pipe = link->sink->entity->pipe;
 	ip = to_ipu_isys_pipeline(pipe);
 	ip->nr_queues++;
@@ -923,8 +945,12 @@ int ipu_isys_isa_init(struct ipu_isys_isa *isa,
 				    NR_OF_ISA_PADS,
 				    NR_OF_ISA_STREAMS,
 				    NR_OF_ISA_SOURCE_PADS,
+<<<<<<< HEAD
 				    NR_OF_ISA_SINK_PADS,
 				    V4L2_SUBDEV_FL_HAS_EVENTS);
+=======
+				    NR_OF_ISA_SINK_PADS, 0);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (rval)
 		goto fail;
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-isys-isa.h b/drivers/media/pci/intel/ipu4/ipu4-isys-isa.h
index 649714d..6b53a8e 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-isys-isa.h
+++ b/drivers/media/pci/intel/ipu4/ipu4-isys-isa.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_ISA_H
@@ -11,6 +15,13 @@
 #include "ipu-isys-subdev.h"
 #include "ipu-isys-video.h"
 
+<<<<<<< HEAD
+=======
+struct ipu_isys;
+struct ipu_fw_isys_frame_buff_set_abi;
+struct ipu_fw_isys_stream_cfg_data;
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define ISA_PAD_SINK			0
 #define ISA_PAD_SOURCE			1
 #define ISA_PAD_CONFIG			2
@@ -22,8 +33,13 @@
 #define NR_OF_ISA_SOURCE_PADS		3
 #define NR_OF_ISA_STREAMS		1
 
+<<<<<<< HEAD
 struct ipu_isys;
 struct ia_css_process_group_light;
+=======
+struct ia_css_process_group_light;
+struct ia_css_terminal;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*
  * struct ipu_isa_buffer
diff --git a/drivers/media/pci/intel/ipu4/ipu4-isys.c b/drivers/media/pci/intel/ipu4/ipu4-isys.c
index c11ced2..f8d1a14 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-isys.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-isys.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2018 Intel Corporation
 
 #include <linux/module.h>
@@ -6,7 +10,10 @@
 #include "ipu.h"
 #include "ipu-platform-regs.h"
 #include "ipu-platform-buttress-regs.h"
+<<<<<<< HEAD
 #include "ipu-platform-isys-csi2-reg.h"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include "ipu-trace.h"
 #include "ipu-isys.h"
 #include "ipu-isys-video.h"
@@ -147,6 +154,7 @@ void isys_setup_hw(struct ipu_isys *isys)
 #endif
 
 #ifdef CONFIG_VIDEO_INTEL_IPU4P
+<<<<<<< HEAD
 /*
  * For new HW, extra common register (en_flush_for_idrain)added to the IBufCtrl
  * of ISL_IS and CSI that enables the feature to send a DMA command with flush
@@ -169,6 +177,8 @@ static int ipu4p_isys_flush_idrain_en(struct ipu_isys *isys)
 	return 0;
 }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static void ipu4p_isys_irq_cfg(struct ipu_isys *isys)
 {
 	void __iomem *base = isys->pdata->base;
@@ -202,19 +212,31 @@ static void ipu4p_isys_bb_cfg(struct ipu_isys *isys)
 {
 	void __iomem *isp_base = isys->adev->isp->base;
 	unsigned int i, val;
+<<<<<<< HEAD
 	unsigned int bbconfig[4][4] = {
 		{4, 13, 32, 0xf},
 		{6, 13, 32, 0x15},
 		{12, 13, 32, 0xf},
 		{14, 13, 32, 0x15},
+=======
+	unsigned int bbconfig[4][3] = {
+		{4, 15, 0xf},
+		{6, 15, 0x15},
+		{12, 15, 0xf},
+		{14, 15, 0x15},
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	};
 
 	/* Config building block */
 	for (i = 0; i < 4; i++) {
 		unsigned int bb = bbconfig[i][0];
 		unsigned int crc = bbconfig[i][1];
+<<<<<<< HEAD
 		unsigned int drc = bbconfig[i][2];
 		unsigned int afe = bbconfig[i][3];
+=======
+		unsigned int afe = bbconfig[i][2];
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 		val = readl(isp_base + BUTTRESS_REG_CPHYX_DLL_OVRD(bb));
 		val &= ~0x7e;
@@ -223,7 +245,12 @@ static void ipu4p_isys_bb_cfg(struct ipu_isys *isys)
 		writel(val, isp_base + BUTTRESS_REG_CPHYX_DLL_OVRD(bb));
 		val = readl(isp_base + BUTTRESS_REG_DPHYX_DLL_OVRD(bb));
 		val |= 1;
+<<<<<<< HEAD
 		val |= drc << 1;
+=======
+		writel(val, isp_base + BUTTRESS_REG_DPHYX_DLL_OVRD(bb));
+		val &= ~1;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		writel(val, isp_base + BUTTRESS_REG_DPHYX_DLL_OVRD(bb));
 		val = afe | (2 << 29);
 		writel(val, isp_base + BUTTRESS_REG_BBX_AFE_CONFIG(bb));
@@ -247,7 +274,10 @@ void isys_setup_hw(struct ipu_isys *isys)
 	ipu4p_isys_irq_cfg(isys);
 	ipu4p_isys_port_cfg(isys);
 	ipu4p_isys_bb_cfg(isys);
+<<<<<<< HEAD
 	ipu4p_isys_flush_idrain_en(isys);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 #endif
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4-psys.c b/drivers/media/pci/intel/ipu4/ipu4-psys.c
index 3fe3a06..1f6e77b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4-psys.c
+++ b/drivers/media/pci/intel/ipu4/ipu4-psys.c
@@ -1,3 +1,4 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
 // Copyright (C) 2018 Intel Corporation
 
@@ -18,10 +19,16 @@
 #include <linux/module.h>
 #include <linux/fs.h>
 
+=======
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2018 Intel Corporation
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include "ipu.h"
 #include "ipu-psys.h"
 #include "ipu-platform-regs.h"
 #include "ipu-trace.h"
+<<<<<<< HEAD
 #define CREATE_TRACE_POINTS
 #define IPU_PG_KCMD_TRACE
 #include "ipu-trace-event.h"
@@ -34,6 +41,8 @@ MODULE_PARM_DESC(early_pg_transfer,
 		 "Copy PGs back to user after resource allocation");
 MODULE_PARM_DESC(enable_concurrency,
 		 "Enable concurrent execution of program groups");
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 struct ipu_trace_block psys_trace_blocks[] = {
 	{
@@ -113,11 +122,14 @@ struct ipu_trace_block psys_trace_blocks[] = {
 	}
 };
 
+<<<<<<< HEAD
 static int ipu_psys_kcmd_abort(struct ipu_psys *psys,
 			       struct ipu_psys_kcmd *kcmd);
 static int ipu_psys_kcmd_queue(struct ipu_psys *psys,
 			       struct ipu_psys_kcmd *kcmd);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static void set_sp_info_bits(void *base)
 {
 	int i;
@@ -145,7 +157,11 @@ static void set_isp_info_bits(void *base)
 			   base + IPU_REG_PSYS_INFO_SEG_DATA_MASTER(i));
 }
 
+<<<<<<< HEAD
 void ipu_psys_setup_hw(struct ipu_psys *psys)
+=======
+void psys_setup_hw(struct ipu_psys *psys)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 {
 	void __iomem *base = psys->pdata->base;
 	void __iomem *spc_regs_base =
@@ -186,6 +202,7 @@ void ipu_psys_setup_hw(struct ipu_psys *psys)
 	for (i = 0; i < psys->pdata->ipdata->hw_variant.cdc_fifos; i++)
 		writel(thd[i], base + IPU_REG_PSYS_CDC_THRESHOLD(i));
 }
+<<<<<<< HEAD
 
 /*
  * Called to free up all resources associated with a kcmd.
@@ -1107,3 +1124,5 @@ long ipu_ioctl_dqevent(struct ipu_psys_event *event,
 
 	return 0;
 }
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4-resource-tables.c b/drivers/media/pci/intel/ipu4/ipu4-resource-tables.c
new file mode 100644
index 00000000..029bd74
--- /dev/null
+++ b/drivers/media/pci/intel/ipu4/ipu4-resource-tables.c
@@ -0,0 +1,173 @@
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2015 - 2018 Intel Corporation
+
+#include <linux/kernel.h>
+#include "ipu-resources.h"
+
+/*
+ * Cell types by cell IDs
+ */
+
+const u32 ipu_fw_psys_cell_types[IPU_FW_PSYS_N_CELL_ID] = {
+	IPU_FW_PSYS_SP_CTRL_TYPE_ID,
+	IPU_FW_PSYS_SP_SERVER_TYPE_ID,
+	IPU_FW_PSYS_SP_SERVER_TYPE_ID,
+	IPU_FW_PSYS_VP_TYPE_ID,
+	IPU_FW_PSYS_VP_TYPE_ID,
+	IPU_FW_PSYS_VP_TYPE_ID,
+	IPU_FW_PSYS_VP_TYPE_ID,
+	IPU_FW_PSYS_ACC_ISA_TYPE_ID,
+	IPU_FW_PSYS_ACC_PSA_TYPE_ID,
+	IPU_FW_PSYS_ACC_PSA_TYPE_ID,
+	IPU_FW_PSYS_ACC_PSA_TYPE_ID,
+	IPU_FW_PSYS_ACC_PSA_TYPE_ID,
+	IPU_FW_PSYS_ACC_PSA_TYPE_ID,
+	IPU_FW_PSYS_ACC_PSA_TYPE_ID,
+	IPU_FW_PSYS_ACC_OSA_TYPE_ID,
+	IPU_FW_PSYS_GDC_TYPE_ID,
+	IPU_FW_PSYS_GDC_TYPE_ID
+};
+
+const u16 ipu_num_dev_channels[IPU_FW_PSYS_N_DEV_CHN_ID] = {
+	IPU_FW_PSYS_DEV_CHN_DMA_EXT0_MAX_SIZE,
+	IPU_FW_PSYS_DEV_CHN_GDC_MAX_SIZE,
+	IPU_FW_PSYS_DEV_CHN_DMA_EXT1_READ_MAX_SIZE,
+	IPU_FW_PSYS_DEV_CHN_DMA_EXT1_WRITE_MAX_SIZE,
+	IPU_FW_PSYS_DEV_CHN_DMA_INTERNAL_MAX_SIZE,
+	IPU_FW_PSYS_DEV_CHN_DMA_IPFD_MAX_SIZE,
+	IPU_FW_PSYS_DEV_CHN_DMA_ISA_MAX_SIZE,
+	IPU_FW_PSYS_DEV_CHN_DMA_FW_MAX_SIZE,
+#ifdef CONFIG_VIDEO_INTEL_IPU4P
+	IPU_FW_PSYS_DEV_CHN_DMA_CMPRS_MAX_SIZE
+#endif
+};
+
+const u16 ipu_fw_psys_mem_size[IPU_FW_PSYS_N_MEM_ID] = {
+	IPU_FW_PSYS_VMEM0_MAX_SIZE,
+	IPU_FW_PSYS_VMEM1_MAX_SIZE,
+	IPU_FW_PSYS_VMEM2_MAX_SIZE,
+	IPU_FW_PSYS_VMEM3_MAX_SIZE,
+	IPU_FW_PSYS_VMEM4_MAX_SIZE,
+	IPU_FW_PSYS_BAMEM0_MAX_SIZE,
+	IPU_FW_PSYS_BAMEM1_MAX_SIZE,
+	IPU_FW_PSYS_BAMEM2_MAX_SIZE,
+	IPU_FW_PSYS_BAMEM3_MAX_SIZE,
+	IPU_FW_PSYS_DMEM0_MAX_SIZE,
+	IPU_FW_PSYS_DMEM1_MAX_SIZE,
+	IPU_FW_PSYS_DMEM2_MAX_SIZE,
+	IPU_FW_PSYS_DMEM3_MAX_SIZE,
+	IPU_FW_PSYS_DMEM4_MAX_SIZE,
+	IPU_FW_PSYS_DMEM5_MAX_SIZE,
+	IPU_FW_PSYS_DMEM6_MAX_SIZE,
+	IPU_FW_PSYS_DMEM7_MAX_SIZE,
+	IPU_FW_PSYS_PMEM0_MAX_SIZE,
+	IPU_FW_PSYS_PMEM1_MAX_SIZE,
+	IPU_FW_PSYS_PMEM2_MAX_SIZE,
+	IPU_FW_PSYS_PMEM3_MAX_SIZE
+};
+
+const enum ipu_mem_id
+ipu_fw_psys_cell_mem[IPU_FW_PSYS_N_CELL_ID][IPU_FW_PSYS_N_DATA_MEM_TYPE_ID] = {
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_DMEM0_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_DMEM1_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_DMEM2_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_VMEM4_ID,
+	 IPU_FW_PSYS_DMEM4_ID,
+	 IPU_FW_PSYS_VMEM0_ID,
+	 IPU_FW_PSYS_BAMEM0_ID
+	},
+	{
+	 IPU_FW_PSYS_VMEM4_ID,
+	 IPU_FW_PSYS_DMEM5_ID,
+	 IPU_FW_PSYS_VMEM1_ID,
+	 IPU_FW_PSYS_BAMEM1_ID
+	},
+	{
+	 IPU_FW_PSYS_VMEM4_ID,
+	 IPU_FW_PSYS_DMEM6_ID,
+	 IPU_FW_PSYS_VMEM2_ID,
+	 IPU_FW_PSYS_BAMEM2_ID
+	},
+	{
+	 IPU_FW_PSYS_VMEM4_ID,
+	 IPU_FW_PSYS_DMEM7_ID,
+	 IPU_FW_PSYS_VMEM3_ID,
+	 IPU_FW_PSYS_BAMEM3_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	},
+	{
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID,
+	 IPU_FW_PSYS_N_MEM_ID
+	}
+};
diff --git a/drivers/media/pci/intel/ipu4/ipu4.c b/drivers/media/pci/intel/ipu4/ipu4.c
index c3615d2..3ce0276 100644
--- a/drivers/media/pci/intel/ipu4/ipu4.c
+++ b/drivers/media/pci/intel/ipu4/ipu4.c
@@ -1,5 +1,12 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
 // Copyright (C) 2018 Intel Corporation
+=======
+/* SPDX-License_Identifier: GPL-2.0
+ * Copyright (C) 2018 Intel Corporation
+ * FIXME: update checkpatch script
+ */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #include <linux/device.h>
 #include <linux/delay.h>
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_inc b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_inc
index 90a2ab4..8a9e9c9 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_inc
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_inc
@@ -19,7 +19,10 @@ IPU_ISYSLIB_INC = \
 	-I$(IPU_ISYSLIB_ROOT)/regmem/src \
 	-I$(IPU_ISYSLIB_ROOT)/support \
 	-I$(IPU_ISYSLIB_ROOT)/syscom/interface \
+<<<<<<< HEAD
 	-I$(IPU_ISYSLIB_ROOT)/syscom/src \
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	-I$(IPU_ISYSLIB_ROOT)/trace/interface \
 	-I$(IPU_ISYSLIB_ROOT)/utils/system_defs/ \
 	-I$(IPU_ISYSLIB_ROOT)/vied \
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_src b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_src
index c20760b..a3ed530 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_src
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4pisys_src
@@ -2,8 +2,11 @@ IPU_ISYSLIB_SRC = \
 	$(IPU_ISYSLIB_ROOT_REL)/isysapi/src/ia_css_isys_private.o \
 	$(IPU_ISYSLIB_ROOT_REL)/isysapi/src/ia_css_isys_public.o \
 	$(IPU_ISYSLIB_ROOT_REL)/isysapi/src/ia_css_isys_public_trace.o
+<<<<<<< HEAD
 
 ifeq ($(CONFIG_VIDEO_INTEL_IPU), m)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 IPU_ISYSLIB_SRC += \
 	$(IPU_ISYSLIB_ROOT_REL)/buffer/src/cpu/buffer_access.o \
 	$(IPU_ISYSLIB_ROOT_REL)/buffer/src/cpu/ia_css_buffer.o \
@@ -15,5 +18,9 @@ IPU_ISYSLIB_SRC += \
 	$(IPU_ISYSLIB_ROOT_REL)/port/src/recv_port.o \
 	$(IPU_ISYSLIB_ROOT_REL)/port/src/send_port.o \
 	$(IPU_ISYSLIB_ROOT_REL)/reg_dump/src/reg_dump_generic_bridge.o \
+<<<<<<< HEAD
 	$(IPU_ISYSLIB_ROOT_REL)/syscom/src/ia_css_syscom.o
 endif
+=======
+	$(IPU_ISYSLIB_ROOT_REL)/syscom/src/ia_css_syscom.o
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4ppsys_inc b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4ppsys_inc
index fb01678..ba72309 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4ppsys_inc
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.ipu4ppsys_inc
@@ -43,7 +43,10 @@ IPU_PSYSLIB_INC = \
 	-I$(IPU_PSYSLIB_ROOT)/routing_bitmap/src \
 	-I$(IPU_PSYSLIB_ROOT)/support \
 	-I$(IPU_PSYSLIB_ROOT)/syscom/interface \
+<<<<<<< HEAD
 	-I$(IPU_PSYSLIB_ROOT)/syscom/src \
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	-I$(IPU_PSYSLIB_ROOT)/trace/interface \
 	-I$(IPU_PSYSLIB_ROOT)/vied \
 	-I$(IPU_PSYSLIB_ROOT)/vied/vied/ \
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.isyslib b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.isyslib
index d0816c5..32dae19 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.isyslib
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/Makefile.isyslib
@@ -10,6 +10,7 @@ IPU_ISYSLIB_ROOT = $(srcpath)/$(src)/$(IPU_ISYSLIB_ROOT_REL)
 include $(srcpath)/$(src)/ipu4p-css/Makefile.ipu4pisys_inc
 include $(srcpath)/$(src)/ipu4p-css/Makefile.ipu4pisys_src
 
+<<<<<<< HEAD
 intel-ipu4p-isys-csslib-objs := \
 		ipu4p-css/libintel-ipu4p.o \
 		$(IPU_ISYSLIB_SRC)
@@ -20,11 +21,32 @@ endif
 obj-$(CONFIG_VIDEO_INTEL_IPU)	+= intel-ipu4p-isys-csslib.o
 
 INCLUDES := -I$(srcpath)/$(src)/$(IPU_ISYSLIB_ROOT_REL) \
+=======
+#
+# copy wrapper here only for isys usage, psys would use the original one
+#
+$(shell cp -f $(srcpath)/$(src)/../ipu-wrapper.c $(srcpath)/$(src)/ipu4p-css/ipu-wrapper.c)
+
+lib2600-mod-$(IPU_STEP)-objs := \
+	ipu4p-css/libintel-ipu4p.o \
+	../libintel-checker.o \
+	$(IPU_ISYSLIB_SRC)
+
+ifeq ($(CONFIG_VIDEO_INTEL_IPU), m)
+lib2600-mod-$(IPU_STEP)-objs += ipu4p-css/ipu-wrapper.o
+endif
+
+obj-$(CONFIG_VIDEO_INTEL_IPU)	+= lib2600-mod-$(IPU_STEP).o
+
+INCLUDES := \
+	-I$(srcpath)/$(src)/$(IPU_ISYSLIB_ROOT_REL) \
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	-I$(srcpath)/$(src) \
 	$(IPU_ISYSLIB_INC)
 
 DEFINES:= -D__HOST__ -D__KERNEL__ -DISYS_FPGA -DPSYS_FPGA
 
+<<<<<<< HEAD
 DEFINES += -DSSID=1
 DEFINES += -DMMID=1
 DEFINES += -DPROGNAME=isys_fw
@@ -38,5 +60,20 @@ DEFINES += -DCFG_VIED_SUBSYSTEM_ACCESS_LIB_IMPL=1
 DEFINES += -DHRT_ON_VIED_SUBSYSTEM_ACCESS=0
 DEFINES += -DHRT_USE_VIR_ADDRS
 DEFINES += -DHRT_HW
+=======
+ DEFINES += -DSSID=1
+ DEFINES += -DMMID=1
+ DEFINES += -DPROGNAME=isys_fw
+ DEFINES += -DPROGMAP=\"isys_fw.map.h\"
+ DEFINES += -DSUBSYSTEM_INCLUDE=\<isys.h\>
+ DEFINES += -DCELL=input_system_unis_logic_sp_control_tile_sp
+ DEFINES += -DSPMAIN=isys_fw
+ DEFINES += -DRUN_INTEGRATION
+ DEFINES += -DDEBUG_SP_NCI
+ DEFINES += -DCFG_VIED_SUBSYSTEM_ACCESS_LIB_IMPL=1
+ DEFINES += -DHRT_ON_VIED_SUBSYSTEM_ACCESS=0
+ DEFINES += -DHRT_USE_VIR_ADDRS
+ DEFINES += -DHRT_HW
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ccflags-y += $(INCLUDES) $(DEFINES) -fno-common
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/ia_css_fw_pkg_release.h b/drivers/media/pci/intel/ipu4/ipu4p-css/ia_css_fw_pkg_release.h
index 408726c..5928c53 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/ia_css_fw_pkg_release.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/ia_css_fw_pkg_release.h
@@ -11,4 +11,8 @@
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 */
+<<<<<<< HEAD
 #define IA_CSS_FW_PKG_RELEASE  0x20181222
+=======
+#define IA_CSS_FW_PKG_RELEASE  0x20180308
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/cpd_binary/ia_css_fw_pkg_release.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/cpd_binary/ia_css_fw_pkg_release.h
index 408726c..5928c53 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/cpd_binary/ia_css_fw_pkg_release.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/cpd_binary/ia_css_fw_pkg_release.h
@@ -11,4 +11,8 @@
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 */
+<<<<<<< HEAD
 #define IA_CSS_FW_PKG_RELEASE  0x20181222
+=======
+#define IA_CSS_FW_PKG_RELEASE  0x20180308
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h
index dbf1cf9..106d1ce 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/fw_abi_common_types/ia_css_terminal_defs.h
@@ -71,6 +71,13 @@ typedef enum ia_css_terminal_type {
  * Dimensions of the data objects. Note that a C-style
  * data order is assumed. Data stored by row.
  */
+<<<<<<< HEAD
+=======
+/* A strange problem with hivecc compiler which is described
+ * here https://icggerrit.ir.intel.com/#/c/51630/1 forces this
+ * enum to be explicitly initialized for the moment
+ */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 typedef enum ia_css_dimension {
 	/**< The number of columns, i.e. the size of the row */
 	IA_CSS_COL_DIMENSION = 0,
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h
index 5e47fe7..d798e78 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isys_fw_bridged_types.h
@@ -61,7 +61,10 @@ struct ia_css_isys_resolution_comm {
  * @out_buf_id: Points to output pin buffer - buffer identifier
  * @addr: Points to output pin buffer - CSS Virtual Address
  * @compress: Request frame compression (1), or  not (0)
+<<<<<<< HEAD
  * This must be the same as ia_css_isys_output_pin_info_comm::reserve_compression
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 struct ia_css_isys_output_pin_payload_comm {
 	aligned_uint64(ia_css_return_token, out_buf_id);
@@ -273,8 +276,11 @@ struct ia_css_isys_frame_buff_set_comm {
 	aligned_struct(struct ia_css_isys_param_pin_comm, process_group_light);
 	aligned_uint8(unsigned int, send_irq_sof);
 	aligned_uint8(unsigned int, send_irq_eof);
+<<<<<<< HEAD
 	aligned_uint8(unsigned int, send_irq_capture_ack);
 	aligned_uint8(unsigned int, send_irq_capture_done);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	aligned_uint8(unsigned int, send_resp_sof);
 	aligned_uint8(unsigned int, send_resp_eof);
 	aligned_uint8(unsigned int, frame_counter);
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi.h
index abbc8b8..f014830 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi.h
@@ -15,6 +15,14 @@
 #ifndef __IA_CSS_ISYSAPI_H
 #define __IA_CSS_ISYSAPI_H
 
+<<<<<<< HEAD
+=======
+/**
+ * errno.h specified error codes to be used
+ * URL:http://man7.org/linux/man-pages/man3/errno.3.html>
+ */
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* The following is needed for the function arguments */
 #include "ia_css_isysapi_types.h"
@@ -40,6 +48,7 @@ extern int ia_css_isys_context_create(
 	HANDLE * context,
 	const struct ia_css_isys_device_cfg_data *config
 );
+<<<<<<< HEAD
 extern int ia_css_isys_context_store_dmem(
 	const HANDLE *context,
 	const struct ia_css_isys_device_cfg_data *config
@@ -47,6 +56,8 @@ extern int ia_css_isys_context_store_dmem(
 extern bool ia_css_isys_ab_spc_ready(
 	HANDLE *context
 );
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 extern int ia_css_isys_device_open(
 	const struct ia_css_isys_device_cfg_data *config
 );
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h
index c002b33..242aadda9 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_proxy_region_defs.h
@@ -110,4 +110,16 @@ struct ia_css_proxy_write_region_description ipu4p_b0_reg_write_desc[N_IPU4P_B0_
 
 #endif /*defined(IPU4P_B0_PROXY_INT)*/
 
+<<<<<<< HEAD
+=======
+/*
+ */
+
+
+
+/*
+ */
+
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* __IA_CSS_ISYSAPI_PROXY_REGION_DEFS_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_types.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_types.h
index 481a7dc..f8fc11b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_types.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/interface/ia_css_isysapi_types.h
@@ -71,7 +71,10 @@ struct ia_css_isys_device_cfg_data {
 	struct ia_css_isys_buffer_partition buffer_partition;
 	struct ia_css_driver_proxy_config driver_proxy;
 	bool secure;
+<<<<<<< HEAD
 	unsigned vtl0_addr_mask; /* only applicable in 'secure' case */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 /**
@@ -89,7 +92,10 @@ struct ia_css_isys_resolution {
  * @out_buf_id: Points to output pin buffer - buffer identifier
  * @addr: Points to output pin buffer - CSS Virtual Address
  * @compressed: Request frame compression (1), or  not (0)
+<<<<<<< HEAD
  * This must be the same as ia_css_isys_output_pin_info::reserve_compression
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 struct ia_css_isys_output_pin_payload {
 	ia_css_return_token out_buf_id;
@@ -273,8 +279,11 @@ struct ia_css_isys_frame_buff_set {
 	struct ia_css_isys_param_pin process_group_light;
 	unsigned int send_irq_sof;
 	unsigned int send_irq_eof;
+<<<<<<< HEAD
 	unsigned int send_irq_capture_ack;
 	unsigned int send_irq_capture_done;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	unsigned int send_resp_sof;
 	unsigned int send_resp_eof;
 	uint8_t      frame_counter;
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/isysapi.mk b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/isysapi.mk
index 0d06298..9a24ea0 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/isysapi.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/isysapi.mk
@@ -14,8 +14,11 @@
 #
 # MODULE is ISYSAPI
 
+<<<<<<< HEAD
 include $(MODULES_DIR)/config/isys/subsystem_$(IPU_SYSVER).mk
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 ISYSAPI_DIR=$${MODULES_DIR}/isysapi
 
 ISYSAPI_INTERFACE=$(ISYSAPI_DIR)/interface
@@ -63,8 +66,11 @@ ISYSAPI_FW_CPPFLAGS += -I$(HIVESDK)/include/ipu
 
 ISYSAPI_FW_CPPFLAGS += -DWA_HSD1805168877=$(WA_HSD1805168877)
 
+<<<<<<< HEAD
 ISYSAPI_HOST_CPPFLAGS += -DREGMEM_OFFSET=$(REGMEM_OFFSET)
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 ifeq ($(ISYS_HAS_DUAL_CMD_CTX_SUPPORT), 1)
 ISYSAPI_HOST_CPPFLAGS += -DHAS_DUAL_CMD_CTX_SUPPORT=$(ISYS_HAS_DUAL_CMD_CTX_SUPPORT)
 ISYSAPI_FW_CPPFLAGS += -DHAS_DUAL_CMD_CTX_SUPPORT=$(ISYS_HAS_DUAL_CMD_CTX_SUPPORT)
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_private.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_private.c
index ec92f14..b8653ec 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_private.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_private.c
@@ -601,10 +601,13 @@ STORAGE_CLASS_INLINE void frame_buff_set_host_to_css(
 			frame_buff_set_host->send_irq_sof ? 1 : 0;
 	frame_buff_set_css->send_irq_eof =
 			frame_buff_set_host->send_irq_eof ? 1 : 0;
+<<<<<<< HEAD
 	frame_buff_set_css->send_irq_capture_done =
 			(uint8_t)frame_buff_set_host->send_irq_capture_done;
 	frame_buff_set_css->send_irq_capture_ack =
 			frame_buff_set_host->send_irq_capture_ack ? 1 : 0;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	frame_buff_set_css->send_resp_sof =
 			frame_buff_set_host->send_irq_sof ?
 				1 : frame_buff_set_host->send_resp_sof;
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_public.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_public.c
index f7b1325..722e4b1 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_public.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/isysapi/src/ia_css_isys_public.c
@@ -218,9 +218,12 @@ static int isys_context_create(
 	/* parameters size */
 	sys.specific_size = sizeof(isys_fw_cfg);
 	sys.secure = config->secure;
+<<<<<<< HEAD
 	if (config->secure) {
 		sys.vtl0_addr_mask = config->vtl0_addr_mask;
 	}
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	IA_CSS_TRACE_0(ISYSAPI, VERBOSE,
 		"isys_context_create || call ia_css_syscom_open()\n");
@@ -294,6 +297,7 @@ int ia_css_isys_context_create(
 	return isys_context_create(context, config);
 }
 
+<<<<<<< HEAD
 /* push context information to DMEM for FW to access */
 int ia_css_isys_context_store_dmem(
 	const HANDLE *context,
@@ -312,6 +316,8 @@ bool ia_css_isys_ab_spc_ready(
 	return ia_css_syscom_is_ab_spc_ready(ctx->sys);
 }
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ia_css_isys_device_open(
 	const struct ia_css_isys_device_cfg_data *config)
 {
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/reg_dump/src/reg_dump_generic_bridge.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/reg_dump/src/reg_dump_generic_bridge.c
index 18d0c98..0e474b1b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/reg_dump/src/reg_dump_generic_bridge.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/reg_dump/src/reg_dump_generic_bridge.c
@@ -26,8 +26,20 @@
 #define REG_DUMP_TRACE_METHOD IA_CSS_TRACE_METHOD_NATIVE
 #define REG_DUMP_TRACE_LEVEL_VERBOSE IA_CSS_TRACE_LEVEL_ENABLED
 
+<<<<<<< HEAD
 /* SSID value is defined in test makefiles as either isys0 or psys0 */
 #define REG_DUMP_READ_REGISTER(addr)    vied_subsystem_load_32(SSID, addr)
+=======
+#ifdef USE_SSID_BUTTRESS
+ * seen from the host; these addresses already contain the ISYS or PSYS offset.
+ */
+#define REG_DUMP_READ_REGISTER(addr)\
+	 vied_subsystem_load_32(IPU_DEVICE_BUTTRESS, addr)
+#else
+/* SSID value is defined in test makefiles as either isys0 or psys0 */
+#define REG_DUMP_READ_REGISTER(addr)    vied_subsystem_load_32(SSID, addr)
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define REG_DUMP_PRINT_0(...) \
 EXPAND_VA_ARGS(IA_CSS_TRACE_0(REG_DUMP, VERBOSE, __VA_ARGS__))
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/regmem/interface/regmem_access.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/regmem/interface/regmem_access.h
index d4576af..d8a15cb 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/regmem/interface/regmem_access.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/regmem/interface/regmem_access.h
@@ -28,6 +28,7 @@ enum regmem_id {
 	SYSCOM_COMMAND_REG	= 3,
 	/* Store interrupt status - updated by SP */
 	SYSCOM_IRQ_REG		= 4,
+<<<<<<< HEAD
 	/* Store VTL0_ADDR_MASK in trusted secure regision - provided by host.*/
 	SYSCOM_VTL0_ADDR_MASK	= 5,
 #if HAS_DUAL_CMD_CTX_SUPPORT
@@ -51,6 +52,12 @@ enum regmem_id {
 #define SYSCOM_IRQ_VTL1_MASK 0x2
 #endif
 
+=======
+	/* first syscom queue pointer register */
+	SYSCOM_QPR_BASE_REG	= 5
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 STORAGE_CLASS_INLINE unsigned int
 regmem_load_32(unsigned int mem_address, unsigned int reg, unsigned int ssid);
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/assert_support.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/assert_support.h
index f904a49..2b36d84 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/assert_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/assert_support.h
@@ -39,6 +39,12 @@
  * should not depend on assert to function (actually the assert
  * could be disabled in a release build) it was decided to
  * disable the assert for KW scans (by defining NDEBUG)
+<<<<<<< HEAD
+=======
+ * see also:
+ * http://www.klocwork.com/products/documentation/current/
+ * Tuning_C/C%2B%2B_analysis#Assertions
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 #define NDEBUG
 #endif /* __KLOCWORK__ */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/math_support.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/math_support.h
index 633f86f..53efe9b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/math_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/support/math_support.h
@@ -44,7 +44,10 @@
 #define IS_ODD(a) ((a) & 0x1)
 #define IS_EVEN(a) (!IS_ODD(a))
 #define IS_POWER2(a) (!((a)&((a)-1)))
+<<<<<<< HEAD
 #define IS_MASK_BITS_SET(a, b)	((a & b) != 0)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*To Find next power of 2 number from x */
 #define bit2(x)            ((x)      | ((x) >> 1))
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom.h
index 5426d6d..c7d7eef 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom.h
@@ -206,6 +206,7 @@ ia_css_syscom_recv_port_transfer(
 	void *token
 );
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /**
  * ia_css_syscom_store_dmem() - store subsystem context information in DMEM
@@ -244,4 +245,6 @@ ia_css_syscom_is_ab_spc_ready(
 );
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* __IA_CSS_SYSCOM_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom_config.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom_config.h
index 8c827c2..0f2b977 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom_config.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/interface/ia_css_syscom_config.h
@@ -91,7 +91,10 @@ struct ia_css_syscom_config {
 	 * if false, non-secure syscom
 	 */
 	bool secure;
+<<<<<<< HEAD
 	unsigned int vtl0_addr_mask; /* only applicable in 'secure' case */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 #endif /* __IA_CSS_SYSCOM_CONFIG_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom.c
index cdf9df0..793790a 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom.c
@@ -349,7 +349,10 @@ ia_css_syscom_open(
 	ia_css_cpu_mem_cache_flush((void *)HOST_ADDRESS(ctx->config_host_addr),
 				    sizeof(struct ia_css_syscom_config_fw));
 
+<<<<<<< HEAD
 #if !HAS_DUAL_CMD_CTX_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* store syscom uninitialized state */
 	IA_CSS_TRACE_3(SYSCOM, INFO, "ia_css_syscom_open store STATE_REG (%#x) @ dmem_addr %#x ssid %d\n",
 		       SYSCOM_STATE_UNINIT, ctx->cell_dmem_addr, cfg->ssid);
@@ -365,6 +368,12 @@ ia_css_syscom_open(
 		       ctx->config_vied_addr, ctx->cell_dmem_addr, cfg->ssid);
 	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_CONFIG_REG,
 			ctx->config_vied_addr, cfg->ssid);
+<<<<<<< HEAD
+=======
+#if HAS_DUAL_CMD_CTX_SUPPORT
+	/* clear IRQ status */
+	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_IRQ_REG, 0x0, cfg->ssid);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 	/* Indicate if ctx is created for secure stream purpose */
@@ -563,6 +572,7 @@ ia_css_syscom_recv_port_transfer(
 
 	return recv_port_transfer(ctx->recv_port + port, token);
 }
+<<<<<<< HEAD
 
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /*
@@ -648,3 +658,5 @@ ia_css_syscom_is_ab_spc_ready(
 	return (value == AB_SPC_READY);
 }
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom_config_fw.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom_config_fw.h
index 0cacd5a..9bb3209 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom_config_fw.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/src/ia_css_syscom_config_fw.h
@@ -33,6 +33,7 @@ enum {
 	SYSCOM_COMMAND_INACTIVE = 0x57A7F001
 };
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 enum {
 	/* Program load or explicit host setting should init to this */
@@ -51,6 +52,8 @@ enum {
 };
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* firmware config: data that sent from the host to SP via DDR */
 /* Cell copies data into a context */
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/syscom.mk b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/syscom.mk
index 8d36b89..fabb815 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/syscom.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600/syscom/syscom.mk
@@ -22,7 +22,10 @@ SYSCOM_SOURCES1=$(SYSCOM_DIR)/src
 SYSCOM_HOST_FILES += $(SYSCOM_SOURCES1)/ia_css_syscom.c
 
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_INTERFACE)
+<<<<<<< HEAD
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_SOURCES1)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 SYSCOM_HOST_CPPFLAGS += -I$${MODULES_DIR}/devices
 ifdef REGMEM_SECURE_OFFSET
 SYSCOM_HOST_CPPFLAGS += -DREGMEM_SECURE_OFFSET=$(REGMEM_SECURE_OFFSET)
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/Makefile b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/Makefile
index ca82d1f..8ff8d9b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/Makefile
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/Makefile
@@ -45,9 +45,15 @@ HOST_DEFINES += -DAPI_SPLIT_START_STATE_UPDATE
 HOST_DEFINES += -DHAS_DUAL_CMD_CTX_SUPPORT=0
 HOST_DEFINES += -DHAS_LATE_BINDING_SUPPORT=0
 
+<<<<<<< HEAD
 intel-ipu4p-psys-csslib-objs := ../../../ipu-wrapper.o \
 		$(IPU_PSYSLIB_SRC)
 obj-$(CONFIG_VIDEO_INTEL_IPU)	+= intel-ipu4p-psys-csslib.o
+=======
+lib2600psys-mod-$(IPU_SYSVER)-objs := ../../../ipu-wrapper.o \
+	$(IPU_PSYSLIB_SRC)
+obj-$(CONFIG_VIDEO_INTEL_IPU)	+= lib2600psys-mod-$(IPU_SYSVER).o
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ccflags-y += $(IPU_PSYSLIB_INC) $(HOST_DEFINES) -fno-common -v
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/CNL_program_group/ia_css_fw_pkg_release.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/CNL_program_group/ia_css_fw_pkg_release.h
index 408726c..5928c53 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/CNL_program_group/ia_css_fw_pkg_release.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/CNL_program_group/ia_css_fw_pkg_release.h
@@ -11,4 +11,8 @@
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 */
+<<<<<<< HEAD
 #define IA_CSS_FW_PKG_RELEASE  0x20181222
+=======
+#define IA_CSS_FW_PKG_RELEASE  0x20180308
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/ICL_program_group/ia_css_fw_pkg_release.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/ICL_program_group/ia_css_fw_pkg_release.h
index 408726c..5928c53 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/ICL_program_group/ia_css_fw_pkg_release.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/ICL_program_group/ia_css_fw_pkg_release.h
@@ -11,4 +11,8 @@
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 */
+<<<<<<< HEAD
 #define IA_CSS_FW_PKG_RELEASE  0x20181222
+=======
+#define IA_CSS_FW_PKG_RELEASE  0x20180308
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/config/psys/subsystem_cnlB0.mk b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/config/psys/subsystem_cnlB0.mk
index be397a0..8519bd0 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/config/psys/subsystem_cnlB0.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/config/psys/subsystem_cnlB0.mk
@@ -37,6 +37,7 @@ PSYS_SERVER_ENABLE_TERMINAL_LOAD_DMA = 1
 # Assume OFS will be running concurrently with IPF, and prioritize according to rates of services on devproxy
 CONCURRENT_OFS_IPF_PRIORITY_OPTIMIZATION_ENABLED	= 1
 
+<<<<<<< HEAD
 # Enable clock gating of input feeder ibufctrl
 ENABLE_IPFD_IBUFCTRL_CLK_GATE    = 1
 
@@ -44,6 +45,24 @@ ENABLE_IPFD_IBUFCTRL_CLK_GATE    = 1
 ENABLE_ISL_IBUFCTRL_CLK_GATE     = 1
 
 # Enable clock gating of GDC0
+=======
+# Enable clock gating of input feeder ibufctrl as specified in:
+#     https://sharepoint.ger.ith.intel.com/sites/ICG_Arch/Shared%20Documents/
+#           IPU%20Specs/IPU4-P/HAS/CNL%20B0%20clock%20gating%20registers.xlsx
+# (see register: processing_system_psa_psa_logic_ipfd_ibufctrl_2600_inst_enable_clk_gate)
+ENABLE_IPFD_IBUFCTRL_CLK_GATE    = 1
+
+# Enable clock gating of input slice light ibufctrl as specified in:
+#     https://sharepoint.ger.ith.intel.com/sites/ICG_Arch/Shared%20Documents/
+#           IPU%20Specs/IPU4-P/HAS/CNL%20B0%20clock%20gating%20registers.xlsx
+# (see register: processing_system_input_slice_light_logic_ibuf_ctrl_enable_clk_gate)
+ENABLE_ISL_IBUFCTRL_CLK_GATE     = 1
+
+# Enable clock gating of GDC0 as specified in:
+#     https://sharepoint.ger.ith.intel.com/sites/ICG_Arch/Shared%20Documents/
+#           IPU%20Specs/IPU4-P/HAS/CNL%20B0%20clock%20gating%20registers.xlsx
+# (see register: processing_system_gdc_logic_gdc0_nr_of_lut_parts)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 ENABLE_GDC0_CLK_GATE     = 1
 
 
@@ -56,6 +75,7 @@ HAS_64KB_GDC_MEM                = 1
 # define for enabling mmu_stream_id_lut support
 ENABLE_MMU_STREAM_ID_LUT = 1
 
+<<<<<<< HEAD
 # define for enabling rgbir related chnages in devproxy
 HAS_RGBIR = 1
 
@@ -72,6 +92,19 @@ FW_LOAD_NO_OF_REQUEST_SIZE_BYTES	= 4
 DISPATCHER_SCRATCH_SPACE_OFFSET 	= 4176	# Taken from REGMEM_SECURE_OFFSET + REGMEM_SIZE_BYTES
 # Total Used (@ REGMEM_OFFSET)		= 164	# FW_LOAD_NO_OF_REQUEST_OFFSET + FW_LOAD_NO_OF_REQUEST_SIZE_BYTES
 # Total Used (@ REGMEM_SECURE_OFFSET)	= 80	# REGMEM_SIZE_BYTES
+=======
+# Specification for Psys server's fixed globals' locations
+REGMEM_OFFSET				= 0
+REGMEM_SECURE_OFFSET			= 4096
+REGMEM_SIZE				= 17
+REGMEM_WORD_BYTES			= 4
+REGMEM_SIZE_BYTES			= 68
+GPC_ISP_PERF_DATA_OFFSET		= 68	# Taken from REGMEM_SECURE_OFFSET + REGMEM_SIZE_BYTES
+GPC_ISP_PERF_DATA_SIZE_BYTES		= 80
+FW_LOAD_NO_OF_REQUEST_OFFSET		= 148	# Taken from GPC_ISP_PERF_DATA_OFFSET + GPC_ISP_PERF_DATA_SIZE_BYTES
+FW_LOAD_NO_OF_REQUEST_SIZE_BYTES	= 4
+DISPATCHER_SCRATCH_SPACE_OFFSET 	= 4164	# Taken from REGMEM_SECURE_OFFSET + REGMEM_SIZE_BYTES
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 # use DMA NCI for OFS Service to reduce load in tproxy
 DMA_NCI_IN_OFS_SERVICE = 1
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/devices/interface/ipu_device_gp_properties_types.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/devices/interface/ipu_device_gp_properties_types.h
index acd9111..b6ffde7 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/devices/interface/ipu_device_gp_properties_types.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/devices/interface/ipu_device_gp_properties_types.h
@@ -71,6 +71,76 @@ enum ipu_device_gp_isa_value {
 	IPU_DEVICE_GP_ISA_PAF_STR_PORT0 = 0,
 	IPU_DEVICE_GP_ISA_PAF_STR_PORT1 = 1,
 
+<<<<<<< HEAD
+=======
+	/* scaler port block options */
+	IPU_DEVICE_GP_ISA_SCALER_PORT_UNBLOCK = 0,
+	IPU_DEVICE_GP_ISA_SCALER_PORT_BLOCK = 1,
+
+	IPU_DEVICE_GP_ISA_STATIC_SCALED_OUT_DEMUX_SEL_S2V = 0,
+	IPU_DEVICE_GP_ISA_STATIC_SCALED_OUT_DEMUX_SEL_PSA = 1,
+
+	/* Muxes/demuxes */
+	/* 0 - to ISL.S2V; 1 - to PSA */
+	IPU_DEVICE_GP_ISA_STATIC_ISA_ORIG_OUT_DEMUX_SEL_S2V = 0,
+	IPU_DEVICE_GP_ISA_STATIC_ISA_ORIG_OUT_DEMUX_SEL_PSA = 1,
+	/* 0 - to ISL.S2V; 1 - to PSA */
+	IPU_DEVICE_GP_ISA_STATIC_ISA_SCALED_A_OUT_DEMUX_SEL_S2V = 0,
+	IPU_DEVICE_GP_ISA_STATIC_ISA_SCALED_A_OUT_DEMUX_SEL_PSA = 1,
+	/* 0 - Input Correction input. 1 - B2B mux input */
+	IPU_DEVICE_GP_ISA_STATIC_AWB_MUX_SEL_INPUT_CORR = 0,
+	IPU_DEVICE_GP_ISA_STATIC_AWB_MUX_SEL_B2B = 1,
+	/* 0 - to Lsc , 1 - to Dpc , 2 - to X2b */
+	IPU_DEVICE_GP_ISA_STATIC_ISA_INPUT_CORR_DEMUX_SEL_LSC = 0,
+	IPU_DEVICE_GP_ISA_STATIC_ISA_INPUT_CORR_DEMUX_SEL_DPC = 1,
+	IPU_DEVICE_GP_ISA_STATIC_ISA_INPUT_CORR_DEMUX_SEL_X2B = 2,
+	/* 0 - Input correction, 1 - Dpc , 2 - X2b */
+	IPU_DEVICE_GP_ISA_STATIC_LSC_MUX_SEL_INPUT_CORR = 0,
+	IPU_DEVICE_GP_ISA_STATIC_LSC_MUX_SEL_DPC = 1,
+	IPU_DEVICE_GP_ISA_STATIC_LSC_MUX_SEL_X2B = 2,
+	/* 0 - to B2b, 1 - to Dpc , 2 - X2b*/
+	IPU_DEVICE_GP_ISA_STATIC_LSC_DEMUX_SEL_B2B = 0,
+	IPU_DEVICE_GP_ISA_STATIC_LSC_DEMUX_SEL_DPC = 1,
+	IPU_DEVICE_GP_ISA_STATIC_LSC_DEMUX_SEL_X2B = 2,
+	/* 0 - Lsc, 1 - Input correction , 2 - X2b */
+	IPU_DEVICE_GP_ISA_STATIC_DPC_MUX_SEL_LSC = 0,
+	IPU_DEVICE_GP_ISA_STATIC_DPC_MUX_SEL_INPUT_CORR = 1,
+	IPU_DEVICE_GP_ISA_STATIC_DPC_MUX_SEL_X2B = 2,
+	/* 0 - to Lsc, 1 - to B2b , 2 - to X2b */
+	IPU_DEVICE_GP_ISA_STATIC_DPC_DEMUX_SEL_LSC = 0,
+	IPU_DEVICE_GP_ISA_STATIC_DPC_DEMUX_SEL_B2B = 1,
+	IPU_DEVICE_GP_ISA_STATIC_DPC_DEMUX_SEL_X2B = 2,
+	/* 0 - Lsc, 1 - X2b, 2 - Input correction */
+	IPU_DEVICE_GP_ISA_STATIC_X2B_MUX_SEL_LSC = 0,
+	IPU_DEVICE_GP_ISA_STATIC_X2B_MUX_SEL_X2B = 1,
+	IPU_DEVICE_GP_ISA_STATIC_X2B_MUX_SEL_INPUT_CORR = 2,
+	/* 0 - Through X2B S2V RGBIR, 1 - Bypass */
+	IPU_DEVICE_GP_ISA_STATIC_SVE_RGBIR_BP_MUX_DEMUX_SEL_SVE_RGBIR = 0,
+	IPU_DEVICE_GP_ISA_STATIC_SVE_RGBIR_BP_MUX_DEMUX_SEL_BYPASS = 1,
+	/* 0 - X2B SVE RGBIR, 1- X2B MD */
+	IPU_DEVICE_GP_ISA_STATIC_IR_DEPTH_MUX_SEL_SVE_RGBIR = 0,
+	IPU_DEVICE_GP_ISA_STATIC_IR_DEPTH_MUX_SEL_MD = 1,
+	/* 0 - to Lsc, 1 - to Dpc, 2 - to B2b */
+	IPU_DEVICE_GP_ISA_STATIC_X2B_DEMUX_SEL_LSC = 0,
+	IPU_DEVICE_GP_ISA_STATIC_X2B_DEMUX_SEL_DPC = 1,
+	IPU_DEVICE_GP_ISA_STATIC_X2B_DEMUX_SEL_B2B = 2,
+	/* 0 - Lsc, 1 - Dpc , 2 - X2b */
+	IPU_DEVICE_GP_ISA_STATIC_B2B_MUX_SEL_LSC = 0,
+	IPU_DEVICE_GP_ISA_STATIC_B2B_MUX_SEL_DPC = 1,
+	IPU_DEVICE_GP_ISA_STATIC_B2B_MUX_SEL_X2B = 2,
+	/* 0 - External PAF CH0/1; 1 - DPC extracted PAF CH0/1; 2 - X2B extracted PAF CH0/ Black Box CH1 */
+	IPU_DEVICE_GP_ISA_STATIC_PAF_SRC_SEL_EXT_PAF = 0,
+	IPU_DEVICE_GP_ISA_STATIC_PAF_SRC_SEL_DPC = 1,
+	IPU_DEVICE_GP_ISA_STATIC_PAF_SRC_SEL_X2B = 2,
+	/* 0 - from R2I; 1 - from B2B - TODO remove after SDK 0.5 as it was removed from design */
+	IPU_DEVICE_GP_ISA_STATIC_ISA_ORIG_OUT_MUX_SEL_R2I = 0,
+	IPU_DEVICE_GP_ISA_STATIC_ISA_ORIG_OUT_MUX_SEL_B2B = 1,
+	/* Blockers */
+	IPU_DEVICE_GP_ISA_STATIC_PORT_BLK_UNBLOCK = 0,
+	IPU_DEVICE_GP_ISA_STATIC_PORT_BLK_BLOCK = 1,
+
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* sis port block options */
 	IPU_DEVICE_GP_ISA_SIS_PORT_UNBLOCK = 0,
 	IPU_DEVICE_GP_ISA_SIS_PORT_BLOCK = 1,
@@ -91,6 +161,45 @@ enum ipu_device_gp_psa_value {
 	/* PSA_V2S_RGB_4_DEMUX */
 	IPU_DEVICE_GP_PSA_DEMUX_POST_V2S_RGB_4_TO_GTM = 0,
 	IPU_DEVICE_GP_PSA_DEMUX_POST_V2S_RGB_4_TO_ACM = 1,
+<<<<<<< HEAD
+=======
+	 * fixed function MAS. Choose between pixel stream and
+	 * delta stream as BNLM output (gpreg 1)
+	 */
+	IPU_DEVICE_GP_PSA_1_NOISE_MUX_BNLM_PIXELS = 0,
+	IPU_DEVICE_GP_PSA_1_NOISE_MUX_DELTA_STREAM = 1,
+	/* enable/disable BNLM Pixel Block (gpreg 2) */
+	IPU_DEVICE_GP_PSA_1_BNLM_PIXEL_STREAM_BLOCK_DISABLE = 0,
+	IPU_DEVICE_GP_PSA_1_BNLM_PIXEL_STREAM_BLOCK_ENABLE = 1,
+	/* enable/disable BNLM delta stream (gpreg 3) */
+	IPU_DEVICE_GP_PSA_1_BNLM_DELTA_STREAM_BLOCK_DISABLE = 0,
+	IPU_DEVICE_GP_PSA_1_BNLM_DELTA_STREAM_BLOCK_ENABLE = 1,
+	/* choose BNLM output to XNR or to WB/DM (gpreg 0) */
+	IPU_DEVICE_GP_PSA_2_BNLM_TO_XNR = 0,
+	IPU_DEVICE_GP_PSA_2_BNLM_TO_WB_DM = 1,
+	/* choose direction of output from vec2str 4 (gpreg 4) */
+	IPU_DEVICE_GP_PSA_2_V2S_RGB_4_TO_GTC = 0,
+	IPU_DEVICE_GP_PSA_2_V2S_RGB_4_TO_ACM = 1,
+	IPU_DEVICE_GP_PSA_2_V2S_RGB_4_TO_VCSC = 2,
+	IPU_DEVICE_GP_PSA_2_V2S_RGB_4_TO_GSTAR = 3,
+	/* enable/disable VCSC input block (gpreg 7) */
+	IPU_DEVICE_GP_PSA_2_VCSC_INPUT_BLOCK_DISABLE = 0,
+	IPU_DEVICE_GP_PSA_2_VCSC_INPUT_BLOCK_ENABLE = 1,
+	/* enable/disable XNR5 bypass block (gpreg 8) */
+	IPU_DEVICE_GP_PSA_2_XNR5_BP_BLOCK_DISABLE = 0,
+	IPU_DEVICE_GP_PSA_2_XNR5_BP_BLOCK_ENABLE = 1,
+	/* choose to use VCSC or bypass it (gpreg 5) */
+	IPU_DEVICE_GP_PSA_3_MUX_USE_VCSC = 0,
+	IPU_DEVICE_GP_PSA_3_MUX_BP_VCSC = 1,
+	/* choose to use XNR5 or bypass it (gpreg 6) */
+	IPU_DEVICE_GP_PSA_3_MUX_USE_XNR5 = 0,
+	IPU_DEVICE_GP_PSA_3_MUX_BP_XNR5 = 1,
+	/* choose which input to use for the BNLM acc */
+	IPU_DEVICE_GP_PSA_1_BNLM_IN_MUX_V2S = 0,
+	IPU_DEVICE_GP_PSA_1_BNLM_IN_MUX_ISA_DOWNSCALED = 1,
+	IPU_DEVICE_GP_PSA_1_BNLM_IN_MUX_ISA_UNSCALED = 2,
+	IPU_DEVICE_GP_PSA_CONF_INVALID = 0xFF
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 enum ipu_device_gp_isl_value {
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h
index dbf1cf9..106d1ce 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/fw_abi_common_types/ia_css_terminal_defs.h
@@ -71,6 +71,13 @@ typedef enum ia_css_terminal_type {
  * Dimensions of the data objects. Note that a C-style
  * data order is assumed. Data stored by row.
  */
+<<<<<<< HEAD
+=======
+/* A strange problem with hivecc compiler which is described
+ * here https://icggerrit.ir.intel.com/#/c/51630/1 forces this
+ * enum to be explicitly initialized for the moment
+ */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 typedef enum ia_css_dimension {
 	/**< The number of columns, i.e. the size of the row */
 	IA_CSS_COL_DIMENSION = 0,
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/psys_server.mk b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/psys_server.mk
index c4462c9..e3abbfd 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/psys_server.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/psys_server.mk
@@ -63,7 +63,10 @@ PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/$(IPU_SYSVER)
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/$(PSYS_SERVER_VERSION)
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/loader/$(PSYS_SERVER_LOADER_VERSION)
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/access_blocker/$(PSYS_ACCESS_BLOCKER_VERSION)
+<<<<<<< HEAD
 PSYS_SERVER_FW_CPPFLAGS += -I$(PSYS_SERVER_SOURCES)/access_blocker/src
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 PSYS_SERVER_FW_CPPFLAGS += -DSSID=$(SSID)
 PSYS_SERVER_FW_CPPFLAGS += -DMMID=$(MMID)
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c
index 6f8aea7..cfb1ad1 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psys_server/src/bxt_spctrl_process_group_cmd_impl.c
@@ -27,6 +27,11 @@
 #include "cpu_mem_support.h"
 #include "ia_css_bxt_spctrl_trace.h"
 
+<<<<<<< HEAD
+=======
+#if !defined(__KERNEL__) && !defined(_MSC_VER)
+/* This section is for FW testing app only */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #if HAS_DUAL_CMD_CTX_SUPPORT
 #define MAX_CLIENT_PGS 8 /* same as test_params.h */
 struct ia_css_process_group_context {
@@ -34,7 +39,11 @@ struct ia_css_process_group_context {
 	bool secure;
 };
 struct ia_css_process_group_context pg_contexts[MAX_CLIENT_PGS];
+<<<<<<< HEAD
 static unsigned int num_of_pgs;
+=======
+int num_of_pgs;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 STORAGE_CLASS_INLINE
 struct ia_css_syscom_context *ia_css_process_group_get_context(ia_css_process_group_t *process_group)
@@ -45,7 +54,11 @@ struct ia_css_syscom_context *ia_css_process_group_get_context(ia_css_process_gr
 	IA_CSS_TRACE_0(BXT_SPCTRL, INFO,
 		"ia_css_process_group_get_context(): enter:\n");
 
+<<<<<<< HEAD
 	for (i = 0; i < num_of_pgs; i++) {
+=======
+	for (i = 0; i < MAX_CLIENT_PGS; i++) {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		if (pg_contexts[i].pg == process_group) {
 			secure = pg_contexts[i].secure;
 			break;
@@ -85,6 +98,20 @@ int ia_css_process_group_store(ia_css_process_group_t *process_group, bool secur
 }
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
 
+<<<<<<< HEAD
+=======
+#else /* !defined(__KERNEL__) && !defined(_MSC_VER) */
+/* This section is for driver environment. */
+STORAGE_CLASS_INLINE
+struct ia_css_syscom_context *ia_css_process_group_get_context(ia_css_process_group_t *process_group)
+{
+	NOT_USED(process_group);
+
+	return psys_syscom;
+}
+#endif /* !defined(__KERNEL__) && !defined(_MSC_VER) */
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ia_css_process_group_on_create(
 	ia_css_process_group_t			*process_group,
 	const ia_css_program_group_manifest_t	*program_group_manifest,
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h
index f08a057..7f4e30c4 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/data/src/ia_css_program_group_data_impl.h
@@ -17,7 +17,10 @@
 
 #include "ia_css_program_group_data.h"
 #include "ia_css_psys_data_trace.h"
+<<<<<<< HEAD
 #include "ia_css_terminal_defs.h"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <error_support.h>	/* for verifexit */
 #include <assert_support.h>	/* for COMPILATION_ERROR_IF */
 #include <misc_support.h>	/* for NOT_USED */
@@ -333,12 +336,21 @@ int ia_css_frame_descriptor_print(
 	IA_CSS_TRACE_1(PSYSAPI_DATA, INFO,
 		"\tstride[%d] = {\n", IA_CSS_N_DATA_DIMENSION - 1);
 	i = 0;
+<<<<<<< HEAD
 	if (IA_CSS_N_DATA_DIMENSION > 2) {
 		for (i = 0; i < (int)IA_CSS_N_DATA_DIMENSION - 2; i++) {
 			IA_CSS_TRACE_1(PSYSAPI_DATA, INFO,
 				"\t%4d,\n", frame_descriptor->stride[i]);
 		}
 	}
+=======
+#if IA_CSS_N_DATA_DIMENSION > 2
+	for (i = 0; i < (int)IA_CSS_N_DATA_DIMENSION - 2; i++) {
+		IA_CSS_TRACE_1(PSYSAPI_DATA, INFO,
+			"\t%4d,\n", frame_descriptor->stride[i]);
+	}
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	IA_CSS_TRACE_1(PSYSAPI_DATA, INFO,
 		"\t%4d }\n", frame_descriptor->stride[i]);
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h
index dc8fa531..9132738 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/interface/ia_css_psys_device.h
@@ -105,10 +105,16 @@ extern struct ia_css_syscom_config *ia_css_psys_specify(void);
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /*! Create the syscom creation descriptor for secure stream
 
+<<<<<<< HEAD
  @param	vtl0_addr_mask[in]	VTL0 address mask that will be stored in 'secure' ctx
  @return NULL on error
  */
 extern struct ia_css_syscom_config *ia_css_psys_specify_secure(unsigned int vtl0_addr_mask);
+=======
+ @return NULL on error
+ */
+extern struct ia_css_syscom_config *ia_css_psys_specify_secure(void);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 /*! Compute the size of storage required for allocating the Psys syscom object
@@ -137,6 +143,7 @@ extern struct ia_css_syscom_context *ia_css_psys_context_create(
 	const struct ia_css_psys_buffer_s *buffer,
 	struct ia_css_syscom_config *config);
 
+<<<<<<< HEAD
 /*! Store the parameters of the Psys syscom object in DMEM, so
     they can be communicated with FW. This step needs to be invoked
     after SPC starts in ia_css_psys_open(), so SPC DMEM access blocker
@@ -150,6 +157,8 @@ extern int ia_css_psys_context_store_dmem(
 	struct ia_css_syscom_context *context,
 	struct ia_css_syscom_config *config);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /*! Start PSYS Server. Psys syscom object must have been created already.
     Target for VTIO usage where multiple syscom objects need to be
     created first before this API is invoked.
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c
index c3ed98a..7937e5e 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/device/src/ia_css_psys_device.c
@@ -16,7 +16,10 @@
 #include "ia_css_psys_device.h"
 #include "ia_css_psys_device_trace.h"
 #include "ia_css_psys_init.h"
+<<<<<<< HEAD
 #include "regmem_access.h"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #include <error_support.h>
 #include <print_support.h>
@@ -98,7 +101,10 @@ static void set_syscom_config(struct ia_css_syscom_config *config)
 	}
 	config->input = ia_css_psys_cmd_queue_cfg;
 	config->output = ia_css_psys_event_queue_cfg;
+<<<<<<< HEAD
 	config->vtl0_addr_mask = 0;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 struct ia_css_syscom_config *ia_css_psys_specify(void)
@@ -113,6 +119,7 @@ struct ia_css_syscom_config *ia_css_psys_specify(void)
 }
 
 #if HAS_DUAL_CMD_CTX_SUPPORT
+<<<<<<< HEAD
 struct ia_css_syscom_config *ia_css_psys_specify_secure(unsigned int vtl0_addr_mask)
 {
 	struct ia_css_syscom_config *config = &psys_syscom_config_secure;
@@ -121,6 +128,15 @@ struct ia_css_syscom_config *ia_css_psys_specify_secure(unsigned int vtl0_addr_m
 	set_syscom_config(config);
 	config->secure = true;
 	config->vtl0_addr_mask = vtl0_addr_mask;
+=======
+struct ia_css_syscom_config *ia_css_psys_specify_secure(void)
+{
+	struct ia_css_syscom_config *config = &psys_syscom_config_secure;
+
+	IA_CSS_TRACE_0(PSYSAPI_DEVICE, INFO, "ia_css_psys_specify_secure(): enter:\n");
+	set_syscom_config(config);
+	config->secure = true;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	return config;
 }
 #endif
@@ -182,6 +198,7 @@ struct ia_css_syscom_context *ia_css_psys_context_create(
 {
 	return psys_context_create(buffer, config);
 }
+<<<<<<< HEAD
 
 /* push context information to DMEM for FW to access */
 int ia_css_psys_context_store_dmem(
@@ -190,6 +207,8 @@ int ia_css_psys_context_store_dmem(
 {
 	return ia_css_syscom_store_dmem(context, config->ssid, config->vtl0_addr_mask);
 }
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 /* Internal function to start psys server */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h
index 530f93e..b83544c 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/interface/ia_css_psys_process_group_cmd_impl.h
@@ -22,8 +22,13 @@
 #define N_UINT64_IN_PROCESS_GROUP_STRUCT	2
 #define N_UINT32_IN_PROCESS_GROUP_STRUCT	5
 #define N_UINT16_IN_PROCESS_GROUP_STRUCT	5
+<<<<<<< HEAD
 #define N_UINT8_IN_PROCESS_GROUP_STRUCT		7
 #define N_PADDING_UINT8_IN_PROCESS_GROUP_STRUCT	3
+=======
+#define N_UINT8_IN_PROCESS_GROUP_STRUCT		6
+#define N_PADDING_UINT8_IN_PROCESS_GROUP_STRUCT	4
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define SIZE_OF_PROCESS_GROUP_STRUCT_BITS \
 	(IA_CSS_RBM_BITS \
@@ -88,8 +93,11 @@ struct ia_css_process_group_s {
 	uint8_t base_queue_id;
 	/**< Number of dedicated queues used */
 	uint8_t num_queues;
+<<<<<<< HEAD
 	/**< Mask the send_pg_done IRQ */
 	uint8_t mask_irq;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/**< Padding for 64bit alignment */
 	uint8_t padding[N_PADDING_UINT8_IN_PROCESS_GROUP_STRUCT];
 };
@@ -163,6 +171,10 @@ extern int ia_css_enqueue_param_buffer_set(
 	ia_css_process_group_t				*process_group,
 	ia_css_buffer_set_t				*buffer_set);
 
+<<<<<<< HEAD
+=======
+#if !defined(__KERNEL__) && !defined(_MSC_VER)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /*! Need to store the 'secure' mode for each PG for FW test app only
  *
  * @param	process_group[in]		process group object
@@ -173,6 +185,10 @@ extern int ia_css_enqueue_param_buffer_set(
 extern int ia_css_process_group_store(
 	ia_css_process_group_t				*process_group,
 	bool						secure);
+<<<<<<< HEAD
 
+=======
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #endif /* __IA_CSS_PSYS_PROCESS_GROUP_CMD_IMPL_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c
index f9e060f..d7bd99a 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/dynamic/src/ia_css_psys_process.c
@@ -15,7 +15,10 @@
 #include "ia_css_psys_process.h"
 #include "ia_css_psys_dynamic_storage_class.h"
 #include "ia_css_psys_process_private_types.h"
+<<<<<<< HEAD
 #include <misc_support.h>	/* for NOT_USED */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*
  * Functions to possibly inline
@@ -918,7 +921,10 @@ int ia_css_process_print(const ia_css_process_t *process, void *fid)
 			(int)vied_nci_cell_get_mem_type(cell_id, mem_index),
 			(int)mem_id,
 			process->ext_mem_offset[mem_index]);
+<<<<<<< HEAD
 		NOT_USED(mem_id);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	}
 	for (dev_chn_index = 0; dev_chn_index < (int)VIED_NCI_N_DEV_CHN_ID;
 		dev_chn_index++) {
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c
index be1ef96..64bcfcf 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_program_manifest.c
@@ -1059,6 +1059,7 @@ void ia_css_program_manifest_init(
    supported in the firmware
   */
 #if !defined(__HIVECC)
+<<<<<<< HEAD
 
 #if defined(_MSC_VER)
 /* WA for a visual studio compiler bug, refer to
@@ -1067,6 +1068,8 @@ void ia_css_program_manifest_init(
 #pragma optimize("", off)
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ia_css_program_manifest_print(
 	const ia_css_program_manifest_t *manifest,
 	void *fid)
@@ -1231,11 +1234,14 @@ int ia_css_program_manifest_print(
 	}
 	return retval;
 }
+<<<<<<< HEAD
 
 #if defined(_MSC_VER)
 /* WA for a visual studio compiler bug */
 #pragma optimize("", off)
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_terminal_manifest.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_terminal_manifest.c
index 80ff0d5..dbf67ef 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_terminal_manifest.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/psysapi/static/src/ia_css_psys_terminal_manifest.c
@@ -1007,9 +1007,12 @@ int ia_css_terminal_manifest_print(
 		PRINT_DIMENSION("max_frame_grid_dimension",
 			framed->max_frame_grid_dimension);
 
+<<<<<<< HEAD
 		NOT_USED(framed);
 		NOT_USED(fragd);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		for (sec_index = 0; sec_index < sec_count; sec_index++) {
 			sec = ia_css_spatial_param_terminal_manifest_get_frm_grid_prm_sct_desc(
 				stm, sec_index);
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/reg_dump/src/reg_dump_generic_bridge.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/reg_dump/src/reg_dump_generic_bridge.c
index 18d0c98..0e474b1b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/reg_dump/src/reg_dump_generic_bridge.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/reg_dump/src/reg_dump_generic_bridge.c
@@ -26,8 +26,20 @@
 #define REG_DUMP_TRACE_METHOD IA_CSS_TRACE_METHOD_NATIVE
 #define REG_DUMP_TRACE_LEVEL_VERBOSE IA_CSS_TRACE_LEVEL_ENABLED
 
+<<<<<<< HEAD
 /* SSID value is defined in test makefiles as either isys0 or psys0 */
 #define REG_DUMP_READ_REGISTER(addr)    vied_subsystem_load_32(SSID, addr)
+=======
+#ifdef USE_SSID_BUTTRESS
+ * seen from the host; these addresses already contain the ISYS or PSYS offset.
+ */
+#define REG_DUMP_READ_REGISTER(addr)\
+	 vied_subsystem_load_32(IPU_DEVICE_BUTTRESS, addr)
+#else
+/* SSID value is defined in test makefiles as either isys0 or psys0 */
+#define REG_DUMP_READ_REGISTER(addr)    vied_subsystem_load_32(SSID, addr)
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define REG_DUMP_PRINT_0(...) \
 EXPAND_VA_ARGS(IA_CSS_TRACE_0(REG_DUMP, VERBOSE, __VA_ARGS__))
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/regmem/interface/regmem_access.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/regmem/interface/regmem_access.h
index d4576af..d8a15cb 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/regmem/interface/regmem_access.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/regmem/interface/regmem_access.h
@@ -28,6 +28,7 @@ enum regmem_id {
 	SYSCOM_COMMAND_REG	= 3,
 	/* Store interrupt status - updated by SP */
 	SYSCOM_IRQ_REG		= 4,
+<<<<<<< HEAD
 	/* Store VTL0_ADDR_MASK in trusted secure regision - provided by host.*/
 	SYSCOM_VTL0_ADDR_MASK	= 5,
 #if HAS_DUAL_CMD_CTX_SUPPORT
@@ -51,6 +52,12 @@ enum regmem_id {
 #define SYSCOM_IRQ_VTL1_MASK 0x2
 #endif
 
+=======
+	/* first syscom queue pointer register */
+	SYSCOM_QPR_BASE_REG	= 5
+};
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 STORAGE_CLASS_INLINE unsigned int
 regmem_load_32(unsigned int mem_address, unsigned int reg, unsigned int ssid);
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/assert_support.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/assert_support.h
index f904a49..2b36d84 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/assert_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/assert_support.h
@@ -39,6 +39,12 @@
  * should not depend on assert to function (actually the assert
  * could be disabled in a release build) it was decided to
  * disable the assert for KW scans (by defining NDEBUG)
+<<<<<<< HEAD
+=======
+ * see also:
+ * http://www.klocwork.com/products/documentation/current/
+ * Tuning_C/C%2B%2B_analysis#Assertions
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
  */
 #define NDEBUG
 #endif /* __KLOCWORK__ */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/math_support.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/math_support.h
index 633f86f..53efe9b 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/math_support.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/support/math_support.h
@@ -44,7 +44,10 @@
 #define IS_ODD(a) ((a) & 0x1)
 #define IS_EVEN(a) (!IS_ODD(a))
 #define IS_POWER2(a) (!((a)&((a)-1)))
+<<<<<<< HEAD
 #define IS_MASK_BITS_SET(a, b)	((a & b) != 0)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /*To Find next power of 2 number from x */
 #define bit2(x)            ((x)      | ((x) >> 1))
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h
index 5426d6d..c7d7eef 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom.h
@@ -206,6 +206,7 @@ ia_css_syscom_recv_port_transfer(
 	void *token
 );
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /**
  * ia_css_syscom_store_dmem() - store subsystem context information in DMEM
@@ -244,4 +245,6 @@ ia_css_syscom_is_ab_spc_ready(
 );
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* __IA_CSS_SYSCOM_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h
index 8c827c2..0f2b977 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/interface/ia_css_syscom_config.h
@@ -91,7 +91,10 @@ struct ia_css_syscom_config {
 	 * if false, non-secure syscom
 	 */
 	bool secure;
+<<<<<<< HEAD
 	unsigned int vtl0_addr_mask; /* only applicable in 'secure' case */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 #endif /* __IA_CSS_SYSCOM_CONFIG_H */
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom.c
index cdf9df0..793790a 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom.c
@@ -349,7 +349,10 @@ ia_css_syscom_open(
 	ia_css_cpu_mem_cache_flush((void *)HOST_ADDRESS(ctx->config_host_addr),
 				    sizeof(struct ia_css_syscom_config_fw));
 
+<<<<<<< HEAD
 #if !HAS_DUAL_CMD_CTX_SUPPORT
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	/* store syscom uninitialized state */
 	IA_CSS_TRACE_3(SYSCOM, INFO, "ia_css_syscom_open store STATE_REG (%#x) @ dmem_addr %#x ssid %d\n",
 		       SYSCOM_STATE_UNINIT, ctx->cell_dmem_addr, cfg->ssid);
@@ -365,6 +368,12 @@ ia_css_syscom_open(
 		       ctx->config_vied_addr, ctx->cell_dmem_addr, cfg->ssid);
 	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_CONFIG_REG,
 			ctx->config_vied_addr, cfg->ssid);
+<<<<<<< HEAD
+=======
+#if HAS_DUAL_CMD_CTX_SUPPORT
+	/* clear IRQ status */
+	regmem_store_32(ctx->cell_dmem_addr, SYSCOM_IRQ_REG, 0x0, cfg->ssid);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 	/* Indicate if ctx is created for secure stream purpose */
@@ -563,6 +572,7 @@ ia_css_syscom_recv_port_transfer(
 
 	return recv_port_transfer(ctx->recv_port + port, token);
 }
+<<<<<<< HEAD
 
 #if HAS_DUAL_CMD_CTX_SUPPORT
 /*
@@ -648,3 +658,5 @@ ia_css_syscom_is_ab_spc_ready(
 	return (value == AB_SPC_READY);
 }
 #endif /* HAS_DUAL_CMD_CTX_SUPPORT */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h
index 0cacd5a..9bb3209 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/src/ia_css_syscom_config_fw.h
@@ -33,6 +33,7 @@ enum {
 	SYSCOM_COMMAND_INACTIVE = 0x57A7F001
 };
 
+<<<<<<< HEAD
 #if HAS_DUAL_CMD_CTX_SUPPORT
 enum {
 	/* Program load or explicit host setting should init to this */
@@ -51,6 +52,8 @@ enum {
 };
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* firmware config: data that sent from the host to SP via DDR */
 /* Cell copies data into a context */
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/syscom.mk b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/syscom.mk
index 8d36b89..fabb815 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/syscom.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/syscom/syscom.mk
@@ -22,7 +22,10 @@ SYSCOM_SOURCES1=$(SYSCOM_DIR)/src
 SYSCOM_HOST_FILES += $(SYSCOM_SOURCES1)/ia_css_syscom.c
 
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_INTERFACE)
+<<<<<<< HEAD
 SYSCOM_HOST_CPPFLAGS += -I$(SYSCOM_SOURCES1)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 SYSCOM_HOST_CPPFLAGS += -I$${MODULES_DIR}/devices
 ifdef REGMEM_SECURE_OFFSET
 SYSCOM_HOST_CPPFLAGS += -DREGMEM_SECURE_OFFSET=$(REGMEM_SECURE_OFFSET)
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/vied_parameters/vied_parameters.mk b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/vied_parameters/vied_parameters.mk
index 834a1a4..3a4f549 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/vied_parameters/vied_parameters.mk
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/lib/vied_parameters/vied_parameters.mk
@@ -72,5 +72,9 @@ VIED_PARAMETERS_FW_CPPFLAGS +=  $(VIED_PARAMETERS_SUPPORT_CPPFLAGS)
 #For IPU interface
 include $(MODULES_DIR)/fw_abi_common_types/cpu/fw_abi_cpu_types.mk
 VIED_PARAMETERS_HOST_CPPFLAGS += $(FW_ABI_COMMON_TYPES_HOST_CPPFLAGS)
+<<<<<<< HEAD
+=======
+endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 VIED_PARAMETERS_FW_CPPFLAGS   += $(FW_ABI_COMMON_TYPES_FW_CPPFLAGS)
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/libcsspsys2600.c b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/libcsspsys2600.c
index 805d154..b861ac7 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/libcsspsys2600.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/lib2600psys/libcsspsys2600.c
@@ -13,10 +13,18 @@
 
 #include <linux/delay.h>
 #include <linux/module.h>
+<<<<<<< HEAD
+=======
+#include "libcsspsys2600.h"
+#include <vied_nci_psys_resource_model.h>
+#include <ia_css_psys_device.h>
+#include <ipu_device_cell_properties_func.h>
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #include <uapi/linux/ipu-psys.h>
 
 #include "ipu.h"
+<<<<<<< HEAD
 #include "ipu-mmu.h"
 #include "ipu-psys.h"
 #include "ipu-wrapper.h"
@@ -28,6 +36,130 @@
 #include <ipu_device_cell_properties_func.h>
 #include <ia_css_psys_program_group_private.h>
 #include <ia_css_psys_process_private_types.h>
+=======
+#include "ipu-fw-psys.h"
+#include "ipu-psys.h"
+#include "ipu-fw-resources.h"
+#include "ipu-wrapper.h"
+#include "ipu-mmu.h"
+
+#include <ia_css_psys_process_group_cmd_impl.h>
+#include <ia_css_psys_process_private_types.h>
+#include <ia_css_psys_init.h>
+#include <ia_css_psys_transport.h>
+#include <ia_css_terminal_base_types.h>
+#include <ia_css_terminal_types.h>
+#include <ia_css_program_group_param_types.h>
+#include <ia_css_psys_terminal_private_types.h>
+#include <ia_css_program_group_data.h>
+#include <ia_css_psys_program_group_private.h>
+
+#define BASIC_ABI_CHECK
+
+#ifndef BASIC_ABI_CHECK
+#define ABI_CHECK(a, b, field)					\
+	{								\
+	if (offsetof(typeof(*a), field) != offsetof(typeof(*b), field))	\
+		pr_err("intel_ipu4 psys ABI mismatch %s\n",		\
+		       __stringify(field));		    \
+	}
+#else
+#define ABI_CHECK(a, b, field) { }
+#endif
+
+#define SIZE_OF_CHECK(a, b) \
+	{		    \
+	if (sizeof(*a) != sizeof(*b))\
+		pr_err("intel_ipu4 psys ABI size of mismatch %s\n",	\
+		       __stringify(a));					\
+	}								\
+
+static void abi_sanity_checker(void)
+{
+	struct ipu_fw_psys_process_group *ipu_fw_psys_pg;
+	struct ia_css_process_group_s *ia_css_pg;
+
+	struct ipu_fw_psys_process *ipu_fw_psys_ps;
+	struct ia_css_process_s *ia_css_ps;
+
+	struct ipu_fw_psys_srv_init *ipu_fw_psys_init;
+	struct ia_css_psys_server_init *ia_css_psys_init;
+
+	struct ipu_fw_psys_cmd *ipu_fw_psys_cmd;
+	struct ia_css_psys_cmd_s *ia_css_psys_cmd;
+
+	struct ipu_fw_psys_event *ipu_fw_psys_event;
+	struct ia_css_psys_event_s *ia_css_psys_event;
+
+	struct ipu_fw_psys_terminal *ipu_fw_psys_terminal;
+	struct ia_css_terminal_s *ia_css_terminal;
+
+	struct ipu_fw_psys_param_terminal *ipu_fw_psys_param_terminal;
+	struct ia_css_param_terminal_s *ia_css_param_terminal;
+
+	struct ipu_fw_psys_param_payload *ipu_fw_psys_param_payload;
+	struct ia_css_param_payload_s *ia_css_param_payload;
+
+	struct ipu_fw_psys_data_terminal *ipu_fw_psys_data_terminal;
+	struct ia_css_data_terminal_s *ia_css_data_terminal;
+
+	struct ipu_fw_psys_frame *ipu_fw_psys_frame;
+	struct ia_css_frame_s *ia_css_frame;
+
+	struct ipu_fw_psys_frame_descriptor *ipu_fw_psys_frame_descriptor;
+	struct ia_css_frame_descriptor_s *ia_css_frame_descriptor;
+
+	struct ipu_fw_psys_stream *ipu_fw_psys_stream;
+	struct ia_css_stream_s *ia_css_stream;
+
+	SIZE_OF_CHECK(ipu_fw_psys_pg, ia_css_pg);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, ID);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, process_count);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, processes_offset);
+	ABI_CHECK(ipu_fw_psys_pg, ia_css_pg, routing_bitmap);
+
+	SIZE_OF_CHECK(ipu_fw_psys_ps, ia_css_ps);
+	ABI_CHECK(ipu_fw_psys_ps, ia_css_ps, ID);
+	ABI_CHECK(ipu_fw_psys_ps, ia_css_ps, dev_chn_offset);
+	ABI_CHECK(ipu_fw_psys_ps, ia_css_ps, cell_id);
+
+	SIZE_OF_CHECK(ipu_fw_psys_init, ia_css_psys_init);
+	ABI_CHECK(ipu_fw_psys_init, ia_css_psys_init, icache_prefetch_sp);
+	ABI_CHECK(ipu_fw_psys_init, ia_css_psys_init, icache_prefetch_isp);
+
+	SIZE_OF_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd);
+	ABI_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd, command);
+	ABI_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd, msg);
+	ABI_CHECK(ipu_fw_psys_cmd, ia_css_psys_cmd, context_handle);
+
+	SIZE_OF_CHECK(ipu_fw_psys_event, ia_css_psys_event);
+	ABI_CHECK(ipu_fw_psys_event, ia_css_psys_event, status);
+	ABI_CHECK(ipu_fw_psys_event, ia_css_psys_event, token);
+
+	SIZE_OF_CHECK(ipu_fw_psys_terminal, ia_css_terminal);
+	ABI_CHECK(ipu_fw_psys_terminal, ia_css_terminal, terminal_type);
+
+	SIZE_OF_CHECK(ipu_fw_psys_param_terminal, ia_css_param_terminal);
+	ABI_CHECK(ipu_fw_psys_param_terminal, ia_css_param_terminal,
+		  param_payload);
+
+	SIZE_OF_CHECK(ipu_fw_psys_param_payload, ia_css_param_payload);
+	ABI_CHECK(ipu_fw_psys_param_payload, ia_css_param_payload, buffer);
+
+	SIZE_OF_CHECK(ipu_fw_psys_data_terminal, ia_css_data_terminal);
+	ABI_CHECK(ipu_fw_psys_data_terminal, ia_css_data_terminal, frame);
+	ABI_CHECK(ipu_fw_psys_data_terminal, ia_css_data_terminal,
+		  connection_type);
+
+	SIZE_OF_CHECK(ipu_fw_psys_frame, ia_css_frame);
+	ABI_CHECK(ipu_fw_psys_frame, ia_css_frame, data_bytes);
+	ABI_CHECK(ipu_fw_psys_frame, ia_css_frame, data);
+	ABI_CHECK(ipu_fw_psys_frame, ia_css_frame, buffer_state);
+
+	SIZE_OF_CHECK(ipu_fw_psys_frame_descriptor, ia_css_frame_descriptor);
+	SIZE_OF_CHECK(ipu_fw_psys_stream, ia_css_stream);
+}
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 int ipu_fw_psys_pg_start(struct ipu_psys_kcmd *kcmd)
 {
@@ -148,7 +280,11 @@ void ipu_fw_psys_pg_dump(struct ipu_psys *psys,
 		ia_css_process_group_get_program_group_ID(pg);
 	uint8_t processes = ia_css_process_group_get_process_count(
 		(ia_css_process_group_t *)kcmd->kpg->pg);
+<<<<<<< HEAD
 	unsigned int p, chn, mem;
+=======
+	unsigned int p, chn, dfm, mem;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	dev_dbg(&psys->adev->dev, "%s %s pgid %i has %i processes\n",
 		__func__, note, pgid, processes);
@@ -166,6 +302,15 @@ void ipu_fw_psys_pg_dump(struct ipu_psys *psys,
 			"%s pgid %i process %i kernel bitmap 0x%llx \n",
 			__func__, pgid, p,
 			ia_css_process_get_kernel_bitmap(process));
+<<<<<<< HEAD
+=======
+		for (dfm = 0; dfm < VIED_NCI_N_DEV_DFM_ID; dfm++ ) {
+			dev_dbg(&psys->adev->dev,
+				"%s pgid %i process %i dfm port bitmap 0x%x \n",
+				__func__, pgid, p,
+				ia_css_process_get_dfm_port_bitmap(process, dfm));
+		}
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		for (mem = 0; mem < VIED_NCI_N_DATA_MEM_TYPE_ID; mem++ ) {
 			unsigned int mem_id = process->ext_mem_id[mem];
 			dev_dbg(&psys->adev->dev,
@@ -257,7 +402,10 @@ int ipu_fw_psys_pg_get_protocol(
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_pg_get_protocol);
 
+<<<<<<< HEAD
 static int libcsspsys2600_init(void);
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 int ipu_fw_psys_open(struct ipu_psys *psys)
 {
 	bool opened;
@@ -265,8 +413,11 @@ int ipu_fw_psys_open(struct ipu_psys *psys)
 
 	ipu_wrapper_init(PSYS_MMID, &psys->adev->dev,
 				psys->pdata->base);
+<<<<<<< HEAD
 	/* When fw psys open, make sure csslib init first */
 	libcsspsys2600_init();
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	server_init->icache_prefetch_sp = psys->icache_prefetch_sp;
 	server_init->icache_prefetch_isp = psys->icache_prefetch_isp;
@@ -335,7 +486,58 @@ u64 ipu_fw_psys_pg_get_token(struct ipu_psys_kcmd *kcmd)
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_pg_get_token);
 
+<<<<<<< HEAD
 static const struct ipu_fw_resource_definitions default_defs = {
+=======
+int ipu_fw_psys_ppg_set_buffer_set(struct ipu_psys_kcmd *kcmd,
+				    struct ipu_fw_psys_terminal *terminal,
+				    int terminal_idx, u32 buffer)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_set_buffer_set);
+
+size_t
+ipu_fw_psys_ppg_get_buffer_set_size(struct ipu_psys_kcmd *kcmd)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_get_buffer_set_size);
+
+int
+ipu_fw_psys_ppg_buffer_set_vaddress(struct ipu_fw_psys_buffer_set *buf_set,
+				     u32 vaddress)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_buffer_set_vaddress);
+
+struct ipu_fw_psys_buffer_set *
+ipu_fw_psys_ppg_create_buffer_set(struct ipu_psys_kcmd *kcmd,
+				   void *kaddr, u32 frame_counter)
+{
+	return NULL;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_create_buffer_set);
+
+int
+ipu_fw_psys_ppg_enqueue_bufs(struct ipu_psys_kcmd *kcmd,
+			      unsigned int queue_offset)
+{
+	return 0;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_ppg_enqueue_bufs);
+
+void ipu_fw_psys_register_ctx_addr(void *ctx_cpu_addr, u32 ctx_vied_addr)
+{}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_register_ctx_addr);
+
+void ipu_fw_psys_unregister_ctx_addr(void *ctx_cpu_addr, u32 ctx_vied_addr)
+{}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_unregister_ctx_addr);
+
+static const struct ipu_resource_definitions default_defs = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	.cells = vied_nci_cell_type,
 	.num_cells = VIED_NCI_N_CELL_ID,
 	.num_cells_type = VIED_NCI_N_CELL_TYPE_ID,
@@ -348,6 +550,7 @@ static const struct ipu_fw_resource_definitions default_defs = {
 
 	.cell_mem_row = VIED_NCI_N_MEM_TYPE_ID,
 	.cell_mem = (enum ipu_mem_id *)vied_nci_cell_mem,
+<<<<<<< HEAD
 };
 
 const struct ipu_fw_resource_definitions *res_defs = &default_defs;
@@ -358,11 +561,36 @@ int ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
 {
 	return ia_css_process_set_cell((ia_css_process_t *)ptr,
 				       (vied_nci_cell_ID_t)value);
+=======
+	.process.ext_mem_id = offsetof(struct ia_css_process_s,
+				       ext_mem_id[0]),
+	.process.ext_mem_offset = offsetof(struct ia_css_process_s,
+					   ext_mem_offset[0]),
+	.process.dev_chn_offset = offsetof(struct ia_css_process_s,
+					   dev_chn_offset[0]),
+	.process.cell_id = offsetof(struct ia_css_process_s, cell_id),
+};
+
+const struct ipu_resource_definitions *res_defs = &default_defs;
+EXPORT_SYMBOL_GPL(res_defs);
+
+/*
+ * Extension library gives byte offsets to its internal structures.
+ * use those offsets to update fields. Without extension lib access
+ * structures directly.
+ */
+void ipu_fw_psys_set_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index,
+				u8 value)
+{
+	/* Byte offset */
+	*((u8 *)ptr + res_defs->process.cell_id) = value;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_cell_id);
 
 u8 ipu_fw_psys_get_process_cell_id(struct ipu_fw_psys_process *ptr, u8 index)
 {
+<<<<<<< HEAD
 	return ia_css_process_get_cell((ia_css_process_t *)ptr);
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_get_process_cell_id);
@@ -388,6 +616,38 @@ int ipu_fw_psys_set_process_ext_mem(struct ipu_fw_psys_process *ptr,
 	return ia_css_process_set_ext_mem((ia_css_process_t *)ptr, mem_id, offset);
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_ext_mem);
+=======
+	/* Byte offset */
+	return *((u8 *)ptr + res_defs->process.cell_id);
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_get_process_cell_id);
+
+void ipu_fw_psys_set_process_dev_chn_offset(struct ipu_fw_psys_process *ptr,
+				       u16 offset, u16 value)
+{
+	/* dev_chn_offset is a byte offset, offset is u16 index */
+	*((u16 *)((u8 *)ptr + res_defs->process.dev_chn_offset) +
+		 offset) = value;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_dev_chn_offset);
+
+void ipu_fw_psys_set_process_ext_mem_offset(struct ipu_fw_psys_process *ptr,
+				       u16 offset, u16 value)
+{
+	/* ext_mem_offset is a byte offset, offset is u16 index */
+	*((u16 *)((u8 *)ptr + res_defs->process.ext_mem_offset) +
+		  offset) = value;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_ext_mem_offset);
+
+void ipu_fw_psys_set_process_ext_mem_id(struct ipu_fw_psys_process *ptr,
+				   u16 offset, u8 value)
+{
+	/* ext_mem_id is a byte offset, offset parameter is u8 index */
+	*((u8 *)ptr + res_defs->process.ext_mem_id + offset) = value;
+}
+EXPORT_SYMBOL_GPL(ipu_fw_psys_set_process_ext_mem_id);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 int ipu_fw_psys_get_program_manifest_by_process(
 	struct ipu_fw_generic_program_manifest *gen_pm,
@@ -423,6 +683,7 @@ int ipu_fw_psys_get_program_manifest_by_process(
 }
 EXPORT_SYMBOL_GPL(ipu_fw_psys_get_program_manifest_by_process);
 
+<<<<<<< HEAD
 static int libcsspsys2600_init(void)
 {
 	int rval;
@@ -430,20 +691,35 @@ static int libcsspsys2600_init(void)
 
 	if (csslib_init)
 		return 0;
+=======
+static int __init libcsspsys2600_init(void)
+{
+	int rval;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	syscom_buffer = kzalloc(ia_css_sizeof_psys(NULL), GFP_KERNEL);
 	if (!syscom_buffer)
 		return -ENOMEM;
 
+<<<<<<< HEAD
 	syscom_config = kzalloc(sizeof(struct ia_css_syscom_config),
 				GFP_KERNEL);
+=======
+	syscom_config = kzalloc(
+		sizeof(struct ia_css_syscom_config), GFP_KERNEL);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (!syscom_config) {
 		rval = -ENOMEM;
 		goto out_syscom_buffer_free;
 	}
 
+<<<<<<< HEAD
 	server_init = kzalloc(sizeof(struct ia_css_psys_server_init),
 			      GFP_KERNEL);
+=======
+	server_init = kzalloc(
+		sizeof(struct ia_css_psys_server_init), GFP_KERNEL);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (!server_init) {
 		rval = -ENOMEM;
 		goto out_syscom_config_free;
@@ -455,6 +731,7 @@ static int libcsspsys2600_init(void)
 
 	*syscom_config = *ia_css_psys_specify();
 	syscom_config->specific_addr = server_init;
+<<<<<<< HEAD
 	syscom_config->specific_size = sizeof(struct ia_css_psys_server_init);
 	syscom_config->ssid = PSYS_SSID;
 	syscom_config->mmid = PSYS_MMID;
@@ -463,6 +740,19 @@ static int libcsspsys2600_init(void)
 	syscom_config->dmem_addr = ipu_device_cell_memory_address(SPC0,
 					IPU_DEVICE_SP2600_CONTROL_DMEM);
 	csslib_init = true;
+=======
+	syscom_config->specific_size =
+		sizeof(struct ia_css_psys_server_init);
+	syscom_config->ssid = PSYS_SSID;
+	syscom_config->mmid = PSYS_MMID;
+	syscom_config->regs_addr =
+		ipu_device_cell_memory_address(
+			SPC0, IPU_DEVICE_SP2600_CONTROL_REGS);
+	syscom_config->dmem_addr =
+		ipu_device_cell_memory_address(
+			SPC0, IPU_DEVICE_SP2600_CONTROL_DMEM);
+	abi_sanity_checker();
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return 0;
 
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-css/libintel-ipu4p.c b/drivers/media/pci/intel/ipu4/ipu4p-css/libintel-ipu4p.c
index 242bab24..0e83870 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-css/libintel-ipu4p.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-css/libintel-ipu4p.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-LIcense_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 // Copyright (C) 2014 - 2018 Intel Corporation
 
 #include <linux/module.h>
@@ -7,8 +11,12 @@
 #include "ipu-isys.h"
 #include "ipu-wrapper.h"
 #include <ia_css_isysapi.h>
+<<<<<<< HEAD
 
 #include "ipu-platform.h"
+=======
+#include "libintel-checker.h"
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define ipu_lib_call_notrace_unlocked(func, isys, ...)		\
 	({								\
@@ -56,11 +64,17 @@ int ipu_fw_isys_close(struct ipu_isys *isys)
 	 * some time as the FW must stop its actions including code fetch
 	 * to SP icache.
 	 */
+<<<<<<< HEAD
 	mutex_lock(&isys->lib_mutex);
 	spin_lock_irqsave(&isys->power_lock, flags);
 	rval = ipu_lib_call_notrace_unlocked(device_close, isys);
 	spin_unlock_irqrestore(&isys->power_lock, flags);
 	mutex_unlock(&isys->lib_mutex);
+=======
+	spin_lock_irqsave(&isys->power_lock, flags);
+	rval = ipu_lib_call(device_close, isys);
+	spin_unlock_irqrestore(&isys->power_lock, flags);
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (rval)
 		dev_err(dev, "Device close failure: %d\n", rval);
 
@@ -183,6 +197,13 @@ struct ipu_fw_isys_resp_info_abi *ipu_fw_isys_get_resp(
 	response->process_group_light.addr =
 		apiresp.process_group_light.addr;
 	response->acc_id = apiresp.acc_id;
+<<<<<<< HEAD
+=======
+#ifdef IPU_OTF_SUPPORT
+	response->frame_counter = apiresp.frame_counter;
+	response->written_direct = apiresp.written_direct;
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 	return response;
 }
@@ -247,6 +268,12 @@ static void output_pin_info_abi_to_api(
 	api->payload_buf_size = abi->payload_buf_size;
 	api->send_irq = abi->send_irq;
 	api->ft = abi->ft;
+<<<<<<< HEAD
+=======
+#ifdef IPU_OTF_SUPPORT
+	api->link_id = abi->link_id;
+#endif
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	api->reserve_compression = abi->reserve_compression;
 }
 
@@ -341,8 +368,11 @@ static void frame_buff_set_abi_to_api(
 
 	api->send_irq_sof = abi->send_irq_sof;
 	api->send_irq_eof = abi->send_irq_eof;
+<<<<<<< HEAD
 	api->send_irq_capture_ack = abi->send_irq_capture_ack;
 	api->send_irq_capture_done = abi->send_irq_capture_done;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 int ipu_fw_isys_complex_cmd(struct ipu_isys *isys,
@@ -384,5 +414,21 @@ int ipu_fw_isys_complex_cmd(struct ipu_isys *isys,
 }
 EXPORT_SYMBOL_GPL(ipu_fw_isys_complex_cmd);
 
+<<<<<<< HEAD
+=======
+static int __init library_init(void)
+{
+	ipu_isys_abi_checker();
+	return 0;
+}
+
+static void __exit library_exit(void)
+{
+}
+
+module_init(library_init);
+module_exit(library_exit);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("Intel ipu library");
diff --git a/drivers/media/pci/intel/ipu4/ipu4p-isys-csi2.c b/drivers/media/pci/intel/ipu4/ipu4p-isys-csi2.c
index 5a58bcd..af8a29c 100644
--- a/drivers/media/pci/intel/ipu4/ipu4p-isys-csi2.c
+++ b/drivers/media/pci/intel/ipu4/ipu4p-isys-csi2.c
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
+=======
+// SPDX-License_Identifier: GPL-2.0
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 //  Copyright (C) 2018 Intel Corporation
 
 #include "ipu.h"
@@ -223,9 +227,13 @@ static u64 tunit_time_to_us(struct ipu_isys *isys, u64 time)
 	struct ipu_bus_device *adev = to_ipu_bus_device(isys->adev->iommu);
 	u64 isys_clk = IS_FREQ_SOURCE / adev->ctrl->divisor / 1000000;
 
+<<<<<<< HEAD
 	do_div(time, isys_clk);
 
 	return time;
+=======
+	return time / isys_clk;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 static u64 tsc_time_to_tunit_time(struct ipu_isys *isys,
@@ -235,6 +243,7 @@ static u64 tsc_time_to_tunit_time(struct ipu_isys *isys,
 	u64 isys_clk = IS_FREQ_SOURCE / adev->ctrl->divisor / 100000;
 	u64 tsc_clk = IPU_BUTTRESS_TSC_CLK / 100000;
 
+<<<<<<< HEAD
 	tsc_time *= isys_clk;
 	tsc_base *= isys_clk;
 	do_div(tsc_time, tsc_clk);
@@ -275,6 +284,9 @@ static int update_timer_base(struct ipu_isys *isys)
 	}
 	dev_dbg(&isys->adev->dev, "Timer base values may not be accurate.\n");
 	return 0;
+=======
+	return (tsc_time - tsc_base) * isys_clk / tsc_clk + tunit_base;
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 }
 
 /* Extract the timestamp from trace message.
@@ -318,8 +330,11 @@ unsigned int ipu_isys_csi2_get_current_field(struct ipu_isys_pipeline *ip,
 	bool msg_matched = false;
 	unsigned int monitor_id;
 
+<<<<<<< HEAD
 	update_timer_base(isys);
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	if (ip->csi2->index >= IPU_ISYS_MAX_CSI2_LEGACY_PORTS)
 		monitor_id = TRACE_REG_CSI2_3PH_TM_MONITOR_ID;
 	else
diff --git a/drivers/media/pci/intel/libintel-checker.c b/drivers/media/pci/intel/libintel-checker.c
new file mode 100644
index 00000000..a831da7
--- /dev/null
+++ b/drivers/media/pci/intel/libintel-checker.c
@@ -0,0 +1,127 @@
+// SPDX-License_Identifier: GPL-2.0
+// Copyright (C) 2016 - 2018 Intel Corporation
+
+#include <linux/module.h>
+#include <linux/stringify.h>
+#include "libintel-checker.h"
+#include "ipu-fw-isys.h"
+#include "ia_css_isys_fw_bridged_types.h"
+
+/*
+ * Comment this out for field-by-field check. When defined only sizeof level
+ * check will be done
+ */
+#define BASIC_ABI_CHECK
+
+#define ABI_CHECK(a, b, field) { }
+
+#define SIZE_OF_CHECK(a, b) \
+	{		    \
+	if (sizeof(*a) != sizeof(*b))\
+		pr_err("ipu isys ABI size of mismatch %s\n",	\
+		       __stringify(a));					\
+	}								\
+
+static void abi_sanity_checker(void)
+{
+	struct ipu_fw_isys_resp_info_abi *abi_resp;
+	struct ia_css_isys_resp_info_comm *comm_resp;
+
+	struct ipu_fw_isys_resolution_abi *abi_resol;
+	struct ia_css_isys_resolution_comm *comm_resol;
+
+	struct ipu_fw_isys_output_pin_payload_abi *abi_pin_payload;
+	struct ia_css_isys_output_pin_payload_comm *comm_pin_payload;
+
+	struct ipu_fw_isys_output_pin_info_abi *abi_output_pin_info;
+	struct ia_css_isys_output_pin_info_comm *comm_output_pin_info;
+
+	struct ipu_fw_isys_param_pin_abi *abi_param_pin;
+	struct ia_css_isys_param_pin_comm *comm_param_pin;
+
+	struct ipu_fw_isys_isa_cfg_abi *abi_isa_cfg;
+	struct ia_css_isys_isa_cfg_comm *comm_isa_cfg;
+
+	struct ipu_fw_isys_input_pin_info_abi *abi_input_pin_info;
+	struct ia_css_isys_input_pin_info_comm *comm_input_pin_info;
+
+	struct ipu_fw_isys_cropping_abi *abi_cropping;
+	struct ia_css_isys_cropping_comm *comm_cropping;
+
+	struct ipu_fw_isys_stream_cfg_data_abi *abi_stream_cfg;
+	struct ia_css_isys_stream_cfg_data_comm *comm_stream_cfg;
+
+	struct ipu_fw_isys_frame_buff_set_abi *abi_frame_buff_set;
+	struct ia_css_isys_frame_buff_set_comm *comm_frame_buff_set;
+
+	SIZE_OF_CHECK(abi_resp, comm_resp);
+	ABI_CHECK(abi_resp, comm_resp, buf_id);
+	ABI_CHECK(abi_resp, comm_resp, type);
+	ABI_CHECK(abi_resp, comm_resp, timestamp[0]);
+	ABI_CHECK(abi_resp, comm_resp, timestamp[1]);
+	ABI_CHECK(abi_resp, comm_resp, stream_handle);
+	ABI_CHECK(abi_resp, comm_resp, error_info.error);
+	ABI_CHECK(abi_resp, comm_resp, error_info.error_details);
+	ABI_CHECK(abi_resp, comm_resp, pin.out_buf_id);
+	ABI_CHECK(abi_resp, comm_resp, pin.addr);
+	ABI_CHECK(abi_resp, comm_resp, pin_id);
+	ABI_CHECK(abi_resp, comm_resp, process_group_light.param_buf_id);
+	ABI_CHECK(abi_resp, comm_resp, process_group_light.addr);
+	ABI_CHECK(abi_resp, comm_resp, acc_id);
+
+	SIZE_OF_CHECK(abi_resol, comm_resol);
+	ABI_CHECK(abi_resol, comm_resol, width);
+	ABI_CHECK(abi_resol, comm_resol, height);
+
+	SIZE_OF_CHECK(abi_pin_payload, comm_pin_payload);
+	ABI_CHECK(abi_pin_payload, comm_pin_payload, out_buf_id);
+	ABI_CHECK(abi_pin_payload, comm_pin_payload, addr);
+
+	SIZE_OF_CHECK(abi_output_pin_info, comm_output_pin_info);
+	ABI_CHECK(abi_output_pin_info, comm_output_pin_info, input_pin_id);
+	ABI_CHECK(abi_output_pin_info, comm_output_pin_info, stride);
+	ABI_CHECK(abi_output_pin_info, comm_output_pin_info, pt);
+	ABI_CHECK(abi_output_pin_info, comm_output_pin_info,
+		  watermark_in_lines);
+	ABI_CHECK(abi_output_pin_info, comm_output_pin_info, send_irq);
+	ABI_CHECK(abi_output_pin_info, comm_output_pin_info, ft);
+
+	SIZE_OF_CHECK(abi_param_pin, comm_param_pin);
+	ABI_CHECK(abi_param_pin, comm_param_pin, param_buf_id);
+	ABI_CHECK(abi_param_pin, comm_param_pin, addr);
+
+	SIZE_OF_CHECK(abi_isa_cfg, comm_isa_cfg);
+
+	SIZE_OF_CHECK(abi_input_pin_info, comm_input_pin_info);
+	ABI_CHECK(abi_input_pin_info, comm_input_pin_info, dt);
+	ABI_CHECK(abi_input_pin_info, comm_input_pin_info, mipi_store_mode);
+
+	SIZE_OF_CHECK(abi_cropping, comm_cropping);
+	ABI_CHECK(abi_cropping, comm_cropping, top_offset);
+	ABI_CHECK(abi_cropping, comm_cropping, left_offset);
+	ABI_CHECK(abi_cropping, comm_cropping, bottom_offset);
+	ABI_CHECK(abi_cropping, comm_cropping, right_offset);
+
+	SIZE_OF_CHECK(abi_stream_cfg, comm_stream_cfg);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, src);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, vc);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, isl_use);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, compfmt);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, send_irq_sof_discarded);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, send_irq_eof_discarded);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, nof_input_pins);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, nof_output_pins);
+	ABI_CHECK(abi_stream_cfg, comm_stream_cfg, nof_input_pins);
+
+	SIZE_OF_CHECK(abi_frame_buff_set, comm_frame_buff_set);
+	ABI_CHECK(abi_frame_buff_set, abi_frame_buff_set, send_irq_sof);
+	ABI_CHECK(abi_frame_buff_set, abi_frame_buff_set, send_irq_eof);
+}
+
+void ipu_isys_abi_checker(void)
+{
+	abi_sanity_checker();
+}
+
+MODULE_LICENSE("GPL");
+MODULE_DESCRIPTION("Intel ipu library sanity checker");
diff --git a/drivers/media/pci/intel/libintel-checker.h b/drivers/media/pci/intel/libintel-checker.h
new file mode 100644
index 00000000..83a068a
--- /dev/null
+++ b/drivers/media/pci/intel/libintel-checker.h
@@ -0,0 +1,9 @@
+/* SPDX-License_Identifier: GPL-2.0 */
+/* Copyright (C) 2016 - 2018 Intel Corporation */
+
+#ifndef LIBINTEL_CHECKER_H
+#define LIBINTEL_CHECKER_H
+
+void ipu_isys_abi_checker(void);
+
+#endif
diff --git a/drivers/media/platform/intel/Kconfig b/drivers/media/platform/intel/Kconfig
index 7e195f7..18bbf87 100755
--- a/drivers/media/platform/intel/Kconfig
+++ b/drivers/media/platform/intel/Kconfig
@@ -1,5 +1,6 @@
 config INTEL_IPU4_BXT_P_PDATA
 	bool "Enable built in platform data for Broxton-P"
+<<<<<<< HEAD
 	depends on VIDEO_INTEL_IPU && VIDEO_INTEL_IPU4
 	---help---
 	Pre-ACPI system platform data is compiled inside kernel
@@ -13,13 +14,19 @@ config INTEL_IPU4_BXT_GP_PDATA
 config INTEL_IPU4_ICI_BXT_P_PDATA
 	depends on VIDEO_INTEL_IPU && VIDEO_INTEL_ICI
 	bool "Enable built in platform data for Broxton-P ICI driver"
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	---help---
 	Pre-ACPI system platform data is compiled inside kernel
 
 config INTEL_IPU4P_CNL_RVP_PDATA
+<<<<<<< HEAD
 	depends on VIDEO_INTEL_IPU && VIDEO_INTEL_IPU4P
 	bool "Enable built in platform data for ipu4p"
 	depends on VIDEO_INTEL_IPU4P
+=======
+	bool "Enable built in platform data for ipu4p"
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	---help---
 	Pre-ACPI system platform data is compiled inside kernel
 
@@ -99,6 +106,7 @@ config INTEL_IPU4_ADV7481
 	---help---
 	HDMI2MIPI convertor device ADV7481
 
+<<<<<<< HEAD
 config INTEL_IPU4_ADV7481_I2C_ID
 	int "I2C bus ID for ADV7481"
 	range 0 8
@@ -106,6 +114,8 @@ config INTEL_IPU4_ADV7481_I2C_ID
 	---help---
 	I2C bus number of ADV7481 Mondello
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 config INTEL_IPU4_ADV7481_EVAL
 	bool "Compile platform data for ADV7481 evaluation board"
 	---help---
@@ -115,6 +125,7 @@ config INTEL_IPU4_IMX290
 	bool "Compile platform data for IMX290"
 	depends on INTEL_IPU4_BXT_P_PDATA
 	---help---
+<<<<<<< HEAD
 	"Sony 8MB camera sensor is enabled for HDR function"
 
 config INTEL_IPU4_OV2775
@@ -140,3 +151,6 @@ config INTEL_IPU4_OV495
 	depends on INTEL_IPU4_BXT_P_PDATA
 	---help---
 	"ov495 camera sensor"
+=======
+	Sony 8MB camera sensor is enabled for HDR function
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/platform/intel/Makefile b/drivers/media/platform/intel/Makefile
index 88ecf07..8ab9640 100644
--- a/drivers/media/platform/intel/Makefile
+++ b/drivers/media/platform/intel/Makefile
@@ -1,10 +1,26 @@
+<<<<<<< HEAD
 # SPDX-License-Identifier: GPL-2.0
 # Copyright (c) 2010 - 2018, Intel Corporation.
+=======
+#
+#  Copyright (c) 2010 - 2018 Intel Corporation.
+#
+#  This program is free software; you can redistribute it and/or modify it
+#  under the terms and conditions of the GNU General Public License,
+#  version 2, as published by the Free Software Foundation.
+#
+#  This program is distributed in the hope it will be useful, but WITHOUT
+#  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
+#  FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+#  more details.
+#
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 ifneq ($(EXTERNAL_BUILD), 1)
 srcpath := $(srctree)
 endif
 
+<<<<<<< HEAD
 # force check the compile warning to make sure zero warnings
 # note we may have build issue when gcc upgraded.
 ccflags-y := -Wall -Wextra
@@ -20,4 +36,10 @@ obj-$(CONFIG_INTEL_IPU4_ICI_BXT_P_PDATA)   += ipu4-ici-bxt-p-pdata.o
 obj-$(CONFIG_VIDEO_INTEL_IPU)   += ipu4-acpi.o
 obj-$(CONFIG_INTEL_IPU4_BXT_P_PDATA)   += ipu4-bxt-p-pdata.o
 obj-$(CONFIG_INTEL_IPU4_BXT_GP_PDATA)   += ipu4-bxt-gp-pdata.o
+=======
+ccflags-y += -I$(srcpath)/$(src)/../../../../include/
+ccflags-y += -I$(srcpath)/$(src)/../../pci/intel/
+
+obj-$(CONFIG_INTEL_IPU4_BXT_P_PDATA)   += ipu4-bxt-p-pdata.o
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 obj-$(CONFIG_INTEL_IPU4P_CNL_RVP_PDATA)   += ipu4p-cnl-rvp-pdata.o
diff --git a/drivers/media/platform/intel/ipu4-bxt-p-pdata.c b/drivers/media/platform/intel/ipu4-bxt-p-pdata.c
index ed9b39c..8c0317d 100644
--- a/drivers/media/platform/intel/ipu4-bxt-p-pdata.c
+++ b/drivers/media/platform/intel/ipu4-bxt-p-pdata.c
@@ -1,6 +1,24 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
 // Copyright (C) 2015 - 2018 Intel Corporation
 
+=======
+/*
+ * Copyright (c) 2015--2018 Intel Corporation.
+ *
+ * Author: Jianxu Zheng <jian.xu.zheng@intel.com>
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License version
+ * 2 as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <linux/clk.h>
 #include <linux/clkdev.h>
 #include <linux/gpio.h>
@@ -10,8 +28,11 @@
 #include <media/ipu-isys.h>
 #include <media/crlmodule.h>
 #include <media/ti964.h>
+<<<<<<< HEAD
 #include <media/ti960.h>
 #include <media/max9286.h>
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include "ipu.h"
 #include <media/dw9714.h>
 #define GPIO_BASE		422
@@ -116,7 +137,10 @@ static struct crlmodule_platform_data ov2740_pdata = {
 	.op_sys_clock = (uint64_t []){ 72000000 },
 	.module_name = "INT3474",
 	.id_string = "0x27 0x40",
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config ov2740_csi2_cfg = {
@@ -134,6 +158,7 @@ static struct ipu_isys_subdev_info ov2740_crl_sd = {
 		.i2c_adapter_id = 2,
 	}
 };
+<<<<<<< HEAD
 
 //for port 2
 static struct crlmodule_platform_data ov2740_pdata_2 = {
@@ -161,6 +186,8 @@ static struct ipu_isys_subdev_info ov2740_crl_sd_2 = {
 	.i2c_adapter_id = 4,
 	}
 };
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 
 #ifdef CONFIG_INTEL_IPU4_IMX185
@@ -175,7 +202,10 @@ static struct crlmodule_platform_data imx185_pdata = {
 					111375000, 222750000 },
 	.module_name = "IMX185",
 	.id_string = "0x1 0x85",
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config imx185_csi2_cfg = {
@@ -207,7 +237,10 @@ static struct crlmodule_platform_data imx185_li_pdata = {
 					111375000, 222750000 },
 	.module_name = "IMX185",
 	.id_string = "0x1 0x85",
+<<<<<<< HEAD
 	.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config imx185_li_csi2_cfg = {
@@ -239,7 +272,10 @@ static struct crlmodule_platform_data ar023z_pdata = {
 	.op_sys_clock = (uint64_t []){317250000},
 	.module_name = "AR023Z",
 	.id_string = "0x4401 0x64",
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config ar023z_csi2_cfg = {
@@ -265,7 +301,10 @@ static struct crlmodule_platform_data ar023z_b_pdata = {
 	.op_sys_clock = (uint64_t []){317250000},
 	.module_name = "AR023Z",
 	.id_string = "0x4401 0x64",
+<<<<<<< HEAD
 	.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config ar023z_b_csi2_cfg = {
@@ -297,7 +336,10 @@ static struct crlmodule_platform_data imx477_pdata_master = {
 	.op_sys_clock = (uint64_t []){600000000},
 	.module_name = "IMX477-MASTER",
 	.id_string = "0x4 0x77",
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config imx477_csi2_cfg_master = {
@@ -323,7 +365,10 @@ static struct crlmodule_platform_data imx477_pdata_slave_1 = {
 	.op_sys_clock = (uint64_t []){600000000},
 	.module_name = "IMX477-SLAVE-1",
 	.id_string = "0x4 0x77",
+<<<<<<< HEAD
 	.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config imx477_csi2_cfg_slave_1 = {
@@ -355,7 +400,10 @@ static struct crlmodule_platform_data imx274_pdata = {
 	.op_sys_clock = (uint64_t []){720000000},
 	.module_name = "IMX274",
 	.id_string = "0x6 0x9",
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config imx274_csi2_cfg = {
@@ -381,7 +429,10 @@ static struct crlmodule_platform_data imx274_b_pdata = {
 	.op_sys_clock = (uint64_t []){720000000},
 	.module_name = "IMX274",
 	.id_string = "0x6 0x9",
+<<<<<<< HEAD
 	.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config imx274_b_csi2_cfg = {
@@ -413,7 +464,10 @@ static struct crlmodule_platform_data imx290_pdata = {
 	.op_sys_clock = (uint64_t []){222750000, 445500000},
 	.module_name = "IMX290",
 	.id_string = "0x2 0x90",
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config imx290_csi2_cfg = {
@@ -443,8 +497,12 @@ static struct crlmodule_platform_data ov13860_pdata = {
 	.lanes = OV13860_LANES,
 	.ext_clk = 24000000,
 	.op_sys_clock = (uint64_t []){ 600000000, 300000000},
+<<<<<<< HEAD
 	.module_name = "OV13860",
 	.suffix = 'a',
+=======
+	.module_name = "OV13860"
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config ov13860_csi2_cfg = {
@@ -476,7 +534,10 @@ static struct crlmodule_platform_data ov9281_pdata = {
 	.op_sys_clock = (uint64_t []){400000000},
 	.module_name = "OV9281",
 	.id_string = "0x92 0x81",
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config ov9281_csi2_cfg = {
@@ -496,7 +557,11 @@ static struct ipu_isys_subdev_info ov9281_crl_sd = {
 };
 #endif
 
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_BU64295)
+=======
+#ifdef CONFIG_VIDEO_BU64295
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define BU64295_VCM_ADDR	0x0c
 #define BU64295_NAME		"bu64295"
@@ -522,8 +587,12 @@ static struct crlmodule_platform_data adv7481_pdata = {
 	.lanes = ADV7481_LANES,
 	.ext_clk = 24000000,
 	.op_sys_clock = (uint64_t []){600000000},
+<<<<<<< HEAD
 	.module_name = "ADV7481",
 	.suffix = 'a',
+=======
+	.module_name = "ADV7481"
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config adv7481_csi2_cfg = {
@@ -556,8 +625,12 @@ static struct crlmodule_platform_data adv7481_eval_pdata = {
 	.lanes = ADV7481_LANES,
 	.ext_clk = 24000000,
 	.op_sys_clock = (uint64_t []){600000000},
+<<<<<<< HEAD
 	.module_name = "ADV7481_EVAL",
 	.suffix = 'a',
+=======
+	.module_name = "ADV7481_EVAL"
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config adv7481_eval_csi2_cfg = {
@@ -583,8 +656,12 @@ static struct crlmodule_platform_data adv7481b_eval_pdata = {
 	.lanes = ADV7481_LANES,
 	.ext_clk = 24000000,
 	.op_sys_clock = (uint64_t []){600000000},
+<<<<<<< HEAD
 	.module_name = "ADV7481B_EVAL",
 	.suffix = 'b',
+=======
+	.module_name = "ADV7481B_EVAL"
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_csi2_config adv7481b_eval_csi2_cfg = {
@@ -606,7 +683,11 @@ static struct ipu_isys_subdev_info adv7481b_eval_crl_sd = {
 };
 #endif
 
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_AGGREGATOR_STUB)
+=======
+#ifdef CONFIG_VIDEO_AGGREGATOR_STUB
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 #define VIDEO_AGGRE_LANES	4
 #define VIDEO_AGGRE_I2C_ADDRESS	0x3b
@@ -645,11 +726,18 @@ static struct ipu_isys_subdev_info video_aggre_b_stub_sd = {
 };
 #endif
 
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_INTEL_IPU4_MAGNA)
 #define MAGNA_LANES		4
 #define MAGNA_PHY_ADDR	0x60 /* 0x30 for 7bit addr */
 #define MAGNA_ADDRESS_A	0x61
 #define MAGNA_ADDRESS_B 0x62
+=======
+#ifdef CONFIG_INTEL_IPU4_MAGNA
+#define MAGNA_LANES		4
+#define MAGNA_PHY_ADDR	0x60 /* 0x30 for 7bit addr */
+#define MAGNA_ADDRESS_A	0x61
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 static struct crlmodule_platform_data magna_pdata = {
 	.lanes = MAGNA_LANES,
@@ -673,7 +761,11 @@ static struct crlmodule_platform_data magna_pdata = {
 };
 #endif
 
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_INTEL_IPU4_OV10635)
+=======
+#ifdef CONFIG_INTEL_IPU4_OV10635
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define OV10635_LANES		4
 #define OV10635_I2C_PHY_ADDR	0x60 /* 0x30 for 7bit addr */
 #define OV10635A_I2C_ADDRESS	0x61
@@ -693,11 +785,19 @@ static struct crlmodule_platform_data ov10635_pdata = {
 	 * The number here stands for which GPIO to connect with.
 	 * 1 means to connect sensor xshutdown to GPIO1
 	 */
+<<<<<<< HEAD
 	.xshutdown = 0,
 };
 #endif
 
 #if IS_ENABLED(CONFIG_INTEL_IPU4_OV10640)
+=======
+	.xshutdown = 1,
+};
+#endif
+
+#ifdef CONFIG_INTEL_IPU4_OV10640
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define OV10640_LANES			4
 #define OV10640_I2C_PHY_ADDR	0x60 /* 0x30 for 7bit addr */
 #define OV10640A_I2C_ADDRESS	0x61
@@ -721,7 +821,11 @@ static struct crlmodule_platform_data ov10640_pdata = {
 };
 #endif
 
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_TI964)
+=======
+#ifdef CONFIG_VIDEO_TI964
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define TI964_I2C_ADAPTER	0
 #define TI964_I2C_ADAPTER_2	7
 #define TI964_I2C_ADDRESS	0x3d
@@ -737,7 +841,11 @@ static struct ipu_isys_csi2_config ti964_csi2_cfg_2 = {
 	.port = 4,
 };
 
+<<<<<<< HEAD
 static struct ti964_subdev_info ti964_subdevs[] = {
+=======
+struct ti964_subdev_info ti964_subdevs[] = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #ifdef CONFIG_INTEL_IPU4_OV10635
 	{
 		.board_info = {
@@ -748,7 +856,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 0,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -759,7 +870,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 1,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -770,7 +884,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 2,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'c',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -781,7 +898,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 3,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'd',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 #endif
 #ifdef CONFIG_INTEL_IPU4_OV10640
@@ -794,7 +914,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 0,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -805,7 +928,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 1,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -816,7 +942,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 2,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'c',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -827,7 +956,10 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 3,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'd',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 #endif
 #ifdef CONFIG_INTEL_IPU4_MAGNA
@@ -840,6 +972,7 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER,
 		.rx_port = 0,
 		.phy_i2c_addr = MAGNA_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'a',
 	},
 	{
@@ -852,11 +985,17 @@ static struct ti964_subdev_info ti964_subdevs[] = {
 		.rx_port = 1,
 		.phy_i2c_addr = MAGNA_PHY_ADDR,
 		.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 #endif
 };
 
+<<<<<<< HEAD
 static struct ti964_subdev_info ti964_subdevs_2[] = {
+=======
+struct ti964_subdev_info ti964_subdevs_2[] = {
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #ifdef CONFIG_INTEL_IPU4_OV10635
 	{
 		.board_info = {
@@ -867,7 +1006,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 0,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'e',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -878,7 +1020,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 1,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'f',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -889,7 +1034,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 2,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'g',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -900,7 +1048,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 3,
 		.phy_i2c_addr = OV10635_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'h',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 #endif
 #ifdef CONFIG_INTEL_IPU4_OV10640
@@ -913,7 +1064,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 0,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'e',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -924,7 +1078,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 1,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'f',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -935,7 +1092,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 2,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'g',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 	{
 		.board_info = {
@@ -946,7 +1106,10 @@ static struct ti964_subdev_info ti964_subdevs_2[] = {
 		.i2c_adapter_id = TI964_I2C_ADAPTER_2,
 		.rx_port = 3,
 		.phy_i2c_addr = OV10640_I2C_PHY_ADDR,
+<<<<<<< HEAD
 		.suffix = 'h',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	},
 #endif
 };
@@ -955,7 +1118,10 @@ static struct ti964_pdata ti964_pdata = {
 	.subdev_info = ti964_subdevs,
 	.subdev_num = ARRAY_SIZE(ti964_subdevs),
 	.reset_gpio = GPIO_BASE + 63,
+<<<<<<< HEAD
 	.suffix = 'a',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_subdev_info ti964_sd = {
@@ -974,7 +1140,10 @@ static struct ti964_pdata ti964_pdata_2 = {
 	.subdev_info = ti964_subdevs_2,
 	.subdev_num = ARRAY_SIZE(ti964_subdevs_2),
 	.reset_gpio = GPIO_BASE + 66,
+<<<<<<< HEAD
 	.suffix = 'b',
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 static struct ipu_isys_subdev_info ti964_sd_2 = {
@@ -990,6 +1159,7 @@ static struct ipu_isys_subdev_info ti964_sd_2 = {
 };
 #endif
 
+<<<<<<< HEAD
 #ifdef CONFIG_INTEL_IPU4_OV2775
 #define OV2775_LANES	   2
 #define OV2775_I2C_ADAPTER     3
@@ -1726,13 +1896,20 @@ static struct ipu_isys_subdev_info max9286_sd = {
 };
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /*
  * Map buttress output sensor clocks to sensors -
  * this should be coming from ACPI
  */
+<<<<<<< HEAD
 static struct ipu_isys_clk_mapping clk_mapping[] = {
 	{ CLKDEV_INIT("2-0036", NULL, NULL), "OSC_CLK_OUT0" },
 	{ CLKDEV_INIT("4-0036", NULL, NULL), "OSC_CLK_OUT1" },
+=======
+struct ipu_isys_clk_mapping clk_mapping[] = {
+	{ CLKDEV_INIT("2-0036", NULL, NULL), "OSC_CLK_OUT0" },
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{ CLKDEV_INIT("2-001a", NULL, NULL), "OSC_CLK_OUT0" },
 	{ CLKDEV_INIT("4-001a", NULL, NULL), "OSC_CLK_OUT1" },
 	{ CLKDEV_INIT("2-0010", NULL, NULL), "OSC_CLK_OUT0" },
@@ -1742,8 +1919,11 @@ static struct ipu_isys_clk_mapping clk_mapping[] = {
 	{ CLKDEV_INIT("0-0010", NULL, NULL), "OSC_CLK_OUT0" },
 	{ CLKDEV_INIT("2-000e", NULL, NULL), "OSC_CLK_OUT0" },
 	{ CLKDEV_INIT("4-000e", NULL, NULL), "OSC_CLK_OUT1" },
+<<<<<<< HEAD
 	{ CLKDEV_INIT("0-0048", NULL, NULL), "OSC_CLK_OUT0" },
 	{ CLKDEV_INIT("4-0048", NULL, NULL), "OSC_CLK_OUT1" },
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	{ CLKDEV_INIT(NULL, NULL, NULL), NULL }
 };
 
@@ -1757,7 +1937,10 @@ static struct ipu_isys_subdev_pdata pdata = {
 #endif
 #ifdef CONFIG_INTEL_IPU4_OV2740
 		&ov2740_crl_sd,
+<<<<<<< HEAD
 		&ov2740_crl_sd_2,
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 #ifdef CONFIG_INTEL_IPU4_IMX185
 		&imx185_crl_sd,
@@ -1786,7 +1969,11 @@ static struct ipu_isys_subdev_pdata pdata = {
 #ifdef CONFIG_INTEL_IPU4_OV9281
 		&ov9281_crl_sd,
 #endif
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_BU64295)
+=======
+#ifdef CONFIG_VIDEO_BU64295
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		&bu64295_sd,
 #endif
 #ifdef CONFIG_INTEL_IPU4_ADV7481
@@ -1796,6 +1983,7 @@ static struct ipu_isys_subdev_pdata pdata = {
 		&adv7481_eval_crl_sd,
 		&adv7481b_eval_crl_sd,
 #endif
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_AGGREGATOR_STUB)
 		&video_aggre_stub_sd,
 		&video_aggre_b_stub_sd,
@@ -1815,6 +2003,15 @@ static struct ipu_isys_subdev_pdata pdata = {
 #endif
 #if IS_ENABLED(CONFIG_VIDEO_MAX9286)
 		&max9286_sd,
+=======
+#ifdef CONFIG_VIDEO_AGGREGATOR_STUB
+		&video_aggre_stub_sd,
+		&video_aggre_b_stub_sd,
+#endif
+#ifdef CONFIG_VIDEO_TI964
+		&ti964_sd,
+		&ti964_sd_2,
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif
 		NULL,
 	},
diff --git a/drivers/media/platform/intel/ipu4p-cnl-rvp-pdata.c b/drivers/media/platform/intel/ipu4p-cnl-rvp-pdata.c
index 74bfe32..e7f38de 100644
--- a/drivers/media/platform/intel/ipu4p-cnl-rvp-pdata.c
+++ b/drivers/media/platform/intel/ipu4p-cnl-rvp-pdata.c
@@ -1,6 +1,22 @@
+<<<<<<< HEAD
 // SPDX-License-Identifier: GPL-2.0
 // Copyright (C) 2018 Intel Corporation
 
+=======
+/*
+ * Copyright (c) 2018 Intel Corporation.
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU General Public License version
+ * 2 as published by the Free Software Foundation.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #include <linux/clk.h>
 #include <linux/clkdev.h>
 #include <linux/kernel.h>
@@ -83,7 +99,11 @@ static struct crlmodule_platform_data ar0231at_pdata = {
 };
 #endif
 
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_MAX9286)
+=======
+#ifdef CONFIG_VIDEO_MAX9286
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define DS_MAX9286_LANES                4
 #define DS_MAX9286_I2C_ADAPTER_B        3
 #define DS_MAX9286_I2C_ADDRESS          0x48
@@ -160,7 +180,11 @@ static struct ipu_isys_subdev_pdata pdata = {
 		&imx355_sd2,
 		&imx319_sd,
 		&ak7375_sd,
+<<<<<<< HEAD
 #if IS_ENABLED(CONFIG_VIDEO_MAX9286)
+=======
+#ifdef CONFIG_VIDEO_MAX9286
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		&max9286_b_sd,
 #endif
 		NULL,
diff --git a/drivers/media/platform/video-sensor-stub-pdata.c b/drivers/media/platform/video-sensor-stub-pdata.c
index 86fa86e..3b98803 100644
--- a/drivers/media/platform/video-sensor-stub-pdata.c
+++ b/drivers/media/platform/video-sensor-stub-pdata.c
@@ -23,6 +23,12 @@ static struct ipu_isys_csi2_config stub_csi2_cfg[] = {
 		.port = 0,
 	},
 	{
+<<<<<<< HEAD
+=======
+		/*
+		 * For BXT B0 FPGA board, port 1 only support 1 lane
+		 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 		.nlanes = 1,
 		.port = 1,
 	},
@@ -63,4 +69,16 @@ static void ipu_quirk(struct pci_dev *pci_dev)
 	pci_dev->dev.platform_data = &pdata;
 }
 
+<<<<<<< HEAD
 DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, 0x5a88, ipu_quirk);
+=======
+/* BXT ISYS FPGA */
+DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, 0x9488, ipu_quirk);
+/* BXT A0 */
+DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, 0x4008, ipu_quirk);
+/* BXTP A0 Iunit=BXT B0 Iunit */
+DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, 0x5a88, ipu_quirk);
+/* BXT FPGA. ISYS & PSYS */
+DECLARE_PCI_FIXUP_EARLY(PCI_VENDOR_ID_INTEL, 0x0a88, ipu_quirk);
+
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
diff --git a/drivers/media/platform/video-sensor-stub.c b/drivers/media/platform/video-sensor-stub.c
index 08195e7..2bcf786 100644
--- a/drivers/media/platform/video-sensor-stub.c
+++ b/drivers/media/platform/video-sensor-stub.c
@@ -79,10 +79,13 @@ static const uint32_t sensor_supported_codes_pad[] = {
 };
 
 
+<<<<<<< HEAD
 static const uint32_t * const sensor_supported_codes[] = {
 	sensor_supported_codes_pad,
 };
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 static u32 sensor_pixel_order(struct stub_sensor *sensor)
 {
 	return sensor->default_pixel_order;
diff --git a/include/media/as3638.h b/include/media/as3638.h
index 6fd6b69..fcc88e9 100644
--- a/include/media/as3638.h
+++ b/include/media/as3638.h
@@ -1,15 +1,22 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef __AS3638_H__
 #define __AS3638_H__
 
+<<<<<<< HEAD
 #ifdef __KERNEL__
 #include <linux/types.h>
 #else
 #include <stdint.h>
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define AS3638_NAME			"as3638"
 #define AS3638_I2C_ADDR			0x30
 
diff --git a/include/media/crlmodule.h b/include/media/crlmodule.h
index f27917d..55035c6 100644
--- a/include/media/crlmodule.h
+++ b/include/media/crlmodule.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation
  * Generic driver for common register list based camera sensor modules
  *
@@ -12,6 +16,7 @@
 #define CRLMODULE_NAME		"crlmodule"
 
 #define CRL_MAX_CUSTOM_GPIO_AMOUNT 3
+<<<<<<< HEAD
 #define CRL_MAX_GPIO_POWERUP_SEQ	4
 
 /* set this flag if this module needs serializer initialization */
@@ -20,6 +25,8 @@
 #define CRL_MODULE_FL_POWERUP	BIT(1)
 /* set this flag if this module needs reset signal */
 #define CRL_MODULE_FL_RESET	BIT(2)
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 struct crl_custom_gpio {
 	char name[16];
@@ -37,6 +44,7 @@ struct crlmodule_platform_data {
 	unsigned int lanes;		/* Number of CSI-2 lanes */
 	const s64 *op_sys_clock;
 
+<<<<<<< HEAD
 	/* specify gpio pins of Deser for PWDN, FSIN, RESET. */
 	int xshutdown;
 	int fsin;
@@ -57,13 +65,19 @@ struct crlmodule_platform_data {
 	 */
 	unsigned int module_flags;
 
+=======
+	int xshutdown;			/* gpio */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	struct crl_custom_gpio custom_gpio[CRL_MAX_CUSTOM_GPIO_AMOUNT];
 	char module_name[16]; /* module name from ACPI */
 	int crl_irq_pin;
 	unsigned int irq_pin_flags;
 	char irq_pin_name[16];
 	const char *id_string;
+<<<<<<< HEAD
 	char suffix; /* suffix to identify multi sensors, abcd.. */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 	unsigned int high_framevalid_flags; /* high framevaild flags*/
 };
 
diff --git a/include/media/dw9714.h b/include/media/dw9714.h
index 11737c6..7abcf0c 100755
--- a/include/media/dw9714.h
+++ b/include/media/dw9714.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2015 - 2018 Intel Corporation
  *
  * Based on ATOMISP dw9714 implementation by
diff --git a/include/media/ipu-isys.h b/include/media/ipu-isys.h
index b2acb94..57f9139 100644
--- a/include/media/ipu-isys.h
+++ b/include/media/ipu-isys.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation */
 
 #ifndef MEDIA_IPU_H
@@ -22,7 +26,10 @@ struct ipu_isys_subdev_i2c_info {
 struct ipu_isys_subdev_info {
 	struct ipu_isys_csi2_config *csi2;
 	struct ipu_isys_subdev_i2c_info i2c;
+<<<<<<< HEAD
 	char *acpiname;
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct ipu_isys_clk_mapping {
diff --git a/include/media/lc898122.h b/include/media/lc898122.h
index 5c42640..8278145 100644
--- a/include/media/lc898122.h
+++ b/include/media/lc898122.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef __LC898122_HEADER__
diff --git a/include/media/lm3643.h b/include/media/lm3643.h
index 58acf6f..4969132 100644
--- a/include/media/lm3643.h
+++ b/include/media/lm3643.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef __LM3643_H__
diff --git a/include/media/max9286.h b/include/media/max9286.h
index 68d3856..4e045dda 100644
--- a/include/media/max9286.h
+++ b/include/media/max9286.h
@@ -40,14 +40,20 @@ struct max9286_csi_data_format {
 struct max9286_subdev_i2c_info {
 	struct i2c_board_info board_info;
 	int i2c_adapter_id;
+<<<<<<< HEAD
 	const char suffix; /* suffix for subdevs */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct max9286_pdata {
 	unsigned int subdev_num;
 	struct max9286_subdev_i2c_info *subdev_info;
 	unsigned int reset_gpio;
+<<<<<<< HEAD
 	const char suffix; /* suffix for multi aggregators, abcd... */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 #endif
diff --git a/include/media/ti964.h b/include/media/ti964.h
index ab5ee21..0f8ac05 100644
--- a/include/media/ti964.h
+++ b/include/media/ti964.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef TI964_H
@@ -46,14 +50,20 @@ struct ti964_subdev_info {
 	int i2c_adapter_id;
 	unsigned short rx_port;
 	unsigned short phy_i2c_addr;
+<<<<<<< HEAD
 	const char suffix; /* suffix for subdevs */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 struct ti964_pdata {
 	unsigned int subdev_num;
 	struct ti964_subdev_info *subdev_info;
 	unsigned int reset_gpio;
+<<<<<<< HEAD
 	const char suffix; /* suffix for multi aggregators, abcd... */
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 };
 
 #endif
diff --git a/include/uapi/linux/crlmodule.h b/include/uapi/linux/crlmodule.h
index f13d278..e843fbb 100644
--- a/include/uapi/linux/crlmodule.h
+++ b/include/uapi/linux/crlmodule.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef UAPI_LINUX_CRLMODULE_H
@@ -60,13 +64,18 @@ struct crl_registers_info {
 #define CRL_CID_MSB_ALIGN		(V4L2_CID_CRLMODULE_BASE + 18)
 
 /* enable/disable auto exposure */
+<<<<<<< HEAD
 #define CRL_CID_AUTO_EXPOSURE_DEBUG	(V4L2_CID_CRLMODULE_BASE + 19)
+=======
+#define CRL_CID_AUTO_EXPOSURE_DEBUG		(V4L2_CID_CRLMODULE_BASE + 19)
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 /* set analog gain for HDR frames */
 #define CRL_CID_ANALOG_GAIN_L		(V4L2_CID_CRLMODULE_BASE + 20)
 #define CRL_CID_ANALOG_GAIN_S		(V4L2_CID_CRLMODULE_BASE + 21)
 #define CRL_CID_ANALOG_GAIN_VS		(V4L2_CID_CRLMODULE_BASE + 22)
 
+<<<<<<< HEAD
 /* Set exposure mode: Linear mode or 2-/3-/4-HDR mode */
 #define CRL_CID_EXPOSURE_MODE		(V4L2_CID_CRLMODULE_BASE + 23)
 
@@ -76,4 +85,6 @@ struct crl_registers_info {
 /* choose hcg/lcg for linear analog */
 #define CRL_CID_ANALOG_LINEAR_CG	(V4L2_CID_CRLMODULE_BASE + 25)
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* UAPI_LINUX_CRLMODULE_H */
diff --git a/include/uapi/linux/ipu-isys-isa-fw.h b/include/uapi/linux/ipu-isys-isa-fw.h
index 3a4ee6d..1a6c5cf 100644
--- a/include/uapi/linux/ipu-isys-isa-fw.h
+++ b/include/uapi/linux/ipu-isys-isa-fw.h
@@ -1,15 +1,22 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2014 - 2018 Intel Corporation */
 
 #ifndef IPU_ISYS_ISA_FW_H
 #define IPU_ISYS_ISA_FW_H
 
+<<<<<<< HEAD
 #ifdef __KERNEL__
 #include <linux/types.h>
 #else
 #include <stdint.h>
 #endif
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #define ia_css_terminal_offsets(pg)			\
 	((uint16_t *)((void *)(pg) +			\
 		      (pg)->terminals_offset_offset))
diff --git a/include/uapi/linux/ipu-isys.h b/include/uapi/linux/ipu-isys.h
index f98bfab..ddb451e 100644
--- a/include/uapi/linux/ipu-isys.h
+++ b/include/uapi/linux/ipu-isys.h
@@ -1,4 +1,8 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2016 - 2018 Intel Corporation */
 
 #ifndef UAPI_LINUX_IPU_ISYS_H
@@ -21,6 +25,7 @@
 #define V4L2_FMT_IPU_ISA_CFG	v4l2_fourcc('i', 'p', '4', 'c')
 #define V4L2_FMT_IPU_ISYS_META	v4l2_fourcc('i', 'p', '4', 'm')
 
+<<<<<<< HEAD
 #ifdef IPU_OTF_SUPPORT
 struct ipu_frame_counter {
 	uint32_t frame_counter;
@@ -36,4 +41,6 @@ struct ipu_frame_counter {
 #define VIDIOC_IPU_GET_DRIVER_VERSION \
 	_IOWR('v', BASE_VIDIOC_PRIVATE + 3, uint32_t)
 
+=======
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 #endif /* UAPI_LINUX_IPU_ISYS_H */
diff --git a/include/uapi/linux/ipu-psys.h b/include/uapi/linux/ipu-psys.h
index c20da18..b03a3cb 100644
--- a/include/uapi/linux/ipu-psys.h
+++ b/include/uapi/linux/ipu-psys.h
@@ -1,14 +1,22 @@
+<<<<<<< HEAD
 /* SPDX-License-Identifier: GPL-2.0 */
+=======
+/* SPDX-License_Identifier: GPL-2.0 */
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 /* Copyright (C) 2013 - 2018 Intel Corporation */
 
 #ifndef _UAPI_IPU_PSYS_H
 #define _UAPI_IPU_PSYS_H
 
+<<<<<<< HEAD
 #ifdef __KERNEL__
 #include <linux/types.h>
 #else
 #include <stdint.h>
 #endif
+=======
+#include <linux/types.h>
+>>>>>>> 58f5e3f... media: intel-ipu: Merge IPU kernel driver into 4.14 kernel
 
 struct ipu_psys_capability {
 	uint32_t version;
-- 
2.7.4

