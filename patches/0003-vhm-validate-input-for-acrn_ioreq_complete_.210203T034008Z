From 941cf4bff7dc6989ac6ffaab75911aa3b9f20da4 Mon Sep 17 00:00:00 2001
From: Yonghua Huang <yonghua.huang@intel.com>
Date: Tue, 24 Nov 2020 17:25:13 +0800
Subject: [PATCH 3/3] vhm: validate input for acrn_ioreq_complete_request()

 Input 'vcpu' of function 'acrn_ioreq_complete_request()'
 is not validated and may overflow.

Tracked-On: projectacrn/acrn-hypervisor#5548
Signed-off-by: Yonghua Huang <yonghua.huang@intel.com>
---
 drivers/vhm/vhm_ioreq.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/drivers/vhm/vhm_ioreq.c b/drivers/vhm/vhm_ioreq.c
index afead7f94732..9ab79ed4969b 100644
--- a/drivers/vhm/vhm_ioreq.c
+++ b/drivers/vhm/vhm_ioreq.c
@@ -1017,6 +1017,12 @@ int acrn_ioreq_complete_request(int client_id, uint64_t vcpu,
 		return -EINVAL;
 	}
 
+	if (vcpu >= refcount_read(&client->ref_vm->vcpu_num)) {
+		pr_err("vhm-ioreq: vcpu %lld overflow\n", vcpu);
+		acrn_ioreq_put_client(client);
+		return -EINVAL;
+	}
+
 	clear_bit(vcpu, client->ioreqs_map);
 	if (!vhm_req) {
 		vhm_req = acrn_ioreq_get_reqbuf(client_id);
-- 
2.17.1

