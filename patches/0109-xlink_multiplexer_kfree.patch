From 79d55bcfecd863570d05791a06cc6b0b728d9da7 Mon Sep 17 00:00:00 2001
From: hspe <hspe@PG02RAL00012.png.intel.com>
Date: Tue, 25 Jan 2022 12:37:57 +0800
Subject: [PATCH 109/109] xlink_multiplexer_kfree

---
 drivers/misc/xlink-core/xlink-multiplexer.c | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/drivers/misc/xlink-core/xlink-multiplexer.c b/drivers/misc/xlink-core/xlink-multiplexer.c
index a92b0ba0c773..9e34ebcacac6 100644
--- a/drivers/misc/xlink-core/xlink-multiplexer.c
+++ b/drivers/misc/xlink-core/xlink-multiplexer.c
@@ -566,10 +566,12 @@ static int open_closed_channel(struct xlink_event *event, u32 link_id,
 		} else {
 			xlink_dispatcher_event_add(EVENT_TX, event);
 			*event_queued = 1;
-			mutex_unlock(&xmux->channels[link_id][chan].lock);
 			save_timeout = opchan->chan->timeout;
 			opchan->chan->timeout = OPEN_CHANNEL_TIMEOUT_MSEC;
+			mutex_unlock(&xmux->channels[link_id][chan].lock);
 			rc = compl_wait(&opchan->opened, opchan);
+			mutex_lock(&xmux->channels[link_id][chan].lock);
+			opchan = xmux->channels[link_id][chan].opchan;
 			if (opchan) {
 				opchan->chan->timeout = save_timeout;
 				if (rc == 0) {
-- 
2.25.1

