From 0bb01c58b406af7b54770f8c09fc8a8c38baec3c Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Thu, 27 Apr 2023 13:17:46 +0800
Subject: [PATCH 05/68] Revert "drm/amdkfd: Fix an illegal memory access"

This reverts commit 6936525142a015e854d0a23e9ad9ea0a28b3843d.
---
 drivers/gpu/drm/amd/amdkfd/kfd_events.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/amd/amdkfd/kfd_events.c b/drivers/gpu/drm/amd/amdkfd/kfd_events.c
index 2c19b3775179b..159be13ef20bb 100644
--- a/drivers/gpu/drm/amd/amdkfd/kfd_events.c
+++ b/drivers/gpu/drm/amd/amdkfd/kfd_events.c
@@ -528,13 +528,16 @@ static struct kfd_event_waiter *alloc_event_waiters(uint32_t num_events)
 	struct kfd_event_waiter *event_waiters;
 	uint32_t i;
 
-	event_waiters = kcalloc(num_events, sizeof(struct kfd_event_waiter),
-				GFP_KERNEL);
+	event_waiters = kmalloc_array(num_events,
+					sizeof(struct kfd_event_waiter),
+					GFP_KERNEL);
 	if (!event_waiters)
 		return NULL;
 
-	for (i = 0; i < num_events; i++)
+	for (i = 0; (event_waiters) && (i < num_events) ; i++) {
 		init_wait(&event_waiters[i].wait);
+		event_waiters[i].activated = false;
+	}
 
 	return event_waiters;
 }
-- 
2.25.1

