From 845b111612122ddec508b1a351cd1d07078e1c83 Mon Sep 17 00:00:00 2001
From: Ranjan Dutta <ranjan.dutta@intel.com>
Date: Thu, 27 Apr 2023 13:17:45 +0800
Subject: [PATCH 03/68] Revert "drm/shmem-helper: Remove another errant put in
 error path"

This reverts commit 684c7372bbd6447c2e86a2a84e97a1478604d21f.
---
 drivers/gpu/drm/drm_gem_shmem_helper.c | 9 +++------
 1 file changed, 3 insertions(+), 6 deletions(-)

diff --git a/drivers/gpu/drm/drm_gem_shmem_helper.c b/drivers/gpu/drm/drm_gem_shmem_helper.c
index b7bb5610dfe21..c56656a95cf99 100644
--- a/drivers/gpu/drm/drm_gem_shmem_helper.c
+++ b/drivers/gpu/drm/drm_gem_shmem_helper.c
@@ -614,14 +614,11 @@ int drm_gem_shmem_mmap(struct drm_gem_object *obj, struct vm_area_struct *vma)
 	int ret;
 
 	if (obj->import_attach) {
-		vma->vm_private_data = NULL;
-		ret = dma_buf_mmap(obj->dma_buf, vma, 0);
-
 		/* Drop the reference drm_gem_mmap_obj() acquired.*/
-		if (!ret)
-			drm_gem_object_put(obj);
+		drm_gem_object_put(obj);
+		vma->vm_private_data = NULL;
 
-		return ret;
+		return dma_buf_mmap(obj->dma_buf, vma, 0);
 	}
 
 	shmem = to_drm_gem_shmem_obj(obj);
-- 
2.25.1

