From 26e92a4655f89664ad44c62b6071b83a8a4bce45 Mon Sep 17 00:00:00 2001
From: Gustaw Lewandowski <gustaw.lewandowski@intel.com>
Date: Wed, 30 Jan 2019 14:37:37 +0100
Subject: [PATCH 257/292] ASoC: Intel: Skylake: Add dummy_codec to
 skl_machine_pdata

Change-Id: I4ec3bc6040815d5e340b4925f88c1c94d4a846cd
Signed-off-by: Gustaw Lewandowski <gustaw.lewandowski@intel.com>
Signed-off-by: Pankaj Bharadiya <pankaj.laxminarayan.bharadiya@intel.com>
---
 sound/soc/intel/skylake/cnl-sst.c | 4 ++--
 sound/soc/intel/skylake/skl.c     | 3 ++-
 sound/soc/intel/skylake/skl.h     | 3 ++-
 3 files changed, 6 insertions(+), 4 deletions(-)

diff --git a/sound/soc/intel/skylake/cnl-sst.c b/sound/soc/intel/skylake/cnl-sst.c
index 55a44599a21c..90e39f6b01e2 100644
--- a/sound/soc/intel/skylake/cnl-sst.c
+++ b/sound/soc/intel/skylake/cnl-sst.c
@@ -110,7 +110,7 @@ static int cnl_prepare_fw(struct sst_dsp *ctx, const void *fwdata, u32 fwsize)
 	struct skl *skl = get_skl_ctx(ctx->dev);
 	struct skl_machine_pdata *pdata = (struct skl_machine_pdata *)
 						skl->mach->pdata;
-	if (pdata && pdata->imr_alloc) {
+	if (pdata && pdata->imr_alloc && *(pdata->imr_alloc)) {
 		ret = cnl_alloc_imr(ctx);
 		if (ret < 0)
 			return ret;
@@ -157,7 +157,7 @@ static int cnl_prepare_fw(struct sst_dsp *ctx, const void *fwdata, u32 fwsize)
 	ctx->dsp_ops.cleanup(ctx->dev, &ctx->dmab, stream_tag,
 						SNDRV_PCM_STREAM_PLAYBACK);
 	cnl_dsp_disable_core(ctx, SKL_DSP_CORE0_MASK);
-	if (pdata && pdata->imr_alloc)
+	if (pdata && pdata->imr_alloc && *(pdata->imr_alloc))
 		cnl_free_imr(ctx);
 
 	return ret;
diff --git a/sound/soc/intel/skylake/skl.c b/sound/soc/intel/skylake/skl.c
index 60bb3064b3a5..6448a559e1b6 100644
--- a/sound/soc/intel/skylake/skl.c
+++ b/sound/soc/intel/skylake/skl.c
@@ -564,7 +564,7 @@ static int skl_find_machine(struct skl *skl, void *driver_data)
 	struct snd_soc_acpi_mach *mach = driver_data;
 	struct skl_machine_pdata *pdata = mach->pdata;
 
-	if (pdata && pdata->imr_alloc)
+	if (pdata && pdata->dummy_codec)
 		goto out;
 
 	mach = snd_soc_acpi_find_machine(mach);
@@ -577,6 +577,7 @@ static int skl_find_machine(struct skl *skl, void *driver_data)
 		}
 	}
 
+out:
 	skl->mach = mach;
 	skl->fw_name = mach->fw_filename;
 
diff --git a/sound/soc/intel/skylake/skl.h b/sound/soc/intel/skylake/skl.h
index c64ff3dfbe1b..25eb5c08aac7 100644
--- a/sound/soc/intel/skylake/skl.h
+++ b/sound/soc/intel/skylake/skl.h
@@ -179,7 +179,8 @@ struct skl_dma_params {
 
 struct skl_machine_pdata {
 	bool use_tplg_pcm; /* use dais and dai links from topology */
-	bool imr_alloc;
+	int *imr_alloc;
+	bool dummy_codec;
 	const u8 *dummy_dais;
 	u8 num_dummy_dais;
 };
-- 
2.21.0

