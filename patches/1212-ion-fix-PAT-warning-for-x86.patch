From 33e2c343e938bb68a6b275310e20526c45a00fec Mon Sep 17 00:00:00 2001
From: "Pan, Kris" <kris.pan@intel.com>
Date: Tue, 13 Oct 2020 11:20:03 +0800
Subject: [PATCH 1212/1214] ion: fix PAT warning for x86

Signed-off-by: Pan, Kris <kris.pan@intel.com>
---
 drivers/staging/android/ion/ion_system_heap.c | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/drivers/staging/android/ion/ion_system_heap.c b/drivers/staging/android/ion/ion_system_heap.c
index 6003cda..287ec71 100644
--- a/drivers/staging/android/ion/ion_system_heap.c
+++ b/drivers/staging/android/ion/ion_system_heap.c
@@ -135,6 +135,10 @@ static int ion_system_heap_allocate(struct ion_heap *heap,
 	sg = table->sgl;
 	list_for_each_entry_safe(page, tmp_page, &pages, lru) {
 		sg_set_page(sg, page, PAGE_SIZE << compound_order(page), 0);
+#ifdef CONFIG_X86
+		if (!(buffer->flags & ION_FLAG_CACHED))
+			set_memory_wc((unsigned long)page_address(sg_page(sg)), PAGE_ALIGN(sg->length) / PAGE_SIZE);
+#endif
 		sg = sg_next(sg);
 		list_del(&page->lru);
 	}
@@ -163,8 +167,13 @@ static void ion_system_heap_free(struct ion_buffer *buffer)
 	if (!(buffer->private_flags & ION_PRIV_FLAG_SHRINKER_FREE))
 		ion_heap_buffer_zero(buffer);
 
-	for_each_sg(table->sgl, sg, table->nents, i)
+	for_each_sg(table->sgl, sg, table->nents, i) {
+#ifdef CONFIG_X86
+		if (!(buffer->flags & ION_FLAG_CACHED))
+			set_memory_wb((unsigned long)page_address(sg_page(sg)), PAGE_ALIGN(sg->length) / PAGE_SIZE);
+#endif
 		free_buffer_page(sys_heap, buffer, sg_page(sg));
+	}
 	sg_free_table(table);
 	kfree(table);
 }
-- 
2.7.4

