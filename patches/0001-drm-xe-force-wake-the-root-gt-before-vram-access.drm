From 1877fcd185cf34f5adf7936b8bf02a45dc5588c9 Mon Sep 17 00:00:00 2001
From: Xin Wang <x.wang@intel.com>
Date: Fri, 18 Jul 2025 06:58:17 +0800
Subject: [PATCH] drm/xe: force wake the root gt before vram access

On rare discrete graphics cards (BMG) and motherboard
configurations, vram access may fail during the migration
from S3 to S0. This is related to hardware timing issues.

Forcewake can ensure that the memory path is open to avoid
vram read and write errors.

This patch also fixes the problem of system crashing when
the monitor is not connected when booting and then connected.

Signed-off-by: Xin Wang <x.wang@intel.com>
---
 drivers/gpu/drm/xe/xe_bo_evict.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/xe/xe_bo_evict.c b/drivers/gpu/drm/xe/xe_bo_evict.c
index ed3746d32b27..ab04011e0679 100644
--- a/drivers/gpu/drm/xe/xe_bo_evict.c
+++ b/drivers/gpu/drm/xe/xe_bo_evict.c
@@ -9,6 +9,8 @@
 #include "xe_device.h"
 #include "xe_ggtt.h"
 #include "xe_tile.h"
+#include "xe_force_wake.h"
+#include "xe_mmio.h"
 
 typedef int (*xe_pinned_fn)(struct xe_bo *bo);
 
@@ -226,9 +228,19 @@ static int xe_bo_restore_and_map_ggtt(struct xe_bo *bo)
  */
 int xe_bo_restore_early(struct xe_device *xe)
 {
-	return xe_bo_apply_to_pinned(xe, &xe->pinned.early.evicted,
+	int ret;
+	unsigned int fw_ref;
+
+	/* forcewake the root gt before the VRAM access */
+	fw_ref = xe_force_wake_get(gt_to_fw(xe_root_mmio_gt(xe)), XE_FW_GT);
+
+	ret = xe_bo_apply_to_pinned(xe, &xe->pinned.early.evicted,
 				     &xe->pinned.early.kernel_bo_present,
 				     xe_bo_restore_and_map_ggtt);
+
+	xe_force_wake_put(gt_to_fw(xe_root_mmio_gt(xe)), fw_ref);
+
+	return ret;
 }
 
 /**
-- 
2.43.0

