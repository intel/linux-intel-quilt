From 88440c5c8adabc8e34e7157785c694a437863355 Mon Sep 17 00:00:00 2001
From: Zhou Furong <furong.zhou@intel.com>
Date: Wed, 29 Sep 2021 11:22:23 +0800
Subject: [PATCH 001/109] Revert "arm64: do not descend to vdso directories
 twice"

This reverts commit a5b8ca97fbf8300a5e21c393df25ce6f521e7939.
---
 arch/arm64/Makefile                                | 10 ++++------
 arch/arm64/kernel/Makefile                         |  5 ++---
 arch/arm64/kernel/vdso/Makefile                    |  1 +
 arch/arm64/kernel/{vdso-wrap.S => vdso/vdso.S}     |  0
 arch/arm64/kernel/vdso32/Makefile                  |  1 +
 arch/arm64/kernel/{vdso32-wrap.S => vdso32/vdso.S} |  0
 6 files changed, 8 insertions(+), 9 deletions(-)
 rename arch/arm64/kernel/{vdso-wrap.S => vdso/vdso.S} (100%)
 rename arch/arm64/kernel/{vdso32-wrap.S => vdso32/vdso.S} (100%)

diff --git a/arch/arm64/Makefile b/arch/arm64/Makefile
index c744b1e7b356..5133c34a66cb 100644
--- a/arch/arm64/Makefile
+++ b/arch/arm64/Makefile
@@ -198,12 +198,10 @@ ifeq ($(KBUILD_EXTMOD),)
 # this hack.
 prepare: vdso_prepare
 vdso_prepare: prepare0
-	$(Q)$(MAKE) $(build)=arch/arm64/kernel/vdso \
-	include/generated/vdso-offsets.h arch/arm64/kernel/vdso/vdso.so
-ifdef CONFIG_COMPAT_VDSO
-	$(Q)$(MAKE) $(build)=arch/arm64/kernel/vdso32 \
-	include/generated/vdso32-offsets.h arch/arm64/kernel/vdso32/vdso.so
-endif
+	$(Q)$(MAKE) $(build)=arch/arm64/kernel/vdso include/generated/vdso-offsets.h
+	$(if $(CONFIG_COMPAT_VDSO),$(Q)$(MAKE) \
+		$(build)=arch/arm64/kernel/vdso32  \
+		include/generated/vdso32-offsets.h)
 endif
 
 define archhelp
diff --git a/arch/arm64/kernel/Makefile b/arch/arm64/kernel/Makefile
index 3f1490bfb938..789ae7dd6ed2 100644
--- a/arch/arm64/kernel/Makefile
+++ b/arch/arm64/kernel/Makefile
@@ -71,10 +71,9 @@ obj-$(CONFIG_CRASH_CORE)		+= crash_core.o
 obj-$(CONFIG_ARM_SDE_INTERFACE)		+= sdei.o
 obj-$(CONFIG_ARM64_PTR_AUTH)		+= pointer_auth.o
 obj-$(CONFIG_ARM64_MTE)			+= mte.o
-obj-y					+= vdso-wrap.o
-obj-$(CONFIG_COMPAT_VDSO)		+= vdso32-wrap.o
 
-obj-y					+= probes/
+obj-y					+= vdso/ probes/
+obj-$(CONFIG_COMPAT_VDSO)		+= vdso32/
 head-y					:= head.o
 extra-y					+= $(head-y) vmlinux.lds
 
diff --git a/arch/arm64/kernel/vdso/Makefile b/arch/arm64/kernel/vdso/Makefile
index 945e6bb326e3..47cf442bbdf7 100644
--- a/arch/arm64/kernel/vdso/Makefile
+++ b/arch/arm64/kernel/vdso/Makefile
@@ -45,6 +45,7 @@ endif
 # Disable gcov profiling for VDSO code
 GCOV_PROFILE := n
 
+obj-y += vdso.o
 targets += vdso.lds
 CPPFLAGS_vdso.lds += -P -C -U$(ARCH)
 
diff --git a/arch/arm64/kernel/vdso-wrap.S b/arch/arm64/kernel/vdso/vdso.S
similarity index 100%
rename from arch/arm64/kernel/vdso-wrap.S
rename to arch/arm64/kernel/vdso/vdso.S
diff --git a/arch/arm64/kernel/vdso32/Makefile b/arch/arm64/kernel/vdso32/Makefile
index 3514269ac75f..57b28f1e5d97 100644
--- a/arch/arm64/kernel/vdso32/Makefile
+++ b/arch/arm64/kernel/vdso32/Makefile
@@ -141,6 +141,7 @@ c-obj-vdso-gettimeofday := $(addprefix $(obj)/, $(c-obj-vdso-gettimeofday))
 asm-obj-vdso := $(addprefix $(obj)/, $(asm-obj-vdso))
 obj-vdso := $(c-obj-vdso) $(c-obj-vdso-gettimeofday) $(asm-obj-vdso)
 
+obj-y += vdso.o
 targets += vdso.lds
 CPPFLAGS_vdso.lds += -P -C -U$(ARCH)
 
diff --git a/arch/arm64/kernel/vdso32-wrap.S b/arch/arm64/kernel/vdso32/vdso.S
similarity index 100%
rename from arch/arm64/kernel/vdso32-wrap.S
rename to arch/arm64/kernel/vdso32/vdso.S
-- 
2.25.1

