From c6b266ff2464725356ca987df1e119d85c66f2c4 Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Tue, 15 Oct 2019 10:32:04 +0100
Subject: [PATCH 581/869] drm/i915/execlists: Clear semaphore immediately upon
 ELSP promotion

There is no significance to our delay before clearing the semaphore the
engine is waiting on, so release it as soon as we acknowledge the CS
update following our preemption request. This should allow the GPU to
resume work earlier, if it was stuck on the semaphore at the end of a
request.

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Reviewed-by: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Link: https://patchwork.freedesktop.org/patch/msgid/20191015093204.25693-1-chris@chris-wilson.co.uk
---
 drivers/gpu/drm/i915/gt/intel_lrc.c | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

Index: kernel-lts-staging/drivers/gpu/drm/i915/gt/intel_lrc.c
===================================================================
--- kernel-lts-staging.orig/drivers/gpu/drm/i915/gt/intel_lrc.c
+++ kernel-lts-staging/drivers/gpu/drm/i915/gt/intel_lrc.c
@@ -1911,6 +1911,9 @@ static void process_csb(struct intel_eng
 		else
 			promote = gen8_csb_parse(execlists, buf + 2 * head);
 		if (promote) {
+			if (!inject_preempt_hang(execlists))
+				ring_set_paused(engine, 0);
+
 			/* cancel old inflight, prepare for switch */
 			trace_ports(execlists, "preempted", execlists->active);
 			while (*execlists->active)
@@ -1927,9 +1930,6 @@ static void process_csb(struct intel_eng
 			if (enable_timeslice(execlists))
 				mod_timer(&execlists->timer, jiffies + 1);
 
-			if (!inject_preempt_hang(execlists))
-				ring_set_paused(engine, 0);
-
 			/* XXX Magic delay for tgl */
 			ENGINE_POSTING_READ(engine, RING_CONTEXT_STATUS_PTR);
 
