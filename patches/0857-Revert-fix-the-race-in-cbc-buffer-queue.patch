From c45f931d293516c14752f91d7d80214566024398 Mon Sep 17 00:00:00 2001
From: Zhou Furong <furong.zhou@intel.com>
Date: Mon, 26 Nov 2018 13:25:29 +0800
Subject: [PATCH 0857/1214] Revert "fix the race in cbc buffer queue"

This reverts commit 29d979e8a4e0943bbc5059a65b734cd23f57939b.
Signed-off-by: Zhou Furong <furong.zhou@intel.com>
Tracked-On: PKT-1557
---
 drivers/tty/cbc/cbc_memory.c | 20 +++++++++++++-------
 1 file changed, 13 insertions(+), 7 deletions(-)

diff --git a/drivers/tty/cbc/cbc_memory.c b/drivers/tty/cbc/cbc_memory.c
index 716d431..69cf65e 100644
--- a/drivers/tty/cbc/cbc_memory.c
+++ b/drivers/tty/cbc/cbc_memory.c
@@ -91,11 +91,17 @@ struct cbc_buffer *cbc_memory_pool_get_buffer(struct cbc_memory_pool *pool)
 
 void cbc_buffer_release(struct cbc_buffer *buffer)
 {
+	int tmp;
 
 	if (!buffer)
 		return;
 
-	atomic_dec(&buffer->refcount);
+	atomic_read(&buffer->refcount);
+
+	tmp = atomic_dec_return(&buffer->refcount);
+	if (tmp == 0)
+		memset(buffer->data, 0xCD, CBC_BUFFER_SIZE);
+
 }
 
 void cbc_buffer_increment_ref(struct cbc_buffer *buffer)
@@ -116,13 +122,13 @@ int cbc_buffer_queue_enqueue(struct cbc_buffer_queue *queue,
 	if (!queue || !buffer)
 		return 0;
 
-	if (queue->read == ((queue->write + 1) & CBC_QUEUE_BM)) {
+	if (queue->read + CBC_QUEUE_LENGTH == queue->write) {
 		pr_err("cbc buffer queue full\n");
 		return 0;
 	}
-	queue->queue[queue->write] = buffer;
-	queue->write = ((++queue->write) & CBC_QUEUE_BM);
 
+	queue->queue[queue->write & CBC_QUEUE_BM] = buffer;
+	queue->write++;
 	return 1;
 }
 
@@ -138,9 +144,9 @@ struct cbc_buffer *cbc_buffer_queue_dequeue(struct cbc_buffer_queue *queue)
 		return buffer;
 	}
 
-	buffer = queue->queue[queue->read];
-	queue->queue[queue->read] = NULL;
-	queue->read = ((++queue->read) & CBC_QUEUE_BM);
+	buffer = queue->queue[queue->read & CBC_QUEUE_BM];
+	queue->queue[queue->read & CBC_QUEUE_BM] = NULL;
+	queue->read++;
 
 	return buffer;
 }
-- 
2.7.4

