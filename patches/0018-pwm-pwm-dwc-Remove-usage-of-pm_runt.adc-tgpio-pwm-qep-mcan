From ce21e06bc284a6d9d95f72b44023c61e761ec2b3 Mon Sep 17 00:00:00 2001
From: "Tan, Raymond" <raymond.tan@intel.com>
Date: Wed, 20 Nov 2019 01:40:03 +0800
Subject: [PATCH 18/32] pwm: pwm-dwc: Remove usage of pm_runtime_autosuspend

Remove usage of pm_runtime_autosuspend and replace pm_runtime_put_noidle
with pm_runtime_put. This makes the default behavior to go into idle
with no dependency on any countdown / delay.

This DWC PWM IP has 8 pins, and all can be separately configured, thus using
pm_runtime_get/put_sync to increment/decrement the internal counter for the
RPM subsystem to decide when the whole IP shall go low power.

Signed-off-by: Tan, Raymond
---
 drivers/pwm/pwm-dwc.c | 7 ++-----
 1 file changed, 2 insertions(+), 5 deletions(-)

diff --git a/drivers/pwm/pwm-dwc.c b/drivers/pwm/pwm-dwc.c
index d672959d54cf..5cceac299545 100644
--- a/drivers/pwm/pwm-dwc.c
+++ b/drivers/pwm/pwm-dwc.c
@@ -139,8 +139,7 @@ static int dwc_pwm_apply(struct pwm_chip *pwm, struct pwm_device *pdev,
 		if (!pwm_is_enabled(pdev))
 			pm_runtime_get_sync(dwc->dev);
 	} else if (pwm_is_enabled(pdev)) {
-		pm_runtime_mark_last_busy(dwc->dev);
-		pm_runtime_put_autosuspend(dwc->dev);
+			pm_runtime_put_sync(dwc->dev);
 	}
 	__dwc_configure(dwc, pdev->hwpwm, state->duty_cycle, state->period);
 	__dwc_set_enable(dwc, pdev->hwpwm, state->enabled);
@@ -224,9 +223,7 @@ static int dwc_pci_probe(struct pci_dev *pci, const struct pci_device_id *id)
 	if (ret)
 		goto err2;
 
-	pm_runtime_set_autosuspend_delay(dev, 1000);
-	pm_runtime_use_autosuspend(dev);
-	pm_runtime_put_noidle(dev);
+	pm_runtime_put(dev);
 	pm_runtime_allow(dev);
 
 	return 0;
-- 
2.17.1

