From f4809fb7148fb65ed0137856392961f46e57ab5b Mon Sep 17 00:00:00 2001
From: Junxiao Chang <junxiao.chang@intel.com>
Date: Sun, 7 Feb 2021 11:07:44 +0800
Subject: [PATCH 0001/1069] Revert "drm/i915/gt: Close race between
 enable_breadcrumbs and cancel_breadcrumbs"

This reverts commit e4747cb3ec3c232d65c84cbe77633abd5871fda3.
---
 drivers/gpu/drm/i915/gt/intel_breadcrumbs.c | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/drivers/gpu/drm/i915/gt/intel_breadcrumbs.c b/drivers/gpu/drm/i915/gt/intel_breadcrumbs.c
index 1d1757584f49..484c74d71739 100644
--- a/drivers/gpu/drm/i915/gt/intel_breadcrumbs.c
+++ b/drivers/gpu/drm/i915/gt/intel_breadcrumbs.c
@@ -451,12 +451,10 @@ void i915_request_cancel_breadcrumb(struct i915_request *rq)
 	struct intel_context *ce = rq->context;
 	bool release;
 
-	spin_lock(&ce->signal_lock);
-	if (!test_and_clear_bit(I915_FENCE_FLAG_SIGNAL, &rq->fence.flags)) {
-		spin_unlock(&ce->signal_lock);
+	if (!test_and_clear_bit(I915_FENCE_FLAG_SIGNAL, &rq->fence.flags))
 		return;
-	}
 
+	spin_lock(&ce->signal_lock);
 	list_del_rcu(&rq->signal_link);
 	release = remove_signaling_context(b, ce);
 	spin_unlock(&ce->signal_lock);
-- 
2.27.0

