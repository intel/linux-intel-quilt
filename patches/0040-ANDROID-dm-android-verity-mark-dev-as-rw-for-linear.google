From 27893632985e9cae76bcffae83bfe71cd2bcb3fc Mon Sep 17 00:00:00 2001
From: Badhri Jagan Sridharan <Badhri@google.com>
Date: Fri, 3 Jun 2016 13:16:59 -0700
Subject: [PATCH 040/429] ANDROID: dm: android-verity: mark dev as rw for
 linear target

Mark as rw when adding as linear target to allow changes
to the underlying filesystem through adb disable verity
and adb remount.

(Cherry-picked from
https://partner-android-review.googlesource.com/#/c/613573/
79a3032bb62da65a5d724eb70c8bdc662945d475)

BUG: 28845874
Signed-off-by: Badhri Jagan Sridharan <Badhri@google.com>
Change-Id: If41e9cad8e0f054f4778c09a6e2f0cb8af6fddaf
---
 drivers/md/dm-android-verity.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/drivers/md/dm-android-verity.c b/drivers/md/dm-android-verity.c
index b2665f569396..0dd69244f77c 100644
--- a/drivers/md/dm-android-verity.c
+++ b/drivers/md/dm-android-verity.c
@@ -648,6 +648,8 @@ static int add_as_linear_device(struct dm_target *ti, char *dev)
         android_verity_target.dax_copy_from_iter = dm_linear_dax_copy_from_iter,
 	android_verity_target.io_hints = NULL;
 
+	set_disk_ro(dm_disk(dm_table_get_md(ti->table)), 0);
+
 	err = dm_linear_ctr(ti, DM_LINEAR_ARGS, linear_table_args);
 
 	if (!err) {
-- 
2.19.1

